// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/Personalization","sap/ushell/services/_Personalization/constants"],function(P,c){"use strict";jQuery.sap.require("sap.ui2.srvc.ODataWrapper");jQuery.sap.require("sap.ui2.srvc.ODataService");var a="yyyyMMddHHmmss",I=new Date(9999,1,1,0,0,0),s=new Date(9999,1,1,0,0,0,0),C="PersContainers",b="ADMIN#sap-ushell-container-expireUTCTimestamp",d="ADMIN#sap-ushell-container-storageUTCTimestamp",f="ADMIN#sap-ushell-container-scope";jQuery.sap.getObject("sap.ushell_abap.adapters.abap",0);sap.ushell_abap.adapters.abap.PersonalizationAdapter=function(S,p,o){this._oConfig=o&&o.config;var e=(jQuery.sap.getObject("config.services.personalization.baseUrl",undefined,o)||"/sap/opu/odata/UI2/INTEROP")+"/";var O={baseUrl:e,'sap-language':sap.ushell.Container.getUser().getLanguage(),'sap-client':sap.ushell.Container.getLogonSystem().getClient()};this._oWrapper=sap.ui2.srvc.createODataWrapper(O);function D(m){sap.ui2.srvc.Error(m,"sap.ushell_abap.adapters.abap.PersonalizationAdapter");}sap.ui2.srvc.ODataService.call(this,this._oWrapper,D);};sap.ushell_abap.adapters.abap.PersonalizationAdapter.prototype.supportsGetWithoutSubsequentLoad=true;sap.ushell_abap.adapters.abap.PersonalizationAdapter.prototype.getAdapterContainer=function(e,S,g){return new sap.ushell_abap.adapters.abap.AdapterContainer(e,this,S,g);};sap.ushell_abap.adapters.abap.PersonalizationAdapter.prototype.delAdapterContainer=function(e,S){return this.getAdapterContainer(e,S).del();};function r(e){var g="sap.ushell.personalization#";if(e.substring(0,g.length)!==g){jQuery.sap.log.error("Unexpected ContainerKey "+e);return e;}return e.substring(g.length,g.length+40);}sap.ui2.srvc.testPublishAt(sap.ushell_abap.adapters.abap.PersonalizationAdapter);sap.ushell_abap.adapters.abap.PersonalizationAdapter.prototype._determineCategory=function(S){if(!S){return"U";}var o=c;if(S.keyCategory&&S.keyCategory===o.keyCategory.FIXED_KEY&&S.writeFrequency&&S.writeFrequency===o.writeFrequency.LOW&&S.clientStorageAllowed&&S.clientStorageAllowed===true){return"P";}return"U";};sap.ushell_abap.adapters.abap.AdapterContainer=function(e,S,o,g){this._oService=S;this._oScope=o;this["sap-cache-id"]=jQuery.sap.getObject("_oService._oConfig.services.personalization.cacheId",undefined,this);C=jQuery.sap.getObject("_oService._oConfig.services.personalization.relativeUrl",undefined,this)||"PersContainers";this._sContainerKey=r(e);this._sAppName=g||"";this._category=sap.ushell_abap.adapters.abap.PersonalizationAdapter.prototype._determineCategory(o);this._oJSONContainer={"category":this._category,"clientExpirationTime":s,"appName":this._sAppName,"component":"","id":this._sContainerKey,PersContainerItems:[]};this._oPropertyBag={};this._aOperationQueue=[];};sap.ushell_abap.adapters.abap.AdapterContainer.prototype._reset=function(){this._oJSONContainer.PersContainerItems=[];};sap.ushell_abap.adapters.abap.AdapterContainer.prototype._obtainODataWrapper=function(){return this._oService._oWrapper;};sap.ushell_abap.adapters.abap.AdapterContainer.prototype.load=function(){var D=new jQuery.Deferred(),t=this,o=this._obtainODataWrapper(),R=C+"(category='"+this._category+"',id='"+encodeURIComponent(this._sContainerKey)+"')?$expand=PersContainerItems";if(this._category&&(this._category==='P')&&this["sap-cache-id"]){R=R+"&sap-cache-id="+this["sap-cache-id"];}sap.ui2.srvc.ODataService.call(this,o,function(){return false;});o.read(R,function(e){t._oJSONContainer=e;t._oJSONContainer.category=t._category;t._oJSONContainer.id=t._sContainerKey;t._oJSONContainer.appName=t._sAppName;t._oJSONContainer.PersContainerItems=(t._oJSONContainer.PersContainerItems&&t._oJSONContainer.PersContainerItems.results)||[];D.resolve(t);},function(e){jQuery.sap.log.warning(e);t._reset();D.resolve(t);});return D.promise();};sap.ushell_abap.adapters.abap.AdapterContainer.prototype.save=function(){var D=new jQuery.Deferred(),t=this,o=this._obtainODataWrapper(),R=C;sap.ui2.srvc.ODataService.call(this,o,function(){return false;});o.create(R,this._oJSONContainer,function(e){D.resolve(t);},function(e){D.reject(e);});return D.promise();};sap.ushell_abap.adapters.abap.AdapterContainer.prototype.del=function(){var D=new jQuery.Deferred(),t=this,o=this._obtainODataWrapper(),R=C+"(category='"+this._category+"',id='"+encodeURIComponent(this._sContainerKey)+"')";sap.ui2.srvc.ODataService.call(this,o,function(){return false;});o.del(R,function(e){D.resolve(t);},function(e){D.reject(e);});this._reset();return D.promise();};sap.ushell_abap.adapters.abap.AdapterContainer.prototype.getItemKeys=function(){var e=[];this._oJSONContainer.PersContainerItems.forEach(function(m){if(m.category==="V"){e.push("VARIANTSET#"+m.id);}else if(m.category==="I"){e.push("ITEM#"+m.id);}});if(this._oJSONContainer.validity>=0){e.push(d);e.push(b);e.push(f);}return e;};sap.ushell_abap.adapters.abap.AdapterContainer.prototype.containsItem=function(i){return this.getItemKeys().indexOf(i)>=0?true:false;};function A(e){if(e===undefined||e===null){return null;}var F=sap.ui.core.format.DateFormat.getDateInstance({pattern:a});return F.parse(JSON.parse(e),true);}function E(D){var F=sap.ui.core.format.DateFormat.getDateInstance({pattern:a});if(D===null){D=s;}if(typeof D==="string"){if(/\/Date\(([0-9]+)\)\//.exec(D)){D=new Date(parseInt(/\/Date\(([0-9]+)\)\//.exec(D)[1],10));}else{jQuery.sap.log.error("Expected Date format "+D);}}if(+D===+s){return undefined;}return F.format(D,true);}sap.ushell_abap.adapters.abap.AdapterContainer.prototype._findItemIndex=function(e,g){var i;for(i=0;i<this._oJSONContainer.PersContainerItems.length;i=i+1){if(this._oJSONContainer.PersContainerItems[i].id===e&&this._oJSONContainer.PersContainerItems[i].category===g){return i;}}return undefined;};sap.ushell_abap.adapters.abap.AdapterContainer.prototype._locateItem=function(i){var e={index:-1};if(i===b){return{containerProperty:"clientExpirationTime",initialValue:s,convToABAP:A,convFromABAP:E};}if(i===f){return{containerProperty:"validity",initialValue:0,convToABAP:function(o){if(!o){return null;}return JSON.parse(o).validity;},convFromABAP:function(v,o){if(v<=0){return undefined;}o=o||{};o.validity=v;return o;}};}if(i===d){return{containerProperty:" ignore",initialValue:I,convToABAP:A,convFromABAP:E};}if(i.indexOf("ITEM#")===0){e.trueItemKey=i.substring("ITEM#".length,"ITEM#".length+40);e.category="I";}else if(i.indexOf("VARIANTSET#")===0){e.trueItemKey=i.substring("VARIANTSET#".length,"VARIANTSET#".length+40);e.category="V";}else if(i.indexOf("ADMIN#")!==0){jQuery.sap.log.error("Unknown itemkey prefix"+i);}e.index=this._findItemIndex(e.trueItemKey,e.category);return e;};sap.ushell_abap.adapters.abap.AdapterContainer.prototype.getItemValue=function(i){var g="",o,h=this._locateItem(i);if(h.containerProperty===" ignore"){return undefined;}if(h.index>=0){g=this._oJSONContainer.PersContainerItems[h.index].value;try{o=JSON.parse(g);}catch(e){if(g==="X"){o=true;}else{o=undefined;}}}if(h.containerProperty){if(typeof h.convFromABAP==="function"){return h.convFromABAP(this._oJSONContainer[h.containerProperty],o);}return this._oJSONContainer[h.containerProperty];}return o;};sap.ushell_abap.adapters.abap.AdapterContainer.prototype.setItemValue=function(i,o){var e=JSON.stringify(o),g=this._locateItem(i);if(g.containerProperty===" ignore"){return;}if(g.containerProperty){if(typeof g.convToABAP==="function"){this._oJSONContainer[g.containerProperty]=g.convToABAP(e);}else{this._oJSONContainer[g.containerProperty]=e;}if(!g.trueItemKey){return;}}if(g.index>=0){this._oJSONContainer.PersContainerItems[g.index].value=e;return;}this._oJSONContainer.PersContainerItems.push({"value":e,"id":g.trueItemKey,"category":g.category,"containerId":this._sContainerKey,"containerCategory":this._category});};sap.ushell_abap.adapters.abap.AdapterContainer.prototype.delItem=function(i){var o=this._locateItem(i);if(o.containerProperty===" ignore"){return;}if(o.containerProperty){this._oJSONContainer[o.containerProperty]=o.initialValue;return;}if(o.index>=0){this._oJSONContainer.PersContainerItems.splice(o.index,1);return;}};return sap.ushell_abap.adapters.abap.PersonalizationAdapter;});

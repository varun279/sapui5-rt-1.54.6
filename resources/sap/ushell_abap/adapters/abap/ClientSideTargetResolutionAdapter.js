// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");jQuery.sap.require("sap.ui2.srvc.ODataWrapper");jQuery.sap.require("sap.ui2.srvc.utils");var S="sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter";var n=["sap-wd-configId","SAP-WD-CONFIGID","sap-client","SAP-CLIENT","System","SYSTEM","sap-language","SAP-LANGUAGE","sap-wd-htmlrendermode","sap-wd-deltarendering","wdallowvaluesuggest","sap-wd-lightspeed","sap-wd-remotedesktop","sap-wd-flashdebug","sap-accessibility","sap-theme","sap-*","SAP-*","wd*","WD*"];sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter=function(s,p,a){var t=this;this._oLocalSystemAlias={http:{id:"",host:"",port:"",pathPrefix:"/sap/bc/"},https:{id:"",host:"",port:"",pathPrefix:"/sap/bc/"},rfc:{id:"",systemId:"",host:"",service:0,loginGroup:"",sncNameR3:"",sncQoPR3:""},id:"",client:"",language:""};this.hasSegmentedAccess=true;this._oAdapterConfig=a&&a.config;this._wdLengthLimit=1800;this._oODataWrapper=undefined;this._getODataWrapper=function(){if(!this._oODataWrapper){this._oODataWrapper=sap.ui2.srvc.createODataWrapper("/sap/opu/odata/UI2/INTEROP/");}return this._oODataWrapper;};this._aTargetMappings=[];this._aInbounds=[];this._aInitialSegment=undefined;this._oSystemAliasBuffer=new sap.ushell.utils.Map();this._storeFromFullStartupResponse=function(f){if(f){if(f.targetMappings){t._aTargetMappings=f.targetMappings;}if(f.systemAliases){t._writeUserSystemAliasesToBuffer(f.systemAliases);}}};this._fallbackToFullStartupRequest=function(r,R){jQuery.sap.log.debug("Falling back to full start_up request from adapter","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");t._requestAllTargetMappings().done(function(f){t._storeFromFullStartupResponse(f);r();}).fail(function(m){R(m);});};this._iTargetMappingsUnusedPromiseRejectCount=0;this._oInitialSegmentPromise=a&&a.config&&a.config.initialSegmentPromise||(new Promise(function(r,R){t._iTargetMappingsUnusedPromiseRejectCount++;if(t._iTargetMappingsUnusedPromiseRejectCount===2){t._fallbackToFullStartupRequest(r,R);}}));this._oNavTargetPromise=a&&a.config&&a.config.navTargetDataPromise||(new Promise(function(r,R){t._iTargetMappingsUnusedPromiseRejectCount++;if(t._iTargetMappingsUnusedPromiseRejectCount===2){t._fallbackToFullStartupRequest(r,R);}}));this._oInitialSegmentPromise.then(function(A){if(A===null){jQuery.sap.log.debug("Initial target mappings segment promise resolved with 'null'","Will not process initial target mappings segments again (mostly likely because this is no longer needed)","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");return;}if(t._aTargetMappings.length===0){jQuery.sap.log.debug("Segmented start_up response returned","storing system aliases and inbounds from segment","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");var r=A[0],T=A[1],b=A[2];t._aTargetMappings=T;t._writeUserSystemAliasesToBuffer(b);t._aInitialSegment=r;}else{jQuery.sap.log.debug("Segmented start_up response returned","ignoring response because the full target mapping response returned before","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");}}).catch(function(r){jQuery.sap.log.error("Initial segment promise was rejected.",r,"sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");});this._oNavTargetPromise.then(function(f){jQuery.sap.log.debug("Full start_up response returned","storing system aliases and inbounds","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");t._storeFromFullStartupResponse(f);});};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype.resolveHashFragmentFallback=function(o,i,p){var s=this._constructShellHashForLpdCust(i,p),a=p&&p["sap-system"]&&p["sap-system"][0],d=new jQuery.Deferred();this._resolveHashFragmentBE(s?s:o).done(function(r){if(r&&a){r["sap-system"]=r["sap-system"]||a;}d.resolve(r);}).fail(d.reject.bind(d));return d.promise();};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype.getInbounds=function(s){var d=new jQuery.Deferred(),t=this;this._oInitialSegmentPromise.then(function(i){if(i===null){return;}if(t._isInSegment(s,t._aInitialSegment)){jQuery.sap.log.debug("Got inbounds from initial segment","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");t._aInbounds=t._formatDirectStart(t._aTargetMappings);d.resolve(t._aInbounds);}else{jQuery.sap.log.debug("Did not get inbound in initial segment","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");}});this._oNavTargetPromise.then(function(){jQuery.sap.log.debug("Got inbounds from full start_up response","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");t._aInbounds=t._formatDirectStart(t._aTargetMappings);t.getInbounds=function(){return new jQuery.Deferred().resolve(t._aInbounds).promise();};d.resolve(t._aInbounds);},function(m){d.reject(m);});return d.promise();};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._isInSegment=function(s,a){if(!jQuery.isArray(a)||!jQuery.isArray(s)){return false;}return s.every(function(e){return!a.every(function(t){return!(e.semanticObject===t.semanticObject&&e.action===t.action);});});};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._requestAllTargetMappings=function(){var p=sap.ui2.srvc.getParameterMap();var d=new jQuery.Deferred();var r="/sap/bc/ui2/start_up?so=*&action=*&",c=(jQuery.sap.getObject("services.targetMappings",0,this._oAdapterConfig).cacheId&&("&sap-cache-id="+jQuery.sap.getObject("services.targetMappings",0,this._oAdapterConfig).cacheId))||"";function a(N){var v=p[N];if(v){r+=N+"="+encodeURIComponent(v[0])+"&";}}a("sap-language");a("sap-client");sap.ui2.srvc.get(r+"&shellType="+sap.ushell_abap.getShellType()+"&depth=0"+c,false,function(N){var o=JSON.parse(N);if(!o){d.reject("Malformed Full TM Result");}d.resolve(o);},function(m){d.reject(m);});return d.promise();};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._formatDirectStart=function(d){var t=this;if(!d){this._aInitialSegment=undefined;return[];}function m(s,o){var T={};var M=s.match(/^([^-]+)-([^~]+)/);if(!M){jQuery.sap.log.warning("The target mapping id "+s+" is not valid","this target mapping will be discarded","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");return undefined;}if(!o.hasOwnProperty("text")){o.text="";}T.semanticObject=M[1];T.action=M[2];T.id=s;T.title=o.text;var f={};["applicationType","applicationDependencies","applicationData","postParameters","text","url","systemAlias"].forEach(function(p){f[p]=o[p];});T.resolutionResult=sap.ushell_abap.bootstrap.adjustNavTargetResult(f);T.resolutionResult.additionalInformation=T.resolutionResult.additionalInformation||"";T.resolutionResult.applicationType=t._formatApplicationType(s,T.resolutionResult);T.resolutionResult.systemAlias=o.systemAlias||"";T.deviceTypes=o.formfactors;T.resolutionResult["sap.ui"]={};T.resolutionResult["sap.ui"].technology=T.resolutionResult.applicationType;if(T.resolutionResult["sap.ui"].technology==="SAPUI5"){T.resolutionResult["sap.ui"].technology="UI5";}if(T.resolutionResult["sap.ui"].technology==="TR"){T.resolutionResult["sap.ui"].technology="GUI";}if(!T.deviceTypes){T.deviceTypes=o.formFactors||{};}T.deviceTypes.desktop=T.deviceTypes.desktop||false;T.deviceTypes.phone=T.deviceTypes.phone||false;T.deviceTypes.tablet=T.deviceTypes.tablet||false;if(jQuery.isArray(o.signature)){T.signature={};T.signature.additionalParameters=o.allowParams?"allowed":"ignored";T.signature.parameters={};o.signature.forEach(function(b){var p={};var u;var N=b.name;if(b.defaultValue&&b.defaultValue.value){p.defaultValue={};p.defaultValue.value=b.defaultValue.value;p.defaultValue.format=b.defaultValue.format||"plain";u=t._extractUserDefaultValue(p.defaultValue.value);if(u){p.defaultValue={"value":u,"format":"reference"};}}if(b.filter&&b.filter.value){p.filter={};p.filter.value=b.filter.value;p.filter.format=b.filter.format||"plain";u=t._extractUserDefaultValue(p.filter.value);if(u){p.filter={"value":u,"format":"reference"};}}if(b.renameTo){p.renameTo=b.renameTo;}p.required=b.required||false;T.signature.parameters[N]=p;});}else{T.signature=jQuery.extend(true,{parameters:{}},o.signature);T.signature.additionalParameters=T.signature.additionalParameters||(o.allowParams?"allowed":"ignored");Object.keys(T.signature.parameters).forEach(function(k){var p=T.signature.parameters[k];if(p.filter){p.filter.format=p.filter.format||"plain";}if(p.defaultValue){p.defaultValue.format=p.defaultValue.format||"plain";}p.required=p.required||false;if(p.filter&&p.filter.hasOwnProperty("format")&&!(p.filter.hasOwnProperty("value"))){delete p.filter;}if(p.defaultValue&&p.defaultValue.hasOwnProperty("format")&&!(p.defaultValue.hasOwnProperty("value"))){delete p.defaultValue;}});}var a=T.signature&&T.signature.parameters&&T.signature.parameters["sap-hide-intent-link"];if(a&&a.hasOwnProperty("defaultValue")){T.hideIntentLink=a.defaultValue.value==="true"?true:false;}if(a&&!a.required&&a.hasOwnProperty("defaultValue")){delete T.signature.parameters["sap-hide-intent-link"];}if(typeof o.parameterMappings==="object"){Object.keys(o.parameterMappings).forEach(function(k){var b=o.parameterMappings[k];if(k&&b.target){T.signature.parameters[k]=T.signature.parameters[k]||{};T.signature.parameters[k].renameTo=b.target;}});}return T;}var R=[];Object.keys(d).forEach(function(k){var r=m(k,d[k]);if(r){R.push(r);}});return R;};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._formatApplicationType=function(t,r){var a=r.applicationType,u=r.url||"";function l(N,d){jQuery.sap.log.warning("Cannot detect application type for TargetMapping id '"+t+"', will default to "+d+" application type","TargetMapping URL is '"+u+"'",S);}if(a==="SAPUI5"){return"SAPUI5";}if(a==="URL"&&r.additionalInformation&&r.additionalInformation.indexOf("SAPUI5.Component=")===0){return"SAPUI5";}if(a==="WDA"||a==="TR"){return a;}if(a==="NWBC"){if(u.indexOf("/~canvas;window=app/wda")>=0){return"WDA";}if(u.indexOf("/~canvas;window=app/transaction")>=0){return"TR";}l(r,"TR");return"TR";}if(a!=="URL"){l(r,"URL");}return"URL";};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._extractUserDefaultValue=function(s){var r,a=new RegExp("^%%(UserDefault[.].+)%%$"),m=a.exec(s);return m?m[1]:r;};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._formatSignature=function(o,a){var t=this,r={"parameters":{},"additionalParameters":a===false?"ignored":"allowed"};if(!o.results){return r;}o.results.forEach(function(e){var p,E=e.name,s,u;if(Object.prototype.hasOwnProperty.call(r.parameters,E)){jQuery.sap.log.error("Duplicate property name "+E+" in "+JSON.stringify(o),"sap.ui2.srvc.ClientSideTargetResolutionAdapter._formatSignature");}r.parameters[E]={"required":t._getObjectDefaulting(e,"required",false)};p=r.parameters[E];s=t._getObjectDefaulting(e,"value","");if(e.regexp===true){p.filter={"value":(s===""?".*":s),"format":"regexp"};return;}if(e.required===false){u=t._extractUserDefaultValue(s);if(u){p.defaultValue={"value":u,"format":"reference"};return;}if(s!==""){p.defaultValue={"value":s};}return;}if(e.required===true&&e.value){u=t._extractUserDefaultValue(s);if(u){p.filter={"value":u,"format":"reference"};return;}if(s!==""){p.filter={"value":s};}}});return r;};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._mergeParameterMappingsIntoSignature=function(s,o){var p=o.results;if(!p){return;}p.forEach(function(P){var a=P.source;var t=P.target;if(t){s.parameters[a]=s.parameters[a]||{};if(s.parameters[a].renameTo){jQuery.sap.log.warning("duplicate parameter mapping for'"+a+"'","OData Parameter mappings is "+JSON.stringify(P,null,"   "),S);}s.parameters[a].renameTo=t;}});};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._formatDeviceTypes=function(f){var r={},t=this;["desktop","tablet","phone"].forEach(function(p){r[p]=t._getObjectDefaulting(f,p,false);});return r;};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._getObjectDefaulting=function(r,s,d){var o=jQuery.sap.getObject(s,undefined,r);return(o===undefined)?d:o;};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._constructShellHashForLpdCust=function(i,p){var l="",f;var t=jQuery.sap.getObject("resolutionResult._original",2,i);if(!jQuery.isPlainObject(t)){f="the given target mapping is not an object";}if(!f&&!t.hasOwnProperty("id")){f="no id found in target mapping _original object";}if(!f&&typeof t.id!=="string"){f="the target mapping id was not a string";}if(!f&&t.id.length===0){f="the target mapping id was an empty string";}if(f){jQuery.sap.log.error("Cannot construct Shell Hash for LPD_CUST resolution",f,"sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");return undefined;}l+=t.id;var b=sap.ushell.Container.getService("URLParsing").paramsToString(p);if(b.length>0){l+="?"+b;}return l;};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._openBatchQueueUnlessOpen=function(o){if(o.isBatchQueueOpen()){return false;}else{o.openBatchQueue();return true;}};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._getShellType=function(){if(sap&&sap.ushell_abap&&typeof sap.ushell_abap.getShellType==="function"){return sap.ushell_abap.getShellType();}return"FLP";};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._resolveHashFragmentBE=function(f){var d=new jQuery.Deferred(),t=this,b,F=sap.ui2.srvc.getFormFactor();function e(u){return encodeURIComponent(u).replace(/'/g,"''");}b=this._openBatchQueueUnlessOpen(this._getODataWrapper());this._oODataWrapper.read("ResolveLink?linkId='"+e(f)+"'&shellType='"+t._getShellType()+"'"+(F?"&formFactor='"+e(F)+"'":""),function(r){var i,D="",a;if(r.results.length){if(r.results.length>1){for(i=0;i<r.results.length;i+=1){delete r.results[i].__metadata;D+=(i===0?"used target: ":"\nignored target: ")+JSON.stringify(r.results[i]);}jQuery.sap.log.error("INTEROP service's ResolveLink operation "+"returned "+r.results.length+" targets for hash '#"+f+"', first one is used.",D,"sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");}r=r.results[0];a=sap.ushell_abap.bootstrap.adjustNavTargetResult(r);a.url=sap.ushell_abap.bootstrap.addPostParametersToNavTargetResultUrl(r.postParameters,a.url);if(a&&a.applicationType==="SAPUI5"){a.applicationType="URL";}t._compactTooLongWdaUrl(a).done(function(c){d.resolve(c);}).fail(function(m){d.reject("Could not resolve link '"+f+"' due to compactation failure"+m);});}else{d.reject("Could not resolve link '"+f+"'");}},function(m){d.reject(m);});if(b){t._getODataWrapper().submitBatchQueue(function(){},d.reject.bind(d));}return d.promise();};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._compactTooLongWdaUrl=function(r){var d=new jQuery.Deferred();if(r&&r.applicationType==="NWBC"&&r.url&&r.url.indexOf("/ui2/nwbc/~canvas;window=")===0&&r.url.length>this._getWDAUrlShorteningLengthLimit()){this._compactUrl(r.url).done(function(c){r.url=c;d.resolve(r);}).fail(d.reject.bind(d));return d.promise();}else{return d.resolve(r).promise();}};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._compactUrl=function(u){var m=u.match(/\?.*/);var U=sap.ushell.Container.getService("URLParsing");if(!(m&&m[0]&&m[0].length>this._getWDAUrlShorteningLengthLimit()-200)){return new jQuery.Deferred().resolve(u).promise();}var p=U.parseParameters(m[0]);var d=new jQuery.Deferred();sap.ushell.Container.getService("ShellNavigation").compactParams(p,n,undefined).done(function(c){var r=u.match(/^[^?]*/)[0]+"?"+U.paramsToString(c);d.resolve(r);}).fail(d.reject.bind(d));return d.promise();};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._getWDAUrlShorteningLengthLimit=function(){var N=sap.ushell.utils.getParameterValueBoolean("sap-ushell-nowdaurlshortening");if(N){return 6000000;}return this._wdLengthLimit;};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype.resolveSystemAlias=function(s){var m,d=new jQuery.Deferred(),t=this;var o;o=this._readSystemAliasFromBuffer(s);if(o){jQuery.sap.log.debug("System alias '"+s+"' was already buffered","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");setTimeout(function(){d.resolve(o);},0);}else{jQuery.sap.log.debug("System alias '"+s+"' is not in buffer","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");var r=function(){o=t._readSystemAliasFromBuffer(s);if(o){jQuery.sap.log.debug("System alias '"+s+"' is now in buffer","Skipping INTEROP service call","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");d.resolve(o);}else{jQuery.sap.log.debug("System alias '"+s+"' still not in buffer","Resolving via INTEROP service","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");t._readSystemAliasViaInterop(s).fail(function(e){d.reject(e);}).done(function(O){o=t._fixSystemAlias(O);if(o&&o.id){t._writeSystemAliasToBuffer(o);d.resolve(o);}else{m="Data returned for system alias is not valid";jQuery.sap.log.warning("ClientSideTargetResolutionAdapter: "+m);d.reject(m);}});}};this._oInitialSegmentPromise.then(r,r);}return d.promise();};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._writeUserSystemAliasesToBuffer=function(s){var t=this;if(typeof s==="undefined"){return;}s.forEach(function(o){t._writeSystemAliasToBuffer(t._fixSystemAlias(o));});};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._readSystemAliasFromBuffer=function(s){var r=this._oSystemAliasBuffer.get(s);if(!r&&s===""){return this._oLocalSystemAlias;}return r;};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._writeSystemAliasToBuffer=function(s){if(s&&s.id){this._oSystemAliasBuffer.put(s.id,s);}return s;};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._fixSystemAlias=function(s){s=s||{};delete s.__metadata;var f={};f.id=s.id||"";f.client=s.client||"";f.language=s.language||"";["http","https"].forEach(function(d){if(s.hasOwnProperty(d)){delete s[d].__metadata;if(s[d].id!==""){f[d]=jQuery.extend({id:"",host:"",port:"",pathPrefix:""},s[d]);}}});if(s.hasOwnProperty("rfc")&&s.rfc.id){delete s.rfc.__metadata;f.rfc=jQuery.extend({id:"",systemId:"",host:"",service:0,loginGroup:"",sncNameR3:"",sncQoPR3:""},s.rfc);}return f;};sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter.prototype._readSystemAliasViaInterop=function(s){var d=new jQuery.Deferred(),r;r="SystemAliases(id='"+encodeURIComponent(s)+"')?$format=json";this._getODataWrapper().read(r,function(o){d.resolve(o);},function(m){d.reject(m);});return d.promise();};}());

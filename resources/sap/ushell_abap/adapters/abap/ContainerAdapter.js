// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell_abap.adapters.abap.ContainerAdapter");jQuery.sap.require("sap.ushell.System");jQuery.sap.require("sap.ushell.User");sap.ushell_abap.adapters.abap.ContainerAdapter=function(s,p,P){var u,t=this,S="/sap/public/bc/icf/logoff";sap.ui2.srvc.testPublishAt(t);function l(D,U){var f=document.createElement("iframe"),a=U.replace(/"/g,'\\"');window.addEventListener("message",function(e){if(e.data===U){D.resolve();}});f.style.visibility="hidden";document.body.appendChild(f);f.contentWindow.document.write('<html><body>\n'+'<script>function l(){parent.postMessage("'+a+'", "*");}\nvar e=document.createElement("img");e.src ="'+a+'";e.addEventListener("load",l);e.addEventListener("error",l);'+'document.body.appendChild(e);<\/script><\/body><\/html>');}this.getSystem=function(){return s;};this.getUser=function(){return u;};sap.ui2.srvc.testPublishAt(t);function d(o){var a=sap.ushell.utils.getParameterValueBoolean("sap-accessibility");if(a!==undefined){return a;}a=o.accessibility;if(a!==undefined){return a;}return false;}this._setThemeAccessibilityFlags=function(o){if(o.userProfile&&o.userProfile.length){var U,a;U=o.userProfile.filter(function(b){return b.id&&b.id==='THEME';})[0];if(U&&U.value){o.setThemePermitted=(U.editState===3);}else{o.oUserProfileDataTheme=false;}a=o.userProfile.filter(function(b){return b.id&&b.id==='ACCESSIBILITY';})[0];if(a&&a.id){o.setAccessibilityPermitted=(a.editState===3);}else{o.setAccessibilityPermitted=false;}if(a&&a.value==="true"){o.accessibility=true;}if(a&&a.value==="false"){o.accessibility=false;}o.accessiblity=d(o);}};this._setUserProfileFlags=function(o){if(o.userProfile&&o.userProfile.length&&jQuery.isArray(o.userProfile)){var U={};o.setContentDensityPermitted=false;o.userProfile.forEach(function(a){if((a.id in U)){return;}U[a.id]=a.id;if(a.id==="CONTENT_DENSITY"){o.contentDensity=a.value;o.setContentDensityPermitted=(a&&a.editState===3)||false;}if(a.id==="TRACKING_USAGE_ANALYTICS"){if(typeof a.value==="string"){if(a.value.toLowerCase()==="true"||a.value.toLowerCase()==="false"){a.value=(a.value.toLowerCase()==="true")||false;}else{a.value=undefined;}}if(typeof a.value==="undefined"||typeof a.value==="boolean"){o.trackUsageAnalytics=a.value;}else{o.trackUsageAnalytics=undefined;}}});}};this.load=function(){var D=new jQuery.Deferred(),o=P.config;o.alias=s.getAlias();o.platform=s.getPlatform();s=new sap.ushell.System(o);this._setThemeAccessibilityFlags(o);this._setUserProfileFlags(o);u=new sap.ushell.User(o);jQuery.sap.require("sap.ui2.srvc.ODataWrapper");sap.ui2.srvc.ODataWrapper["sap-language"]=o.language;sap.ui2.srvc.ODataWrapper["sap-client"]=o.client;if(o.target){sap.ushell_abap.adapters.abap.ContainerAdapter.startUpApplication={adjustedInitialTarget:o.adjustedInitialTarget,target:o.target};}this._setUserImage(u);return D.resolve().promise();};this.addFurtherRemoteSystems=function(){var D=new jQuery.Deferred(),o;o=sap.ushell.Container.getService("PageBuilding").getFactory().getPageBuildingService();o.readAllCatalogsForUser("type eq 'H' or type eq 'REMOTE'",function(a){var c=a.results,b="/sap/opu/odata/sap/SM_CATALOG_SRV/";if(c){c.forEach(function(C){var i=/^\/sap\/hba\//.test(C.baseUrl);if(C.type==='H'||C.baseUrl===b||i){sap.ushell.Container.addRemoteSystem(new sap.ushell.System({alias:C.systemAlias,platform:(i||C.type==='H')?"hana":"abap",baseUrl:C.type==='H'?"":";o="}));}});}D.resolve();},function(e){jQuery.sap.log.error("Reading REMOTE catalogs failed: "+e,null,"sap.ushell_abap.adapters.abap.ContainerAdapter");D.reject();});return D.promise();};this.getCurrentUrl=function(){return window.location.href;};this.logout=function(L){var D=new jQuery.Deferred(),U;if(L){if(sap.ushell.utils.hasNativeLogoutCapability()){var f=(new URI(S)).absoluteTo(this.getCurrentUrl()).search("").toString();window.external.getPrivateEpcm().doLogOff(f);}else{this.logoutRedirect();}jQuery.sap.log.info("ABAP system logged out: "+s.getAlias(),null,"sap.ushell_abap.adapters.abap.ContainerAdapter");D.resolve();}else{U=s.adjustUrl(S);jQuery.sap.log.info("Logging out from system '"+s.getAlias()+"' via hidden iframe");l(D,U);}return D.promise();};this.logoutRedirect=function(){var U=s.adjustUrl(S);this._setDocumentLocation(U);};this._setDocumentLocation=function(L){document.location=L;};this._setUserImage=function(u){function i(){var c=window["sap-ushell-config"],U=jQuery.sap.getObject("renderers.fiori2.componentData.config.enableUserImage",undefined,c);return!!U;}if(i()&&u&&u.isJamActive&&u.isJamActive()){OData.read('/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData/Self?$format=json',function(r){var j=r.results.Id,J="/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData/Members('"+j+"')/ProfilePhoto/$value";u.setImage(J);},function(m){jQuery.sap.log.error("Could not recieve JAM user data");});}};};}());

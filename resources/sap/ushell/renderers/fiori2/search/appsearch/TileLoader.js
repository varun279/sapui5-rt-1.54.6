sap.ui.define(['sap/ushell/renderers/fiori2/search/SearchHelper'],function(S){"use strict";var T=function(){this.init.apply(this,arguments);};T.prototype={init:function(p){this.launchPageService=sap.ushell.Container.getService("LaunchPage");this.optimizedAppSearch=p.optimizedAppSearch;},getTiles:function(){if(this.loadDeferred){return this.loadDeferred;}this.loadDeferred=this.launchPageService.getCatalogs().then(function(c){var a=[];for(var i=0;i<c.length;i++){a.push(this.launchPageService.getCatalogTiles(c[i]));}a.push(this._getPersonalizedGroupTiles());return jQuery.when.apply(jQuery,a).then(function(){var b=Array.prototype.slice.call(arguments);var c=b.slice(0,-1);var p=b.slice(-1);try{var d=this._collectTiles(c);this._sortTiles(d);var f=this._createTileMap(d);var g=this._collectTiles(p);this._sortTiles(g);this._caculateCorrespondingCatalogTiles(g,d);}catch(e){return jQuery.Deferred().reject(e);}var h=[];h.push.apply(h,d);h.push.apply(h,g);h=this._removeDuplicateTiles(h);this._sortTiles(h);return{catalogTiles:d,catalogTileMap:f,personalizedTiles:g,allTiles:h};}.bind(this));}.bind(this));return this.loadDeferred;},search:function(q){return this.getTiles().then(function(t){var a;if(q.suggestion===true){a=new S.Tester(q.searchTerm);}else{a=new S.Tester(q.searchTerm,'',true);}var s=t[q.scope];var r=[];var b;var m=0;for(var j=0;j<s.length;j++){b=s[j];var c=this._testMatch(a,q.searchInKeywords,b);if(c.match){m+=1;if(m<=q.skip){continue;}if(m>(q.skip+q.top)){continue;}r.push(this._formatTile(b,c.highlightedLabel));}}return{totalCount:m,tiles:r};}.bind(this));},_testMatch:function(t,s,a){var b=t.test(a.label);if(b.bMatch){return{match:true,highlightedLabel:b.sHighlightedText};}if(s&&a.keywords&&Array.isArray(a.keywords)){b=t.test(a.keywords.join(' '));if(b.bMatch){return{match:true};}}return{match:false};},_formatTile:function(t,h){var r=jQuery.extend({},t);if(h){r.label=h;}return r;},_createTileMap:function(t){var m={};for(var i=0;i<t.length;++i){var a=t[i];if(!a.tile.getChip){continue;}var c=a.tile.getChip();if(!c){continue;}var b=c.getId();m[b]=a;}return m;},_isTileViewNeeded:function(t){if(this.optimizedAppSearch){return false;}return!this.launchPageService.getCatalogTilePreviewTitle(t);},_collectTiles:function(c){var t=[];var a,b,d,k,f,s,g,h;var l=new RegExp('DisplayFactSheet','i');for(var i=0;i<c.length;i++){var m=c[i];for(var j=0;j<m.length;j++){try{a=m[j];b=null;if(this._isTileViewNeeded(a)){b=this.launchPageService.getCatalogTileView(a);}k=this.launchPageService.getCatalogTileKeywords(a);f=this.launchPageService.getCatalogTileTargetURL(a);d=this.launchPageService.getCatalogTilePreviewTitle(a)||this.oLpdService.getCatalogTileTitle(a);s=this.launchPageService.getCatalogTilePreviewSubtitle(a);g=this.launchPageService.getCatalogTileSize(a);h=this.launchPageService.getCatalogTilePreviewIcon(a)||"sap-icon://business-objects-experience";if(b){if(!b.destroy){var n=new Error('The tileview "'+d+'" with target url "'+f+'" does not implement mandatory function destroy!');n.name='Missing Impementation';throw n;}b.destroy();}if(a.getContract){var p=a.getContract("preview");if(p){p.setEnabled(false);}}if(!this._isValid(a)){continue;}if(!f){continue;}if(l.test(f)){continue;}var o=d;if(s){o+=' - '+s;}t.push({tile:a,keywords:k,url:f,label:o,title:d||'',subtitle:s||'',tooltip:d||'',icon:h,size:g});}catch(e){jQuery.sap.log.error(e);if(e.toString().indexOf('does not implement mandatory function destroy')>=0){throw e;}}}}return t;},_isValid:function(t){if(this.launchPageService.isTileIntentSupported){return this.launchPageService.isTileIntentSupported(t);}else{return true;}},_getPersonalizedGroupTiles:function(){return this.launchPageService.getGroups().then(function(g){var r=[];for(var j=0;j<g.length;j++){var t=this.launchPageService.getGroupTiles(g[j])||[];r.push.apply(r,t);}return r;}.bind(this));},calcKey:function(t){return t.title+t.url+t.icon;},_removeDuplicateTiles:function(t){var a={};var r=[];for(var i=0;i<t.length;++i){var b=t[i];var k=this.calcKey(b);if(a[k]){continue;}a[k]=b;r.push(b);}return r;},_caculateCorrespondingCatalogTiles:function(p,c){var m={};var k;for(var i=0;i<c.length;++i){var t=c[i];k=this.calcKey(t);m[k]=t;}for(var j=0;j<p.length;++j){var a=p[j];k=this.calcKey(a);a.catalogTile=m[k];}},_sortTiles:function(t){t.sort(function(a,b){if(a.title.toUpperCase()<b.title.toUpperCase()){return-1;}if(a.title.toUpperCase()>b.title.toUpperCase()){return 1;}return 0;});}};return T;});

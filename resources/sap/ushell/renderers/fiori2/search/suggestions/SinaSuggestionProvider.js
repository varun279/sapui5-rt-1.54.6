sap.ui.define(['sap/ushell/renderers/fiori2/search/SearchHelper','sap/ushell/renderers/fiori2/search/suggestions/SinaBaseSuggestionProvider','sap/ushell/renderers/fiori2/search/suggestions/SuggestionType'],function(S,a,b){"use strict";jQuery.sap.declare('sap.ushell.renderers.fiori2.search.suggestions.SinaSuggestionProvider');var m=sap.ushell.renderers.fiori2.search.suggestions.SinaSuggestionProvider=function(){this.init.apply(this,arguments);};m.prototype=jQuery.extend(new a(),{suggestionLimit:jQuery.device.is.phone?5:7,init:function(p){a.prototype.init.apply(this,arguments);this.dataSourceDeferred=null;this.suggestionQuery=this.sinaNext.createSuggestionQuery();},abortSuggestions:function(){this.suggestionQuery.abort();},getSuggestions:function(f){var t=this;this.suggestions=[];this.firstObjectDataSuggestion=true;this.numberSuggestionsByType={};for(var i=0;i<b.types.length;++i){var s=b.types[i];this.numberSuggestionsByType[s]=0;}var c=f.searchTerm;if(this.suggestionTypes.length===1&&this.suggestionTypes.indexOf(b.SearchTermData)>=0&&c.length<3){return jQuery.when(this.suggestions);}if(this.suggestionTypes.length===1&&this.suggestionTypes.indexOf(b.DataSource)>=0&&t.model.getDataSource()!==t.model.sinaNext.allDataSource){return jQuery.when(this.suggestions);}t.createAllAndAppDsSuggestions();if(!t.model.config.searchBusinessObjects){return jQuery.when(this.suggestions);}if(t.model.getDataSource()===t.model.appDataSource){return jQuery.when(this.suggestions);}t.prepareSuggestionQuery(f);return t.suggestionQuery.getResultSetAsync().then(function(r){var d=r.items;t.formatSinaSuggestions(d);return t.suggestions;});},createAllAndAppDsSuggestions:function(){if(this.suggestionTypes.indexOf(b.DataSource)<0){return;}if(this.model.getDataSource()!==this.model.allDataSource){return;}var d=[];d.unshift(this.model.appDataSource);d.unshift(this.model.allDataSource);var s=this.model.getProperty('/uiFilter/searchTerm');var c=s.replace(/\*/g,'');var t=new S.Tester(c);for(var i=0;i<d.length;++i){var e=d[i];if(e.id===this.model.getDataSource().id){continue;}var T=t.test(e.label);if(T.bMatch===true){var n=this.numberSuggestionsByType[b.DataSource];var l=b.properties.DataSource.limit;if(n>=l){return;}var f={};f.label='<i>'+sap.ushell.resources.i18n.getText("searchInPlaceholder",[""])+'</i> '+T.sHighlightedText;f.dataSource=e;f.position=b.properties.DataSource.position;f.type=this.sinaNext.SuggestionType.DataSource;f.calculationMode=this.sinaNext.SuggestionCalculationMode.Data;f.key=e.id;this.addSuggestion(f);}}},preFormatSuggestions:function(s){for(var i=0;i<s.length;++i){var c=s[i];c.uiSuggestionType=this.getSuggestionType(c);c.position=b.properties[c.uiSuggestionType].position;switch(c.uiSuggestionType){case b.SearchTermData:c.key=c.filter.searchTerm;break;case b.SearchTermHistory:c.key=c.filter.searchTerm;break;case b.DataSource:c.key=c.dataSource.id;break;}if(c.childSuggestions){this.preFormatSuggestions(c.childSuggestions);}}},formatSinaSuggestions:function(s){this.preFormatSuggestions(s);for(var i=0;i<s.length;++i){var c=s[i];if(this.suggestionTermBuffer.hasTerm(c.key)){continue;}var n=this.numberSuggestionsByType[c.uiSuggestionType];var l=b.properties[c.uiSuggestionType].limit;if(n>=l){continue;}switch(c.uiSuggestionType){case b.DataSource:if(this.model.getDataSource()!==this.model.allDataSource){continue;}c.label='<i>'+sap.ushell.resources.i18n.getText("searchInPlaceholder",[""])+'</i> '+c.label;this.addSuggestion(c);break;case b.SearchTermData:this.formatSearchTermDataSuggestion(c);break;case b.SearchTermHistory:this.addSuggestion(c);break;default:break;}}return this.suggestions;},addSuggestion:function(s){this.suggestions.push(s);this.suggestionTermBuffer.addTerm(s.key);this.numberSuggestionsByType[s.uiSuggestionType]+=1;},formatSearchTermDataSuggestion:function(s){if(this.model.getDataSource()===this.model.allDataSource){if(this.firstObjectDataSuggestion){this.firstObjectDataSuggestion=false;if(s.childSuggestions.length>0){s.label=this.assembleSearchInSuggestionLabel(s);this.addSuggestion(s);this.addChildSuggestions(s);}else{this.addSuggestion(s);}}else{this.addSuggestion(s);}}else{this.addSuggestion(s);}},addChildSuggestions:function(s){for(var i=0;i<Math.min(2,s.childSuggestions.length);++i){var l=b.properties.SearchTermData.limit;var n=this.numberSuggestionsByType[b.SearchTermData];if(n>=l){return;}var c=s.childSuggestions[i];c.label=this.assembleSearchInSuggestionLabel(c);this.addSuggestion(c);}},assembleSearchInSuggestionLabel:function(s){return sap.ushell.resources.i18n.getText("resultsIn",['<span>'+s.label+'</span>',s.filter.dataSource.labelPlural]);},getSuggestionType:function(s){switch(s.type){case this.sinaNext.SuggestionType.SearchTerm:if(s.calculationMode===this.sinaNext.SuggestionCalculationMode.History){return b.SearchTermHistory;}return b.SearchTermData;case this.sinaNext.SuggestionType.SearchTermAndDataSource:if(s.calculationMode===this.sinaNext.SuggestionCalculationMode.History){return b.SearchTermHistory;}return b.SearchTermData;case this.sinaNext.SuggestionType.DataSource:return b.DataSource;}}});return m;});

sap.ui.define(['sap/ushell/renderers/fiori2/search/SearchHelper','sap/ushell/renderers/fiori2/search/suggestions/SinaSuggestionProvider','sap/ushell/renderers/fiori2/search/suggestions/AppSuggestionProvider','sap/ushell/renderers/fiori2/search/suggestions/TimeMerger','sap/ushell/renderers/fiori2/search/suggestions/SuggestionType'],function(S,a,A,T,b){"use strict";jQuery.sap.declare('sap.ushell.renderers.fiori2.search.suggestions.SuggestionHandler');var s=sap.ushell.renderers.fiori2.search.suggestions;var c=function(){this.init.apply(this,arguments);};c.prototype={init:function(){this.terms={};},addTerm:function(t){t=t.trim().toLowerCase();this.terms[t]=true;},hasTerm:function(t){t=t.trim().toLowerCase();return!!this.terms[t];},clear:function(){this.terms={};}};s.SuggestionHandler=function(){this.init.apply(this,arguments);};s.SuggestionHandler.prototype={init:function(p){var t=this;t.model=p.model;t.suggestionProviders=[];t.suggestionTermBuffer=new c();t.keyboardRelaxationTime=400;t.uiUpdateInterval=500;t.uiClearOldSuggestionsTimeOut=1000;t.appSuggestionProvider=new A({model:t.model,suggestionTermBuffer:t.suggestionTermBuffer});t.doSuggestionInternal=S.delayedExecution(t.doSuggestionInternal,t.keyboardRelaxationTime);t.timeMerger=new T();},abortSuggestions:function(d){if(d===undefined||d===true){this.model.setProperty("/suggestions",[]);}if(this.clearSuggestionTimer){clearTimeout(this.clearSuggestionTimer);this.clearSuggestionTimer=null;}this.doSuggestionInternal.abort();this.getSuggestionProviders().done(function(e){for(var i=0;i<e.length;++i){var f=e[i];f.abortSuggestions();}});this.timeMerger.abort();},getSuggestionProviders:function(){var t=this;if(t.suggestionProvidersDeferred){return t.suggestionProvidersDeferred;}t.suggestionProvidersDeferred=t.model.initBusinessObjSearch().then(function(){t.sinaNext=t.model.sinaNext;var d=[t.appSuggestionProvider];if(!t.model.config.searchBusinessObjects){return jQuery.when(d);}d.push.apply(d,t.createSinaSuggestionProviders());return jQuery.when(d);});return t.suggestionProvidersDeferred;},createSinaSuggestionProviders:function(){var p=[{suggestionTypes:[b.SearchTermHistory]},{suggestionTypes:[b.SearchTermData]},{suggestionTypes:[b.DataSource]}];var d=[];for(var k=0;k<p.length;++k){var e=p[k];d.push(new a({model:this.model,sinaNext:this.sinaNext,suggestionTermBuffer:this.suggestionTermBuffer,suggestionTypes:e.suggestionTypes}));}return d;},isSuggestionPopupVisible:function(){return jQuery('.searchSuggestion').filter(':visible').length>0;},doSuggestion:function(f){var t=this;if(this.isSuggestionPopupVisible()){this.abortSuggestions(false);this.clearSuggestionTimer=setTimeout(function(){t.clearSuggestionTimer=null;t.model.setProperty("/suggestions",[]);},t.uiClearOldSuggestionsTimeOut);}else{this.abortSuggestions();}this.doSuggestionInternal(f);},doSuggestionInternal:function(f){var t=this;var d=t.model.getProperty("/uiFilter/searchTerm");if(d.length===0){return;}if(d.trim()==='*'){return;}t.model.eventLogger.logEvent({type:t.model.eventLogger.SUGGESTION_REQUEST,suggestionTerm:t.model.getProperty('/uiFilter/searchTerm'),dataSourceKey:t.model.getProperty('/uiFilter/dataSource').id});t.suggestionTermBuffer.clear();t.getSuggestionProviders().done(function(e){var p=[];var g=true;var h=e.length;for(var i=0;i<e.length;++i){var k=e[i];p.push(k.getSuggestions(f));}t.timeMerger.abort();t.timeMerger=new T(p,t.uiUpdateInterval);t.timeMerger.process(function(r){h-=r.length;var s=[];for(var j=0;j<r.length;++j){var l=r[j];s.push.apply(s,l);}if(h>0&&s.length===0){return;}if(t.clearSuggestionTimer){clearTimeout(t.clearSuggestionTimer);t.clearSuggestionTimer=null;}t.insertSuggestions(s,g);g=false;});});},insertSuggestions:function(i,f){var s=this.model.getProperty('/suggestions');if(f){s=[];}var g=this._groupByPosition(i);for(var p in g){var d=g[p];this._insertSuggestions(s,d);}this.model.setProperty('/suggestions',s);},_groupByPosition:function(s){var g={};for(var i=0;i<s.length;++i){var d=s[i];var e=g[d.position];if(!e){e=[];g[d.position]=e;}e.push(d);}return g;},_insertSuggestions:function(s,i){if(i.length<=0){return;}var d=i[0];var e=0;for(;e<s.length;++e){var f=s[e];if(f.position>d.position){break;}}var g=[e,0];g.push.apply(g,i);s.splice.apply(s,g);}};return s.SuggestionHandler;});

sinaDefine(['../../core/core','../../core/util','../../core/lang','./ajax','./ajaxTemplates','./conditionSerializer','./dataSourceSerializer','./FacetParser','./ItemParser','./NlqParser','./suggestionParser','./suggestionTermSplitter','./LabelCalculator','./UserEventLogger','./MetadataParser'],function(c,u,l,a,b,d,e,F,I,N,S,s,L,U,M){return c.defineClass({id:'abap_odata',_initAsync:function(f){this.requestPrefix=u.getBaseUrl(f.url)+'/sap/opu/odata/sap/ESH_SEARCH_SRV';this.sina=f.sina;this.ajaxClient=a.createAjaxClient();this.metadataLoadPromises={};this.internalMetadata={};this.labelCalculator=new L();this.userEventLogger=new U(this);this.metadataParser=new M(this);this.itemParser=new I(this);this.nlqParser=new N(this);this.facetParser=new F(this);this.suggestionParser=new S(this);this.sessionId=c.generateGuid();return this.loadServerInfo().then(function(g){this.serverInfo=g.d.results[0];if(!this.supports('Search')){return Promise.reject(new c.Exception('Enterprise Search is not active'));}return this.loadBusinessObjectDataSources();}.bind(this)).then(function(){return{capabilities:this.sina._createCapabilities({fuzzy:false})};}.bind(this));},supports:function(f,g){for(var i=0;i<this.serverInfo.Services.results.length;++i){var h=this.serverInfo.Services.results[i];if(h.Id==f){if(!g){return true;}for(var j=0;j<h.Capabilities.length;++j){var k=h.Capabilities[j];if(k.Capability===g){return true;}}}}return false;},loadServerInfo:function(){var r=this.buildQueryUrl(this.requestPrefix,"/ServerInfos?$expand=Services/Capabilities");return this.ajaxClient.getJson(r).then(function(f){return f.data;}.bind(this));},loadBusinessObjectDataSources:function(){var r=this.buildQueryUrl(this.requestPrefix,"/DataSources?$expand=Attributes/UIAreas&$filter=Type eq 'View' and IsInternal eq false");return this.ajaxClient.getJson(r).then(function(f){var g=f.data.d.results;for(var i=0;i<g.length;++i){var h=g[i];var j=this.sina._createDataSource({id:h.Id,label:h.Name,labelPlural:h.NamePlural,type:this.sina.DataSourceType.BusinessObject,attributesMetadata:[{id:'dummy'}]});j.system=h.SourceSystem;j.client=h.SourceClient;j.sematicObjectType=h.SemanticObjectTypeId;this.labelCalculator.calculateLabel(j);this.metadataParser.fillMetadataBuffer(j,h.Attributes.results);}}.bind(this));},assembleOrderBy:function(q){var r=[];for(var i=0;i<q.sortOrder.length;++i){var f=q.sortOrder[i];var g=(f.order===this.sina.SortOrder.Descending)?'desc':'asc';r.push({AttributeId:f.id,SortOrder:g});}return r;},executeSearchQuery:function(q){var r=b.searchRequest;if(q.nlq){r=b.nlqSearchRequest;}r=JSON.parse(JSON.stringify(r));var f=q.filter.rootCondition.clone();var g=d.serialize(q.filter.dataSource,f);if(g.SubFilters.length!==0){r.d.Filter=g;}else{delete r.d.Filter;}r.d.DataSources=[e.serialize(q.filter.dataSource)];r.d.QueryOptions.SearchTerms=q.filter.searchTerm;r.d.QueryOptions.Top=q.top;r.d.QueryOptions.Skip=q.skip;r.d.OrderBy=this.assembleOrderBy(q);this.addSessionId(r);if(!q.calculateFacets){delete r.d.MaxFacetValues;delete r.d.Facets;}else{r.d.MaxFacetValues=5;r.d.Facets=[{"Values":[]}];}var h=this.buildQueryUrl(this.requestPrefix,"/SearchQueries");return this.ajaxClient.postJson(h,r).then(function(i){return this.itemParser.parse(q,i.data.d).then(function(j){var k=this.facetParser.parse(q,i.data.d);var n=this.nlqParser.parse(i.data.d);var t=n.success?n.description:'Search Result List';return this.sina._createSearchResultSet({title:t,query:q,items:j,nlqSuccess:n.success,totalCount:i.data.d.ResultList.TotalHits,facets:k});}.bind(this));}.bind(this));},executeChartQuery:function(q){var r="";var f={};var g=q.filter.rootCondition.clone();this._decideValueHelp(q);if(q.valueHelp){f=JSON.parse(JSON.stringify(b.valueHelperRequest));f.d.ValueHelpAttribute=q.dimension;var h=d.serialize(q.filter.dataSource,g);if(h.SubFilters.length!==0){f.d.Filter=h;}else{delete f.d.Filter;}f.d.ValueFilter=this.getFilterValueFromConditionTree(q.dimension,h);f.d.QueryOptions.SearchTerms=q.filter.searchTerm;f.d.DataSources=[e.serialize(q.filter.dataSource)];r=this.buildQueryUrl(this.requestPrefix,"/ValueHelpQueries");}else{f=JSON.parse(JSON.stringify(b.chartRequest));var h=d.serialize(q.filter.dataSource,g);if(h.SubFilters.length!==0){f.d.Filter=h;}else{delete f.d.Filter;}f.d.DataSources=[e.serialize(q.filter.dataSource)];f.d.QueryOptions.SearchTerms=q.filter.searchTerm;f.d.QueryOptions.Skip=0;this.addSessionId(f);f.d.FacetRequests=[{DataSourceAttribute:q.dimension}];f.d.MaxFacetValues=q.top;r=this.buildQueryUrl(this.requestPrefix,"/SearchQueries");}return this.ajaxClient.postJson(r,f).then(function(i){var j=this.facetParser.parse(q,i.data.d);return j[0];}.bind(this));},_decideValueHelp:function(q){var f=q.filter.rootCondition.conditions;for(var i=0;i<f.length;i++){if(q.filter._getAttribute(f[i])===q.dimension){q.valueHelp=true;return;}}q.valueHelp=false;},executeSuggestionQuery:function(q){var r=JSON.parse(JSON.stringify(b.suggestionRequest));var f=q.filter.searchTerm;var g=s.split(this,f);var h=q.filter.rootCondition.clone();var i=d.serialize(q.filter.dataSource,h);if(i.SubFilters.length!==0){r.d.Filter=i;}else{delete r.d.Filter;}r.d.SuggestionInput=g.suggestionTerm;r.d.DataSources=[e.serialize(q.filter.dataSource)];r.d.QueryOptions.Top=q.top;r.d.QueryOptions.Skip=q.skip;r.d.SuggestionInput=g.suggestionTerm;r.d.QueryOptions.SearchTerms=g.searchTerm===null?"":g.searchTerm;this.includeSuggestionTypes(q,r);this.addSessionId(r);var j=this.buildQueryUrl(this.requestPrefix,"/SuggestionsQueries");return this.ajaxClient.postJson(j,r).then(function(k){var m=[];if(k.data.d.Suggestions!==null){m=this.suggestionParser.parse(q,k.data.d.Suggestions.results);}s.concatenate(this,g,m);return this.sina._createSuggestionResultSet({title:'Suggestions',query:q,items:m});}.bind(this));},includeSuggestionTypes:function(q,f){var g={SearchTerm:{Data:'SuggestObjectData',History:'SuggestSearchHistory'},Object:{},DataSource:{Data:'SuggestDataSources'}};var o=[];var h=q.types;var k=q.calculationModes;for(var i=0;i<h.length;i++){var m=h[i];for(var j=0;j<k.length;j++){var n=k[j];var v=g[m][n];switch(v){case"SuggestObjectData":f.d.IncludeAttributeSuggestions=true;f.d.IncludeHistorySuggestions=false;f.d.IncludeDataSourceSuggestions=false;break;case"SuggestSearchHistory":f.d.IncludeAttributeSuggestions=false;f.d.IncludeHistorySuggestions=true;f.d.IncludeDataSourceSuggestions=false;break;case"SuggestDataSources":f.d.IncludeAttributeSuggestions=false;f.d.IncludeHistorySuggestions=false;f.d.IncludeDataSourceSuggestions=true;break;}}}},addSessionId:function(r){r.d.QueryOptions.ClientSessionID=this.sessionId;var t=new Date().getTime();r.d.QueryOptions.ClientCallTimestamp="\\/Date("+t+")\\/";},getFilterValueFromConditionTree:function(f,g){if(g.ConditionAttribute&&g.ConditionAttribute===f){return g.ConditionValue;}else if(g.SubFilters){var i;var r=null;for(var i=0;r===null&&i<g.SubFilters.length;i++){r=this.getFilterValueFromConditionTree(f,g.SubFilters[i]);}return r}return null;},getConfigurationAsync:function(){var r=this.buildQueryUrl(this.requestPrefix,"/PersonalizedSearchMainSwitches?$filter=Selected eq true");return this.ajaxClient.getJson(r).then(function(f){var g={personalizedSearch:false,personalizedSearchIsEditable:false};switch(f.data.d.results[0].MainSwitch){case 3:g.isPersonalizedSearchEditable=true;break;case 4:g.isPersonalizedSearchEditable=true;break;case 2:g.isPersonalizedSearchEditable=false;break;case 1:g.isPersonalizedSearchEditable=true;break;}r=this.buildQueryUrl(this.requestPrefix,"/Users('<current>')");return this.ajaxClient.getJson(r).then(function(f){if(f.data.d.IsEnabledForPersonalizedSearch){g.personalizedSearch=true;}return this.sina._createConfiguration(g);}.bind(this));}.bind(this));},saveConfigurationAsync:function(f){var g={"IsEnabledForPersonalizedSearch":f.personalizedSearch};var r=this.buildQueryUrl(this.requestPrefix,"/Users('<current>')");return this.ajaxClient.mergeJson(r,g);},resetPersonalizedSearchDataAsync:function(){var f={"ClearPersonalizedSearchHistory":true};var r=this.buildQueryUrl(this.requestPrefix,"/Users('<current>')");return this.ajaxClient.mergeJson(r,f);},logUserEvent:function(f){return this.userEventLogger.logUserEvent(f);},buildQueryUrl:function(q,f){var w=window.location.href;var r="";var g="";var h="";var i="";g=w.indexOf("sap-system=sid(");if(g!==-1){var j=w.substring(g).indexOf(")");if(j!==-1){h=w.substring(g+15,g+j);if(h.length!==0){i=";o=sid("+h+")";}}}if(h.length===0){g=w.indexOf("sap-system=");if(g!==-1){var k=w.substring(g).indexOf("&");var m=w.substring(g).indexOf("#");if(k!==-1&&m!==-1){if(k<m){h=w.substring(g+11,g+k);}else{h=w.substring(g+11,g+m);}}if(k!==-1&&m===-1){h=w.substring(g+11,g+k);}if(k===-1&&m!==-1){h=w.substring(g+11,g+m);}if(k===-1&&m===-1){h=w.substring(g+11);}}if(h.length!==0){i=";o="+h;}}r=q+i+f;return r;},getDebugInfo:function(){return'Searchsystem: '+this.serverInfo.SystemId+' Client: '+this.serverInfo.Client+' SinaProvider :'+this.id;}});});

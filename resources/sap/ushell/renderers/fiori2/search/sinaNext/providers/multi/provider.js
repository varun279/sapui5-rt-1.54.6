sinaDefine(['../../core/core','../../sina/sinaFactory'],function(c,s){"use strict";return c.defineClass({id:'multi',_initAsync:function(p){this.sina=p.sina;this.parentSina=p.sina;this.multiSina=[p.sina];this.sina.dataSourceMap[this.sina.allDataSource.multiId]=this.sina.allDataSource;var d=function(a){if(a>=p.subProviders.length){if(this.multiSina.length<1){return c.Promise.reject(new c.Exception('sina creation by trial failed'));}else{return;}}var b=p.subProviders[a];return s.createAsync(b).then(function(e){e.allDataSource.multiId=e.provider.id+'_'+e.allDataSource.id;e.allDataSource.label=e.allDataSource.label+' ('+e.provider.id+')';e.allDataSource.labelPlural=e.allDataSource.labelPlural+' ('+e.provider.id+')';e.provider.parentSina=this.sina;this.sina.dataSources=this.sina.dataSources.concat(e.dataSources);for(var i=0;i<e.dataSources.length;i++){this.sina.dataSourceMap[e.dataSources[i].multiId]=e.dataSources[i];}this.multiSina.push(e);return d(a+1);}.bind(this),function(){return d(a+1);}.bind(this));}.bind(this);return d(0);},executeSearchQuery:function(q){var t=this;var m=1;t.searchResultSet=this.sina._createSearchResultSet({title:'Search Multi Result List',query:q,items:[],totalCount:0,facets:[this.sina._createDataSourceResultSet({title:q.filter.dataSource.label,items:[],query:q})]});var d=function(i){if(i>=t.multiSina.length){t.searchResultSet.items=t.searchResultSet.items.slice(0,q.top);return t.searchResultSet;}if(t.multiSina[i].provider.id==="multi"){return d(i+1);}var a=t.multiSina[i].createSearchQuery({dataSource:t.multiSina[i].allDataSource,searchTerm:q.searchTerm,top:q.top});return a.getResultSetAsync().then(function(b){t.searchResultSet.items=t.mergeMultiResults(t.searchResultSet.items,b.items,m);t.searchResultSet.totalCount+=b.totalCount;t.searchResultSet.facets[0].items.push(t.sina._createDataSourceResultSetItem({dataSource:b.query.filter.dataSource,dimensionValueFormatted:b.query.filter.dataSource.label,measureValue:b.totalCount,measureValueFormatted:b.totalCount}));m++;return d(i+1);});};return d(0);},mergeMultiResults:function(f,a,m){if(m<1){return[];}if(m===1){return a;}var b=f.length;var d=a.length;for(var i=0;i<b;i++){if(i>=d){break;}f.splice(m*(i+1)-1,0,a[i]);}if(d>b){f=f.concat(a.slice(b-d));}return f;},buildMultiDataSourceMap:function(){this.multiDataSourceMap={};for(var i=0;i<this.multiSina.length;i++){var d=this.multiSina[i].dataSources;for(var j=0;j<d.length;j++){var a=d[j];this.multiDataSourceMap[a.multiId]=a;}}}});});

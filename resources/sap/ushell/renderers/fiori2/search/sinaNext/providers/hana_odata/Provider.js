sinaDefine(['../../core/core','../../core/util','../../core/lang','./ajax','./conditionSerializer','./dataSourceSerializer','./FacetParser','./ItemParser','./suggestionParser','./suggestionTermSplitter','./MetadataParser'],function(c,u,l,a,b,d,F,I,S,s,M){"use strict";return c.defineClass({id:'hana_odata',_initAsync:function(e){this.requestPrefix=u.getBaseUrl(e.url)+'/es/odata/callbuildin.xsjs';this.sina=e.sina;this.ajaxClient=a.createAjaxClient();this.metadataLoadPromises={};this.internalMetadata={};this.metadataParser=new M(this);this.itemParser=new I(this);this.facetParser=new F(this);this.suggestionParser=new S(this);return this.loadServerInfo().then(function(f){this.serverInfo=f;if(!this.supports('Search')){return Promise.reject(new c.Exception('Enterprise Search is not active'));}return this.loadBusinessObjectDataSources();}.bind(this)).then(function(){if(this.sina.dataSources.length===0){return Promise.reject(new c.Exception('Enterprise Search is not active - no datasources'));}return{capabilities:this.sina._createCapabilities({fuzzy:false})};}.bind(this));},supports:function(e,f){var g=this.serverInfo.services;for(var h in g){if(h===e){if(!f){return true;}var i=g[h].Capabilities;for(var j=0;j<i.length;++j){var k=i[j];if(k===f){return true;}}}}return false;},loadServerInfo:function(){var e={rawServerInfo:{Services:[{Service:'Search',Capabilities:[{Capability:'SemanticObjectType'}]},{Service:'Suggestions2',Capabilities:[{Capability:'ScopeTypes'}]}]},services:{Suggestions:{suggestionTypes:['objectdata']},Search:{capabilities:['SemanticObjectType']}}};return Promise.resolve(e);},loadBusinessObjectDataSources:function(){var t=this;var r=this.buildQueryUrl(this.requestPrefix,"/$metadata");return this.ajaxClient.getXML(r).then(function(e){t.metadataParser.parseResponse(e).then(function(f){for(var i=0;i<f.dataSourcesList.length;++i){var g=f.dataSourcesList[i];t.metadataParser.fillMetadataBuffer(g,f.businessObjectMap[g.id]);}});});},assembleOrderBy:function(q){var r=[];for(var i=0;i<q.sortOrder.length;++i){var e=q.sortOrder[i];var f=(e.order===this.sina.SortOrder.Descending)?'desc':'asc';r.push({AttributeId:e.id,SortOrder:f});}return r;},executeSearchQuery:function(q){var r=q.filter.rootCondition.clone();var f=b.serialize(q.filter.dataSource,r);var e=q.filter.searchTerm;var g=d.serialize(q.filter.dataSource);var t=q.top||10;var h=q.skip||0;var i=q.facetTop||5;var j="Search.search(query='";if(q.filter.dataSource!==this.sina.getAllDataSource()){j+="SCOPE:"+g.Id+" ";}j+=e+"')";var k='';if(f){k=k+' and '+f;}var m='filter('+j+k+')';var n={$count:true,$top:t,$skip:h,$apply:m,whyfound:true};var o=this.buildQueryUrl(this.requestPrefix,'/$all');if(q.calculateFacets){n.facets='all';n.facetlimit=i;}return this.ajaxClient.getJson(o,n).then(function(p){return this.itemParser.parse(q,p.data).then(function(v){var w=this.facetParser.parse(q,p.data['@com.sap.vocabularies.Search.v1.Facets']);return this.sina._createSearchResultSet({title:'Search Result List',query:q,items:v,totalCount:p.data['@odata.count']||0,facets:w});}.bind(this));}.bind(this));},executeChartQuery:function(q){var e=q.filter.searchTerm;var f=d.serialize(q.filter.dataSource);var r=q.filter.rootCondition.clone();var g=15;var h=r.removeAttributeConditions(q.dimension);var i=h.deleted;var t=q.top||5;var j=q.skip||0;var k="Search.search(query='";if(f!==this.sina.getAllDataSource()){k+="SCOPE:"+f.Id+" ";}k+=e;var m='';if(i===true){k+=' AND '+h.attribute+":("+h.value+")";}k+="')";m='';var n=b.serialize(q.filter.dataSource,r);if(n){m=m+' and '+n;}var o='filter('+k+m+')';var p={$count:true,$top:t,$skip:j,$apply:o};var v=this.buildQueryUrl(this.requestPrefix,'/$all');var w='all';p.facetlimit=t;if(q.dimension){w=q.dimension;var x=q.filter.dataSource.getAttributeMetadata(q.dimension);if((x.type==='Double'||x.type==='Integer')&&t>=20){p.facetlimit=g;}}p.facets=w;return this.ajaxClient.getJson(v,p).then(function(y){var z=this.facetParser.parse(q,y.data['@com.sap.vocabularies.Search.v1.Facets']);return z;}.bind(this)).then(function(y){if(y.length>0){return y[0];};}.bind(this));},executeSuggestionQuery:function(q){var e={SearchTerm:{Data:'SuggestObjectData',History:'SuggestSearchHistory'},Object:{},DataSource:{Data:'SuggestDataSources'}};var f=q.types;var g=q.calculationModes;var h=c.Promise.resolve({items:[]});for(var i=0;i<f.length;i++){var k=f[i];for(var j=0;j<g.length;j++){var m=g[j];var v=e[k][m];switch(v){case"SuggestObjectData":return this._fireSuggestionQuery(q);default:return h;}}}},_fireSuggestionQuery:function(q){var e=q.filter.searchTerm;var f=s.split(this,e);var g="GetSuggestion(term='";if(q.filter.dataSource!==this.sina.getAllDataSource()){g+="SCOPE:"+q.filter.dataSource.id+" ";}g+=e+"')";var h={};var i=this.buildQueryUrl(this.requestPrefix,'/$all/'+g);return this.ajaxClient.getJson(i,h).then(function(r){var j=[];if(r.data.value){j=this.suggestionParser.parse(q,r.data.value);}s.concatenate(this,f,j);return this.sina._createSuggestionResultSet({title:'Suggestions',query:q,items:j});}.bind(this));},getFilterValueFromConditionTree:function(e,f){if(f.ConditionAttribute&&f.ConditionAttribute===e){return f.ConditionValue;}else if(f.SubFilters){var i;var r=null;for(i=0;r===null&&i<f.SubFilters.length;i++){r=this.getFilterValueFromConditionTree(e,f.SubFilters[i]);}return r}return null;},logUserEvent:function(e){},buildQueryUrl:function(q,e){var r=q+'/v5'+e;return r;},getDebugInfo:function(){return' SinaProvider :'+this.id;}});});

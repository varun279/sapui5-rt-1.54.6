sinaDefine(['../../core/core','./typeConverter'],function(c,t){"use strict";return c.defineClass({_init:function(p){this.provider=p;this.sina=p.sina;this.presentationUsageConversionMap={TITLE:'TITLE',SUMMARY:'SUMMARY',DETAIL:'DETAIL',IMAGE:'IMAGE',THUMBNAIL:'THUMBNAIL',HIDDEN:'HIDDEN'};this.accessUsageConversionMap={AUTO_FACET:'AUTO_FACET',SUGGESTION:'SUGGESTION'};},_getWindow:function(){if(typeof window==="undefined"){return new Promise(function(r,a){sinaRequire(['jsdom','fs'],function(j,f){var b=f.readFileSync("./node_modules/jquery/dist/jquery.js","utf-8");j.env({html:"<html><body></body></html>",src:[b],done:function(e,w){if(!e){r(w);}else{a(e);}}});});});}else{return Promise.resolve(window);}},parseResponse:function(m){var a=this;var b={businessObjectMap:{},businessObjectList:[],dataSourceMap:{},dataSourcesList:[]};return this._getWindow().then(function(w){w.$(m).find('Schema').each(function(){var $=w.$(this);var h=a._parseEntityType($,w);a._parseEntityContainer($,h,b,w);});return Promise.resolve(b);})},_parseEntityType:function(s,w){var a=this;var h={};s=w.$(s);s.find('EntityType').each(function(){var b=w.$(this).attr('Name');var d={schema:s.attr('Namespace'),keys:[],attributeMap:{},resourceBundle:'',label:''};h[b]=d;w.$(this).find('Key>PropertyRef').each(function(){d.keys.push(w.$(this).attr('Name'));});w.$(this).find('Annotation').each(function(){if(w.$(this).attr('Term')==='EnterpriseSearchHana.uiResource.label.bundle'){var r=w.$(this).attr('String');try{d.resourceBundle=jQuery.sap.resources({url:r,language:sap.ui.getCore().getConfiguration().getLanguage()});}catch(e){console.error("Resource bundle of "+b+" '"+r+"' can't be found:"+e.toString());}w.$(this).siblings('Annotation').each(function(){if(w.$(this).attr('Term')==='EnterpriseSearchHana.uiResource.label.key'){var k=w.$(this).attr('String');if(k&&d.resourceBundle){var T=d.resourceBundle.getText(k);if(T){d.label=T;}}}});}});w.$(this).find('Property').each(function(i){var e=w.$(this).attr('Name');var f={labelRaw:e,label:null,type:w.$(this).attr('Type'),presentationUsage:[],isFacet:false,isSortable:false,supportsTextSearch:false,displayOrder:i,unknownAnnotation:[]};d.attributeMap[e]=f;w.$(this).find('Annotation').each(function(){switch(w.$(this).attr('Term')){case'SAP.Common.Label':if(!f.label){f.label=w.$(this).attr('String');}break;case'EnterpriseSearchHana.uiResource.label.key':var k=w.$(this).attr('String');if(k&&d.resourceBundle){var T=d.resourceBundle.getText(k);if(T){f.label=T;}}break;case'EnterpriseSearch.key':f.isKey=w.$(this).attr('Bool')=="true"?true:false;break;case'EnterpriseSearch.presentationMode':w.$(this).find('Collection>String').each(function(){var p=w.$(this).text();p=a.presentationUsageConversionMap[p];if(p){f.presentationUsage.push(p);}});break;case'EnterpriseSearchHana.isSortable':f.isSortable=w.$(this).attr('Bool')=="true"?true:false;break;case'EnterpriseSearchHana.supportsTextSearch':f.supportsTextSearch=w.$(this).attr('Bool')=="true"?true:false;break;case'EnterpriseSearch.filteringFacet.default':f.isFacet=w.$(this).attr('Bool')=="true"?true:false;break;case'EnterpriseSearch.displayOrder':f.displayOrder=w.$(this).attr('Int');break;default:f.unknownAnnotation.push(w.$(this));}});});});return h;},_parseEntityContainer:function(s,h,a,w){var b=this;s.find('EntityContainer>EntitySet').each(function(){if(w.$(this).attr('Name')&&w.$(this).attr('EntityType')){var n=w.$(this).attr('Name');var e=w.$(this).attr('EntityType');var d=e.slice(e.lastIndexOf('.')+1);var f=h[d];if(f===undefined){throw'EntityType '+d+' has no corresponding meta data!';}var g=b.sina._createDataSource({id:n,label:f.label||n,labelPlural:f.label||n,type:b.sina.DataSourceType.BusinessObject,attributesMetadata:[{id:'dummy'}]});a.dataSourceMap[g.id]=g;a.dataSourcesList.push(g);f.name=n;f.dataSource=g;a.businessObjectMap[n]=f;a.businessObjectList.push(f);}});},fillMetadataBuffer:function(d,a){if(d.attributesMetadata[0].id!=='dummy'){return;}d.attributesMetadata=[];d.attributeMetadataMap={};for(var b in a.attributeMap){this.fillPublicMetadataBuffer(d,a.attributeMap[b]);}},fillPublicMetadataBuffer:function(d,a){var b=a.displayOrder;var p=this.sina._createAttributeMetadata({id:a.labelRaw,label:a.label||a.labelRaw,isKey:a.isKey||false,isSortable:a.isSortable,usage:this.parseUsage(a,b)||{},type:this.parseAttributeType(a),matchingStrategy:this.parseMatchingStrategy(a)});p.semanticObjectType=a.SemanticObjectTypeId;d.attributesMetadata.push(p);d.attributeMetadataMap[p.id]=p;},parseMatchingStrategy:function(a){if(a.supportsTextSearch===true){return this.sina.MatchingStrategy.Text;}else{return this.sina.MatchingStrategy.Exact;}},parseAttributeType:function(a){for(var i=0;i<a.presentationUsage.length;i++){var p=a.presentationUsage[i]||'';switch(p.toUpperCase()){case'SUMMARY':continue;case'DETAIL':continue;case'TITLE':continue;case'HIDDEN':continue;case'FACTSHEET':continue;case'THUMBNAIL':case'IMAGE':return this.sina.AttributeType.ImageUrl;case'LONGTEXT':return this.sina.AttributeType.Longtext;default:throw new c.Exception('Unknown presentation usage '+p);}}switch(a.type){case'Edm.String':case'Edm.Binary':case'Edm.Boolean':case'Edm.Byte':case'Edm.Guid':return this.sina.AttributeType.String;case'Edm.Double':case'Edm.Decimal':case'Edm.Float':return this.sina.AttributeType.Double;case'Edm.Int16':case'Edm.Int32':case'Edm.Int64':return this.sina.AttributeType.Integer;case'Edm.Time':return this.sina.AttributeType.Time;case'Edm.DateTime':if(a.TypeLength>8){return this.sina.AttributeType.Timestamp;}else{return this.sina.AttributeType.Date;}case'Collection(Edm.String)':return this.sina.AttributeType.String;case'GeoJson':return this.sina.AttributeType.GeoJson;default:throw new c.Exception('Unknown data type '+a.EDMType);}},parseUsage:function(a,d){var u={};for(var i=0;i<a.presentationUsage.length;i++){var b=a.presentationUsage[i].toUpperCase()||'';if(b==="TITLE"){u.Title={displayOrder:d};}if(b==="SUMMARY"||b==="DETAIL"||b==="IMAGE"||b==="LONGTEXT"){u.Detail={displayOrder:d};}}if(a.isFacet){u.AdvancedSearch={displayOrder:d};}return u;}});});

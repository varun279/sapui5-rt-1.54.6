// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/UserActivityLog','./Navigation','sap/ushell/ui/launchpad/ActionItem','sap/ushell/ui/launchpad/Fiori2LoadingDialog','sap/ushell/ui/launchpad/ViewPortContainer','sap/ushell/ui/shell/RightFloatingContainer','sap/ushell/ui/shell/ShellLayout'],function(U,N,A,F,V,R,S){"use strict";function s(i,c){return sap.ui.getCore().byId(c.getObject());}sap.ui.jsview("sap.ushell.renderers.fiori2.Shell",{createContent:function(c){this.oShellAppTitleStateEnum={SHELL_NAV_MENU_ONLY:0,ALL_MY_APPS_ONLY:1,SHELL_NAV_MENU:2,ALL_MY_APPS:3};var t=this,v=this.getViewData()||{},C=v.config||{},b=(C.appState==="embedded")?true:false,f=new F({id:"Fiori2LoadingDialog",text:""}),o=new sap.ushell.ui.shell.ShellHeadItem({id:"configBtn",tooltip:"{i18n>showGrpsBtn_tooltip}",ariaLabel:"{i18n>showGrpsBtn_tooltip}",icon:sap.ui.core.IconPool.getIconURI("menu2"),selected:{path:"/currentState/showPane"},press:[c.togglePane,c]}),B=sap.ui.getCore().getConfiguration().getRTL()?"feeder-arrow":"nav-back",h=new sap.ushell.ui.shell.ShellHeadItem({id:"homeBtn",tooltip:"{i18n>homeBtn_tooltip}",ariaLabel:"{i18n>homeBtn_tooltip}",icon:sap.ui.core.IconPool.getIconURI("home"),target:C.rootIntent?"#"+C.rootIntent:"#"}),a=new sap.ushell.ui.shell.ShellHeadItem({id:"backBtn",tooltip:"{i18n>backBtn_tooltip}",ariaLabel:"{i18n>backBtn_tooltip}",icon:sap.ui.core.IconPool.getIconURI(B),press:c._navBack.bind(c)}),d,n,m;this._allowUpToThreeActionInShellHeader(C);a.setShowSeparator(false);h.setShowSeparator(false);h.addCustomData(new sap.ushell.ui.launchpad.AccessibilityCustomData({key:"aria-disabled",value:"false",writeToDom:true}));h.addEventDelegate({onsapskipback:function(i){if(sap.ushell.renderers.fiori2.AccessKeysHandler.getAppKeysHandler()){i.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=false;}},onsapskipforward:function(i){if(sap.ushell.renderers.fiori2.AccessKeysHandler.getAppKeysHandler()){i.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=false;}}});o.addEventDelegate({onsapskipforward:function(i){if(sap.ushell.renderers.fiori2.AccessKeysHandler.getAppKeysHandler()){i.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=false;}},onfocusin:function(){sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=true;sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusPassedToExternalHandlerFirstTime=true;}});this.aDanglingControls=[];var e;d=this.initViewPortContainer(c);var g=jQuery.sap.getObject("services.Notifications.config.enabled",undefined,window["sap-ushell-config"]);if(g){n=new sap.ushell.ui.shell.ShellHeadItem({id:"NotificationsCountButton",icon:sap.ui.core.IconPool.getIconURI("ui-notifications"),visible:true,enabled:false}).addStyleClass("sapUshellPlaceHolders");n.setShowSeparator(false);this.aDanglingControls.push(n);}m=new sap.ushell.ui.shell.ShellHeadItem({id:"meAreaHeaderButton",icon:'{/userImage/personPlaceHolder}',visible:true,enabled:false}).addStyleClass("sapUshellPlaceHolders");m.setShowSeparator(false);this.aDanglingControls.push(m);if(C.enablePersonalization!==false){var j="openCatalogBtn";var k=sap.ushell.resources.i18n.getText("open_appFinderBtn");var l='sap-icon://sys-find';var p=function(){jQuery.sap.measure.start("FLP:AppFinderLoadingStartToEnd","AppFinderLoadingStartToEnd","FLP");var i="Shell-home&/appFinder/catalog";if(this.data("isShellHeader")){var O=new RegExp("^"+i);if(O.test(hasher.getHash())){window.location.reload();return;}}setTimeout(function(){var P=sap.ushell.Container.getService("CrossApplicationNavigation");P.toExternal({target:{shellHash:"#"+i}});},!!sap.ui.Device.system.desktop?0:500);};var q=!C.disableAppFinder;if(C.moveAppFinderActionToShellHeader){if(!this.oOpenCatalogItem){this.oOpenCatalogItem=new sap.ushell.ui.shell.ShellHeadItem(j,{icon:l,tooltip:k,text:k,press:p,showSeparator:false,visible:q});if(C.enableHelp){this.oOpenCatalogItem.addStyleClass('help-id-openCatalogActionItem');}this.oOpenCatalogItem.data("isShellHeader",true);}}else{if(!this.oOpenCatalogItem){this.oOpenCatalogItem=new A(j,{text:k,icon:l,actionType:'action',press:p,visible:q});if(C.enableHelp){this.oOpenCatalogItem.addStyleClass('help-id-openCatalogActionItem');}}}this.aDanglingControls.push(this.oOpenCatalogItem);if(C.moveEditHomePageActionToShellHeader){jQuery.sap.measure.start("FLP:Shell.view.createContent","create the edit home page button as shell head enditem","FLP");if(!this.oTileActionsButton){this.oTileActionsButton=new sap.ushell.ui.shell.ShellHeadItem("ActionModeBtn",{icon:'sap-icon://edit',visible:false,showSeparator:false});this.oTileActionsButton.data("isShellHeader",true);if(C.enableHelp){this.oTileActionsButton.addStyleClass('help-id-openCatalogActionItem');}}this.aDanglingControls.push(this.oTileActionsButton);jQuery.sap.measure.end("FLP:Shell.view.createContent");}}var E=new sap.ushell.ui.shell.ShellHeadItem({id:"endItemsOverflowBtn",tooltip:"{i18n>shellHeaderOverflowBtn_tooltip}",ariaLabel:"{i18n>shellHeaderOverflowBtn_tooltip}",icon:"sap-icon://overflow",press:[c.pressEndItemsOverflow,c],visible:true,showSeparator:false});this.aDanglingControls.push(E);var r=new sap.ushell.ui.shell.SplitContainer({id:'shell-split',showSecondaryContent:{path:"/currentState/showPane"},secondaryContent:{path:"/currentState/paneContent",factory:s},content:d,subHeader:{path:"/currentState/subHeader",factory:s}});var u=new sap.ushell.ui.shell.ToolArea({id:'shell-toolArea',toolAreaItems:{path:"/currentState/toolAreaItems",factory:s}});var w=new R({id:'right-floating-container',top:'6.875',hideItemsAfterPresentation:true,visible:'{/currentState/showRightFloatingContainer}',floatingContainerItems:{path:"/currentState/RightFloatingContainerItems",factory:s},insertItemsWithAnimation:{path:'/animationMode',formatter:function(i){return i!=='minimal';}}});var x=new sap.ushell.ui.shell.ShellTitle("shellTitle",{text:{path:"/title"}});var H=function(O,P){var Q=P.getProperty("icon");var T=P.getProperty("title");var W=P.getProperty("subtitle");var X=P.getProperty("intent");if(!Q){Q="sap-icon://circle-task-2";}var Y=(new sap.m.StandardListItem({type:sap.m.ListType.Active,title:T,description:W,icon:Q,customData:[new sap.ui.core.CustomData({key:"intent",value:X})],press:function(Z){var $=Z.getSource().getCustomData();if($&&$.length>0){for(var i=0;i<$.length;i++){if($[i].getKey()==="intent"){var a1=$[i].getValue();if(a1&&a1[0]==="#"){c.navigateFromShellApplicationNavigationMenu(a1);return;}}}}}})).addStyleClass("sapUshellNavigationMenuListItems");return Y;};var y=function(i,O){var P=O.getProperty("icon");var T=O.getProperty("title");var Q=O.getProperty("subtitle");var W=O.getProperty("intent");if(!Q&&!P){P="sap-icon://documents";}jQuery.sap.require("sap.ushell.ui.shell.NavigationMiniTile");return new sap.ushell.ui.shell.NavigationMiniTile({title:T,subtitle:Q,icon:P,intent:W,press:function(){var X=this.getIntent();if(X&&X[0]==='#'){c.navigateFromShellApplicationNavigationMenu(X);}}});};var z=new sap.ushell.ui.shell.ShellNavigationMenu("shellNavigationMenu",{title:"{/currentState/application/title}",icon:"{/currentState/application/icon}",showTitle:{path:"/currentState/application/showNavMenuTitle"},items:{path:"/currentState/application/hierarchy",factory:H.bind(this)},miniTiles:{path:"/currentState/application/relatedApps",factory:y.bind(this)},visible:{path:'/ShellAppTitleState',formatter:function(i){return i===this.oShellAppTitleStateEnum.SHELL_NAV_MENU;}.bind(this)}});this.oShellNavigationMenu=z;var D;D=new sap.ushell.ui.shell.ShellAppTitle({id:"shellAppTitle",text:"{/currentState/application/title}",tooltip:sap.ushell.resources.i18n.getText("shellNavMenu_openMenuTooltip"),navigationMenu:z});D.addEventDelegate({onsapskipforward:function(i){if(sap.ushell.renderers.fiori2.AccessKeysHandler.getAppKeysHandler()){i.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=false;}}});var G=new sap.ui.model.Filter('','EQ','a'),I,J;G.fnTest=c.isHeadEndItemNotInOverflow.bind(c);I=new sap.ushell.ui.shell.ShellHeader({id:'shell-header',showLogo:{path:"/currentState/showLogo"},headItems:{path:"/currentState/headItems",factory:s},headEndItems:{path:"/currentState/headEndItems",factory:s,filters:[G]},title:x,appTitle:D,showSeparators:false});J=new S({id:"shell",header:I,toolArea:u,rightFloatingContainer:w,floatingContainerVisible:false,canvasSplitContainer:r,toolAreaVisible:{path:"/currentState/toolAreaVisible"},headerHiding:{path:"/currentState/headerHiding"},headerVisible:{path:"/currentState/headerVisible"},backgroundColorForce:false,showBrandLine:false,showAnimation:false,enableCanvasShapes:C.enableBackGroundShapes===undefined?true:C.enableBackGroundShapes});J._setStrongBackground(true);this.setOUnifiedShell(J);if(e){I.setUser(e);}if(I){var K=I.onAfterRendering;I.onAfterRendering=function(){var i=this.getModel().getProperty("/currentState/headerVisible");if(i){if(K){K.apply(this,arguments);}if(this.getModel().getProperty("/enableHelp")){jQuery('#actionsBtn').addClass('help-id-actionsBtn');jQuery('#configBtn').addClass('help-id-configBtn');jQuery('#homeBtn').addClass('help-id-homeBtn');}jQuery(".sapUshellHeadTitle").removeAttr("tabindex",0);var O=jQuery("#sapUshellHeaderAccessibilityHelper");O.focusin(function(P){var Q=sap.ui.getCore().byId('viewPortContainer'),T=Q.getCurrentState(),W;if(sap.ushell.renderers.fiori2.AccessKeysHandler.bForwardNavigation){switch(T){case"Center":var X=sap.ushell.renderers.fiori2.AccessKeysHandler;if(X.getAppKeysHandler()){setTimeout(function(){X.fnExternalKeysHandler(P,X.bFocusPassedToExternalHandlerFirstTime);X.bFocusOnShell=false;},0);}else{var Y=jQuery(":focusable").filter("[tabindex!='-1']"),Z=Y.index(document.activeElement),W=Y.eq(Z+1);if(!W.length){W=Y[0];}}break;case"LeftCenter":W=jQuery("#logoutBtn");if(W.length===0){W=jQuery("#userStatusOpener");}break;case"RightCenter":W=jQuery("#sapUshellNotificationIconTabByDate");sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=false;break;}}else{var $=sap.ui.getCore().byId("shell-header"),a1=$.getHeadEndItems(),b1;if(a1.length>0){b1=a1[a1.length-1];W=b1;}else W=$.getAppTitle();}setTimeout(function(){if(W){W.focus();}},0);});}};}this.oShellPage=this.pageFactory("shellPage",J,true);if(b){I.setLogo(sap.ui.resource('sap.ui.core','themes/base/img/1x1.gif'));}else{this.initShellBarLogo(I);}this.setDisplayBlock(true);this.aDanglingControls=this.aDanglingControls.concat([sap.ui.getCore().byId('viewPortContainer'),this.oShellPage,f,h,a,o]);J.updateAggregation=this.updateShellAggregation;I.updateAggregation=this.updateShellAggregation;u.updateAggregation=this.updateShellAggregation;w.updateAggregation=this.updateShellAggregation;r.updateAggregation=this.updateShellAggregation;var L=(C.enableSearch!==false);if(L){var _=function(i){if(!t._searchShellHelperDeferred){t._searchShellHelperDeferred=jQuery.Deferred();sap.ui.require(['sap/ushell/renderers/fiori2/search/SearchShellHelperAndModuleLoader'],function(){var O=sap.ui.require('sap/ushell/renderers/fiori2/search/SearchShellHelper');if(i){O.init();}t._searchShellHelperDeferred.resolve(O);});}return t._searchShellHelperDeferred;};t.oShellSearchBtn=new sap.ushell.ui.shell.ShellHeadItem({id:"sf",tooltip:"{i18n>searchbox_tooltip}",text:"{i18n>searchBtn}",ariaLabel:"{i18n>searchbox_tooltip}",icon:sap.ui.core.IconPool.getIconURI("search"),visible:true,showSeparator:false,press:function(i){_(false).done(function(O){O.onShellSearchButtonPressed(i);});}});if(C.openSearchAsDefault){_(true).done(function(i){i.setDefaultOpen(true);i.openSearch(false,false);});}var M=function(){var i=sap.ui.core.routing.HashChanger.getInstance();i.attachEvent("shellHashChanged",function(O){var P=O.mParameters;sap.ui.require(['sap/ushell/renderers/fiori2/search/HashChangeHandler'],function(Q){Q.handle(P);});});};sap.ui.getCore().getEventBus().subscribeOnce("sap.ushell","coreResourcesFullyLoaded",M);t.oShellSearchBtn.addEventDelegate({onsapskipforward:function(i){i.preventDefault();jQuery("#sapUshellHeaderAccessibilityHelper").focus();},onsapskipback:function(i){i.preventDefault();jQuery("#sapUshellHeaderAccessibilityHelper").focus();},onAfterRendering:function(){jQuery("#sf").attr("aria-pressed",false);}});t.aDanglingControls.push(t.oShellSearchBtn);}this.logonIFrameReference=null;return new sap.m.App({pages:this.oShellPage});},_allowUpToThreeActionInShellHeader:function(c){if(Object.keys(c).length!=0){var C=[c.moveAppFinderActionToShellHeader,c.moveUserSettingsActionToShellHeader,c.moveGiveFeedbackActionToShellHeader,c.moveContactSupportActionToShellHeader,c.moveEditHomePageActionToShellHeader];var a=0;for(var i=0;i<5;i++){if(a===3){C[i]=false;}else{if(C[i]){a++;}}}c.moveAppFinderActionToShellHeader=C[0];c.moveUserSettingsActionToShellHeader=C[1];c.moveGiveFeedbackActionToShellHeader=C[2];c.moveContactSupportActionToShellHeader=C[3];c.moveEditHomePageActionToShellHeader=C[4];}},createPostCoreExtControls:function(){jQuery.sap.require("sap.ushell.ui.shell.FloatingContainer");jQuery.sap.require("sap.ushell.ui.shell.ShellFloatingActions");var o=new sap.ushell.ui.shell.FloatingContainer({id:'shell-floatingContainer',content:{path:"/currentState/floatingContainerContent",factory:s}});o.addCustomData(new sap.ushell.ui.launchpad.AccessibilityCustomData({key:"tabindex",value:"-1",writeToDom:true}));o.addEventDelegate({onsapskipforward:function(e){e.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.setIsFocusHandledByAnotherHandler(true);sap.ushell.renderers.fiori2.AccessKeysHandler.sendFocusBackToShell(e);},onsapskipback:function(e){if(sap.ushell.renderers.fiori2.AccessKeysHandler.getAppKeysHandler()){e.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=false;}}});var a=sap.ui.getCore().byId("shell"),m=a.getModel();o.setModel(m);this.aDanglingControls.push(o);var b=new sap.ushell.ui.shell.ShellFloatingActions({id:'shell-floatingActions',floatingActions:{path:"/currentState/floatingActions",factory:s}});b.updateAggregation=this.updateShellAggregation;var c=this.getOUnifiedShell();c.setFloatingContainer(o);c.setFloatingActionsContainer(b);this._createAllMyAppsView();},_createAllMyAppsView:function(){var t=this,_=function(){return t.getModel();};if(sap.ushell.Container.getService("AllMyApps").isEnabled()){this.oAllMyAppsView=sap.ui.view("allMyAppsView",{type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.ushell.renderers.fiori2.allMyApps.AllMyApps",viewData:{_fnGetShellModel:_},height:"100%",visible:{path:'/ShellAppTitleState',formatter:function(c){return c!==this.oShellAppTitleStateEnum.SHELL_NAV_MENU;}.bind(this)}}).addStyleClass("sapUshellAllMyAppsView");this.oAllMyAppsView.addCustomData(new sap.ushell.ui.launchpad.AccessibilityCustomData({key:"aria-label",value:sap.ushell.resources.i18n.getText("allMyApps_headerTitle"),writeToDom:true}));this.getOUnifiedShell().getHeader().getAppTitle().setAllMyApps(this.oAllMyAppsView);}},getOUnifiedShell:function(){return this.oUnifiedShell;},setOUnifiedShell:function(u){this.oUnifiedShell=u;},_getIconURI:function(i){var r=null;if(i){var m=/url[\s]*\('?"?([^\'")]*)'?"?\)/.exec(i);if(m){r=m[1];}}return r;},initShellBarLogo:function(o){var m=jQuery.sap.getModulePath("sap.ushell");jQuery.sap.require("sap.ui.core.theming.Parameters");o.setLogo(m+'/themes/base/img/sap_55x27.png');var t=this;sap.ui.getCore().attachThemeChanged(function(){if(o.bIsDestroyed){return;}var n=sap.ui.core.theming.Parameters.get("sapUiGlobalLogo");if(n){n=t._getIconURI(n);if(n){o.setLogo(n);}else{o.setLogo(m+'/themes/base/img/sap_55x27.png');}}else{o.setLogo(m+'/themes/base/img/sap_55x27.png');}});},initViewPortContainer:function(c){var v=new V({id:"viewPortContainer",defaultState:sap.ushell.ui.launchpad.ViewPortState.Center,afterNavigate:jQuery.proxy(c.onAfterNavigate,c),afterSwitchState:jQuery.proxy(c.onAfterViewPortSwitchState,c)});return v;},updateShellAggregation:function(n){var b=this.mBindingInfos[n],a=this.getMetadata().getJSONKeys()[n],c;jQuery.each(this[a._sGetter](),jQuery.proxy(function(i,v){this[a._sRemoveMutator](v);},this));jQuery.each(b.binding.getContexts(),jQuery.proxy(function(i,v){c=b.factory(this.getId()+"-"+i,v)?b.factory(this.getId()+"-"+i,v).setBindingContext(v,b.model):"";this[a._sMutator](c);},this));},disableBouncing:function(p){p.onBeforeRendering=function(){sap.m.Page.prototype.onBeforeRendering.apply(p);var o=this._oScroller,O=o.onAfterRendering;o.onAfterRendering=function(){O.apply(o);if(o._scroller){o._scroller.options.bounce=false;}};};return p;},getControllerName:function(){return"sap.ushell.renderers.fiori2.Shell";},pageFactory:function(i,c,d){var p=new sap.m.Page({id:i,showHeader:false,content:c,enableScrolling:!!sap.ui.Device.system.desktop}),e=["onAfterHide","onAfterShow","onBeforeFirstShow","onBeforeHide","onBeforeShow"],D={};jQuery.each(e,function(I,E){D[E]=jQuery.proxy(function(a){jQuery.each(this.getContent(),function(I,c){c._handleEvent(a);});},p);});p.addEventDelegate(D);if(d&&sap.ui.Device.system.desktop){this.disableBouncing(p);}return p;},createIFrameDialog:function(){var d=null,l=this.logonIFrameReference,c;var _=function(){if(l){l.remove();}return jQuery('<iframe id="SAMLDialogFrame" src="" frameborder="0" height="100%" width="100%"></iframe>');};var a=function(){d.addStyleClass('sapUshellSamlDialogHidden');jQuery('#sap-ui-blocklayer-popup').addClass('sapUshellSamlDialogHidden');};this.destroyIFrameDialog();var b=new sap.m.Button({text:sap.ushell.resources.i18n.getText("samlCloseBtn"),press:function(){sap.ushell.Container.cancelLogon();}});var h=new sap.ui.core.HTML("SAMLDialogFrame");this.logonIFrameReference=_();h.setContent(this.logonIFrameReference.prop('outerHTML'));d=new sap.m.Dialog({id:"SAMLDialog",title:sap.ushell.resources.i18n.getText("samlDialogTitle"),contentWidth:"50%",contentHeight:"50%",rightButton:b}).addStyleClass("sapUshellIframeDialog");c=sap.ushell.Container.getService("SupportTicket").isEnabled();if(c){jQuery.sap.require("sap.ushell.ui.footerbar.ContactSupportButton");var C=new sap.ushell.ui.footerbar.ContactSupportButton();C.setWidth('150px');C.setIcon('');d.setLeftButton(C);}d.addContent(h);d.open();a();this.logonIFrameReference=jQuery('#SAMLDialogFrame');return this.logonIFrameReference[0];},destroyIFrameDialog:function(){var d=sap.ui.getCore().byId('SAMLDialog');if(d){d.destroy();}this.logonIFrameReference=null;},showIFrameDialog:function(){var d=sap.ui.getCore().byId('SAMLDialog');if(d){d.removeStyleClass('sapUshellSamlDialogHidden');jQuery('#sap-ui-blocklayer-popup').removeClass('sapUshellSamlDialogHidden');}}});},false);

// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/resources','sap/ui/core/UIComponent','sap/ushell/components/flp/ComponentKeysHandler','sap/ushell/utils','sap/m/Dialog','sap/m/Button','sap/m/Text'],function(r,U,C,u,D,B,T){var s=sap.ushell.Container.getRenderer("fiori2").getShellController(),S=s.getView(),o=(S.getViewData()?S.getViewData().config:{})||{},d={},i=false;var p="sap.ushell.components.shell.userImage.";return U.extend("sap.ushell.components.shell.UserImage.Component",{metadata:{version:"1.53.0-SNAPSHOT",library:"sap.ushell.components.shell.UserImage",dependencies:{libs:["sap.m"]},},createContent:function(){var s=sap.ushell.Container.getRenderer("fiori2").getShellController(),S=s.getView(),o=(S.getViewData()?S.getViewData().config:{})||{};"use strict";this.loadUserImage();var t=this;var a=sap.ushell.Container.getUser();if(o.enableUserImgConsent==true&&a.getImageConsent()==undefined){this._showUserConsentPopup();}sap.ui.getCore().getEventBus().publish("shell","userImageCompLoaded",{delay:0});},_showUserConsentPopup:function(){var t=this;var a=sap.ui.getCore().getConfiguration().getRTL()?'Right':'Left';var e=sap.ui.Device.system.phone?"auto":"14rem";var b=sap.ui.Device.system.phone?"auto":"10rem";var y=new sap.m.Button('yesButton',{text:sap.ushell.resources.i18n.getText("DisplayImg"),type:"Emphasized",press:function(){t.updateUserImage(true);m.close();}});var n=new sap.m.Button('noButton',{text:sap.ushell.resources.i18n.getText("DontDisplayImg"),press:function(){t.updateUserImage(false);m.close();}});var c=new sap.m.Text({text:sap.ushell.resources.i18n.getText("userImageConsentText"),textAlign:a}).addStyleClass('sapUshellUserConsentDialogText');var f=new sap.m.Link({text:sap.ushell.resources.i18n.getText("userImageConsentDialogShowTermsOfUse"),textAlign:a,press:function(){var q=k.getVisible();if(q){k.setVisible(false);f.setText(sap.ushell.resources.i18n.getText("userImageConsentDialogShowTermsOfUse"));}else{f.setText(sap.ushell.resources.i18n.getText("userImageConsentDialogHideTermsOfUse"));k.setVisible(true);}}.bind(this)}).addAriaLabelledBy(c);var g=new sap.m.Text({text:sap.ushell.resources.i18n.getText("userImageConsentDialogTermsOfUse"),}).addStyleClass('sapUshellUserConsentDialogTerms');var h=new sap.m.FlexBox({alignItems:'Center',direction:'Row',items:[c,]}).addStyleClass('sapUshellUserConsentDialogBox');var j=new sap.m.FlexBox({alignItems:'Center',direction:'Row',items:[f]}).addStyleClass('sapUshellUserConsentDialogBox').addStyleClass('sapUshellUserConsentDialogLink');var k=new sap.m.FlexBox({alignItems:'Center',direction:'Row',items:[g]}).addStyleClass('ushellUserImgConsentTermsOfUseFlexBox');k.setVisible(false);var l=new sap.ui.layout.VerticalLayout('userConsentDialogLayout',{content:[h,j,k]});var m=new sap.m.Dialog("userConsentDialog",{title:sap.ushell.resources.i18n.getText("userImageConsentDialogTitle"),modal:true,stretch:sap.ui.Device.system.phone,buttons:[y,n],afterClose:function(){m.destroy();}}).addStyleClass('sapUshellUserConsentDialog');m.addContent(l);m.open();},loadUserImage:function(){var a=sap.ushell.Container.getUser(),b=a.getImage();if(b){this._setUserImage(b);}a.attachOnSetImage(this._setUserImage.bind(this));},_setUserImage:function(a){var b=(typeof a)==='string'?a:a.mParameters,c=true;if((typeof b)==='string'){if(b){c=false;}}else{if(!jQuery.isEmptyObject(b)){c=false;}}var e=sap.ui.core.IconPool.getIconURI("person-placeholder"),f=sap.ui.core.IconPool.getIconURI("account");oHeaders={'Cache-Control':'no-cache, no-store, must-revalidate','Pragma':'no-cache','Expires':'0'};if(!c){jQuery.ajax({url:b,headers:oHeaders,success:function(){S.getModel().setProperty("/userImage/personPlaceHolder",b);S.getModel().setProperty("/userImage/account",b);},error:function(){jQuery.sap.log.error("Could not load user image from: "+b,"","sap.ushell.renderers.fiori2.Shell.view");var g=sap.ushell.Container.getUser();g.setImage("");}});}else{S.getModel().setProperty("/userImage/personPlaceHolder",e);S.getModel().setProperty("/userImage/account",f);}},updateUserImage:function(a){var b=sap.ushell.Container.getUser();this.userInfoService=sap.ushell.Container.getService("UserInfo");var c=jQuery.Deferred();var e;if(a!=undefined){b.setImageConsent(a);e=this.userInfoService.updateUserPreferences(b);e.done(function(){b.resetChangedProperties();c.resolve();}.bind(this));}else{c.reject(a+"is undefined");}},exit:function(){"use strict";}});});

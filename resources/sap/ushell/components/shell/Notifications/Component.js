// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/resources','sap/ui/core/UIComponent','sap/ushell/components/flp/ComponentKeysHandler','sap/ushell/utils'],function(r,U,C,u){var s=sap.ushell.Container.getRenderer("fiori2").getShellController(),S=s.getView(),o=(S.getViewData()?S.getViewData().config:{})||{},d={},i=false;function h(e,a){if(e){a=e.getSource();}var n,N=sap.ushell.Container.getService("Notifications"),b=sap.ui.getCore().byId("notifications-preview-container"),A=S.getModel().getProperty('/animationMode')||'full';if(d.view&&i==false){n=sap.ui.view("notificationsView",{viewName:"sap.ushell.renderers.fiori2.notifications.Notifications",type:'JS',viewData:{}});i=true;if(d.view.position==="right"){sap.ushell.Container.getRenderer("fiori2").addRightViewPort(n);}else{sap.ushell.Container.getRenderer("fiori2").addLeftViewPort(n);}}s.bMeAreaSelected=false;var m=sap.ui.getCore().byId("meAreaHeaderButton");if(m){m.setSelected(false);jQuery(m.getDomRef()).attr("aria-pressed","false");}s.bNotificationsSelected=a.getSelected();if(s.bNotificationsSelected){s._switchViewPortStateByControl(a,"Center");}else{S.getModel().setProperty("/notificationsCount",0);if(b){b.setFloatingContainerItemsVisiblity(false);this._switchToNotificationViewWithPreview(b,A,a);}else{this._switchToNotificationView(a);}}s.bNotificationsSelected=!s.bNotificationsSelected;a.setSelected(s.bNotificationsSelected);N.notificationsSeen();S.getModel().setProperty("/notificationsCount",0);jQuery(a.getDomRef()).attr("aria-pressed",s.bNotificationsSelected);jQuery(a.getDomRef()).attr("aria-label",sap.ushell.resources.i18n.getText("NotificationToggleButtonCollapsedNoNotifications"));};return U.extend("sap.ushell.components.shell.Notifications.Component",{metadata:{version:"1.53.0-SNAPSHOT",library:"sap.ushell.components.shell.Notifications",dependencies:{libs:["sap.m"]}},createContent:function(){"use strict";sap.ui.getCore().getEventBus().subscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);var c=this.getComponentData().config;d={view:{position:"right"},enableHeaderButton:true,enablePreview:true};var n,a;if(sap.ushell.Container.getService("Notifications").isEnabled()===true){s.getModel().setProperty("/enableNotifications",true);sap.ushell.Container.getService("Notifications").init();if(o.enableNotificationsUI===true){s.getModel().setProperty("/enableNotificationsUI",true);sap.ushell.Container.getService("Notifications").registerDependencyNotificationsUpdateCallback(this.notificationsCountUpdateCallback.bind(this),true);}}d=jQuery.extend(d,c);n=sap.ui.getCore().byId("NotificationsCountButton");n.applySettings({icon:sap.ui.core.IconPool.getIconURI("ui-notifications"),floatingNumber:{parts:["/notificationsCount"],formatter:function(b){var j=this.getDomRef(),e="";if(j){if(b>0){e=sap.ushell.resources.i18n.getText("NotificationToggleButtonCollapsed",b);}else{e=sap.ushell.resources.i18n.getText("NotificationToggleButtonCollapsedNoNotifications");}j.setAttribute("aria-label",e);}return b;}},visible:"{/enableNotifications}",enabled:"{/enableNotifications}",selected:{path:"/currentViewPortState",formatter:function(v){if(v==='RightCenter'){return true;}return false;}},press:[h,this],showSeparator:false,tooltip:sap.ushell.resources.i18n.getText("NotificationToggleButtonExpanded")}).removeStyleClass("sapUshellPlaceHolders");a=n.onAfterRendering;n.onAfterRendering=function(){if(a){a.apply(this,arguments);}jQuery(this.getDomRef()).attr("aria-pressed",s.bNotificationsSelected);if(this.getDisplayFloatingNumber()>0){jQuery(this.getDomRef()).attr("aria-label",sap.ushell.resources.i18n.getText("NotificationToggleButtonCollapsed",this.getDisplayFloatingNumber()));}else{jQuery(this.getDomRef()).attr("aria-label",sap.ushell.resources.i18n.getText("NotificationToggleButtonCollapsedNoNotifications"));}};n.addEventDelegate({onsapskipforward:function(e){sap.ushell.renderers.fiori2.AccessKeysHandler.bForwardNavigation=true;e.preventDefault();jQuery("#sapUshellHeaderAccessibilityHelper").focus();},onsaptabnext:function(e){sap.ushell.renderers.fiori2.AccessKeysHandler.bForwardNavigation=true;e.preventDefault();jQuery("#sapUshellHeaderAccessibilityHelper").focus();},onsapskipback:function(e){if(sap.ushell.renderers.fiori2.AccessKeysHandler.getAppKeysHandler()){e.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=false;}}});S.aDanglingControls.push(n);if(s.getModel().getProperty("/enableNotificationsUI")===true){sap.ushell.components.applicationIntegration.AppLifeCycle.addHeaderEndItem(["NotificationsCountButton"],false,["home","app","minimal"],true);}sap.ui.getCore().getEventBus().publish("shell","notificationsCompLoaded",{delay:3000});},_handleAlerts:function(c,e,n){var N;if(s.oViewPortContainer.getCurrentState()!=='RightCenter'){for(N=0;N<n.length;N++){this.handleNotification(n[N]);}}},handleNotification:function(n){var a=sap.ushell.Container.getRenderer("fiori2").addRightFloatingContainerItem({press:function(e){var v=sap.ui.getCore().byId('viewPortContainer');if(hasher.getHash()===n.NavigationTargetObject+"-"+n.NavigationTargetAction){v.switchState("Center");}else{u.toExternalWithParameters(n.NavigationTargetObject,n.NavigationTargetAction,n.NavigationTargetParams);}sap.ushell.Container.getService("Notifications").markRead(n.Id);},datetime:sap.ushell.resources.i18n.getText("notification_arrival_time_now"),title:n.SensitiveText?n.SensitiveText:n.Text,description:n.SubTitle,unread:n.IsRead,priority:"High",hideShowMoreButton:true},true,true);setTimeout(function(){sap.ushell.Container.getRenderer("fiori2").removeRightFloatingContainerItem(a.getId(),true);},3500);},notificationsCountUpdateCallback:function(D){var t=this,v=s.oViewPortContainer.getCurrentState(),I=v==="RightCenter"?true:false;if((D===undefined)||(!I)){this._updateBadge();}else{D.done(function(){t._updateBadge();});}},_updateBadge:function(){var n;sap.ushell.Container.getService("Notifications").getUnseenNotificationsCount().done(function(N){n=parseInt(N,10);S.getModel().setProperty('/notificationsCount',n);}).fail(function(a){jQuery.sap.log.error("Shell.controller - call to notificationsService.getCount failed: ",a,"sap.ushell.renderers.lean.Shell");});},_switchToNotificationView:function(a){s.oViewPortContainer.navTo('rightViewPort',"notificationsView",'show');s._switchViewPortStateByControl(a,"RightCenter");sap.ui.getCore().getEventBus().publish("launchpad","notificationViewOpened");},_switchToNotificationViewWithPreview:function(n,a,b){if(a==='minimal'){this._switchToNotificationView(b);}else{var c=n.getFloatingContainerItems().length;setTimeout(function(){this._switchToNotificationView(b);}.bind(this),300+(c*100));}},exit:function(){"use strict";sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);if(sap.ushell.Container){if(sap.ushell.Container.getService("Notifications").isEnabled()===true){sap.ushell.Container.getService("Notifications").destroy();}}}});});

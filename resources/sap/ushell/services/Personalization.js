// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/services/_Personalization/utils","sap/ushell/services/_Personalization/constants.private","sap/ushell/services/_Personalization/constants","sap/ushell/services/_Personalization/ContextContainer","sap/ushell/services/_Personalization/WindowAdapter","sap/ushell/services/_Personalization/TransientPersonalizer","sap/ushell/services/_Personalization/PersonalizationContainer","sap/ushell/services/_Personalization/Personalizer","sap/ushell/services/_Personalization/VariantSetAdapter","sap/ushell/services/_Personalization/Variant","sap/ushell/services/_Personalization/VariantSet","sap/ushell/services/_Personalization/WindowAdapterContainer","sap/ui/core/format/DateFormat","sap/ui/base/ManagedObject"],function(u,p,a,b,C,W,T,P,c,V,d,e,f,D,M){"use strict";function g(A,o,s,h){this._oConfig=(h&&h.config)||{};this._seed=(h&&h.config&&typeof h.config.seed==="string"&&h.config.seed)||"12345678901AFERANDOMBETTER";while(this._seed.length<40){this._seed=this._seed+this._seed;}this._oAppVariantAdapterWithBackendAdapter=this._configureAppVariantStorage(this._oConfig.appVariantStorage);this._oAdapterWithBackendAdapter={lazy:false,instance:new W(this,A)};this._oAdapterWindowOnly={lazy:false,instance:new W(this,undefined)};this._oContainerMap=new u.Map();this._oPendingOperationsMap=new u.Map();};g.prototype.SAVE_DEFERRED_DROPPED="Deferred save dropped (OK) - Data superseeded by subsequent save";g.prototype.constants=b;g.prototype._configureAppVariantStorage=function(A){var t=this,s="sap.ushell.adapters.AppVariantPersonalizationAdapter";if(!A){A={adapter:{module:s}};}if(Object.keys(A).length===0||A.enabled===false){return;}var h=(A.adapter&&A.adapter.module)||s;var i=h.split(".").join("/");var j=function(){t._oAppVariantAdapterLoadPromise=t._oAppVariantAdapterLoadPromise||(function(){var o=new jQuery.Deferred();try{sap.ui.require([i],R);}catch(r){o.reject(r);}function R(k){try{var l=new k();var w=new W(t,l);o.resolve(w);}catch(E){o.reject(E);}}return o.promise();})();return t._oAppVariantAdapterLoadPromise;};return{lazy:true,create:j};};g.prototype.getGeneratedKey=function(){var s="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",h=s.length,r="",t=this;var R=function(i){return(t._seed.charCodeAt(i)+Math.floor(Math.random()*h))%h;};if(window&&window.crypto&&window.crypto.getRandomValues){var j=new Uint32Array(40);window.crypto.getRandomValues(j);R=function(i){return(j[i]+t._seed.charCodeAt(i))%s.length;}}var k=function(i){return s[R(i)];};while(r.length<40){r+=k(r.length);}return r;};g.prototype.getPersonalizer=function(o,s,h){h=h||this._getApplicationComponent();return new c(this,this._oAdapterWithBackendAdapter.instance,o,s,h);};g.prototype._getApplicationComponent=function(){var o;var O=M._sOwnerId;if(O){o=sap.ui.getCore().getComponent(O);if(o instanceof sap.ui.core.UIComponent){return o;}}return undefined;};g.prototype.getTransientPersonalizer=function(){return new T();};g.prototype.getContainer=function(s,S,o){o=o||this._getApplicationComponent();return this._createContainer(s,S,false,o);};g.prototype.createEmptyContainer=function(s,S,o){o=o||this._getApplicationComponent();return this._createContainer(s,S,true,o);};g.prototype._createContainer=function(s,S,h,o){var t=this,l,i,j,k,A,m,U,n=new jQuery.Deferred();if(typeof s!=="string"){throw new u.Error("sContainerKey is not a string: sap.ushell.services.Personalization"," ");}l=p.isLaunchpadReload();U=!!(p.isAppVariant(o)&&(!S||!S.shared)&&this._oAppVariantAdapterWithBackendAdapter);A=p.adjustScope(S,l);if(U){var q=o.getManifestObject();A.component=o;A.appVarId=q.getEntry("/sap.ui5/appVariantId");A.appVersion=q.getEntry("/sap.app/applicationVersion/version");}m=p.addContainerPrefix(s);j=U?this._oAppVariantAdapterWithBackendAdapter:this._oAdapterWithBackendAdapter;i=t._oAdapterWindowOnly;k=p.pickAdapter(S,l,i,j);p.loadAdapter(k).then(function(L){var r;var v=new C(t,L,m,A,o);var w=L&&L.supportsGetWithoutSubsequentLoad===true;if(h&&w){r=new jQuery.Deferred();r.resolve(v);}else{r=v.load();}r.fail(function(){n.reject();}).done(function(){if(h||v._isExpired()){v.clear();}n.resolve(v);});},function(E){n.reject(E);});return n.promise();};g.prototype.delContainer=function(s,S){var o={},h,i="",t=this;S=t._adjustScope(S,false);i=p.addContainerPrefix(s);o=new jQuery.Deferred();h=t._pendingContainerOperations_cancelAddNext(s,null);h.always(function(){t.getContainer(s,S).fail(function(){t._pendingContainerOperations_cancelAddNext(s,o);o.reject();}).done(function(j){var A;t._pendingContainerOperations_cancelAddNext(s,o);A=S.validity===0?t._oAdapterWindowOnly:t._oAdapterWithBackendAdapter;p.loadAdapter(A).then(function(l){l.delAdapterContainer(i,S).fail(function(){o.reject();}).done(function(){o.resolve();});},function(){o.reject();});});});return o.promise();};g.prototype._pendingContainerOperations_flushAddNext=function(s,o){var h,S;h=this._oPendingOperationsMap.get(s);if(!h){h=new jQuery.Deferred();h.resolve();}if(o!==null){this._oPendingOperationsMap.put(s,o);}if(!h||h.state()!=="pending"){return h;}clearTimeout(h._sapTimeoutId);h._sapTimeoutId=undefined;if(typeof h._sapFnSave==="function"){S=h._sapFnSave;h._sapFnSave=undefined;S();}return h;};g.prototype._pendingContainerOperations_cancelAddNext=function(s,o){var h;h=this._oPendingOperationsMap.get(s);if(!h){h=new jQuery.Deferred();h.resolve();}if(o!==null){this._oPendingOperationsMap.put(s,o);}if(!h||h.state()!=="pending"){return h;}if(h._sapTimeoutId){clearTimeout(h._sapTimeoutId);h._sapTimeoutId=undefined;h.resolve(g.prototype.SAVE_DEFERRED_DROPPED);}return h;};g.prototype.getPersonalizationContainer=function(s){var h="",o={},i={};if(typeof s!=="string"){throw new u.Error("sContainerKey is not a string: sap.ushell.services.Personalization"," ");}h=p.addContainerPrefix(s);if(this._oContainerMap.containsKey(h)){return this._oContainerMap.get(h).promise();}i=new jQuery.Deferred();o=new P(this._oAdapterWithBackendAdapter.instance,h);o.done(function(j){i.resolve(j);}).fail(function(j){i.reject(j);});this._oContainerMap.put(h,i);return i.promise();};g.prototype.delPersonalizationContainer=function(s){var o={},h="",t=this;h=p.addContainerPrefix(s);o=new jQuery.Deferred();this.getPersonalizationContainer(s).fail(function(){o.reject();}).done(function(i){t._oAdapterWithBackendAdapter.instance.delAdapterContainer(h).fail(function(){o.reject();}).done(function(){t._oContainerMap.remove(h);o.resolve();});});return o.promise();};g.prototype._adjustScope=p.adjustScope;g.hasNoAdapter=false;g.ContextContainer=C;g.Variant=d;g.VariantSet=e;g.VariantSetAdapter=V;g.WindowAdapter=W;g.WindowAdapterContainer=f;return g;},true);

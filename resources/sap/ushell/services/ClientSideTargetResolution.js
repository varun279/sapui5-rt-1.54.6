// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/services/_ClientSideTargetResolution/Utils","sap/ushell/services/AppConfiguration","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ushell/services/_ClientSideTargetResolution/InboundProvider","sap/ushell/services/_ClientSideTargetResolution/InboundIndex","sap/ushell/services/_ClientSideTargetResolution/VirtualInbounds","sap/ushell/services/_ClientSideTargetResolution/Search","sap/ushell/services/_ClientSideTargetResolution/StagedLogger","sap/ushell/services/_ClientSideTargetResolution/Formatter","sap/ushell/navigationMode"],function(u,c,b,S,I,d,V,f,l,F,n){"use strict";function C(a,o,p,s){this._init.apply(this,arguments);};var g="";var O={apply:"apply",applied:"applied"};C.prototype._init=function(a,o,p,s){this._iLogId=0;if(!this._implementsServiceInterface(a)){jQuery.sap.log.error("Cannot get Inbounds","ClientSideTargetResolutionAdapter should implement getInbounds method","sap.ushell.services.ClientSideTargetResolution");return;}this._oInboundProvider=new I(a.getInbounds.bind(a));this._oHaveEasyAccessSystemsDeferreds={userMenu:null,sapMenu:null};this._validateServiceConfiguration(s);this._oServiceConfiguration=s;this._oAdapter=a;};C.prototype._validateServiceConfiguration=function(s){var e=jQuery.sap.getObject("config.enableInPlaceForClassicUIs",undefined,s),a=true;if(e){if(typeof e!=="object"){a=false;}else{Object.keys(e).forEach(function(k){if(["GUI","WDA"].indexOf(k)===-1){a=false;}else if(typeof e[k]!=="boolean"){a=false;}});}}if(!a){jQuery.sap.log.error("Invalid service configuration: 'enableInPlaceForClassicUIs' must be an object; allowed properties: GUI|WDA, type boolean","Actual config: "+JSON.stringify(s),"sap.ushell.services.ClientSideTargetResolution");}};C.prototype._implementsServiceInterface=function(a){if(typeof a.getInbounds==="function"){return true;}return false;};C.prototype._getURLParsing=function(){if(!this._oURLParsing){this._oURLParsing=sap.ushell.Container.getService("URLParsing");}return this._oURLParsing;};C.prototype.isInPlaceConfiguredFor=function(t){var e=jQuery.sap.getObject("config.enableInPlaceForClassicUIs",undefined,this._oServiceConfiguration);if(!e){return false;}return e[t]?true:false;};C.prototype._isFullLocalWDAResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWdaLocalResolution"]===false){return false;}return!(!o||!r||!(r["sap.wda"])||!(r.applicationType==="WDA"));};C.prototype._isLocalWDAResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWdaLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="WDA"));};C.prototype._isFullLocalWebguiResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r["sap.gui"])||!(r.applicationType==="TR"));};C.prototype._isLocalWebguiNowrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/~canvas;")>=0)||!(r.url.indexOf("app/transaction/APB_LPD_CALL_")===-1));};C.prototype._isLocalWebguiWrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/~canvas;")>=0)||!(r.url.indexOf("app/transaction/APB_LPD_CALL_")>=0));};C.prototype._isLocalNativeWebguiWrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableNativeWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/its/webgui")>=0)||!(r.url.indexOf("APB_LPD_CALL_")!==-1));};C.prototype._isLocalNativeWebguiNowrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableNativeWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/its/webgui")>=0)||!(r.url.indexOf("APB_LPD_CALL_")===-1));};C.prototype._hasRenameTo=function(m){return m.inbound&&m.inbound.signature&&m.inbound.signature.parameters&&Object.keys(m.inbound.signature.parameters).some(function(k){return!!(m.inbound.signature.parameters[k].renameTo);});};C.prototype._removeUnusedComplexParameterValuesFromDefaultList=function(m){m.defaultedParamNames=m.defaultedParamNames.filter(function(N){if(m.intentParamsPlusAllDefaults[N]&&!jQuery.isArray(m.intentParamsPlusAllDefaults[N])){if(!(m.resolutionResult.oNewAppStateMembers&&m.resolutionResult.oNewAppStateMembers[N])){return false;}}return true;});};C.prototype._mapDefaultParameterNames=function(m){var p=jQuery.sap.getObject("inbound.signature.parameters",undefined,m)||{},M={};m.defaultedParamNames.forEach(function(N){var s=(p[N]&&p[N].renameTo)||N;if(M[s]){jQuery.sap.log.error("renaming of defaultedParamNames creates duplicates"+N+"->"+s);}else{M[s]=true;}});m.mappedDefaultedParamNames=Object.keys(M).sort();};C.prototype._mixAppStateIntoResolutionResultAndRename=function(m,a){var D=new jQuery.Deferred(),t=this,N,s,o;function e(T){var q;t._removeUnusedComplexParameterValuesFromDefaultList(T);t._mapDefaultParameterNames(T);q=n.compute(jQuery.sap.getObject("inbound.resolutionResult.applicationType",undefined,T),(T.intentParamsPlusAllDefaults["sap-ushell-next-navmode"]||[])[0],(T.intentParamsPlusAllDefaults["sap-ushell-navmode"]||[])[0],(b.getCurrentApplication()||{}).applicationType,t._oServiceConfiguration&&t._oServiceConfiguration.config&&t._oServiceConfiguration.config.enableInPlaceForClassicUIs);u.shallowMergeObject(T.resolutionResult,q);delete T.resolutionResult.oNewAppStateMembers;D.resolve(T);}function h(m){return(m.resolutionResult.oNewAppStateMembers&&!jQuery.isEmptyObject(m.resolutionResult.oNewAppStateMembers));}function j(L,P){return jQuery.isArray(L)&&L.some(function(q){return(P.indexOf(q)!==-1);});}function k(A,P){var q,v,w;if(A&&A.selectionVariant){q=new S(JSON.stringify(A.selectionVariant));w=q.getSelectOptionsPropertyNames()||[];v=q.getParameterNames()||[];if(j(w,P)||j(v,P)){return true;}}return false;}function r(q,R,P,v){var w=new S(),x=q.getParameterNames()||[],y=q.getSelectOptionsPropertyNames()||[],z,A;x.forEach(function(B){z=q.getParameter(B);if(v&&!P[B]){R.deleted=true;return;}if(P[B]&&P[B].renameTo){if((w.getParameter(P[B].renameTo)===undefined)&&(w.getSelectOption(P[B].renameTo)===undefined)){w.addParameter(P[B].renameTo,z);R.changed=true;}else{jQuery.sap.log.error("renaming of appstate creates duplicates "+B+"->"+P[B].renameTo);}}else{if((w.getParameter(B)===undefined)&&(w.getSelectOption(B)===undefined)){w.addParameter(B,z);}}});y.forEach(function(B){A=q.getSelectOption(B);if(v&&!P[B]){R.deleted=true;return;}if(P[B]&&P[B].renameTo){if((w.getSelectOption(P[B].renameTo)===undefined)&&(w.getParameter(P[B].renameTo)===undefined)){w.massAddSelectOption(P[B].renameTo,A);R.changed=true;}else{jQuery.sap.log.error("renaming of appstate creates duplicates "+B+"->"+P[B].renameTo);}}else{if((w.getSelectOption(B)===undefined)&&(w.getParameter(B)===undefined)){w.massAddSelectOption(B,A);}}});x.forEach(function(B){q.removeParameter(B);});y.forEach(function(B){q.removeSelectOption(B);});w.getParameterNames().forEach(function(B){q.addParameter(B,w.getParameter(B));});w.getSelectOptionsPropertyNames().forEach(function(B){q.massAddSelectOption(B,w.getSelectOption(B));});return q;}function p(q){if(q===undefined||jQuery.isPlainObject(q)){return false;}return true;}function M(q){var v=q.getData()||{},w,x={};var y=m.inbound.signature;if(v.selectionVariant){w=new S(JSON.stringify(v.selectionVariant));}else{w=new S();}if(h(m)){Object.keys(m.resolutionResult.oNewAppStateMembers).forEach(function(A){w.massAddSelectOption(A,m.resolutionResult.oNewAppStateMembers[A].Ranges);});}var z=y.additionalParameters==="ignored";w=r(w,x,y.parameters,z);if(w.getParameterNames().length!==0||w.getSelectOptionsPropertyNames().length!==0||x.deleted){v.selectionVariant=w.toJSONObject();}if(!x.changed&&!x.deleted&&!h(m)){e(m);return;}q.setData(v);q.save().done(function(){m.intentParamsPlusAllDefaults["sap-xapp-state"]=[q.getKey()];m.mappedIntentParamsPlusSimpleDefaults["sap-xapp-state"]=[q.getKey()];e(m);});}if(!h(m)&&!t._hasRenameTo(m)){e(m);}else{s=m.intentParamsPlusAllDefaults["sap-xapp-state"]&&m.intentParamsPlusAllDefaults["sap-xapp-state"][0];if(s){a.getAppState(s).done(function(q){var P=c.constructParameterDominatorMap(m.inbound.signature.parameters);o=q.getData();if(p(o)){delete m.resolutionResult.oNewAppStateMembers;e(m);}if(m.resolutionResult.oNewAppStateMembers){Object.keys(m.resolutionResult.oNewAppStateMembers).forEach(function(v){var w=P[v].dominatedBy;if(k(o,w)){delete m.resolutionResult.oNewAppStateMembers[v];}});}if(!h(m)&&!t._hasRenameTo(m)){e(m);}else{N=a.createEmptyAppState(undefined,true);if(N){N.setData(q.getData());M(N);}}});}else if(h(m)){M(a.createEmptyAppState(undefined,true));}else{e(m);}}return D.promise();};C.prototype._extractInboundFilter=function(o){if(!this._oAdapter.hasSegmentedAccess){return undefined;}if(typeof o!=="string"){return undefined;}var s=o.indexOf("#")===0?o:"#"+o;var a=this._getURLParsing().parseShellHash(s);if(!a||!a.semanticObject||!a.action){return undefined;}return[{semanticObject:a.semanticObject,action:a.action}];};C.prototype.resolveHashFragment=function(h){var t=this,D=new jQuery.Deferred(),B=this._oAdapter.resolveHashFragmentFallback&&this._oAdapter.resolveHashFragmentFallback.bind(this._oAdapter),s=this._extractInboundFilter(h);this._oInboundProvider.getInbounds(s).then(function(a){t._resolveHashFragment(h,B,a).done(function(o){return D.resolve(o);}).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};C.prototype.resolveTileIntent=function(h){var t=this,D=new jQuery.Deferred(),s=this._extractInboundFilter(h);this._oInboundProvider.getInbounds(s).then(function(o){t._resolveTileIntent(h,undefined,o).done(D.resolve.bind(D)).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};C.prototype.resolveTileIntentInContext=function(a,h){var o,D=new jQuery.Deferred();o=d.createIndex(a.concat(V.getInbounds()));this._resolveTileIntent(h,undefined,o).done(D.resolve.bind(D)).fail(D.reject.bind(D));return D.promise();};C.prototype._resolveHashFragment=function(h,B,a){var U=this._getURLParsing(),t=this,D=new jQuery.Deferred(),s=h.indexOf("#")===0?h:"#"+h,e=U.parseShellHash(s);if(e===undefined){jQuery.sap.log.error("Could not parse shell hash '"+h+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return D.reject().promise();}e.formFactor=u.getFormFactor();this._getMatchingInbounds(e,a,{bExcludeTileInbounds:true}).fail(function(E){jQuery.sap.log.error("Could not resolve "+h,"_getMatchingInbounds promise rejected with: "+E,"sap.ushell.services.ClientSideTargetResolution");D.reject(E);}).done(function(m){var M;if(m.length===0){jQuery.sap.log.warning("Could not resolve "+h,"rejecting promise","sap.ushell.services.ClientSideTargetResolution");D.reject("Could not resolve navigation target");return;}M=m[0];c.whenDebugEnabled(function(){function j(K,v){return this[K]===undefined?"<undefined>":v;}function r(o,v){return(o==="_original")?undefined:j.call(this,o,v);}var k=JSON.stringify(M,r,"   ");jQuery.sap.log.debug("The following target will now be resolved",k,"sap.ushell.services.ClientSideTargetResolution");});t._resolveSingleMatchingTarget(M,B,s).done(function(o){D.resolve(o);}).fail(D.reject.bind(D));});return D.promise();};C.prototype._resolveEasyAccessMenuIntent=function(o,m,B,s){var e="Intent must be either #Shell-startGUI or #Shell-startWDA";if(o.action==="startGUI"){return this._resolveEasyAccessMenuIntentWebgui(o,m,B,s,true);}if(o.action==="startWDA"){return this._resolveEasyAccessMenuIntentWDA(o,m);}return new jQuery.Deferred().reject("The easy access menu intent "+o.semanticObject+"-"+o.action+" could not be resolved: "+e).promise();};C.prototype._resolveEasyAccessMenuIntentWDA=function(o,m){var s,a,e,D=new jQuery.Deferred(),t=this;a=o.params["sap-ui2-wd-app-id"][0];s=(jQuery.sap.getObject("params.sap-ui2-wd-conf-id",undefined,o)||[])[0];e=Object.keys(o.params).reduce(function(r,p){if(p!=="sap-ui2-wd-app-id"&&p!=="sap-ui2-wd-conf-id"){r[p]=o.params[p];}return r;},{});t._buildWdaURI(a,s,e).done(function(U){var r={url:U.toString(),applicationType:"NWBC",text:a,additionalInformation:"","sap-system":o.params["sap-system"][0]};if(m&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){r["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}D.resolve(r);}).fail(function(E){D.reject(E);});return D.promise();};C.prototype._buildNativeWebGuiURI=function(t,s){var U,o;U="/gui/sap/its/webgui?%7etransaction="+t+"&%7enosplash=1";o=new URI(U);return this._spliceSapSystemIntoURI(o,g,s,"NATIVEWEBGUI",O.apply);};C.prototype._buildWdaURI=function(a,s,o){var e,U,h,j=jQuery.extend(true,{},o);if(s){j["sap-wd-configId"]=s;}e=j["sap-system"][0];delete j["sap-system"];U="/ui2/nwbc/~canvas;window=app/wda/"+a+"/"+"?"+this._getURLParsing().paramsToString(j);h=new URI(U);return this._spliceSapSystemIntoURI(h,g,e,"WDA",O.apply);};C.prototype._resolveEasyAccessMenuIntentWebgui=function(o,m,B,s,U){var D=new jQuery.Deferred(),t=this;this._buildNativeWebGuiURI(o.params["sap-ui2-tcode"][0],o.params["sap-system"][0]).done(function(e){delete m.intentParamsPlusAllDefaults["sap-ui2-tcode"];t._mapParameterNamesAndRemoveObjects(m);t._blendParamsIntoNativeWebGUI(m,e);var a=m;if(m.resolutionResult&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){a["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}a.resolutionResult["sap-system"]=o.params["sap-system"][0];if(U){a.resolutionResult.text=o.params["sap-ui2-tcode"][0];}D.resolve(a.resolutionResult);return;});return D.promise();};C.prototype._resolveSingleMatchingTarget=function(m,B,s){var t=this,D=new jQuery.Deferred(),U=this._getURLParsing(),o=U.parseShellHash(s);if(o.semanticObject==="Shell"&&(o.action==="startWDA"||o.action==="startGUI")){return this._resolveEasyAccessMenuIntent(o,m,B,s).then(function(r){var N=n.compute(jQuery.sap.getObject("inbound.resolutionResult.applicationType",undefined,m),(m.intentParamsPlusAllDefaults["sap-ushell-next-navmode"]||[])[0],(m.intentParamsPlusAllDefaults["sap-ushell-navmode"]||[])[0],(b.getCurrentApplication()||{}),t._oServiceConfiguration&&t._oServiceConfiguration.config&&t._oServiceConfiguration.config.enableInPlaceForClassicUIs);u.shallowMergeObject(r,N);return r;});}this._mapParameterNamesAndRemoveObjects(m);this._mixAppStateIntoResolutionResultAndRename(m,sap.ushell.Container.getService("AppState")).done(function(m){var a=t._determineResultProcessor(m);delete m.intentParamsPlusAllDefaults["sap-tag"];delete m.mappedIntentParamsPlusSimpleDefaults["sap-tag"];m.mappedDefaultedParamNames=m.mappedDefaultedParamNames.filter(function(p){return p!=="sap-tag";});var e=jQuery.sap.getObject('inbound.resolutionResult.url',undefined,m);a(m,B,s,e).done(function(m){D.resolve(m.resolutionResult);jQuery.sap.log.debug("Intent was resolved to the following target",JSON.stringify(m.resolutionResult,null,3),"sap.ushell.services.ClientSideTargetResolution");}).fail(function(M){if(M.indexOf("fallback:")>=0){t._constructFallbackResolutionResult.call(this,m,B,s).fail(D.reject.bind(D)).done(function(m){D.resolve(m.resolutionResult);});}else{D.reject(M);}});});return D.promise();};C.prototype._resolveTileIntent=function(h,B,o){var U=this._getURLParsing(),t=this,D=new jQuery.Deferred(),s=h.indexOf("#")===0?h:"#"+h,a=U.parseShellHash(s);if(a===undefined){jQuery.sap.log.error("Could not parse shell hash '"+h+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return D.reject("Cannot parse shell hash").promise();}a.formFactor=u.getFormFactor();this._getMatchingInbounds(a,o,{bExcludeTileInbounds:false}).fail(function(e){jQuery.sap.log.error("Could not resolve "+h,"_getMatchingInbounds promise rejected with: "+e,"sap.ushell.services.ClientSideTargetResolution");D.reject(e);}).done(function(m){var M;if(m.length===0){jQuery.sap.log.warning("Could not resolve "+h,"no matching targets were found","sap.ushell.services.ClientSideTargetResolution");D.reject("No matching targets found");return;}M=m[0];t._resolveSingleMatchingTileIntent(M,B,s).done(D.resolve.bind(D)).fail(D.reject.bind(D));});return D.promise();};C.prototype._resolveSingleMatchingTileIntent=function(m,B,s){var D=new jQuery.Deferred(),t=this;this._mapParameterNamesAndRemoveObjects(m);this._mixAppStateIntoResolutionResultAndRename(m,sap.ushell.Container.getService("AppState")).done(function(m){var a=t._determineResultProcessor(m);delete m.intentParamsPlusAllDefaults["sap-tag"];delete m.mappedIntentParamsPlusSimpleDefaults["sap-tag"];m.mappedDefaultedParamNames=m.mappedDefaultedParamNames.filter(function(p){return p!=="sap-tag";});var e=jQuery.sap.getObject('inbound.resolutionResult.url',undefined,m);a(m,B,s,e).done(function(m){var T=jQuery.extend(true,{},m.inbound.tileResolutionResult);T.startupParameters=m.effectiveParameters;T.navigationMode=m.resolutionResult.navigationMode;if(!T.navigationMode){T.navigationMode=n.getNavigationMode(m.resolutionResult)}D.resolve(T);jQuery.sap.log.debug("Tile Intent was resolved to the following target",JSON.stringify(T,null,3),"sap.ushell.services.ClientSideTargetResolution");}).fail(function(M){D.reject(M);});});return D.promise();};C.prototype._determineResultProcessor=function(m){var o=m.inbound,r=o&&o.resolutionResult;function a(P,R){jQuery.sap.log.debug("Resolution result will be constructed via "+P+" processor",R,"sap.ushell.services.ClientSideTargetResolution");}if(!o||!r){a("FALLBACK","the inbound or the inbound resolutionResult member was not available");return this._constructFallbackResolutionResult.bind(this);}if(r.applicationType==="SAPUI5"){a("SAPUI5","inbound resolutionResult had SAPUI5 applicationType");return this._constructSAPUI5ResolutionResult.bind(this);}var e=this._isFullLocalWDAResolution(m);if(e){a("WDA full url construction");return this._constructFullWDAResolutionResult.bind(this);}var h=this._isLocalWDAResolution(m);if(h){a("WDA");return this._constructWDAResolutionResult.bind(this);}var j=this._isFullLocalWebguiResolution(m);if(j){a("NON-WRAPPED WEBGUI full url construction");return this._constructFullWebguiResolutionResult.bind(this);}var k=this._isLocalWebguiNowrapResolution(m);if(k){a("NON-WRAPPED WEBGUI");return this._constructWebguiNowrapResult.bind(this);}var p=this._isLocalWebguiWrapResolution(m);if(p){a("WRAPPED WEBGUI");return this._constructWebguiWrapResult.bind(this);}var q=this._isLocalNativeWebguiNowrapResolution(m);if(q){a("NATIVE NON-WRAPPED WEBGUI");return this._constructNativeWebguiNowrapResult.bind(this);}var s=this._isLocalNativeWebguiWrapResolution(m);if(s){a("NATIVE WRAPPED WEBGUI");return this._constructNativeWebguiWrapResult.bind(this);}if(r.applicationType==="URL"){a("URL","inbound resolutionResult had URL applicationType");return this._constructURLResolutionResult.bind(this);}a("FALLBACK","could not apply any result processor to inbound resolutionResult: "+JSON.stringify(r,null,"   "));return this._constructFallbackResolutionResult.bind(this);};C.prototype._stripURI=function(U,s,a){var D=new jQuery.Deferred(),t=this;if(typeof s==="undefined"){this._stripURIWithSystemAlias(U,s,a,undefined).fail(function(e){D.reject(e);}).done(function(N){D.resolve(N);});return D.promise();}this._resolveSystemAlias(s).fail(function(e){D.reject(e);}).done(function(r){t._stripURIWithSystemAlias(U,s,a,r).fail(function(e){D.reject(e);}).done(function(N){D.resolve(N);});});return D.promise();};C.prototype._resolveSystemAlias=function(s){if(typeof this._oAdapter.resolveSystemAlias!=="function"){return new jQuery.Deferred().reject("fallback: the adapter does not implement resolveSystemAlias").promise();}return this._oAdapter.resolveSystemAlias(s);};C.prototype._stripURIWithSystemAlias=function(U,s,a,r){var t=this,o,e,T,h,D=new jQuery.Deferred(),p=new jQuery.Deferred();U.protocol("");U.hostname("");U.port("");t._removeParametersFromURI(U,["sap-client","sap-language"]);if(!jQuery.isPlainObject(r)||typeof s!=="string"){return D.resolve(U).promise();}e=t._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol());o=r[e];h=(typeof o.pathPrefix==="string")&&o.pathPrefix;if(h!==""){p.resolve(h);}else{this._resolveSystemAlias("").fail(function(E){D.reject(E);}).done(function(R){var j=R[e];p.resolve(j.pathPrefix);});}p.fail(function(E){D.reject(E);}).done(function(h){if(h&&h.length>0){T=U.path();T=T.replace(h,"");if(T.indexOf("/")!==0){T="/"+T;}U.path(T);}if(a==="NATIVEWEBGUI"&&r.hasOwnProperty("rfc")){T=U.path();T=T.split(";").filter(function(P){return P.indexOf("~sysid=")!==0&&P.indexOf("~service=")!==0&&P.indexOf("~loginGroup=")!==0&&P.indexOf("~messageServer=")!==0&&P.indexOf("~sncNameR3=")!==0&&P.indexOf("~sncQoPR3=")!==0;}).join(";");U.path(T);}D.resolve(U);});return D.promise();};C.prototype._removeParametersFromURI=function(U,p){var B={},t;p.forEach(function(P){B[P]=true;});t=U.query();t=t.split("&").filter(function(P){var s=(P.split("=")[0]||"").toLowerCase();return!B.hasOwnProperty(s);}).join("&");U.query(t);};C.prototype._spliceSapSystemIntoUrlURI=function(U,s,a){var t=this,D=new jQuery.Deferred();if(s===g||typeof s==="undefined"){if(this._isAbsoluteURI(U)){return D.resolve(U);}t._applyAliasToURI(a,U,"URL").fail(function(e){D.reject(e);}).done(function(o){D.resolve(o);});return D.promise();}this._resolveSystemAlias(s).fail(function(e){D.reject(e);}).done(function(r){var e=t._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),o=r[e],h;if((U.protocol()||"").toLowerCase()===e&&(U.hostname()||"")===o.host&&(U.path().indexOf(o.pathPrefix)===0)){U.protocol("");U.hostname("");h=U.path().replace(o.pathPrefix,"");U.path(h);t._removeParametersFromURI(U,["sap-language","sap-client"]);t._applyAliasToURI(a,U,"URL").fail(function(E){D.reject(E);}).done(function(j){D.resolve(j);});}else{D.resolve(U);}});return D.promise();};C.prototype._spliceSapSystemIntoURI=function(U,s,a,e,h){var D=new jQuery.Deferred(),t=this;if(h!==O.apply&&h!==O.applied){throw new Error("Invalid system alias semantic was provided: '"+h+"'");}if(h===O.applied&&(typeof a==="undefined"||s===a)){return D.resolve(U).promise();}if(h===O.apply&&typeof s==="undefined"&&typeof a==="undefined"){return D.resolve(U).promise();}if(e==="URL"&&h==O.applied){return this._spliceSapSystemIntoUrlURI(U,s,a);}(new Promise(function(r){if(h===O.apply){r({targetUri:U,alias:a?a:s});return;}t._stripURI(U,s,e).fail(function(E){D.reject(E);}).done(function(o){r({targetUri:o,alias:a});});})).then(function(A){t._applyAliasToURI(A.alias,A.targetUri,e).fail(function(E){D.reject(E);}).done(function(o){D.resolve(o);});});return D.promise();};C.prototype._applyAliasToURI=function(s,U,a){var t=this,N=U,D=new jQuery.Deferred();this._resolveSystemAlias(s).fail(function(e){D.reject(e);}).done(function(r){var v=t._validateResolvedSystemAlias(r);if(!v.isValid){t._reportResolvedSystemAliasValidationErrors(v);D.reject("Invalid system alias definition");return D;}var e=t._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),o=r[e],q,L,h;if(s===g&&o.host===""&&(o.port===0||o.port==="")){e="";}N.protocol(e);N.hostname(o.host);N.port(o.port);t._interpolatePathPrefixIntoURI(N,a,o.pathPrefix).fail(function(E){D.reject(E);}).done(function(N){q=N.query();if(typeof r.client==="string"&&r.client!==""){q=q+(q.length>0?"&":"")+"sap-client="+r.client;}if(typeof r.language==="string"&&r.language!==""){L=r.language;}else{h=sap.ushell.Container.getUser();if(!h){jQuery.sap.log.error("Cannot retieve the User object via sap.ushell.Container while determining sap-language","will default to 'en' language","sap.ushell.services.ClientSideTargetResolution");L="en";}else{L=h.getLanguage();}}q=q+(q.length>0?"&":"")+"sap-language="+L;N.query(q);N=t._interpolateNativeWebguiDataIntoURI(r,N,a);D.resolve(N);});});return D.promise();};C.prototype._interpolateNativeWebguiDataIntoURI=function(s,U,a){var e,t,h,p;if(s.hasOwnProperty("rfc")&&a==="NATIVEWEBGUI"){h=s.rfc;e=!!h.systemId;if(e){t=[h.systemId&&("~sysid="+h.systemId),h.loginGroup&&("~loginGroup="+h.loginGroup),h.sncNameR3&&("~messageServer="+encodeURIComponent(h.sncNameR3)),h.sncNameR3&&("~sncNameR3="+encodeURIComponent(h.sncNameR3)),h.sncQoPR3&&("~sncQoPR3="+h.sncQoPR3)].filter(function(o){return(typeof o==="string")&&(o!=="");});}else{t=[h.service&&("~service="+h.service),h.sncNameR3&&("~sncNameR3="+encodeURIComponent(h.sncNameR3)),h.sncQoPR3&&("~sncQoPR3="+h.sncQoPR3)].filter(function(o){return(typeof o==="string")&&(o!=="");});}p=U.path()+";"+t.join(";").replace(/(%[A-F0-9]{2})/g,function(E){return E.toLowerCase();});U.path(p);U._parts.path=p;}return U;};C.prototype._interpolatePathPrefixIntoURI=function(U,s,p){var t=this,D=new jQuery.Deferred(),T;if(s==="URL"&&p.length===0){return D.resolve(U).promise();}function a(P){var r=P+U.path();U.path(r.replace(/\/+/g,"/"));D.resolve(U);}if(p.length>0){if((s==="WDA"||s==="WEBGUI")&&U.path().indexOf("~canvas")>=0){T=U.path();T="/~canvas"+T.split("~canvas")[1];U.path(T);}a(p);}else{this._resolveSystemAlias("").fail(function(e){D.reject(e);}).done(function(r){var e=t._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),P=r[e].pathPrefix;a(P);});}return D.promise();};C.prototype._selectSystemAliasDataName=function(s,B){if(s.hasOwnProperty("https")){return"https";}if(s.hasOwnProperty("http")){return"http";}jQuery.sap.log.error("Cannot select which system alias to pick between http/https","make sure they are provided in the given system alias collection","sap.ushell.services.ClientSideTargetResolution");return undefined;};C.prototype._getRenameParameterName=function(p,s,P){if(!P||!jQuery.isArray(P)){return p;}if(s&&s.parameters&&s.parameters[p]&&s.parameters[p].renameTo){return s.parameters[p].renameTo;}return p;};C.prototype._mapParameterNamesAndRemoveObjects=function(m){var t=this,N={},o=m.intentParamsPlusAllDefaults;Object.keys(o).sort().forEach(function(p){var r=t._getRenameParameterName(p,m.inbound.signature,o[p]);if(jQuery.isArray(m.intentParamsPlusAllDefaults[p])){if(N[r]){jQuery.sap.log.error("collision of values during parameter mapping : \""+p+"\" -> \""+r+"\"");}else{N[r]=m.intentParamsPlusAllDefaults[p];}}});m.mappedIntentParamsPlusSimpleDefaults=N;};C.prototype._constructFullWDAResolutionResult=function(m,B,s){var t=this,o=jQuery.sap.getObject("inbound.resolutionResult",undefined,m),D=new jQuery.Deferred();t._buildWdaURI(o["sap.wda"].applicationId,o["sap.wda"].configId,{"sap-system":[o.systemAlias]}).done(function(w){var M=m.mappedIntentParamsPlusSimpleDefaults;t._constructWDAURLParameters(M,m.mappedDefaultedParamNames).then(function(U){var a=t._appendParametersToURI(w,U);var e=M["sap-system"]&&M["sap-system"][0];var r=t._createWDAResolutionResult(m.inbound,a,e);u.shallowMergeObject(m.resolutionResult,r);D.resolve(m);},function(e){D.reject(e);});}).fail(function(e){D.reject(e);});return D.promise();};C.prototype._constructFullWebguiResolutionResult=function(m,B,s){var t=this,o=m.inbound,r=o&&o.resolutionResult,D=new jQuery.Deferred();this._buildNativeWebGuiURI(o.resolutionResult["sap.gui"].transaction,r.systemAlias).done(function(U){t._mapParameterNamesAndRemoveObjects(m);t._blendParamsIntoNativeWebGUI(m,U);if(m.resolutionResult&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){m.resolutionResult["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}m.resolutionResult["sap-system"]=r.systemAlias;D.resolve(m);}).fail(function(M){D.reject(M);});return D.promise();};C.prototype._constructWDAResolutionResult=function(m,B,s,a){var t=this,o=m.inbound,r=o&&o.resolutionResult,M=m.mappedIntentParamsPlusSimpleDefaults,D=new jQuery.Deferred();var w=new URI(a);var e=M["sap-system"]&&M["sap-system"][0];Promise.all([(new Promise(function(h){t._spliceSapSystemIntoURI(w,r.systemAlias,e,"WDA",r.systemAliasSemantics||O.applied).fail(D.reject.bind(D)).done(function(w){h(w);});})),t._constructWDAURLParameters(M,m.mappedDefaultedParamNames)]).then(function(R){var W=R[0];var U=R[1];var h=t._appendParametersToURI(W,U);var r=t._createWDAResolutionResult(o,h,e);u.shallowMergeObject(m.resolutionResult,r);D.resolve(m);},function(E){D.reject(E);});return D.promise();};C.prototype._createWDAResolutionResult=function(o,s,a){var r={"sap-system":a,url:s,text:o.title,applicationType:"NWBC"};["additionalInformation","applicationDependencies"].forEach(function(p){if(o.resolutionResult.hasOwnProperty(p)){r[p]=o.resolutionResult[p];}});return r;};C.prototype._appendParametersToURI=function(U,s){var p=U.search();if(s){p=p+((p.indexOf("?")<0)?"?":"&")+s;}return U.search(p).toString();};C.prototype._constructWDAURLParameters=function(p,m){var t=this;return new Promise(function(r,R){var e=jQuery.extend(true,{},p);if(m.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(m)];}delete e["sap-system"];sap.ushell.Container.getService("ShellNavigation").compactParams(e,["sap-xapp-state","sap-ushell-defaultedParameterNames","sap-intent-params"],undefined,true).fail(function(E){R(E);}).done(function(E){var s=t._getURLParsing().paramsToString(E);r(s);});});};C.prototype._constructWebguiNowrapResult=function(m,B,s,a){var t=this,o=m.inbound,r=o&&o.resolutionResult,D=new jQuery.Deferred();var w=new URI(a);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var h=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=h;delete e["sap-system"];var U=t._getUnnecessaryWebguiParameters(e,o||{});this._removeObjectKey(e,U);t._spliceSapSystemIntoURI(w,r.systemAlias,h,"WEBGUI",r.systemAliasSemantics||O.applied).fail(D.reject.bind(D)).done(function(w){var E=t._getURLParsing().paramsToString(e);var p=w.search();if(E){p=p+((p.indexOf("?")<0)?"?":"&")+E;}w.search(p);["additionalInformation","applicationDependencies"].forEach(function(P){if(o.resolutionResult.hasOwnProperty(P)){m.resolutionResult[P]=o.resolutionResult[P];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=o.title;m.resolutionResult.applicationType="NWBC";D.resolve(m);});return D.promise();};C.prototype._constructWebguiWrapResult=function(m,B,s,a){var t=this,o=m.inbound,r=o&&o.resolutionResult,D=new jQuery.Deferred();var w=new URI(a);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var h=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=h;delete e["sap-system"];t._spliceSapSystemIntoURI(w,r.systemAlias,h,"WEBGUI",r.systemAliasSemantics||O.applied).fail(D.reject.bind(D)).done(function(w){var p=w.search();p=t._injectEffectiveParametersIntoWebguiPobjectParam(p,e,"&","=");w.search(p);["additionalInformation","applicationDependencies"].forEach(function(P){if(o.resolutionResult.hasOwnProperty(P)){m.resolutionResult[P]=o.resolutionResult[P];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=o.title;m.resolutionResult.applicationType="NWBC";D.resolve(m);});return D.promise();};C.prototype._injectEffectiveParametersIntoWebguiPobjectParam=function(q,p,Q,s){var a,P="P_OBJECT"+s,m=132;var e=this._getURLParsing().privparamsToString(p,"%25","%21");if(!e){return q;}var h="";this._amendGuiParam("P_OBJECT",q,Q,s,function(j){var k=j.replace(P,"");h=decodeURIComponent(k);if(h.length>0){h=h+"%25";}return P;});e=h+e;var o={pObjX:"",pObject:""};e.match(new RegExp(".{1,"+m+"}","g")).map(function(j){return encodeURIComponent(j);}).forEach(function(j,G){var k="P_OBJECT";var r="pObject";if(G>0){k="P_OBJ"+G;r="pObjX";}var t=o[r].length===0?"":Q;o[r]=o[r]+t+k+s+j;});a=[o.pObjX,o.pObject].filter(function(j){return j.length>0;}).join(Q);var A=this._amendGuiParam("P_OBJECT",q,Q,s,function(j){return a;});if(A.found){return A.query;}return q+(q.length===0?"":Q)+a;};C.prototype._amendGuiParam=function(t,q,Q,s,a){var e=false,p=t+s;var A=q.split(Q).map(function(P){if(P.indexOf(p)!==0){return P;}e=true;return a(P);}).filter(function(P){return typeof P!=="undefined";}).join(Q);return{found:e,query:A};};C.prototype._parseWebguiTransactionQueryParam=function(t){var T="^(.+?)(%20|(%20)(.+))?$",r=new RegExp(T,"i"),s,p={hasParameters:null,transactionParamName:"",transactionCode:"",parameters:[]};var P=t.split("=");if(P.length>2){return{"error":"Found more than one assignment ('=') in the transaction query parameter","details":"Only one '=' sign is expected in "+t};}if(P.length<2||typeof P[1]==="undefined"||P[1].length===0){return{"error":"The transaction query parameter must specify at least the transaction name","details":"Got "+t+" instead."};}p.transactionParamName=P[0];s=P[1];var m=s.match(r);if(!m){return{"error":"Cannot parse ~transaction query parameter value.","details":s+" should match /"+T+"/"};}p.transactionCode=m[1];if(m[2]&&m[2]!=="%20"){var a=m[4]||"";a.split("%3b").forEach(function(N){var e=N.split("%3d"),h=e[0];if(h&&typeof h==="string"&&h.length>0){p.parameters.push({name:h,value:e[1]});}});}p.hasParameters=false;if(p.parameters.length>0){p.hasParameters=true;p.transactionCode=p.transactionCode.replace(/^[*]/,"");}return p;};C.prototype._injectEffectiveParametersIntoWebguiQueryParam=function(t,p){var P=this._parseWebguiTransactionQueryParam(t);if(P.error){jQuery.sap.log.error(P.error,P.details,"sap.ushell.services.ClientSideTargetResolution");return t;}var a=P.parameters.map(function(e){return e.name.toUpperCase()+"%3d"+e.value;});var o={};Object.keys(p).forEach(function(k){o[k.toUpperCase()]=p[k];});var s=this._getURLParsing().privparamsToString(o,"%3b","%3d");if(s){a.push(s);}var h=a.length>0;return P.transactionParamName+"="+(h?"*":"")+P.transactionCode+(h?"%20":"")+a.join("%3b");};C.prototype._constructNativeWebguiWrapResult=function(m,B,s,a){var t=this,o=m.inbound,r=o&&o.resolutionResult,D=new jQuery.Deferred();var w=new URI(a);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var h=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=h;delete e["sap-system"];t._spliceSapSystemIntoURI(w,r.systemAlias,h,"NATIVEWEBGUI",r.systemAliasSemantics||O.applied).fail(D.reject.bind(D)).done(function(w){var p=w.search();var P=p.split("&").map(function(q){var j;if(q.indexOf("?%7etransaction")===0||q.indexOf("%7etransaction")===0){j=t._injectEffectiveParametersIntoWebguiPobjectParam(q,e,"%3b","%3d");return j;}return q;}).join("&");w.search(P);["additionalInformation","applicationDependencies"].forEach(function(j){if(o.resolutionResult.hasOwnProperty(j)){m.resolutionResult[j]=o.resolutionResult[j];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=o.title;m.resolutionResult.applicationType="TR";D.resolve(m);});return D.promise();};C.prototype._isWebguiBusinessParameter=function(N,v){var a;if(arguments.length===1){a=N.split(/[=](.+)?/);if(a.length>1){return this._isWebguiBusinessParameter.apply(this,a);}}return!(N.indexOf("sap-")===0||N.charAt(0)==="~");};C.prototype._getWebguiNonBusinessParameters=function(p){var t=this,N;N=c.filterObject(p,function(k,v){return!t._isWebguiBusinessParameter(k,v);});return N;};C.prototype._getWebguiBusinessParameters=function(p){var B=c.filterObject(p,this._isWebguiBusinessParameter);return B;};function i(p,o){return o&&o.signature&&o.signature&&o.signature.parameters&&o.signature.parameters[p]&&o.signature.parameters[p].required===true;}C.prototype._getUnnecessaryWebguiParameters=function(e,o){var a=i("DYNP_OKCODE",o)||i("DYNP_NO1ST",o);var B=[];if(a){return[];}var h=this._getWebguiBusinessParameters(e);function j(s){return s.toUpperCase();}var N=Object.keys(h).map(j).sort();function k(A,m){if(A.length!==m.length){return false;}return A.every(function(U,p){return A[p]==m[p];});}if(k(["DYNP_NO1ST","DYNP_OKCODE"],N)||k(["DYNP_OKCODE"],N)||k(["DYNP_NO1ST"],N)){B=Object.keys(h);}return B;};C.prototype._constructNativeWebguiNowrapResult=function(m,B,s,a){var t=this,o=m.inbound,r=o&&o.resolutionResult,D=new jQuery.Deferred(),e={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true};var w=new URI(a);var E=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var h=E["sap-system"]&&E["sap-system"][0];m.resolutionResult["sap-system"]=h;Object.keys(E).forEach(function(p){if(e[p.toLowerCase()]){delete E[p];}});t._spliceSapSystemIntoURI(w,r.systemAlias,h,"NATIVEWEBGUI",r.systemAliasSemantics||O.applied).fail(D.reject.bind(D)).done(function(w){t._blendParamsIntoNativeWebGUI(m,w);D.resolve(m);});return D.promise();};C.prototype._removeObjectKey=function(o,k){k.forEach(function(K){delete o[K];});};C.prototype._blendParamsIntoNativeWebGUI=function(m,w){var t=this,o=m.inbound,a={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true};var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;Object.keys(e).forEach(function(j){if(a[j.toLowerCase()]){delete e[j];}});var U=t._getUnnecessaryWebguiParameters(e,o||{});this._removeObjectKey(e,U);var E=this._getWebguiNonBusinessParameters(e);this._removeObjectKey(e,Object.keys(E));var p=w.search();var P=p.split("&").map(function(q){var N;if(!t._isWebguiBusinessParameter(q)){if(q.indexOf("=")>=0){N=q.split("=");if(!E.hasOwnProperty(N[0])){E[N[0]]=N[1];}}else{jQuery.sap.log.error("Found no '=' separator of Webgui non-business parameter. Parameter will be skipped.","'"+q+"'","sap.ushell.services.ClientSideTargetResolution");}return undefined;}var j;if(q.indexOf("?%7etransaction")===0||q.indexOf("%7etransaction")===0){j=t._injectEffectiveParametersIntoWebguiQueryParam(q,e,"%3b","%3d");return j;}return q;}).filter(function(j){return typeof j!=="undefined";}).join("&");var h=t._getURLParsing().paramsToString(E);P=[P,h.replace("~","%7e")].join("&");w.search(P);["additionalInformation","applicationDependencies","sap.platform.runtime"].forEach(function(j){if(o.resolutionResult.hasOwnProperty(j)){m.resolutionResult[j]=o.resolutionResult[j];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=o.title;m.resolutionResult.applicationType="TR";return m;};C.prototype._constructSAPUI5ResolutionResult=function(m,B,s,a){var o=m.inbound,D=new jQuery.Deferred(),U,e,E;["applicationType","additionalInformation","applicationDependencies"].forEach(function(p){if(o.resolutionResult.hasOwnProperty(p)){m.resolutionResult[p]=o.resolutionResult[p];}});m.resolutionResult.url=a;if(m.resolutionResult.applicationDependencies&&typeof m.resolutionResult.url==="undefined"){m.resolutionResult.url="";}if(typeof m.resolutionResult.url==="undefined"){return D.reject("Cannot resolve intent: url was not specified in matched inbound").promise();}E=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);m.resolutionResult.reservedParameters={};var r={"sap-ui-fl-max-layer":true,"sap-ui-fl-control-variant-id":true};Object.keys(r).forEach(function(N){var v=E[N];if(v){delete E[N];m.resolutionResult.reservedParameters[N]=v;}});m.mappedDefaultedParamNames=m.mappedDefaultedParamNames.filter(function(h){return!r[h];});if(m.mappedDefaultedParamNames.length>0){E["sap-ushell-defaultedParameterNames"]=[JSON.stringify(m.mappedDefaultedParamNames)];}e=E["sap-system"]&&E["sap-system"][0];m.resolutionResult["sap-system"]=e;m.effectiveParameters=E;U=this._getURLParsing().paramsToString(E);if(U){m.resolutionResult.url=a+((a.indexOf("?")<0)?"?":"&")+U;}if(typeof o.resolutionResult.ui5ComponentName!=="undefined"){m.resolutionResult.ui5ComponentName=o.resolutionResult.ui5ComponentName;}m.resolutionResult.text=o.title;D.resolve(m);return D.promise();};C.prototype._isAbsoluteURI=function(U){return(U.protocol()||"").length>0;};C.prototype._absoluteUrlDefinedByUser=function(U,s,a){if(!a||a===O.applied){return this._isAbsoluteURI(U)&&!s;}if(a===O.apply){return this._isAbsoluteURI(U);}throw new Error("Invalid system alias semantics: '"+a+"'");};C.prototype._constructURLResolutionResult=function(m,B,s,a){var t=this,o=m.inbound,r=o&&o.resolutionResult,D=new jQuery.Deferred();var U=new URI(a);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);if(m.inbound&&m.inbound.action==="launchURL"&&m.inbound.semanticObject==="Shell"){delete e["sap-external-url"];}var h=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=h;delete e["sap-system"];(new Promise(function(j){if(t._absoluteUrlDefinedByUser(U,r.systemAlias,r.systemAliasSemantics)){j(a);}else{t._spliceSapSystemIntoURI(U,r.systemAlias,h,"URL",r.systemAliasSemantics||O.applied).fail(D.reject.bind(D)).done(function(k){var p=k.toString();j(p);});}})).then(function(j){var p=t._getURLParsing().paramsToString(e);return t._appendParametersToUrl(p,j);}).then(function(j){["additionalInformation","applicationDependencies"].forEach(function(p){if(o.resolutionResult.hasOwnProperty(p)){m.resolutionResult[p]=o.resolutionResult[p];}});m.resolutionResult.url=j;m.resolutionResult.text=o.title;m.resolutionResult.applicationType="URL";D.resolve(m);});return D.promise();};C.prototype._appendParametersToUrl=function(p,U){var s,a;if(p){var e=U.match(/#.*/);if(e){a=e;s=U.replace(e,"");}else{s=U;a="";}U=s+((U.indexOf("?")<0)?"?":"&")+p+a;}return U;};C.prototype._constructFallbackResolutionResult=function(m,B,s){var D=new jQuery.Deferred(),e={},a;Object.keys(m.intentParamsPlusAllDefaults).forEach(function(p){if(jQuery.isArray(m.intentParamsPlusAllDefaults[p])){e[p]=m.intentParamsPlusAllDefaults[p];}});a=m.mappedDefaultedParamNames||m.defaultedParamNames;if(a.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(a)];}if(typeof B!=="function"){jQuery.sap.log.error("Cannot resolve hash fragment",s+" has matched an inbound that cannot be resolved client side"+" and no resolveHashFragmentFallback method was implemented in ClientSideTargetResolutionAdapter","sap.ushell.services.ClientSideTargetResolution");D.reject("Cannot resolve hash fragment: no fallback provided.");return D.promise();}jQuery.sap.log.warning("Cannot resolve hash fragment client side",s+" has matched an inbound that cannot be resolved client side. Using fallback logic","sap.ushell.services.ClientSideTargetResolution");B(s,jQuery.extend(true,{},m.inbound),e).done(function(r){["applicationType","additionalInformation","url","applicationDependencies","text"].forEach(function(p){if(r.hasOwnProperty(p)){m.resolutionResult[p]=r[p];}});D.resolve(m);}).fail(D.reject.bind(D));return D.promise();};C.prototype.getDistinctSemanticObjects=function(){var D=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(o){var s={};o.getAllInbounds().forEach(function(a){if(typeof a.semanticObject==="string"&&a.semanticObject!=="*"&&!a.hideIntentLink&&a.semanticObject.length>0){s[a.semanticObject]=true;}});D.resolve(Object.keys(s).sort());},function(){D.reject.apply(D,arguments);});return D.promise();};C.prototype.getLinks=function(a){var N,t=this,s,p,e,D=new jQuery.Deferred(),o;if(arguments.length===1&&jQuery.isPlainObject(arguments[0])){N=arguments[0];o=jQuery.extend(true,{},N);["action","semanticObject"].forEach(function(A){if(N.hasOwnProperty(A)){o[A]=N[A];}});if(o.appStateKey){o.params=o.params||{};o.params["sap-xapp-state"]=[o.appStateKey];delete o.appStateKey;}}else if(arguments.length<=3){jQuery.sap.log.warning("Passing positional arguments to getLinks is deprecated","Please use nominal arguments instead","sap.ushell.services.ClientSideTargetResolution");s=arguments[0];p=arguments[1];e=arguments[2];o={semanticObject:s,params:p,ignoreFormFactor:e};}else{return D.reject("invalid arguments for getLinks").promise();}this._oInboundProvider.getInbounds().then(function(h){t._getLinks(o,h).done(D.resolve.bind(D)).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};C.prototype._validateGetSemanticObjectLinksArgs=function(a){var s=a.semanticObject,A=a.action,e=!a.hasOwnProperty("action");if(typeof s!=="undefined"||e){if(typeof s!=="string"){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must be a string, got "+Object.prototype.toString.call(s)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}if(e&&s.match(/^\s+$/)){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must be a non-empty string, got '"+s+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}if(!e&&s.length===0){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must not be an empty string, got '"+s+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}}if(typeof A!=="undefined"){if(typeof A!=="string"){jQuery.sap.log.error("invalid input for _getLinks","the action must be a string, got "+Object.prototype.toString.call(A)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action";}if(A.length===0){jQuery.sap.log.error("invalid input for _getLinks","the action must not be an empty string, got '"+A+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action";}}return undefined;};C.prototype._getLinks=function(a,o){var s=a.semanticObject,A=a.action,p=a.params,w=!!a.withAtLeastOneUsedParam,t=!!a.treatTechHintAsFilter,e=a.ignoreFormFactor,h=a.hasOwnProperty("sortResultsBy")?a.sortResultsBy:"intent";if(a.hasOwnProperty("sortResultOnTexts")){jQuery.sap.log.warning("the parameter 'sortResultOnTexts' was experimantal and is no longer supported","getLinks results will be sorted by '"+h+"'","sap.ushell.services.ClientsideTargetResolution");}var j={bExcludeTileInbounds:true};var E=this._validateGetSemanticObjectLinksArgs(a);if(a.tags){j.tags=a.tags;}if(E){return new jQuery.Deferred().reject(E).promise();}if(s==="*"){return jQuery.when([]);}function k(U,p){var B=U.paramsToString(p);return B?"?"+B:"";}var U=this._getURLParsing(),D=new jQuery.Deferred(),m=u.getFormFactor(),q=U.parseParameters(k(U,p)),r={semanticObject:(s===""?undefined:s),action:A,formFactor:(e?undefined:m),params:q};if(t){r.treatTechHintAsFilter=true;}this._getMatchingInbounds(r,o,j).done(function(M){var v={},R=M.map(function(y){var z=s||y.inbound.semanticObject,B="#"+z+"-"+y.inbound.action,N;if(z==="*"){return undefined;}if(y.inbound.action==="*"){return undefined;}if(y.inbound&&y.inbound.hasOwnProperty("hideIntentLink")&&y.inbound.hideIntentLink===true){return undefined;}if(!v.hasOwnProperty(B)){v[B]={matchingInbound:y.inbound,count:1};if(y.inbound.signature.additionalParameters==="ignored"){N=c.filterObjectKeys(q,function(P){return(P.indexOf("sap-")===0)||y.inbound.signature.parameters.hasOwnProperty(P);},false);}else{N=q;}if(w){var G=Object.keys(N).some(function(P){return P.indexOf("sap-")!==0;});if(!G){v[B].hideReason="getLinks called with 'withAtLeastOneUsedParam = true', but the inbound had no business parameters defined.";return undefined;}}var J=c.inboundSignatureMeetsParameterOptions(y.inbound.signature.parameters,a.paramsOptions||[]);if(!J){v[B].hideReason="inbound signature does not meet the requested parameter filter options";return undefined;}var K={"intent":B+k(U,N),"text":y.inbound.title};if(y.inbound.icon){K.icon=y.inbound.icon;}if(y.inbound.subTitle){K.subTitle=y.inbound.subTitle;}if(y.inbound.shortTitle){K.shortTitle=y.inbound.shortTitle;}var L=jQuery.sap.getObject('inbound.signature.parameters.sap-tag.defaultValue.value',undefined,y);if(L){K.tags=[L];}return K;}else{v[B].count++;}return undefined;}).filter(function(y){return typeof y==="object";});if(h!=="priority"){R.sort(function(G,y){return G[h]<y[h]?-1:1;});}if(R.length===0){jQuery.sap.log.debug("_getLinks returned no results");}else if(jQuery.sap.log.getLevel()>=jQuery.sap.log.Level.DEBUG){if(jQuery.sap.log.getLevel()>=jQuery.sap.log.Level.TRACE){var x=[];var H=[];R.forEach(function(y){var z=y.intent.split("?")[0];if(v[z].hideReason){H.push(["-",z+"("+v[z].hideReason+")\n"," text:",y.text+"\n"," full intent:",y.intent].join(" "));}else{x.push(["-",z,v[z].count>1?"("+(v[z].count-1)+" others matched)\n":"\n","text:",y.text+"\n","full intent:",y.intent].join(" "));}});jQuery.sap.log.debug("_getLinks filtered to the following unique intents:","\n"+x.join("\n"),"sap.ushell.services.ClientSideTargetResolution");jQuery.sap.log.debug("_getLinks would have also returned the following unique intents, but something prevented this:",H.join("\n"),"sap.ushell.services.ClientSideTargetResolution");}else{jQuery.sap.log.debug("_getLinks filtered to unique intents.","Reporting histogram: \n - "+Object.keys(v).join("\n - "),"sap.ushell.services.ClientSideTargetResolution");}}D.resolve(R);}).fail(D.reject.bind(D));return D.promise();};C.prototype._getMatchingInbounds=function(s,o,a){var t=this,T,A,L,e,h,E,p,D=new jQuery.Deferred();if(a){T=a.tags;E=a.bExcludeTileInbounds;}c.whenDebugEnabled(function(){L=++t._iLogId;});l.begin(function(){function j(m){var q=m.action||(typeof m.action==="undefined"?"<any>":"<invalid-value>");var r=m.semanticObject||(typeof m.semanticObject==="undefined"?"<any>":"<invalid-value>");return t._getURLParsing().constructShellHash({semanticObject:r,action:q,params:m.params});}var k=j(s);return{logId:L,title:"Matching Intent '"+k+"' to inbounds (form factor: "+(s.formFactor||'<any>')+")",moduleName:"sap.ushell.services.ClientSideTargetResolution",stages:["STAGE1: Find matching inbounds","STAGE2: Resolve references","STAGE3: Rematch with references","STAGE4: Sort matched targets"]};});h=s.semanticObject;A=s.action;e=T?o.getSegmentByTags(T):o.getSegment(h,A);if(E){p=e.filter(function(j){return!j.tileResolutionResult||!j.tileResolutionResult.isCustomTile;});}else{p=e;}f.match(s,p,{},c.isDebugEnabled()).then(function(j){l.log(function(){return{logId:L,stage:1,prefix:"\u2718",lines:Object.keys(j.noMatchReasons||{}).map(function(k){return k+" "+j.noMatchReasons[k];})};});l.log(function(){var k=j.matchResults.map(function(M){return F.formatInbound(M.inbound);});return{logId:L,stage:1,prefix:k.length>0?"\u2705":"\u2718",lines:k.length>0?k:["No inbound was matched"]};});var m=Object.keys(j.missingReferences||[]);if(m.length===0){l.log(function(){return{logId:L,stage:2,prefix:"\u2705",line:"No need to resolve references"};});return new jQuery.Deferred().resolve({matchResults:j.matchResults,referencesToInclude:null}).promise();}l.log(function(){return{logId:L,stage:2,line:"@ Must resolve the following references:",prefix:"\u2022",lines:m};});var r=new jQuery.Deferred();sap.ushell.Container.getService("ReferenceResolver").resolveReferences(m).done(function(R){l.log(function(){return{logId:L,stage:2,line:"\u2705 resolved references with the following values:",prefix:"\u2022",lines:Object.keys(R).map(function(k){return k+": '"+R[k]+"'";})};});r.resolve({matchResults:j.matchResults,referencesToInclude:R});}).fail(function(k){l.log(function(){return{logId:L,stage:2,prefix:"\u274c",line:"Failed to resolve references: "+k};});D.resolve([]);});return r.promise();}).then(function(j){var m,M,r=j.referencesToInclude;if(!r){l.log(function(){return{logId:L,stage:3,line:"rematch was skipped (no references to resolve)",prefix:"\u2705"};});return new jQuery.Deferred().resolve(j).promise();}M=j.matchResults;m=M.map(function(k){return k.inbound;});return f.match(s,m,r,0).then(function(k){l.log(function(){var M=k.matchResults||[];if(M.length>=1){return{logId:L,stage:3,line:"The following inbounds re-matched:",lines:M.map(function(q){return F.formatInbound(q.inbound);}),prefix:"\u2705"};}return{logId:L,stage:3,line:"No inbounds re-matched",prefix:"-"};});return k;});}).then(function(j){var m=j.matchResults||[];if(m.length<=1){l.log(function(){return{logId:L,stage:4,line:"Nothing to sort"};});D.resolve(m);return;}var k=f.sortMatchingResultsDeterministic(j.matchResults||[]);l.log(function(){var q=k.map(function(M){return F.formatInbound(M.inbound||{})+(M.matchesVirtualInbound?" (virtual)":"")+"\n[ Sort Criteria ] "+"\n * 1 * sap-priority: '"+M["sap-priority"]+"'"+"\n * 2 * Sort string: '"+M.priorityString+"\n * 3 * Deterministic blob: '"+f.serializeMatchingResult(M)+"'";});return{logId:L,stage:4,line:"Sorted inbounds as follows:",lines:q,prefix:".",number:true};});D.resolve(k);});return D.promise().then(function(m){l.end(function(){return{logId:L};});return m;});};C.prototype._isIntentSupportedOne=function(s,o){var D=new jQuery.Deferred(),a=this._getURLParsing().parseShellHash(s);if(s==="#"){D.resolve(true);return D.promise();}if(a===undefined){return D.reject("Could not parse shell hash '"+s+"'").promise();}a.formFactor=u.getFormFactor();this._getMatchingInbounds(a,o,{bExcludeTileInbounds:true}).done(function(t){D.resolve(t.length>0);}).fail(function(){D.reject();});return D.promise();};C.prototype.isIntentSupported=function(a){var t=this,D=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(o){t._isIntentSupported(a,o).done(D.resolve.bind(D)).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};C.prototype._isIntentSupported=function(a,o){var t=this,D=new jQuery.Deferred(),s={};D.resolve();function e(h,j){s[h]={supported:j};}var r=[];a.forEach(function(h){var N=t._isIntentSupportedOne(h,o);N.fail(function(E){r.push(E);});N.done(function(j){e(h,j);});D=jQuery.when(D,N);});var R=new jQuery.Deferred();D.done(function(){R.resolve(s);}).fail(function(){R.reject("One or more input intents contain errors: "+r.join(", "));});return R.promise();};C.prototype.getUserDefaultParameterNames=function(){var t=this,D=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(o){var r;try{r=t._getUserDefaultParameterNames(o.getAllInbounds());D.resolve(r);}catch(e){D.reject("Cannot get user default parameters from inbounds: "+e);}},function(){D.reject.apply(D,arguments);});return D.promise();};C.prototype._getUserDefaultParameterNames=function(a){var r={simple:{},extended:{}};a.forEach(function(t){var s=t.signature&&t.signature.parameters||[];Object.keys(s).forEach(function(p){var P=s[p],R,e,h,o;if(P){if(P.filter&&P.filter.format==="reference"){h=P.filter.value;}else if(P.defaultValue&&P.defaultValue.format==="reference"){h=P.defaultValue.value;}if(typeof h==="string"){o=sap.ushell.Container.getService("ReferenceResolver");R=o.extractUserDefaultReferenceName(h);if(typeof R==="string"){r.simple[R]={};}e=o.extractExtendedUserDefaultReferenceName(h);if(typeof e==="string"){r.extended[e]={};}}}});});return r;};C.prototype.getEasyAccessSystems=function(m){var r={},a,v,D;m=m||"sapMenu";if(this._oHaveEasyAccessSystemsDeferreds[m]){return this._oHaveEasyAccessSystemsDeferreds[m].promise();}this._oHaveEasyAccessSystemsDeferreds[m]=new jQuery.Deferred();D=this._oHaveEasyAccessSystemsDeferreds[m];function e(o,s,v){return o&&o.semanticObject&&o.semanticObject==="Shell"&&o.action&&v[m][o.action]&&o.deviceTypes&&s!==undefined&&o.deviceTypes[s];}a={startGUI:{priority:3,appType:"TR"},startWDA:{priority:2,appType:"WDA"},startURL:{priority:1,appType:"URL"}};v={userMenu:{startGUI:true,startWDA:true,startURL:true},sapMenu:{startGUI:true,startWDA:true,startURL:false}};this._oInboundProvider.getInbounds().then(function(o){var L={};o.getAllInbounds().filter(function(h){return e(h,u.getFormFactor(),v);}).forEach(function(E){var s;if(jQuery.isPlainObject(E.signature.parameters["sap-system"])&&E.signature.parameters["sap-system"].hasOwnProperty("filter")){s=jQuery.sap.getObject("signature.parameters.sap-system.filter.value",undefined,E);}if(typeof s==="string"){var h=a[E.action].priority;var j=a[E.action].appType;if(!r[s]){L[s]=-1;r[s]={appType:{}};}if(L[s]<h){r[s].text=E.title;L[s]=h;}r[s].appType[j]=true;}else{jQuery.sap.log.warning("Cannot extract sap-system from easy access menu inbound: "+F.formatInbound(E),"This parameter is supposed to be a string. Got '"+s+"' instead.","sap.ushell.services.ClientSideTargetResolution");}});D.resolve(r);},function(){D.reject.apply(D,arguments);});return D.promise();};C.prototype._reportResolvedSystemAliasValidationErrors=function(v){jQuery.sap.log.error("Invalid system alias definition: "+v.debug,"ERRORS:"+v.errors.map(function(e){return"\n - "+e;}).join(""),"sap.ushell.services.ClientSideTargetResolution");};C.prototype._validateResolvedSystemAlias=function(r){function v(o){var e=[];if(typeof o.host!=="string"){e.push("host field must be a string");}if(typeof o.port!=="number"&&typeof o.port!=="string"){e.push("port field must be a number or a string");}if(typeof o.pathPrefix!=="string"){e.push("pathPrefix field must be a string");}return e;}var e=[],h=r.hasOwnProperty("https"),H=r.hasOwnProperty("http");if(!H&&!h){e.push("at least one of 'http' or 'https' fields must be defined");}if(h){v(r.https).forEach(function(E){e.push("https>"+E);});}if(H){v(r.http).forEach(function(E){e.push("http>"+E);});}if(e.length>0){return{isValid:false,errors:e,debug:JSON.stringify(r,null,3)};}return{isValid:true};};C.hasNoAdapter=false;return C;},true);

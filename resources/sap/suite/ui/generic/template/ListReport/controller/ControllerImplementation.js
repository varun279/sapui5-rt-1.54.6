sap.ui.define(["jquery.sap.global","sap/ui/model/json/JSONModel","sap/m/ObjectIdentifier","sap/m/Table","sap/m/Text","sap/ui/comp/smartfield/SmartField","sap/ui/generic/app/navigation/service/SelectionVariant","sap/suite/ui/generic/template/ListReport/extensionAPI/ExtensionAPI","sap/m/MessageBox","sap/suite/ui/generic/template/js/AnnotationHelper","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/ListReport/controller/IappStateHandler","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsHandler","sap/ui/model/Filter","sap/ui/comp/navpopover/LinkData"],function(q,J,O,T,a,S,b,E,M,A,c,I,d,F,L){"use strict";return{getMethods:function(v,t,C){var s={};s.oWorklistData={};s.oWorklistData.bWorkListEnabled=false;s.oWorklistData.bVariantDirty=true;var e=true;var f;var w=null;function g(){var i=C.getOwnerComponent();var z=t.oComponentUtils.getTemplatePrivateModel();z.setProperty("/listReport/isLeaf",i.getIsLeaf());}function h(){var G=q.sap.getObject("sap.ushell.Container.getUser");var i=C.getOwnerComponent().getAppComponent().getMetadata().getManifestEntry("sap.ui");var B=(i&&i.icons&&i.icons.icon)||"";var z=C.getOwnerComponent().getAppComponent().getMetadata().getManifestEntry("sap.app");var D=(z&&z.title)||"";var H={bookmarkIcon:B,bookmarkAppTitle:D,bookmarkCustomUrl:function(){var N=hasher.getHash();return N?("#"+N):window.location.href;},bookmarkServiceUrl:function(){var N=s.oSmartTable.getTable();var P=N.getBinding("rows")||N.getBinding("items");return P?P.getDownloadUrl()+"&$top=0&$inlinecount=allpages":"";},isShareInJamActive:!!G&&G().isJamActive()};var K=t.oComponentUtils.getTemplatePrivateModel();K.setProperty("/listReport/share",H);}function o(i){C.onInitSmartFilterBarExtension(i);s.oIappStateHandler.onSmartFilterBarInitialise();}function j(){var i=s.oIappStateHandler.parseUrlAndApplyAppState();i.then(function(){e=false;},function(z){if(z instanceof Error){z.showMessageBox();}});}function k(){if(!e){s.oIappStateHandler.changeIappState(true,false);}}function u(i){var z=C.getOwnerComponent().getModel(),B=t.oComponentUtils.getTemplatePrivateModel();var D=z.getMetaModel();var G=t.oCommonUtils.getCurrentEntitySetName(i);var H=D.getODataEntitySet(G);var K=H["Org.OData.Capabilities.V1.DeleteRestrictions"];var N=false;if(sap.suite.ui.generic.template.js.AnnotationHelper.areDeleteRestrictionsValid(D,H.entityType,K)){var P=K&&K.Deletable&&K.Deletable.Path;var Q=t.oCommonUtils.getSelectedContexts(i);N=Q.some(function(R){var U=z.getObject(R.getPath()+"/DraftAdministrativeData");var V=!(U&&U.InProcessByUser&&!U.DraftIsProcessedByMe);return V&&!(P&&!z.getProperty(P,R));});}B.setProperty("/listReport/deleteEnabled",N);t.oCommonUtils.setEnabledToolbarButtons(i);if(!t.oCommonUtils.isSmartChart(i)){t.oCommonUtils.setEnabledFooterButtons(i);}}function l(i){var z=i.getParameters();var B=i.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationPressed(B,z);}function m(i){var z,B;z=i.getParameters();B=i.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(B,z,s,undefined,undefined);}function n(i){var z,B,D,G,H,K;z=i.getParameters().mainNavigation;H=i.getParameters();K=i.getSource();if(z){B=K.getText&&K.getText();D=t.oCommonUtils.getCustomData(i);if(D&&D["LinkDescr"]){G=D["LinkDescr"];z.setDescription(G);}}K=K.getParent().getParent().getParent().getParent();t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(K,H,s,B,z);}function p(z){var B=v.getItems();for(var i=0;i<B.length;i++){if(!z||B[i].getBindingContextPath()===z){return B[i];}}}function r(P,i){var z=i.getSource();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){t.oCommonEventHandlers.addEntry(z,false,s.oSmartFilterbar,P);},q.noop,s);}function x(i){var z=C.getOwnerComponent().getCreateWithFilters();var B=z.strategy||"extension";var P;switch(B){case"extension":P=C.getPredefinedValuesForCreateExtension(s.oSmartFilterbar);break;default:q.sap.log.error(B+" is not a valid strategy to extract values from the SmartFilterBar");return;}r(P,i);}function y(){var i=s.oWorklistData.oSearchField.getValue()||"";if(i){s.oSmartTable.data("allowSearchWorkListLight",true);}s.oWorklistData.oWorklistState={"searchString":i};}function W(i){var P=C.byId("template::PageVariant");if(P){if(i&&i.getId()==="liveChange"||(!s.oWorklistData.bVariantDirty)){P.currentVariantSetModified(true);}}s.oSmartTable.rebindTable();s.oIappStateHandler.changeIappState(true,true);}return{onInit:function(){var i=C.getOwnerComponent().getAppComponent();var z=i.getConfig();s.oWorklistData.bWorkListEnabled=!!z.pages[0].component.settings&&z.pages[0].component.settings.isWorklist;s.oSmartFilterbar=C.byId("listReportFilter");s.oSmartTable=C.byId("listReport");s.updateControlOnSelectionChange=u;f=t.oServices.oApplication.getFclProxyForView(0);s.bLoadListAndFirstEntryOnStartup=f&&f.isListAndFirstEntryLoadedOnStartup&&f.isListAndFirstEntryLoadedOnStartup();s.oMultipleViewsHandler=new d(s,C,t);s.oIappStateHandler=new I(s,C,t);if(s.oWorklistData.bWorkListEnabled){s.oIappStateHandler.fetchAndSaveWorklistSearchField();}var B=t.oComponentUtils.getTemplatePrivateModel();B.setProperty("/generic/bDataAreShownInTable",false);t.oServices.oApplication.registerStateChanger({isStateChange:s.oIappStateHandler.isStateChange});v.getUrlParameterInfo=s.oIappStateHandler.getUrlParameterInfo;v.getItems=function(){var D=s.oSmartTable.getTable();if(t.oCommonUtils.isUiTable(D)){return D.getRows();}return D.getItems();};v.displayNextObject=function(D){return new Promise(function(G,H){w={aWaitingObjects:D,resolve:G,reject:H};});};v.onComponentActivate=function(){if(!e){s.oIappStateHandler.parseUrlAndApplyAppState();}};v.refreshBinding=function(){if(s.oIappStateHandler.areDataShownInTable()){if(s.oMultipleViewsHandler.getMode()==="multi"){var D=s.oMultipleViewsHandler.getImplementingHelper();var G=s.oSmartTable.getModel("_templPrivGlobal");var H=G.getProperty("/generic/multipleViews/objectPage/currentEntitySet");D.setTablesToDirtyByEntitySet(H,true);G.setProperty("/generic/multipleViews/objectPage/currentEntitySet",null);}t.oCommonUtils.refreshSmartTable(s.oSmartTable);}};g();h();C.byId("template::FilterText").attachBrowserEvent("click",function(){C.byId("page").setHeaderExpanded(true);});var B=t.oComponentUtils.getTemplatePrivateModel();B.setProperty("/listReport/isHeaderExpanded",true);B.setProperty("/listReport/deleteEnabled",false);},handlers:{addEntry:r.bind(null,undefined),addEntryWithFilters:x,deleteEntries:function(i){t.oCommonEventHandlers.deleteEntries(i);},updateTableTabCounts:function(){s.oMultipleViewsHandler.fnUpdateTableTabCounts();},onSelectionChange:function(i){var z=i.getSource();u(z);},onChange:function(i){t.oCommonEventHandlers.onChange(i);},onSmartFieldUrlPressed:function(i){t.oCommonEventHandlers.onSmartFieldUrlPressed(i,s);},onBreadCrumbUrlPressed:function(i){t.oCommonEventHandlers.onBreadCrumbUrlPressed(i,s);},onContactDetails:function(i){t.oCommonEventHandlers.onContactDetails(i);},onSmartFilterBarInitialise:o,onSmartFilterBarInitialized:j,onBeforeSFBVariantFetch:function(){s.oIappStateHandler.onBeforeSFBVariantFetch();},onAfterSFBVariantSave:function(){s.oIappStateHandler.onAfterSFBVariantSave();},onAfterSFBVariantLoad:function(i){s.oIappStateHandler.onAfterSFBVariantLoad(i);},onDataRequested:function(){s.oMultipleViewsHandler.onDataRequested();},onDataReceived:function(z){t.oCommonEventHandlers.onDataReceived(z);var B=s.oMultipleViewsHandler.getImplementingHelper();if(B&&typeof B.setTableDirty==='function'){B.setTableDirty(s.oSmartTable,false);}if(w){var D;var G=false;for(var i=0;i<w.aWaitingObjects.length&&!G;i++){D=p(w.aWaitingObjects[i]);if(D){t.oCommonEventHandlers.onListNavigate(D,s);w.resolve();G=true;}}if(!G){D=p();if(D){t.oCommonEventHandlers.onListNavigate(D,s);w.resolve();}else{w.reject();}}w=null;return;}var H=z.getSource().getTable();f.handleDataReceived(H,s,t);},onSmartChartDataReceived:function(){s.oMultipleViewsHandler.onDataRequested();},onBeforeRebindTable:function(i){s.oMultipleViewsHandler.aTableFilters=i.getParameters()&&i.getParameters().bindingParams&&q.extend(true,{},i.getParameters().bindingParams.filters);t.oCommonEventHandlers.onBeforeRebindTable(i,{determineSortOrder:s.oMultipleViewsHandler.determineSortOrder});C.onBeforeRebindTableExtension(i);s.oMultipleViewsHandler.onRebindContentControl(i);},onShowDetails:function(i){t.oCommonEventHandlers.onShowDetails(i.getSource(),s);},onListNavigate:function(i){if(!C.onListNavigationExtension(i)){t.oCommonEventHandlers.onListNavigate(i.getSource(),s);}},onCallActionFromToolBar:function(i){t.oCommonEventHandlers.onCallActionFromToolBar(i,s);},onDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldForIntentBasedNavigation(i,s);},onDataFieldWithIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldWithIntentBasedNavigation(i,s);},onBeforeSemanticObjectLinkPopoverOpens:function(i){var z=i.getParameters();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){var B=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());t.oCommonUtils.semanticObjectLinkNavigation(z,B,C);},q.noop,s,q.noop);},onSemanticObjectLinkNavigationPressed:l,onSemanticObjectLinkNavigationTargetObtained:m,onSemanticObjectLinkNavigationTargetObtainedSmartLink:n,onDraftLinkPressed:function(i){var B=i.getSource();var z=B.getBindingContext();t.oCommonUtils.showDraftPopover(z,B);},onAssignedFiltersChanged:function(i){if(i.getSource()){C.byId("template::FilterText").setText(i.getSource().retrieveFiltersWithValuesAsText());}},onFilterChange:k,onToggleFiltersPressed:function(){var i=t.oComponentUtils.getTemplatePrivateModel();i.setProperty("/listReport/isHeaderExpanded",!i.getProperty("/listReport/isHeaderExpanded"));},onSearchButtonPressed:function(){t.oCommonUtils.refreshModel(s.oSmartTable);s.oIappStateHandler.changeIappState(false,true);},onSemanticObjectLinkPopoverLinkPressed:function(i){t.oCommonEventHandlers.onSemanticObjectLinkPopoverLinkPressed(i,s);},onAfterTableVariantSave:function(){s.oIappStateHandler.onAfterTableVariantSave();},onAfterApplyTableVariant:function(){if(!e){s.oIappStateHandler.onAfterApplyTableVariant();}},onAfterChartVariantSave:function(i){s.oIappStateHandler.onAfterTableVariantSave();},onAfterApplyChartVariant:function(i){if(!e){s.oIappStateHandler.onAfterApplyTableVariant();}},onBeforeRebindChart:function(i){s.oMultipleViewsHandler.aTableFilters=i.getParameters()&&i.getParameters().bindingParams&&q.extend(true,{},i.getParameters().bindingParams.filters);t.oCommonEventHandlers.onBeforeRebindChart(i);C.onBeforeRebindChartExtension(i);s.oMultipleViewsHandler.onRebindContentControl(i);},onChartInitialise:function(i){s.oMultipleViewsHandler.fnRegisterToChartEvents(i);s.oMultipleViewsHandler.init(i);t.oCommonUtils.checkToolbarIntentsSupported(i.getSource());},onSelectionDetailsActionPress:function(i){s.oMultipleViewsHandler.onDetailsActionPress(i);},onShareListReportActionButtonPress:function(i){var z=t.oCommonUtils.getDialogFragment("sap.suite.ui.generic.template.fragments.lists.ShareSheet",{shareEmailPressed:function(){sap.m.URLHelper.triggerEmail(null,t.oCommonUtils.getText("EMAIL_HEADER",[t.oServices.oApplication.getAppTitle()]),document.URL);},shareJamPressed:function(){var G=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:document.URL,share:t.oServices.oApplication.getAppTitle()}}});G.open();}},"share",function(G,H){var R=sap.ui.getCore().getLibraryResourceBundle("sap.m");H.setProperty("/emailButtonText",R.getText("SEMANTIC_CONTROL_SEND_EMAIL"));H.setProperty("/jamButtonText",R.getText("SEMANTIC_CONTROL_SHARE_IN_JAM"));H.setProperty("/bookmarkButtonText",R.getText("SEMANTIC_CONTROL_SAVE_AS_TILE"));var K=q.sap.getObject("sap.ushell.Container.getUser");H.setProperty("/jamVisible",!!K&&K().isJamActive());});z.openBy(i.getSource());var B=this.getView().byId("template::Share");var D=this.getView().byId("bookmarkButton");D.setBeforePressHandler(function(){B.focus();});},onInlineDataFieldForAction:function(i){t.oCommonEventHandlers.onInlineDataFieldForAction(i,s);},onInlineDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onInlineDataFieldForIntentBasedNavigation(i.getSource(),s);},onDeterminingDataFieldForAction:function(i){t.oCommonEventHandlers.onDeterminingDataFieldForAction(i,s.oSmartTable);},onDeterminingDataFieldForIntentBasedNavigation:function(i){var B=i.getSource();t.oCommonEventHandlers.onDeterminingDataFieldForIntentBasedNavigation(B,s.oSmartTable.getTable(),s);},onTableInit:function(i){var z=i.getSource();t.oCommonUtils.checkToolbarIntentsSupported(z);s.oMultipleViewsHandler.init(i);},onSearchWorkListLight:function(i){s.oIappStateHandler.fetchAndSaveWorklistSearchField();y();s.oSmartTable.data("searchString",i.getSource().getValue());W(i);},onWorkListLightTableSort:function(i){y();var z=s.oSmartTable;if(z){z.openPersonalisationDialog("Sort");}},onWorkListLightTableFilter:function(){y();var i=s.oSmartTable;if(i){i.openPersonalisationDialog("Filter");}},onWorkListLightTableGroup:function(){y();var i=s.oSmartTable;if(i){i.openPersonalisationDialog("Group");}},onWorkListLightTableColumns:function(){y();var i=s.oSmartTable;if(i){i.openPersonalisationDialog("Columns");}}},formatters:{formatDraftType:function(D,i,H){if(D&&D.DraftUUID){if(!i){return sap.m.ObjectMarkerType.Draft;}else if(H){return D.InProcessByUser?sap.m.ObjectMarkerType.Locked:sap.m.ObjectMarkerType.Unsaved;}}return sap.m.ObjectMarkerType.Flagged;},formatDraftVisibility:function(D,i){if(D&&D.DraftUUID){if(!i){return sap.m.ObjectMarkerVisibility.TextOnly;}}return sap.m.ObjectMarkerVisibility.IconAndText;},formatDraftLineItemVisible:function(D){if(D&&D.DraftUUID){return true;}return false;},formatDraftOwner:function(D,H){var i="";if(D&&D.DraftUUID&&H){var U=D.InProcessByUserDescription||D.InProcessByUser||D.LastChangedByUserDescription||D.LastChangedByUser;if(U){i=t.oCommonUtils.getText("ST_DRAFT_OWNER",[U]);}else{i=t.oCommonUtils.getText("ST_DRAFT_ANOTHER_USER");}}return i;},formatItemTextForMultipleView:function(i){return s.oMultipleViewsHandler?s.oMultipleViewsHandler.formatItemTextForMultipleView(i):"";}},extensionAPI:new E(t,C,s)};}};});

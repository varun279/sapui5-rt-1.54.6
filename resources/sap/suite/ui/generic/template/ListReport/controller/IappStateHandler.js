sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/generic/app/navigation/service/NavError","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState"],function(q,B,N,S,U){"use strict";var d="sap.suite.ui.generic.template.customData",a="sap.suite.ui.generic.template.genericData";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(o){if(o){for(var p in o){o[p]=null;}}}function f(o,O){var k=Object.keys(o);if(k.length!==Object.keys(O).length){return true;}for(var i=0;i<k.length;i++){var K=k[i];var p=o[K];var P=O[K];if(p.length!==P.length){return true;}for(var j=0;j<p.length;j++){if(p[j]!==P[j]){return true;}}}return false;}function g(s,c,t){var o=t.oCommonUtils.getNavigationHandler();var b=c.getOwnerComponent().getSmartVariantManagement();var r={appStateKey:"",urlParams:{},selectionVariant:"",tableVariantId:""};var e=false;var h=null;var A=Promise.resolve();var D=false;var k=false;var E=c.byId("editStateFilter");var l;var m=null;var p=null;s.oSmartFilterbar.setSuppressSelection(true);var u=(function(){var i;return function(){i=i||s.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function v(){return D;}function w(){var j={};j[d]={};var Z=[];var $=u();for(var i=0;i<$.length;i++){var _=$[i];if(s.oSmartFilterbar.isVisibleInFilterBarByName(_)){Z.push(_);}}j[a]={suppressDataSelection:!D,visibleCustomFields:Z};if(E){j[a].editStateFilter=E.getSelectedKey();}var a1=s.oMultipleViewsHandler&&s.oMultipleViewsHandler.getContentForIappState();if(a1){var b1=a1.mode==="single"?"tableViewData":"tableTabData";j[a][b1]=a1.state;}if(s.oWorklistData.bWorkListEnabled){var c1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";var d1={"searchString":c1};j[a]["Worklist"]=d1;}c.getCustomAppStateDataExtension(j[d]);return j;}function x(){var Z=s.oSmartFilterbar.getUiState().getSelectionVariant();var $=sap.ui.getCore().getConfiguration().getLanguage().split("-",1);$[0]=$[0].toLowerCase();var _=0;if(s.oSmartFilterbar.getUiState().getValueTexts()&&s.oSmartFilterbar.getUiState().getValueTexts().Texts&&s.oSmartFilterbar.getUiState().getValueTexts().Texts.length>1){for(var i=0;i<s.oSmartFilterbar.getUiState().getValueTexts().Texts.length;i++){if(s.oSmartFilterbar.getUiState().getValueTexts().Texts[i].Language===$[0]){_=i;break;}}}if(s.oSmartFilterbar.getUiState().getValueTexts()&&s.oSmartFilterbar.getUiState().getValueTexts().Texts){for(var j=0;j<s.oSmartFilterbar.getUiState().getValueTexts().Texts[_].PropertyTexts.length;j++){var a1=s.oSmartFilterbar.getUiState().getValueTexts().Texts[_].PropertyTexts[j].ValueTexts;for(var i=0;i<a1.length;i++){if(a1[i]){Z.SelectOptions[j].Ranges[i].Low=a1[i].Text;}}}}var b1=JSON.stringify(Z);var c1=new S(b1);var d1=c.getVisibleSelectionsWithDefaults();for(var i=0;i<d1.length;i++){if(!c1.getValue(d1[i])){c1.addSelectOption(d1[i],"I","EQ","");}}if(c.byId('template::PageVariant')&&c.byId('template::PageVariant').currentVariantGetModified()&&c1.getID()){c1.setID("");}if(s.oWorklistData.bWorkListEnabled){var e1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";c1.addSelectOption("Worklist.SearchField","I","EQ",e1);}var f1={selectionVariant:c1.toJSONString(),tableVariantId:(!b&&s.oSmartTable.getCurrentVariantId())||"",customData:w()};return f1;}function y(){if(!k){return;}k=false;try{m=o.storeInnerAppStateWithImmediateReturn(x(),true);}catch(i){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: "+i);return;}if(m instanceof N){k=true;m=null;return;}m.promise.fail(function(j){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Error when persisting appState"+j);});if(p===m.appStateKey){m=null;}else{o.replaceHash(m.appStateKey);}}function R(j,Z){if(j&&j.editStateFilter!==undefined){if(E){E.setSelectedKey((j.editStateFilter===null)?0:j.editStateFilter);}}var $=j&&j.visibleCustomFields;if($&&$.length>0){var _=s.oSmartFilterbar.getAllFilterItems();for(var i=0;i<_.length;i++){var a1=_[i];var b1=a1.getName();if($.indexOf(b1)!==-1){a1.setVisibleInFilterBar(true);}}}D=Z&&!(j&&j.suppressDataSelection);if(D&&!s.oWorklistData.bWorkListEnabled){s.oSmartFilterbar.search();W(D);}}function z(i){c.restoreCustomAppStateDataExtension(i||{});}function C(i,j){i=i||{};if(i.hasOwnProperty(d)&&i.hasOwnProperty(a)){z(i[d]);R(i[a],j);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}z(i);}}function F(){return A.then(function(){if(r.appStateKey){return{"sap-iapp-state":[r.appStateKey]};}return r.urlParams;});}function G(i){var j=t.oComponentUtils.getTemplatePrivateModel();j.setProperty("/generic/bDataAreShownInTable",i);}function H(i,j){G(j);if(e){return;}if(i||j!==D){D=j;if(!k){k=true;if(!s.oSmartFilterbar.isDialogOpen()){if(h){y();}else{setTimeout(y,0);}}}}}function J(j,Z,$){s.oSmartFilterbar.setSuppressSelection(false);s.sNavType=$;var _=j.appStateKey||"";if(e){return;}if(p===null){p=_;}else if(_!==p){return;}e=true;var a1=j.selectionVariant||"";var b1=(!b&&j.tableVariantId)||"";var c1=(!_&&Z)||{};if((r.appStateKey!==_||r.selectionVariant!==a1||r.tableVariantId!==b1||f(r.urlParams,c1))&&$!==sap.ui.generic.app.navigation.service.NavType.initial){if(!m||m.appStateKey!==_){var d1=j&&j.bNavSelVarHasDefaultsOnly;if(!s.oWorklistData.bWorkListEnabled){if(j.oSelectionVariant&&r.selectionVariant!==a1){var e1=j.oSelectionVariant.getParameterNames().concat(j.oSelectionVariant.getSelectOptionsPropertyNames());for(var i=0;i<e1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(e1[i]);}}var f1=new U({selectionVariant:j.oSelectionVariant.toJSONObject()});j.oUiState=f1;if(d1&&s.oSmartFilterbar.isCurrentVariantStandard()){s.oSmartFilterbar.setUiState(f1,{replace:false,strictMode:false});}else if(!d1||s.oSmartFilterbar.isCurrentVariantStandard()){s.oSmartFilterbar.clearVariantSelection();s.oSmartFilterbar.clear();s.oSmartFilterbar.setUiState(f1,{replace:true,strictMode:false});}}if(b1!==r.tableVariantId){s.oSmartTable.setCurrentVariantId(b1);}j.customData=j.customData||{};var g1=s.oMultipleViewsHandler&&s.oMultipleViewsHandler.getMode();if(g1){var h1=g1==="single"?"tableViewData":"tableTabData";if(j.customData[a]&&j.customData[a][h1]){s.oMultipleViewsHandler.restoreFromIappState(j.customData[a][h1]);}}if(s.oWorklistData.bWorkListEnabled){s.oWorklistData.oWorklistSavedData=j.customData[a]["Worklist"];X();}C(j.customData,true);}r={appStateKey:_,urlParams:c1,selectionVariant:a1,tableVariantId:b1};}if(h){h();h=null;}if($!==sap.ui.generic.app.navigation.service.NavType.iAppState&&!D){var i1=($===sap.ui.generic.app.navigation.service.NavType.xAppState||$===sap.ui.generic.app.navigation.service.NavType.URLParams)&&!j.bNavSelVarHasDefaultsOnly;D=i1||s.bLoadListAndFirstEntryOnStartup||l||s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();G(D);if(D){s.oSmartFilterbar.search();W(D);}}if($==="initial"&&s.oWorklistData.bWorkListEnabled){if(s.oSmartFilterbar.isCurrentVariantStandard()){X();}}m=null;e=false;}function P(){if(!h){A=new Promise(function(j){h=j;});}var i=new Promise(function(j,Z){var $=o.parseNavigation();$.done(function(_,a1,b1){J(_,a1,b1);j();});$.fail(function(_,a1,b1){q.sap.log.warning(_.getErrorCode(),"app state could not be parsed - continuing with empty state","sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");J({},a1,b1);j();});});return i;}function K(){var i=x();s.oSmartFilterbar.setFilterData({_CUSTOM:i.customData});}function L(){H(true,D);}function M(i){var j=i.getParameter("context");var Z=s.oSmartFilterbar.getFilterData();if(Z._CUSTOM!==undefined){if(s.oWorklistData.bWorkListEnabled){var $=Z._CUSTOM[a]["Worklist"];s.oSmartFilterbar.setSuppressSelection(false);s.oWorklistData.oSearchField.setValue($.searchString);s.oWorklistData.oSearchField.fireSearch();}else{C(Z._CUSTOM);}}else{var _=w();n(_[d]);n(_[a]);C(_);}if(I.indexOf(j)<0){D=i.getParameter("executeOnSelect");H(true,D);}}function O(){if(!b){H(true,D);}}function Q(){if(!b){H(true,D);}}function T(i){var j=i.getParameter("arguments");var Z=j&&j["?query"];p=(Z&&Z["sap-iapp-state"])||"";if(m){if(m.appStateKey!==p){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Got AppstateKey "+p+" expected "+m.appStateKey);return false;}P();return true;}return false;}function V(){l=s.oSmartTable.getEnableAutoBinding();s.oSmartFilterbar.attachFiltersDialogClosed(y);}function W(D){if(c&&c.getOwnerComponent&&c.getOwnerComponent().getModel){var i=c.getOwnerComponent().getModel("_templPriv");if(D){i.setProperty("/listReport/isHeaderExpanded",false);}else{i.setProperty("/listReport/isHeaderExpanded",true);}}}function X(){var i=s.oWorklistData.oWorklistSavedData?s.oWorklistData.oWorklistSavedData:{};if(s.sNavType==="initial"){s.oSmartFilterbar.setSuppressSelection(false);}if(i.searchString){Y();s.oWorklistData.oSearchField.setValue(i.searchString);s.oWorklistData.bVariantDirty=false;s.oWorklistData.oSearchField.fireSearch();return;}s.oSmartFilterbar.search();s.oIappStateHandler.changeIappState(true,true);}function Y(){var i=s.oSmartTable;var j=i.getCustomToolbar().getContent();for(var Z in j){if(j[Z].getId().indexOf("SearchField")>-1){s.oWorklistData.oSearchField=j[Z];break;}}}s.getCurrentAppState=x;return{areDataShownInTable:v,parseUrlAndApplyAppState:P,getUrlParameterInfo:F,changeIappState:H,onSmartFilterBarInitialise:V,onBeforeSFBVariantFetch:K,onAfterSFBVariantSave:L,onAfterSFBVariantLoad:M,onAfterTableVariantSave:O,onAfterApplyTableVariant:Q,isStateChange:T,fetchAndSaveWorklistSearchField:Y};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(s,c,t){q.extend(this,g(s,c,t));}});});

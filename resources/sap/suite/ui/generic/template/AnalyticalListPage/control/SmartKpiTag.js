sap.ui.define(["sap/ui/core/Control","sap/suite/ui/generic/template/AnalyticalListPage/controller/KpiTagController","sap/suite/ui/generic/template/AnalyticalListPage/util/KpiUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/KpiAnnotationHelper","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/ui/comp/odata/ODataModelUtil","sap/suite/ui/generic/template/AnalyticalListPage/control/KpiTag","sap/suite/ui/generic/template/AnalyticalListPage/control/KpiProvider"],function(C,K,a,b,F,V,O,c,d){"use strict";var T="Target",M="Maximize",e="Minimize";return c.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.SmartKpiTag",{metadata:{designTime:true,interfaces:["sap.m.IOverflowToolbarContent"],properties:{entitySet:{type:"string",defaultValue:"",bindable:false},qualifier:{type:"string",defaultValue:"",bindable:false},modelName:{type:"string",defaultValue:undefined,bindable:false},smartFilterId:{type:"string",defaultValue:undefined,bindable:false}},events:{beforeRebindFilterableKPI:{}}},renderer:{render:c.render},_isPercent:false,_unScaledValue:"",_sUnitofMeasure:"",_relativeToProperties:[],propagateProperties:function(){C.prototype.propagateProperties.apply(this,arguments);this._initialiseMetadata();},_initialiseMetadata:function(){O.handleModelInit(this,this._onMetaDataInit);},_onMetaDataInit:function(){if(this.getModelName()){this._oModel=this.getModel(this.getModelName());this._oModel.getMetaModel().loaded().then(function(){this.kpiProvider=new d(this);if(!this.kpiProvider){return;}this.kpiSettings=this.kpiProvider.getConfig();if(!this.kpiSettings){return;}var s=this.getSmartFilterId();if(s){if(s&&!this._oSmartFilter){this._oSmartFilter=this._findControl(s);this._oSmartFilter.attachSearch(this._createFilterableKpi,this);this._oSmartFilter.attachFilterChange(function(E){if(!this._oSmartFilter.isLiveMode()&&!this._oSmartFilter.isDialogOpen()){this.setEnabled(false);}}.bind(this));}this._createFilterableKpi();}else{this._createGlobalKpi();}}.bind(this));}},_createFilterableKpi:function(){this.setBusy(true);this.setBusyIndicatorDelay(0);if(this.getEntitySet()===this._oSmartFilter.getEntitySet()){if(!this._checkSearchAllowed()){return;}}var f=this.kpiSettings,s=f.selectOptions,p=f.parameters,u=this._oSmartFilter.getUiState(),U=u.getProperty("selectionVariant"),g=U?U.SelectOptions:undefined,h=U?U.Parameters:undefined,S=this._oSmartFilter.getFilterData(true),o=new sap.ui.generic.app.navigation.service.SelectionVariant(U),k=new sap.ui.generic.app.navigation.service.SelectionVariant(),l=[],m,P,n,r,q,t,v,w=this._oModel.getMetaModel(),E=w.getODataEntitySet(this.getEntitySet()),x=w.getODataEntityType(E.entityType);if(s){for(var i=0;i<s.length;i++){m=s[i];P=m.PropertyName.PropertyPath;n=o.getSelectOption(P);var y=w.getODataProperty(x,P),I=y&&y['sap:filterable'];if(I==="false"){continue;}if(n){for(var j=0;j<n.length;j++){r=n[j];if(r.Sign==="I"||r.Sign==="E"){if(r.Low!==undefined){q=a.getFilter(r,n,P);k.addSelectOption(q.path,q.sign,q.operator,q.value1,q.value2);}}}}else{if(S&&S[P]===undefined){for(var j=0;j<m["Ranges"].length;j++){r=m["Ranges"][j];if(r.Sign.EnumMember===V.SelectionRangeSignType+"/I"||r.Sign.EnumMember===V.SelectionRangeSignType+"/E"){if(r.Low!==undefined){q=a.getFilter(r,m);k.addSelectOption(q.path,q.sign,q.operator,q.value1,q.value2);}}}}}}}if(p){for(var i=0;i<p.length;i++){t=p[i];P=t.PropertyName&&t.PropertyName.PropertyPath;v=o.getParameter(P)||t.PropertyValue.String;if(S&&S["$Parameter."+P]===undefined){if(P&&v&&(v!=="")){k.addParameter(P,v);}}}}if(h){for(var i=0;i<h.length;i++){t=h[i];P=t.PropertyName;v=t.PropertyValue;if(v!==k.getParameter(P)){if(P&&v&&(v!=="")){var z=b.checkParameterizedEntitySet(this._oModel,E,P);if(z){k.addParameter(P,v);}}}}}if(g){for(var i=0;i<g.length;i++){var A=g[i],B=A.PropertyName||undefined,y=w.getODataProperty(x,B);I=y&&y['sap:filterable'];if(y&&(I!==false)){if(!k.getSelectOption(B)){for(var j=0;j<A["Ranges"].length;j++){r=A["Ranges"][j];if(r.Sign==="I"||r.Sign==="E"){if(r.Low!==undefined){q=a.getFilter(r,A,B);k.addSelectOption(q.path,q.sign,q.operator,q.value1,q.value2);}}}}}}}this.fireBeforeRebindFilterableKPI({selectionVariant:k,entityType:E.entityType});var D=k.getSelectOptionsPropertyNames();for(var i=0;i<D.length;i++){m=k.getSelectOption(D[i]);for(var j=0;j<m.length;j++){r=m[j];if(r.Sign==="I"||r.Sign==="E"){if(r.Low!==undefined){q=a.getFilter(r,null,D[i]);l.push(new sap.ui.model.Filter(q));}}}}this._filterableKPISelectionVariant=k;var G=b.resolveParameterizedEntitySet(this._oModel,f.entitySet,k);this._applyFiltersToKpi.apply(this,[k,l,G]);},_createGlobalKpi:function(){this.setBusy(true);this.setBusyIndicatorDelay(0);var f=this.kpiSettings;var s=f.selectOptions,S,r,g=[];if(s){for(var i=0;i<s.length;i++){S=s[i];for(var j=0;j<S["Ranges"].length;j++){r=S["Ranges"][j];if(r.Low){g.push(new sap.ui.model.Filter(a.getFilter(r,S)));}}}}var p=b.resolveParameterizedEntitySet(this._oModel,f.entitySet,f.selectionVariant);this._applyFiltersToKpi.apply(this,[f.selectionVariant,g,p]);},_applyFiltersToKpi:function(s,f,p){this._relativeToProperties=[];var g=this.kpiSettings;var D=g.dataPoint,S;this._getCriticalityRefProperties(D);this._oConfig={path:p,filterable:this.getSmartFilterId()?true:false,properties:{value:g.props.value,title:g.props.title,unitOfMeasure:g.props.unitOfMeasure}};this._oConfig.properties.shortDescription=g.props.shortDescription;this._checkForPercent(this._oConfig.properties.unitOfMeasure);this._checkKpiCriticality();if(this._relativeToProperties.length!==0){S=(this._relativeToProperties.indexOf(this._oConfig.properties.value)===-1)?[this._oConfig.properties.value].concat(this._relativeToProperties).join(","):this._relativeToProperties;}else{S=[this._oConfig.properties.value];}if(this._oConfig){this._oModel.read(this._oConfig.path,{async:true,filters:f,urlParameters:{"$select":S,"$top":1},success:this._kpiSuccessHandler.bind(this),error:function(h){jQuery.sap.log.error("Error reading URL:"+h);}});}},_checkSearchAllowed:function(){var A=this._oSmartFilter.determineMandatoryFilterItems(),f=this._oSmartFilter.getFiltersWithValues(),I=true,g=0;if(A.length){if(!f.length||(f.length<A.length)){I=false;}else{for(var i=0;i<A.length;i++){for(var j=0;j<f.length;j++){if(f[j].getName()===A[i].getName()){g++;}}}I=(g===A.length);}}if(I){var s=this._oSmartFilter.verifySearchAllowed.apply(this._oSmartFilter,arguments);if(s.hasOwnProperty("error")||s.hasOwnProperty("mandatory")){I=false;}}return I;},_checkKpiCriticality:function(){var f=this.kpiSettings;var D=f.dataPoint;var m;if(f.criticality){if(f.criticality.criticalityPath){m=f.criticality.criticalityPath;this._oConfig.criticality={criticalityPath:f.criticality.criticalityPath};}else if(f.criticality.criticalityType){m=this._getCriticalityFromEnum(f.criticality.criticalityType);this._oConfig.criticality={criticalityType:f.criticality.criticalityType};}}else if(f.criticalityCalculation){var i=f.criticalityCalculation.improveDirection,t=f.criticalityCalculation.toleranceHigh,s=f.criticalityCalculation.toleranceLow,g=f.criticalityCalculation.deviationLow,h=f.criticalityCalculation.deviationHigh;var I=[];if(this.getSmartFilterId()&&this._checkCriticalityCalculationForNumber(D.CriticalityCalculation,i)){this._mCriticalityIndicator=sap.m.ValueColor.Neutral;}else{I.push(this._getPathForIndicatorParts(t));I.push(this._getPathForIndicatorParts(s));I.push(this._getPathForIndicatorParts(g));I.push(this._getPathForIndicatorParts(h));I.push({path:"/"+f.props.value});m={parts:I,formatter:function(j,k,l,n,v){var o=k?k:s,p=j?j:t,q=l?l:g,r=n?n:h;o=o&&Number(o);p=p&&Number(p);q=q&&Number(q);r=r&&Number(r);v=v&&Number(v);return this._getImproveDirection(o,p,q,r,v);}.bind(this)};this._oConfig.criticalityCalculation={improveDirection:f.criticalityCalculation.improveDirection,toleranceLow:f.criticalityCalculation.toleranceLow,toleranceHigh:f.criticalityCalculation.toleranceHigh,deviationLow:f.criticalityCalculation.deviationLow,deviationHigh:f.criticalityCalculation.deviationHigh};}}this._oConfig.criticalityProps={criticalityIndicator:m,relativeProperties:this._relativeToProperties};},_getCriticalityRefProperties:function(D){var f=D.CriticalityCalculation;var g=D.Criticality;if(g&&g.Path&&this._relativeToProperties.indexOf(g.Path)===-1){this._relativeToProperties.push(g.Path);}else if(f){if(f.DeviationRangeLowValue&&f.DeviationRangeLowValue.Path&&this._relativeToProperties.indexOf(f.DeviationRangeLowValue.Path)===-1){this._relativeToProperties.push(f.DeviationRangeLowValue.Path);}if(f.DeviationRangeHighValue&&f.DeviationRangeHighValue.Path&&this._relativeToProperties.indexOf(f.DeviationRangeHighValue.Path)===-1){this._relativeToProperties.push(f.DeviationRangeHighValue.Path);}if(f.ToleranceRangeLowValue&&f.ToleranceRangeLowValue.Path&&this._relativeToProperties.indexOf(f.ToleranceRangeLowValue.Path)===-1){this._relativeToProperties.push(f.ToleranceRangeLowValue.Path);}if(f.ToleranceRangeHighValue&&f.ToleranceRangeHighValue.Path&&this._relativeToProperties.indexOf(f.ToleranceRangeHighValue.Path)===-1){this._relativeToProperties.push(f.ToleranceRangeHighValue.Path);}}},_kpiSuccessHandler:function(f,r){this.setBusy(false);var k=new sap.ui.model.json.JSONModel();k.setData(f.results[0]);this.setModel(k);this._setKpiName();this._setKpiValue();if(this._oConfig.properties.unitOfMeasure){(this._oConfig.properties.unitOfMeasure.hasOwnProperty("Path"))?this.bindProperty("unit",{path:"/"+this._oConfig.properties.unitOfMeasure.Path}):this.setProperty("unit",this._oConfig.properties.unitOfMeasure.String||this._oConfig.properties.unitOfMeasure);}this._setKpiIndicator();if(!this.getEnabled()){this.setEnabled(true);}},_setKpiIndicator:function(){var f=this._oConfig.criticalityProps.criticalityIndicator;if(typeof f==="string"){this.setIndicator(f);}else if(typeof f==="object"){this.bindProperty("indicator",f);}},_setKpiValue:function(){this.bindProperty("value",{path:"/"+this._oConfig.properties.value,formatter:function(v){this._isPercent=this._oConfig.properties.isPercent;this._unScaledValue=sap.ui.core.format.NumberFormat.getFloatInstance({maxFractionDigits:2,groupingEnabled:true,showScale:false},new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage())).format(v);return this._oConfig.properties.isPercent?a.formatNumberForPresentation(v,true):a.formatNumberForPresentation(v);}.bind(this)});},_checkCriticalityCalculationForNumber:function(f,i){if(i===M){if((f.DeviationRangeLowValue&&!f.DeviationRangeLowValue.Path)||(f.ToleranceRangeLowValue&&!f.ToleranceRangeLowValue.Path)){return true;}}else if(i===e){if((f.DeviationRangeHighValue&&!f.DeviationRangeHighValue.Path)||(f.ToleranceRangeHighValue&&!f.ToleranceRangeHighValue.Path)){return true;}}else if(i===T){if((f.ToleranceRangeLowValue&&!f.ToleranceRangeLowValue.Path)||(f.ToleranceRangeHighValue&&!f.ToleranceRangeHighValue.Path)){return true;}}},_setKpiName:function(){var n=this._oConfig.properties.title;if(n===undefined||typeof n!=="string"){n="";}var k=this._oConfig.properties.shortDescription?this._oConfig.properties.shortDescription:n;if(k){if(k.indexOf(">")>0){this.bindProperty("shortDescription",{path:k,formatter:function(v){return this._getKpiTagTitle(v);}.bind(this)});}else{this.setProperty("shortDescription",this._getKpiTagTitle(k));}}},_getPathForIndicatorParts:function(v){if(Number(v)||!v){return{path:"/dummy"};}return v;},_getKpiTagTitle:function(n){return this.getShortDescription()?this.getShortDescription():this._getNameFromHeuristic(n);},_getCriticalityFromEnum:function(s){return this.kpiProvider.getCriticalityFromEnum(s);},_getImproveDirection:function(D,s,f,g,v){return this.kpiProvider.getImproveDirection(D,s,f,g,v);},_onMouseClick:function(E){K.openKpiCard(E);},_onKeyPress:function(E){if(E.which===jQuery.sap.KeyCodes.ENTER||E.which===jQuery.sap.KeyCodes.SPACE){K.openKpiCard(E);}},_checkForPercent:function(u){if(u&&u.hasOwnProperty("String")){this._oConfig.properties.unitOfMeasure=(u.String)?u.String:"";}if(u&&u.hasOwnProperty("Path")&&this._relativeToProperties.indexOf(u.Path)===-1){this._relativeToProperties.push(u.Path);}this._oConfig.properties.isPercent=(u&&u.hasOwnProperty("String"))?(u.String==="%"):false;},_getNameFromHeuristic:function(s){var p=s.split(/\s/);return p.length===1?this._getNameFromSingleWordHeuristic(s):this._getNameFromMultiWordHeuristic(p);},_getNameFromSingleWordHeuristic:function(w){return w.substr(0,3).toUpperCase();},_getNameFromMultiWordHeuristic:function(w){var p=[];p.push(w[0].charAt(0));p.push(w[1].charAt(0));if(w.length>=3){p.push(w[2].charAt(0));}return p.join("").toUpperCase();},getFilterableKPISelectionVariant:function(){return this._filterableKPISelectionVariant;},_findControl:function(i){var r,v;if(i){r=sap.ui.getCore().byId(i);if(!r){v=this._getView();if(v){r=v.byId(i);}}}return r;},_getView:function(){if(!this._oView){var o=this.getParent();while(o){if(o instanceof sap.ui.core.mvc.View){this._oView=o;break;}o=o.getParent();}}return this._oView;},exit:function(){this._relativeToProperties=[];},onAfterRendering:function(){var r=this.getModel("i18n").getResourceBundle(),f=(this._isPercent)?this.getValue()+" "+this.getUnit():this._unScaledValue+" "+this.getUnit(),g;switch(this.getIndicator()){case sap.m.ValueColor.Error:g="KPI_TOOLTIP_ERROR";break;case sap.m.ValueColor.Good:g="KPI_TOOLTIP_GOOD";break;case sap.m.ValueColor.Critical:g="KPI_TOOLTIP_CRITICAL";break;default:g="KPI_TOOLTIP_NEUTRAL";break;}if(this._oConfig){var n=this._oConfig.properties.title;if(n&&n.indexOf(">")>0){this.bindProperty("tooltip",{path:n,formatter:function(v){this._oConfig.properties.title=v;return v+" "+f;}.bind(this)});}else{this.setTooltip(n+" "+f);}this._ariaLabel=r.getText(g,[this._oConfig.properties.title,f]);}setTimeout(function(){this.detachBrowserEvent("click",this._onMouseClick).attachBrowserEvent("click",this._onMouseClick);this.detachBrowserEvent("keypress",this._onKeyPress).attachBrowserEvent("keypress",this._onKeyPress);}.bind(this),1);},getSmartKpiConfig:function(){return this._oConfig;},getOverflowToolbarConfig:function(){return{canOverflow:true};},setShortDescription:function(v){this.setProperty("shortDescription",this._getNameFromHeuristic(v));}});},true);

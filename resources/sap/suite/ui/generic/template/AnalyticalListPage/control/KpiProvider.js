sap.ui.define(["sap/suite/ui/generic/template/AnalyticalListPage/util/KpiUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/KpiAnnotationHelper","sap/suite/ui/generic/template/AnalyticalListPage/util/CriticalityUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms"],function(K,a,C,F,V,b){"use strict";var b=function(k){this.kpiConfig=k;this._getDataFromAnnotations();};b.prototype._getDataFromAnnotations=function(){var m=this;var M=this.kpiConfig._oModel;var o=M.getMetaModel();var e=o.getODataEntitySet(this.kpiConfig.getEntitySet());var E=o.getODataEntityType(e.entityType);var q=this.kpiConfig.getQualifier();var s,d,S,D;var p={};var k="com.sap.vocabularies.UI.v1.KPI#"+q;var c=E[k];if(c){if(c["DataPoint"]){D=this.getPathOrAnnotationPath(c["DataPoint"],true);}if(c["SelectionVariant"]){S=this.getPathOrAnnotationPath(c["SelectionVariant"],true);}if(c["ShortDescription"]){var f=K.getPrimitiveValue(c["ShortDescription"]);}var g=c.ID;var h=c.Detail&&c.Detail.SemanticObject;var A=c.Detail&&c.Detail.Action;p.kpiAnnotationPath=k;}else{var i="com.sap.vocabularies.UI.v1.SelectionPresentationVariant#"+q;p.selectionPresentationVariantPath=i;var j=E[i];if(!j){return;}if(j.SelectionVariant){S=this.getPathOrAnnotationPath(j.SelectionVariant);}if(j.PresentationVariant){var P=this.getPathOrAnnotationPath(j.PresentationVariant);}if(!P){return;}var l=E[P];var v=l.Visualizations;v.forEach(function(L){if(L.AnnotationPath.indexOf("DataPoint")>0){D=m.getPathOrAnnotationPath(L);}});}if(!D){jQuery.sap.log.error("DataPoint does not have Path.");return;}d=E[D];if(!S){jQuery.sap.log.error("SelectionVariant does not have a path");}s=E[S];p.dataPointPath=D;p.selectionVariantPath=S;var n=d.Value.Path;var r=s&&s.SelectOptions,t=s&&s.Parameters;var u=o.getODataProperty(E,d.Value.Path);var U=K.getUnitofMeasure(M,u);var w=d.Title,x=K.getPrimitiveValue(w);if(x===undefined){x="";}this.kpiConfig={entityTypeProperty:u,props:{title:x,value:n,unitOfMeasure:U},entitySet:e,dataPoint:d,selectionVariant:s,selectOptions:r,parameterS:t,kpiPropertyPath:p};if(h&&A&&g){this.kpiConfig.navigation={semanticObject:h.String,action:A.String,kpiId:g.String};}if(f){this.kpiConfig.props.shortDescription=f;}var y=F.readProperty(d,"Criticality"),z=y&&(y.EnumMember)?K.getPrimitiveValue(y):undefined,B=(y&&y.Path)?this._getCriticalityParameters(y):undefined;if(z){this.kpiConfig.criticality={criticalityType:z};}else if(B){this.kpiConfig.criticality={criticalityPath:B};}else{var I=(!z&&F.readProperty(d,"CriticalityCalculation.ImprovementDirection.EnumMember"))?K.getPrimitiveValue(d.CriticalityCalculation.ImprovementDirection):undefined;if(I){var T=this._getCriticalityParameters(d.CriticalityCalculation.ToleranceRangeLowValue),G=this._getCriticalityParameters(d.CriticalityCalculation.ToleranceRangeHighValue),H=this._getCriticalityParameters(d.CriticalityCalculation.DeviationRangeLowValue),J=this._getCriticalityParameters(d.CriticalityCalculation.DeviationRangeHighValue);this.kpiConfig.criticalityCalculation={improveDirection:I,toleranceLow:T,toleranceHigh:G,deviationLow:H,deviationHigh:J};}}};b.prototype._getCriticalityParameters=function(c){if(c){if(c.Path){return{path:"/"+c.Path};}else{return K.getPrimitiveValue(c);}}};b.prototype.getCriticalityFromEnum=function(c){return C.getCriticalityIndicatorFromEnum(c);};b.prototype.getConfig=function(){return this.kpiConfig;};b.prototype.getImproveDirection=function(d,D,s,c,v){C.setVals(d,D,s,c,v);return(C[this.kpiConfig.criticalityCalculation.improveDirection]());};b.prototype.getPathOrAnnotationPath=function(e,i){var p=i?e.Path:(e.Path||e.AnnotationPath);if(/^@/.test(p)){p=p.slice(1);}return p;};return b;},true);

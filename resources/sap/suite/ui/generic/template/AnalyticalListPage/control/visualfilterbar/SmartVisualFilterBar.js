sap.ui.define(["sap/m/HeaderContainer","sap/suite/ui/generic/template/AnalyticalListPage/controller/VisualFilterDialogController","sap/ui/comp/odata/ODataModelUtil","sap/ui/comp/smartfilterbar/FilterProvider","sap/suite/ui/generic/template/AnalyticalListPage/control/visualfilterbar/VisualFilterProvider","sap/ui/comp/smartvariants/PersonalizableInfo","sap/ui/comp/smartvariants/SmartVariantManagement","sap/ui/model/Filter","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/ui/comp/odata/MetadataAnalyser","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/m/VBox","sap/m/Button","sap/m/Title","sap/suite/ui/generic/template/AnalyticalListPage/controller/DropDownController"],function(H,V,O,F,a,P,S,b,c,T,M,d,e,f,B,g,D){"use strict";var o=sap.ui.model.SimpleType.extend("sap.ui.model.DimensionFilterType",{formatValue:function(v){return v;},parseValue:function(v){return v;},validateValue:function(v){}});var h=H.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.SmartVisualFilterBar",{metadata:{designTime:true,properties:{entitySet:{type:"string",group:"Misc",defaultValue:null},config:{type:"object",group:"Misc",defaultValue:null},persistencyKey:{type:"string",group:"Misc",defaultValue:null},displayCurrency:{type:"string",group:"Misc",defaultValue:null},smartFilterId:{type:"string",group:"Misc",defaultValue:null}},associations:{smartVariant:{type:"sap.ui.core.Control",multiple:false}},events:{filterChange:{}}},renderer:{}});h.prototype.init=function(){if(H.prototype.init){H.prototype.init.apply(this,arguments);}var i=jQuery(document.body).hasClass("sapUiSizeCozy");this._cellItemHeightNorth="2.0rem";this._cellItemHeightSouth=i?"9.9rem":"7.9rem";this._cellHeight=i?"12rem":"10.9rem";this._cellWidth="20rem";this.labelHeight=2.0;this.compHeight=i?9.9:7.9;this.cellHeightPadding=1;this.cellHeight=(this.labelHeight+this.compHeight+this.cellHeightPadding)+"rem";this.cellWidth=320;this._dialogFilters={};this._compactFilters={};this._oVariantConfig={};this._smartFilterContext;this._oMetadataAnalyser;this.setModel(new sap.ui.model.json.JSONModel(),'_visualFilterConfigModel');if(i){if(sap.ui.Device.system.phone){this.setOrientation("Vertical");this.addStyleClass("sapSmartTemplatesAnalyticalListPageVisualFilterBarCozyPhone");}else{this.addStyleClass("sapSmartTemplatesAnalyticalListPageVisualFilterBarCozy");}}else{this.addStyleClass("sapSmartTemplatesAnalyticalListPageVisualFilterBar");}};h.prototype.propagateProperties=function(){H.prototype.propagateProperties.apply(this,arguments);this._initMetadata();};h.prototype._initMetadata=function(){if(!this.bIsInitialised){O.handleModelInit(this,this._onMetadataInit);}};h.prototype._onMetadataInit=function(){if(this.bIsInitialised){return;}this._annoProvider=this._createVisualFilterProvider();if(!this._annoProvider){return;}this._oMetadataAnalyser=this._annoProvider.getMetadataAnalyser();this.bIsInitialised=true;this._updateFilterBar();};h.prototype._createVisualFilterProvider=function(){var m=this.getModel();var i=this.getEntitySet();if(!m||!i){return null;}return new a(this);};h.prototype._getBasicGroupTitle=function(){return this.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE");};h.prototype._getFieldGroupForProperty=function(E,C){return this._annoProvider?this._annoProvider._getFieldGroupForProperty(E,C):undefined;};h.prototype._getGroupList=function(){return this._annoProvider?this._annoProvider.getGroupList():[];};h.prototype._getGroupMap=function(){return this._annoProvider?this._annoProvider.getGroupMap():{};};h.prototype._getMeasureMap=function(){return this._annoProvider?this._annoProvider.getMeasureMap():{};};h.prototype._getDimensionMap=function(){return this._annoProvider?this._annoProvider.getDimensionMap():{};};h.prototype.setSmartFilterContext=function(C){this._smartFilterContext=C;};h.prototype._updateFilterBar=function(){var i=this._getAnnotationSettings();if(i&&i.filterList){var j=this._convertSettingsToConfig(i);}else{j={filterCompList:[]};this.getModel('_visualFilterConfigModel').setData(j);return;}var v=this._getVariantConfig();if(v&&v.config){j.filterCompList.forEach(function(k){if(v.config[k.component.properties.parentProperty]){jQuery.extend(true,k,v.config[k.component.properties.parentProperty]);}});this._oVariantConfig=j;}this.unbindAggregation('content',true);this.getModel('_visualFilterConfigModel').setData(j);this.bindAggregation('content',{path:"_visualFilterConfigModel>/filterCompList",factory:function(I,C){var k=C.getProperty('component'),p=k?k.properties:undefined,s=this._resolveChartType(k?k.type:undefined);return this._createHeaderItems(C.sPath,s,p);}.bind(this),filters:new sap.ui.model.Filter("shownInFilterBar",sap.ui.model.FilterOperator.EQ,true)});return;};h.prototype._createHeaderItems=function(p,t,i){var j=this._createFilterItemOfType(t,i),I=j.getInParameters(),k=[],m=this;if(I&&I.length>0){I.forEach(function(u){k.push({path:'_filter>/'+u.localDataProperty});});}j.addCustomData(new sap.ui.core.CustomData({key:'sPath',value:p}));if(m.getEntitySet()===j.getEntitySet()){var l=m._smartFilterContext.determineMandatoryFilterItems();if(l&&l.length>0){l.forEach(function(u){if(!u.data("isCustomField")){k.push({path:'_filter>/'+u.getName()});}});}}j.bindProperty('dimensionFilter',{path:'_filter>/'+j.getParentProperty(),type:new o()});j.bindProperty('measureField',{path:'_visualFilterConfigModel>'+p+'/component/properties/measureField'});j.bindProperty('sortOrder',{path:'_visualFilterConfigModel>'+p+'/component/properties/sortOrder'});j.bindProperty('unitField',{path:'_visualFilterConfigModel>'+p+'/component/properties/measureField',formatter:function(){var u=m._getMeasureMap();var v=u[this.getEntitySet()][this.getMeasureField()];return v?v.fieldInfo.unit:"";}});if(k&&k.length>0){j.bindProperty('dimensionFilterExternal',{parts:k,formatter:function(){var I=this.getInParameters(),u=this.getParentProperty();var v,w;if(!(m.getEntitySet()===this.getEntitySet()&&m._smartFilterContext.getAnalyticBindingPath()!=="")&&(m._smartFilterContext.getAnalyticBindingPath()===""||((m._smartFilterContext.getAnalyticBindingPath().indexOf("P_DisplayCurrency"))!=-1))){var x=m.getProperty("displayCurrency");if(x){var y=this.getMeasureField();var z=m.getModel();var A=z.getMetaModel();var E=A.getODataEntityType(m._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(this.getEntitySet()));var G=A.getODataProperty(E,y);if(G){var J=G[e.ISOCurrency];if(J){var K=J.Path;for(var L=(I.length-1);L>-1;L--){var N=I[L].valueListProperty;var Q=I[L].localDataProperty;if(N===K){var R=m._smartFilterContext.getFilterData();if(!R[Q]){w=A.getODataProperty(E,K);if(w&&w["sap:filterable"]!=="false"){v=new sap.ui.model.Filter({aFilters:[new sap.ui.model.Filter({path:K,operator:"EQ",value1:x,value2:undefined})],and:false});}}break;}}}}}}return m._getFiltersForFilterItem(I,u,v,K);}});}if(j.attachFilterChange){j.attachFilterChange(this._onFilterChange,this);}if(j.attachTitleChange){j.attachTitleChange(this._onTitleChange,this);}var n=this._createTitleToolbar(i,j),q=new f({height:this._cellItemHeightNorth,items:[n]});var r=new f({width:"100%",height:this._cellItemHeightSouth,items:[new sap.m.Text({width:this.cellWidth+"px",textAlign:sap.ui.core.TextAlign.Center,text:{path:'_visualFilterConfigModel>'+p+'/overlayMessage',formatter:function(u){return this.getModel("i18n").getResourceBundle().getText(u);}}})],visible:{path:'_visualFilterConfigModel>'+p+'/showChartOverlay',formatter:function(v){return v;}}});r.addStyleClass("sapUiOverlay");r.addStyleClass("sapSmartTemplatesAnalyticalListPageVFOverflow");r.addStyleClass("sapSmartTemplatesAnalyticalListPageVFOverflowCozy");var s=new f({height:this._cellItemHeightSouth,items:[j],visible:{path:"_visualFilterConfigModel>"+p+"/showChartOverlay",formatter:function(v){return!v;}}});var C=new f({fieldGroupIds:["headerBar"],height:this._cellHeight,width:this.cellWidth+"px",items:[q,r,s]});return C;};h.prototype._getAnnotationSettings=function(){return this._annoProvider?this._annoProvider.getVisualFilterConfig():null;};h.prototype._convertSettingsToConfig=function(s,I){var k={filterCompList:[]};var l=this._getGroupList();var m={};for(var i=0;i<l.length;i++){var n=l[i];for(var j=0;j<n.fieldList.length;j++){var p=n.fieldList[j];m[p.name]={name:n.name,label:n.label};}}var q=this._getGroupMap();var r=q["_BASIC"];var t=[];if(r&&r.fieldList){for(var i=0;i<r.fieldList.length;i++){t.push(r.fieldList[i].name);}}var u=this._getMeasureMap(),v=s.filterList,w={};for(var i=0;i<v.length;i++){var x=v[i];var y=x.dimension.field;var z=u[x.collectionPath][x.measure.field];var A=false;if(z.fieldInfo[e.ISOCurrency]){A=true;}var C={shownInFilterBar:x.selected,component:{type:x.type,properties:{sortOrder:x.sortOrder,measureField:x.measure.field,parentProperty:x.parentProperty?x.parentProperty:undefined}}};if(!I){var E={shownInFilterDialog:x.selected||t.indexOf(y)!=-1,group:m[x.parentProperty],component:{properties:{scaleFactor:x.scaleFactor,numberOfFractionalDigits:x.numberOfFractionalDigits,filterRestriction:x.filterRestriction,width:this.cellWidth+"px",height:this.compHeight+"rem",entitySet:x.collectionPath?x.collectionPath:this.getEntitySet(),dimensionField:y,dimensionFieldDisplay:x.dimension.fieldDisplay,dimensionFilter:x.dimensionFilter,unitField:z?z.fieldInfo.unit:"",isCurrency:A,isDropDown:x.isDropDown,isMandatory:x.isMandatory,outParameter:x.outParameter?x.outParameter:undefined,inParameters:x.inParameters?x.inParameters:undefined,textArrangement:x.displayBehaviour,chartQualifier:x.chartQualifier?x.chartQualifier:undefined,dimensionFieldIsDateTime:x.dimensionFieldIsDateTime}}};jQuery.extend(true,C,E);k.filterCompList.push(C);}else{w[x.parentProperty]=C;}}return I?w:k;};h.prototype._setVariantModified=function(){if(this._oVariantManagement){this._oVariantManagement.currentVariantSetModified(true);}};h.prototype._onFilterChange=function(i){this._setVariantModified();this.fireFilterChange();};h.prototype._getFiltersForFilterItem=function(i,p,j,k){var l={},m=[],n=new sap.ui.model.Filter({aFilters:[],and:true});if(i){var r=function(t){t.sPath=v;};for(var q=(i.length-1);q>-1;q--){var s=i[q].localDataProperty,v=i[q].valueListProperty;if(s!==p&&m.indexOf(s)===-1){l=this._smartFilterContext.getFilters([s]);if(l&&l.length>0){if(l[0].aFilters){l[0].aFilters.forEach(r.bind(this));}else{r(l[0]);}m.push(s);n.aFilters.push(l[0]);}}}if(j){n.aFilters.push(j);}}return n;};h.prototype._createTitleToolbar=function(p,i){var t=new g({text:{path:"i18n>VIS_FILTER_TITLE_MD",formatter:function(){return i.getTitle();}},titleStyle:sap.ui.core.TitleLevel.H6});if(i.getProperty("isMandatory")){t.addStyleClass("sapMLabelRequired");}var I=this._smartFilterContext.getControlByKey(p.parentProperty);this._smartFilterContext.ensureLoadedValueHelp(p.parentProperty);if(I){var j=d.getPropertyNameDisplay(this.getModel(),i.getEntitySet(),i.getDimensionField()),r=this.getModel("i18n").getResourceBundle(),k=I.getShowValueHelp&&I.getShowValueHelp(),s=(p.isDropDown)?"sap-icon://slim-arrow-down":"",l=k?"sap-icon://value-help":s,m,n=new B({text:{path:"_filter>/"+i.getParentProperty(),formatter:function(C){var u=i.getFilterRestriction();m=0;if(C){if(u==='single'){m=1;}else{if(typeof C==="object"){if(C.value){m++;}if(C.items&&C.items.length){m+=C.items.length;}if(C.ranges&&C.ranges.length){m+=C.ranges.length;}}else{m++;}}}return m?"("+m+")":"";}},icon:(k||p.isDropDown)?l:"",visible:{path:"_filter>/"+i.getParentProperty(),formatter:function(C){if(k||p.isDropDown){return true;}else{if(!C){return false;}if(typeof C==="object"){return(C.value||(C.items&&C.items.length)||(C.ranges&&C.ranges.length))?true:false;}return true;}}},press:function(E){if(k){I.fireValueHelpRequest.call(I);}else if(p.isDropDown){var u=this._isEntitytypeSearchable(this.getModel(),p.entitySet),v=this.getModel("visualFilter")||this.getModel();D.createDropdown(E.getSource(),i,v,j,p,u);}else{V.launchAllFiltersPopup(n,i,E.getSource().getModel('i18n'));}}.bind(this),layoutData:new sap.m.OverflowToolbarLayoutData({priority:sap.m.OverflowToolbarPriority.NeverOverflow}),tooltip:{path:"_filter>/"+i.getParentProperty(),formatter:function(){return d.getTooltipForValueHelp(k,j,r,m);}}});}var q=new c({design:sap.m.ToolbarDesign.Transparent,width:this.cellWidth+"px",content:[t,new T(),n]});q.addStyleClass("sapSmartTemplatesAnalyticalListPageVisualFilterTitleToolbar");return q;};h.prototype._isEntitytypeSearchable=function(m,E){var j=m.getMetaModel().getODataEntitySet(E);if(j.extensions.length){for(var i=0;i<j.extensions.length;i++){if(j.extensions[i].name=="searchable"){return j.extensions[i].value=="true";}}}return true;};h.prototype.getTitleByFilterItemConfig=function(i,u,s){var p=i.component.properties;var j=p.entitySet;var m=this.getModel();if(!m){return"";}var k=d.getPropertyNameDisplay(m,j,p.measureField);var l=d.getPropertyNameDisplay(m,j,p.dimensionField);if(!u){u="";}if(!s){s="";}var t="";var r=this.getModel("i18n").getResourceBundle();if(s&&u){t=r.getText("VIS_FILTER_TITLE_MD_UNIT_CURR",[k,l,s,u]);}else if(u){t=r.getText("VIS_FILTER_TITLE_MD_UNIT",[k,l,u]);}else if(s){t=r.getText("VIS_FILTER_TITLE_MD_UNIT",[k,l,s]);}else{t=r.getText("VIS_FILTER_TITLE_MD",[k,l]);}return t;};h.prototype._onTitleChange=function(i){var C=i.getSource().getParent().getParent();var l=C.getItems()[0].getItems()[0].getContent()[0];if(i.getSource().getProperty("isMandatory")){l.addStyleClass("sapMLabelRequired");}l.setText(i.getSource().getTitle());l.setTooltip(i.getSource().getTitle());};h.prototype._getSupportedFilterItemList=function(){if(!this._supportedFilterItemList){this._supportedFilterItemList=[{type:"Bar",className:"sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroBar",iconLink:"sap-icon://horizontal-bar-chart",textKey:"VISUAL_FILTER_CHART_TYPE_BAR"},{type:"Donut",className:"sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroDonut",iconLink:"sap-icon://donut-chart",textKey:"VISUAL_FILTER_CHART_TYPE_Donut"},{type:"Line",className:"sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroLine",iconLink:"sap-icon://line-charts",textKey:"VISUAL_FILTER_CHART_TYPE_Line"}];}return this._supportedFilterItemList;};h.prototype._getSupportedFilterItemMap=function(){if(!this._supportedFilterItemMap){this._supportedFilterItemMap={};var j=this._getSupportedFilterItemList();for(var i=0;i<j.length;i++){var k=j[i];this._supportedFilterItemMap[k.type]=k;}}return this._supportedFilterItemMap;};h.prototype._resolveChartType=function(t){var i=this._getSupportedFilterItemMap();var j=i[t];if(!j){var k;for(k in i){j=i[k];break;}jQuery.sap.log.error("Could not resolve the filter component type: \""+t+"\", falling back to "+k);t=k;}return t;};h.prototype._createFilterItemOfType=function(t,p){var i=this._getSupportedFilterItemMap();var j=i[t];var k=j.className;jQuery.sap.require(k);var l=jQuery.sap.getObject(k);var m=new l(p);m.setSmartFilterId(this.getSmartFilterId());m.setModel(this.getModel('_filter'),'_filter');m.setModel(this.getModel('i18n'),'i18n');m.setModel(this.getModel("_templPriv"),"_templPriv");m.setModel(this.getModel('_visualFilterConfigModel'),"_visualFilterConfigModel");m.setModel(this.getModel());var v=this.getModel("visualFilter");if(v){m.setModel(v,"visualFilter");}return m;};h.prototype.getConfig=function(I){var j=this.getModel('_visualFilterConfigModel').getData(),v={};if(!j){return{filterCompList:[]};}var k=0;var l=sap.ui.getCore().byFieldGroupId("headerBar");for(var i=0;i<j.filterCompList.length;i++){var m=j.filterCompList[i];if(I){v[m.component.properties.parentProperty]={shownInFilterBar:m.shownInFilterBar,component:{type:m.component.type,properties:{measureField:m.component.properties.measureField,sortOrder:m.component.properties.sortOrder,parentProperty:m.component.properties.parentProperty}}};}else{if(!m.shownInFilterBar){continue;}var n=l[k];if(!n){jQuery.sap.log.error("The configured selected filter bar items do not correspond to the actual filter bar items.  Could be an error during initialization, e.g. a chart class not found");return{filterCompList:[]};}k++;if(n._chart){var p=n;m.component.properties=p.getP13NConfig();}}}return I?v:j;};h.prototype.setSmartVariant=function(s){this.setAssociation("smartVariant",s);if(s){var p=new P({type:"sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.SmartVisualFilterBar",keyName:"persistencyKey"});p.setControl(this);}this._oVariantManagement=this._getVariantManagementControl(s);if(this._oVariantManagement){this._oVariantManagement.addPersonalizableControl(p);this._oVariantManagement.initialise(this._variantInitialised,this);this._oVariantManagement.attachSave(this._onVariantSave,this);}else if(s){if(typeof s==="string"){jQuery.sap.log.error("Variant with id="+s+" cannot be found");}else if(s instanceof sap.ui.core.Control){jQuery.sap.log.error("Variant with id="+s.getId()+" cannot be found");}}else{jQuery.sap.log.error("Missing SmartVariant");}};h.prototype._getVariantManagementControl=function(s){var i=null;if(s){i=typeof s=="string"?sap.ui.getCore().byId(s):s;if(i&&!(i instanceof S)){jQuery.sap.log.error("Control with the id="+s.getId?s.getId():s+" not of expected type");return null;}}return i;};h.prototype._variantInitialised=function(){if(!this._oCurrentVariant){this._oCurrentVariant="STANDARD";}};h.prototype._onVariantSave=function(){if(this._oCurrentVariant=="STANDARD"){this._oCurrentVariant={config:this.getConfig(true)};}};h.prototype.applyVariant=function(v,C){this._oCurrentVariant=v;if(this._oCurrentVariant=="STANDARD"){this._oCurrentVariant=null;}if(this._oCurrentVariant&&this._oCurrentVariant.config&&this._oCurrentVariant.config.filterCompList){this._oCurrentVariant.config=null;}if(this._oCurrentVariant&&this._oCurrentVariant.config==null){var i=this._getAnnotationSettings();if(i&&i.filterList){this._oCurrentVariant.config=this._convertSettingsToConfig(i,true);}}this._updateFilterBar();if(this._oVariantManagement){this._oVariantManagement.currentVariantSetModified(false);}};h.prototype._getVariantConfig=function(){return this._oCurrentVariant;};h.prototype.fetchVariant=function(){if(!this._oCurrentVariant||this._oCurrentVariant=="STANDARD"){var i=this._getAnnotationSettings();if(i&&i.filterList){this._oCurrentVariant={config:this._convertSettingsToConfig(i,true)};return this._oCurrentVariant;}else{return{config:null};}}return{config:this.getConfig(true)};};h.prototype.updateVisualFilterBindings=function(A){var j=sap.ui.getCore().byFieldGroupId("headerBar");for(var i=0;i<j.length;i++){if(j[i]._chart){j[i]._updateBinding();j[i]._bAllowBindingUpdateOnPropertyChange=A===true;}}};h.prototype.addVisualFiltersToBasicArea=function(p){var j=jQuery.extend(true,{},this.getModel('_visualFilterConfigModel').getData()),k=(p&&p.constructor===Array&&p.length)?p.length:0,C=0;if(!j){jQuery.sap.log.error("Could not add filter to basic area. No config found!");return false;}else if(!k){jQuery.sap.log.error("Improper parameter passed. Pass an array of properties.");return false;}else{for(var i=0;i<j.filterCompList.length;i++){var l=j.filterCompList[i];if(p.indexOf(d.readProperty(l.component.properties.parentProperty))!==-1&&!l.shownInFilterBar){l.shownInFilterBar=true;l.shownInFilterDialog=true;C++;}}if(C){this.getModel('_visualFilterConfigModel').setData(j);return true;}else{jQuery.sap.log.info("Filters already present in visual filter basic area");return false;}}};return h;},true);

sap.ui.define(["sap/suite/ui/microchart/InteractiveDonutChart","sap/suite/ui/microchart/InteractiveDonutChartSegment","sap/ui/model/json/JSONModel","sap/suite/ui/generic/template/AnalyticalListPage/control/visualfilterbar/FilterItemMicroChart","sap/suite/ui/generic/template/AnalyticalListPage/util/CriticalityUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil"],function(I,a,J,F,C,b){"use strict";var c="__IS_OTHER__";var d=F.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroDonut",{metadata:{properties:{labelWidthPercent:{type:"float",group:"Misc",defaultValue:1/2}},aggregations:{control:{type:"sap.suite.ui.microchart.InteractiveDonutChart",multiple:false}}},renderer:{}});d.prototype.init=function(){this._chart=new sap.suite.ui.microchart.InteractiveDonutChart({selectionEnabled:true,segments:[]});this.setControl(this._chart);this.setModel(new J(),'__alp_chartJSONModel');this._otherField="__IS_OTHER__";this._sorters=[];F.prototype.init.apply(this,arguments);};d.prototype._applyDonutChartSelections=function(o,D){var s=this._chart.getSegments(),p=this.getParentProperty(),S=[],e,r;if(o.dimValue===c){s.forEach(function(f){e=f.getCustomData()[0].getValue();if(e!==c){if(f.getSelected()){S.push(e);}r={"exclude":true,"operation":"EQ"};r.keyField=p;r.value1=e;D.ranges.push(r);}});if(S.length>0){D.items=D.items.filter(function(f){return S.indexOf(f.key)===-1;});D.ranges=D.ranges.filter(function(r){return!(r.exclude===false&&r.operation==="EQ"&&r.keyField===p&&S.indexOf(r.value1)>-1);});}}else{D.items.push({key:o.dimValue,text:o.dimValueDisplay});var i=false;s.forEach(function(f){e=f.getCustomData()[0].getValue();if(e===c&&f.getSelected()){i=true;}if(e!==c){S.push(e);}});if(i){D.ranges=D.ranges.filter(function(r){return!(r.exclude===true&&r.operation==="EQ"&&r.keyField===p&&S.indexOf(r.value1)>-1);});}}return D;};d.prototype._updateBinding=function(){this.applyOverlay();this._chart.setBusyIndicatorDelay(0);this._chart.setBusy(true);this._chart.unbindSegments();var e=this.getEntitySet(),f=this.getDimensionField(),g=this.getDimensionFieldDisplay(),m=this.getMeasureField(),u=this.getUnitField(),h=this.getDimensionFilterExternal(),s=[],S=[],s=this.getSortOrder(),M=this.getModel(),o=M.getMetaModel(),i=F._getSorter(s);this._sorters=i.sorter;S=i.sortFields;if(!e||!m||!f||!g){return;}var j=[m,f],n=b.IsNavigationProperty(this.getModel(),e,g)?g.split("/")[0]:null,N=b.getKeysForNavigationEntitySet(o,this.getEntitySet(),n),j=b.getVisualFilterSelectFields(m,f,g,u,S,N);var k=[];if(h&&h.aFilters&&h.aFilters.length){k=[h];}var l=this;var M=this.getModel();var B="/"+e;if(M){var D=C.getDataPoint(M,this);if(D){(D.ValueFormat&&D.ValueFormat.ScaleFactor)?this.setScaleFactor(b.getPrimitiveValue(D.ValueFormat.ScaleFactor)):this.setScaleFactor(null);(D.ValueFormat&&D.ValueFormat.NumberOfFractionalDigits)?this.setNumberOfFractionalDigits(b.getPrimitiveValue(D.ValueFormat.NumberOfFractionalDigits)):this.setNumberOfFractionalDigits(null);var r=C.getCriticalityRefProperties(D);}if(this.getSmartFilterId()){var p=sap.ui.getCore().byId(this.getSmartFilterId());if(p&&p.getEntitySet()===e){var t=this.getModel("_templPriv"),q=t.getProperty('/alp/searchable');if(q){B=this.considerAnalyticBinding(B,p);}else{this.applyOverlay(this.requiredFilterMessage);return;}}}if(this._oTop4ReadObject){this._oTop4ReadObject.abort();}if(this._oTotalReadObject){this._oTotalReadObject.abort();}var T=this._fetchData(M,B,k,j,false,r,D,n),v=this._fetchData(M,B,k,[m],true);jQuery.when(T,v).then(function(w,x){if(!w[1]){l.applyOverlay(l.noDataIssueMessage);}else if(w[1]<=3){l._onDataReceived(w[0]);}else if(w[1]>3){if(x[1]){l._onDataReceived(w[0],x[0]);}else{l.applyOverlay(l.noDataIssueMessage);}}},function(E,w){if(!E||(E.statusCode!==0&&E.statusText!=="abort")){if(w===true){l._oTotalReadObject=null;}else{l._oTop4ReadObject=null;}l.applyOverlay(l.technicalIssueMessage);}});}};d.prototype._fetchData=function(m,B,f,s,t,r,D,n){var e=this,o=new jQuery.Deferred(),v=this.getModel("visualFilter")||m;if(!v&&!B){o.reject(null,t);}else{var u={"$select":r?[r].concat(s).join(","):s.join(","),"$top":(t)?1:4};if(n&&!t){jQuery.extend(u,{"$expand":n});}var g={async:true,filters:f,urlParameters:u,success:function(h,i){if(t===true){e._oTotalReadObject=null;}else{e._oTop4ReadObject=null;}h=D?C.CalculateCriticality(D,h,e.getMeasureField()):h;var j=(h&&h.results&&h.results.length)?h.results.length:0;o.resolve(h,j);},error:function(h,t){o.reject(h,t);}};if(!t){g.sorters=this._sorters;}if(t){this._oTotalReadObject=v.read(B,g);}else{this._oTop4ReadObject=v.read(B,g);}}return o.promise();};d.prototype._onDataReceived=function(t,T){var r=[],D=this.getDimensionFieldDisplay(),m=this.getMeasureField(),s=this.getDimensionField(),n=b.IsNavigationProperty(this.getModel(),this.getEntitySet(),D)?D.split("/"):null;if(!T){t.results.forEach(function(h,i){h['dimensionValue']=h[s];r.push(h);});}else{var f=0,o=0;t.results.forEach(function(h,i){if(i<2){h['dimensionValue']=h[s];r.push(h);f+=parseFloat(h[m]);}});if(T){T.results.forEach(function(h){var i=this.getModel("i18n"),j=jQuery.extend(true,{},h);j['dimensionValue']=this._otherField;j[s]=this._otherField;if(n&&n.length>0){j[n[0]]={};j[n[0]][n[1]]=i?i.getResourceBundle().getText("VIS_FILTER_DONUT_OTHER"):"";}else{j[D]=i?i.getResourceBundle().getText("VIS_FILTER_DONUT_OTHER"):"";}if(f<0){o=parseFloat(h[m])+f;}else{o=parseFloat(h[m])-f;}j[m]=o;r.push(j);}.bind(this));}}F.prototype._onDataReceived.call(this,r);this.getModel('__alp_chartJSONModel').setData(r);this._chart.setModel(this.getModel('__alp_chartJSONModel'));var e=3,g={path:'/',template:new a(this._getChartAggregationSettings(true)),startIndex:0,length:e};this._chart.bindSegments(g);this._chart.setBusy(false);};return d;},true);

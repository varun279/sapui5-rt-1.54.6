sap.ui.define(['jquery.sap.global','sap/ui/core/mvc/Controller','sap/ui/model/Filter','sap/ui/model/json/JSONModel',"sap/m/Button","sap/m/StandardListItem","sap/m/List","sap/m/ToolbarSpacer","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/ui/model/FilterOperator"],function(q,C,F,J,B,S,L,T,a,b){"use strict";var s=false,t={},I={},u="",D=C.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController",{});sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createDropdown=function(c,o,m,d,p,i){u=(p.filterRestriction=='multiple')?q.extend(true,{items:[],ranges:[],value:null},o.getDimensionFilter()):o.getDimensionFilter();var e=c.getModel('i18n'),f={"descriptionAndId":p.dimensionFieldDisplay,"descriptionOnly":p.dimensionFieldDisplay,"idAndDescription":p.dimensionField,"idOnly":p.dimensionField},f=(Object.keys(f).indexOf(p.textArrangement)!==-1)?f[p.textArrangement]:p.dimensionFieldDisplay,g=new sap.m.ToggleButton({icon:"sap-icon://menu",type:"Transparent",iconFirst:true,enabled:(u&&u.hasOwnProperty("items"))?Boolean(u.items.length):Boolean(u),tooltip:e.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_VIEW_SELECTED")}),l=sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createStandardListItem(m,o,e,d,p,g,f),h=sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createPopoverWithList(m,o,e,p,d,l,f,g,i),O=new sap.m.Button({text:e.getResourceBundle().getText("OK"),press:function(E){o.setDimensionFilter(u);o.fireFilterChange();h.close();}}),k=new sap.m.Button({text:e.getResourceBundle().getText("CANCEL"),press:function(){h.close();}});s=false;h.addContent(l);l.attachSelectionChange(function(E){var n=l.getModel().getData(E.mParameters.listItem.getBindingContext().sPath);n=n[p.dimensionField];var r=E.getParameters().listItem.mProperties.selected;if(p.filterRestriction==='multiple'){if(u.items&&u.items.length){for(var j=0;j<u.items.length;j++){if(u.items[j].key===n){u.items.splice(j,1);}else if(r){u.items.push({key:n});break;}}}else if(u.items){u.items.push({key:n});}else{u.items=[];}if(u.items.length){t.setVisible(true);I.setText(e.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_SELECTED_COUNT",[d,u.items.length]));}t.setVisible(Boolean(u.items.length));g.setEnabled(this.bUpdateToolbarButton||Boolean(u.items.length));}else if(p.filterRestriction==='single'){u=n;if(u){t.setVisible(true);I.setText(e.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_SELECTED_COUNT",[d,+Boolean(u)]));}g.setEnabled(Boolean(u));}}.bind(this));h.addStyleClass("sapSmartTemplatesAnalyticalListPageSelectedLinkDialog");h.setBeginButton(O);h.setEndButton(k);h.openBy(c);};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createPopoverWithList=function(m,c,i,p,d,l,f,o,e){if(l){var A=function(E){if(E.getParameter("clearButtonPressed")){return;}var g=this.fnApplyFilterFromSearchField(f,E.getSource().getValue());var h=l.getBinding("items");s=false;o.setPressed(false);o.setTooltip(i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_VIEW_SELECTED"));h.filter(g);}.bind(this);this.oSearchField=new sap.m.SearchField({liveChange:A,search:A,enabled:e,initialFocus:true});this._oPopoverDialog=new sap.m.ResponsivePopover('',{placement:sap.m.PlacementType.Bottom,verticalScrolling:true,title:d,subHeader:[new sap.m.Toolbar({content:[this.oSearchField,o]})],content:[l]});this._oPopoverDialog.setModel(c.getModel("_filter"),"_filter");}this._oPopoverDialog.setInitialFocus(this.oSearchField);this._oPopoverDialog.setContentWidth("320px");return this._oPopoverDialog;};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.createStandardListItem=function(m,c,i,d,p,o,f){var e="/"+p.entitySet,g=sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.standardListItemTemplateCreation(c,p);I=new sap.m.Label({text:i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_SELECTED_COUNT",[d,typeof(c.getDimensionFilter())==="object"&&c.getDimensionFilter()!==null?c.getDimensionFilter().items.length:+Boolean(c.getDimensionFilter())])});t=new sap.m.Toolbar({content:[I,new sap.m.ToolbarSpacer(),new sap.ui.core.Icon({src:"sap-icon://sys-cancel",tooltip:i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_CLEAR_SELECTION"),press:function(E){t.setVisible(false);s=false;o.setTooltip(i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_VIEW_SELECTED"));o.setEnabled(false);o.setPressed(false);l.removeSelections(true);(u&&u.hasOwnProperty("items"))?u.items=[]:u="";I.setText(i.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_SELECTED_COUNT",[d,(u&&u.hasOwnProperty("items"))?u.items.length:+Boolean(u)]));l.getBinding("items").filter(this.fnApplyFilterFromSearchField(f,this.oSearchField.getValue()));}.bind(this)}).addStyleClass("sapSmartTemplatesAnalyticalListPageDropdownDialogCancelButton")],"visible":(u&&u.hasOwnProperty("items"))?Boolean(u.items.length):Boolean(u)});if(c.getSmartFilterId()){var h=sap.ui.getCore().byId(c.getSmartFilterId());if(h&&h.getEntitySet()===p.entitySet){e=c.considerAnalyticBinding(e,h);}}var j=[p.measureField,p.dimensionField,p.dimensionFieldDisplay],n=a.IsNavigationProperty(c.getModel(),p.entitySet,p.dimensionFieldDisplay)?p.dimensionFieldDisplay.split("/")[0]:null,U={select:j.join(",")};if(n){q.extend(U,{"expand":n});}var l=new sap.m.List({mode:p.filterRestriction==="single"?sap.m.ListMode.SingleSelectMaster:sap.m.ListMode.MultiSelect,growing:true,growingThreshold:15,showNoData:false,infoToolbar:t,items:{path:e,template:g,sorter:sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.getSortObject(p),parameters:U}});g.setModel(c.getModel("_filter"),"_filter");l.setModel(m);o.attachPress(function(E){if(p.filterRestriction=="multiple"&&u.items.length||u&&u.hasOwnProperty('items')&&!u.items.length&&s){sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.updateFilterWithListBindings(l,o,i,p.filterRestriction,p.dimensionField);}else if(p.filterRestriction=="single"&&u!=null||u==null&&s){sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.updateFilterWithListBindings(l,o,i,p.filterRestriction,p.dimensionField);}});return l;};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.selectedVisibilityUpdateFormatter=function(u,c){for(var i=0;i<u.items.length;i++){if(u.items[i].key===c){return true;}}return false;};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.standardListItemTemplateCreation=function(c,p){var d=p.textArrangement,e=[];e.push({path:p.measureField});p.unitField?e.push({path:p.unitField}):"";var f=new sap.m.StandardListItem({title:{parts:[p.dimensionFieldDisplay,p.dimensionField],formatter:function(o,g){return a.getTextArrangement(o,g,d);}},description:{parts:e,formatter:function(g,h){return sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroChart.prototype._getFormattedNumberWithUoM(g,h);}},selected:{parts:["_filter>/"+c.getParentProperty(),p.dimensionField],formatter:function(o,g){if(s){return true;}else{if(typeof(u)==="object"&&u!==null){for(var i=0;i<u.items.length;i++){if(u.items[i].key===g){return true;}}}else{return(u!==null&&u===g)?true:false;}}}}});return f;};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.getSortObject=function(p){if(p.sortOrder&&p.sortOrder.length){return new sap.ui.model.Sorter((p.sortOrder[0].Field)?p.sortOrder[0].Field.String:"",p.sortOrder[0].Descending.Boolean);}};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.updateFilterWithListBindings=function(l,o,c,f,d){var e=[];s=!s;this.bUpdateToolbarButton=s;if(s){o.setTooltip(c.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_VIEW_ALL"));o.setEnabled(true);if(f==='multiple'){for(var i=0;i<u.items.length;i++){var g=new F(d,sap.ui.model.FilterOperator.EQ,(f==="multiple")?u.items[i].key:u);e.push(g);}}else if(f==='single'){var g=new F(d,sap.ui.model.FilterOperator.EQ,u);e.push(g);}l.getBinding("items").filter(e);}else{o.setTooltip(c.getResourceBundle().getText("VIS_VALUEHELP_DROPDOWN_VIEW_SELECTED"));o.setEnabled((u&&u.hasOwnProperty("items"))?Boolean(u.items.length):Boolean(u));l.getBinding("items").filter(e);}};sap.suite.ui.generic.template.AnalyticalListPage.controller.DropDownController.fnApplyFilterFromSearchField=function(f,Q){var c=[];if(Q&&Q.length>0){var d=new F(f,b.Contains,Q);c.push(d);}return c;};return D;});

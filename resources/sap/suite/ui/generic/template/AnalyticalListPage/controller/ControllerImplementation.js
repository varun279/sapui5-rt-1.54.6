sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/model/json/JSONModel","sap/m/ObjectIdentifier","sap/m/Table","sap/m/Text","sap/ui/comp/smartfield/SmartField","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/base/EventProvider","sap/suite/ui/generic/template/AnalyticalListPage/extensionAPI/ExtensionAPI","sap/ui/core/ResizeHandler","sap/suite/ui/generic/template/AnalyticalListPage/controller/FilterBarController","sap/suite/ui/generic/template/AnalyticalListPage/controller/ToolbarController","sap/suite/ui/generic/template/AnalyticalListPage/controller/VisualFilterBarController","sap/suite/ui/generic/template/AnalyticalListPage/controller/VisualFilterDialogController","sap/suite/ui/generic/template/lib/MessageUtils","sap/m/MessageBox","sap/ui/table/AnalyticalTable","sap/ui/model/odata/AnnotationHelper","sap/ui/model/analytics/odata4analytics","sap/suite/ui/generic/template/AnalyticalListPage/controller/ContentAreaController","sap/suite/ui/generic/template/AnalyticalListPage/controller/IappStateHandler","sap/suite/ui/generic/template/AnalyticalListPage/util/CommonUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/ui/Device"],function(q,B,J,O,T,a,S,b,E,c,R,F,d,V,f,M,g,A,h,j,C,I,k,l,D){"use strict";var m="sap.suite.ui.generic.template.customData",n="sap.suite.ui.generic.template.genericData",o="chart",p="visual",r="compact";return{getMethods:function(v,t,s){var u={};var w=true;function x(){var e=s.getOwnerComponent();var i=e.getModel("_templPriv");i.setProperty("/listReport/isLeaf",e.getIsLeaf());}function y(){var e=q.sap.getObject("sap.ushell.Container.getUser");var i=s.getOwnerComponent().getAppComponent().getMetadata().getManifestEntry("sap.ui");var Q=(i&&i.icons&&i.icons.icon)||"";var U=s.getOwnerComponent().getAppComponent().getMetadata().getManifestEntry("sap.app");var W=(U&&U.title)||"";var X={bookmarkIcon:Q,bookmarkAppTitle:W,bookmarkCustomUrl:function(){P();return hasher.getHash()?("#"+hasher.getHash()):window.location.href;},bookmarkServiceUrl:function(){var Z=u.oSmartTable.getTable();var $;if(Z){$=Z.getBinding("rows")||Z.getBinding("items");}else{$="";}return $?$.getDownloadUrl()+"&$top=0&$inlinecount=allpages":"";},isShareInJamActive:!!e&&e().isJamActive()};var Y=s.getOwnerComponent().getModel("_templPriv");Y.setProperty("/listReport/share",X);}function z(e,i){var Q=e&&e.property;return Q.filter(function(U){return typeof U[i]!=="undefined";});}function G(i){var Q=i.getModel(),U=Q&&Q.getMetaModel(),W=U&&U.getODataEntityType(i.getEntityType()),X=U&&U.getODataEntityType(i.getEntityType(),true),Y=W&&z(W,"com.sap.vocabularies.Common.v1.FilterDefaultValue"),Z,$,_,a1,b1,c1,d1=[];try{$=new j.Model(new j.Model.ReferenceByModel(Q));c1=$&&$.findQueryResultByName(i.getEntitySet());_=c1&&c1.getParameterization();a1=_&&U.getODataEntitySet(_.getEntitySet().getQName());b1=a1&&U.getODataEntityType(a1.entityType);d1=b1?z(b1,"defaultValue"):[];}catch(e){q.sap.log.Error(e);}if(Y.length>0||d1.length>0){Z={"SelectOptions":[],"Parameters":[]};Y.forEach(function(e1){var f1=U.createBindingContext(X+"/property/[${path:'name'}===\'"+e1.name+"']/com.sap.vocabularies.Common.v1.FilterDefaultValue"),g1={"PropertyName":e1.name,"Ranges":[{"Sign":"I","Option":"EQ","Low":h.format(f1),"High":null}]};Z.SelectOptions.push(g1);});d1.forEach(function(e1){var f1={"PropertyName":e1.name,"PropertyValue":e1.defaultValue};Z.Parameters.push(f1);});}return Z;}function H(e){var i=e.getSource(),Q=G(i);if(Q){u.oIappStateHandler.fnSetFiltersUsingUIState(JSON.stringify(Q),true,false);}u.oIappStateHandler.onSmartFilterBarInitialise();s.onInitSmartFilterBarExtension(e);}function K(){var e=u.oIappStateHandler.onSmartFilterBarInitialized();e.then(function(){w=false;},function(i){if(i instanceof Error){i.showMessageBox();}u.oIappStateHandler.fnSetDefaultFilter();u.oIappStateHandler.fnUpdateSVFB();w=false;});}function L(e){var i=e.getParameters();var Q=e.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationPressed(Q,i);}function N(e){var i,Q;i=e.getParameters();Q=e.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(Q,i,u,undefined,undefined);}function P(){if(!w){u.oIappStateHandler.fnStoreCurrentAppStateAndAdjustURL();}}return{onInit:function(){var e=s.getOwnerComponent();var Q=e.getModel("_templPriv");Q.setProperty("/alp",{filterMode:e.getHideVisualFilter()?r:e.getDefaultFilterMode(),contentView:e.getDefaultContentView(),autoHide:e.getAutoHide(),visibility:{hybridView:(D.system.phone||D.system.tablet&&!D.system.desktop)?false:true},filterChanged:false});u.hideVisualFilter=e.getHideVisualFilter();u.hideVisualFilter=(u.hideVisualFilter===undefined||u.hideVisualFilter!==true)?false:true;u.oSmartFilterbar=s.byId("template::SmartFilterBar");u.oSmartTable=s.byId("table");u.oSmartFilterableKPI=s.byId("template::KPITagContainer::filterableKPIs");u.oPage=s.byId("template::Page");u.oSmartChart=s.byId("chart");u.alr_compactFilterContainer=s.byId("template::CompactFilterContainer");u.alr_visualFilterContainer=s.byId("template::VisualFilterContainer");u.alr_filterContainer=s.byId("template::FilterContainer");u.alr_visualFilterBar=s.byId("template::VisualFilterBar");u.alp_ColumnListItem=s.byId("template::responsiveHightlightCol");if(u.alr_visualFilterBar){u.alr_visualFilterBar.setSmartFilterId(u.oSmartFilterbar.getId());}u.oKpiTagContainer=s.byId("template::KPITagContainer::globalKPIs");u.oFilterableKpiTagContainer=s.byId("template::KPITagContainer::filterableKPIs");if(u.oKpiTagContainer||u.oFilterableKpiTagContainer){q.sap.require("sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiTagController");sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiTagController.init(u);}u.oContentArea=new C();u.oTemplateUtils=t;u.toolbarController=new d();u.oController=s;u.filterBarController=new F();u.filterBarController.init(u);u.oContentArea.createAndSetCustomModel(u);u.oContentArea.setState(u);if(!u.hideVisualFilter){u.visualFilterBarContainer=new V();u.visualFilterBarContainer.init(u);}u.oIappStateHandler=new I(u,s,t.oCommonUtils.getNavigationHandler());x();y();s.byId("template::FilterText").attachBrowserEvent("click",function(){s.byId("template::Page").setHeaderExpanded(true);});Q.setProperty("/listReport/isHeaderExpanded",true);if(u.oSmartTable){var U=u.oSmartTable.getTable();}var W="sapUiSizeCozy",X="sapUiSizeCompact",Y="sapUiSizeCondensed";if(t.oCommonUtils.isUiTable(U)||U instanceof A){var Z=s.getView();var $=q(document.body);if($.hasClass(W)||Z.hasStyleClass(W)){u.oSmartTable.addStyleClass(W);}else if($.hasClass(X)||Z.hasStyleClass(X)){var _=e.getComponentContainer().getSettings().condensedTableLayout;if(_===false){u.oSmartTable.addStyleClass(X);}else{u.oSmartTable.addStyleClass(Y);}}}if(u.oSmartFilterableKPI){u.oSmartFilterableKPI.setModel(e.getModel("_templPriv"),"_templPriv");var a1=u.oSmartFilterableKPI.getContent(),b1=u.oController;a1.forEach(function(i){if(i.getSmartFilterId){i.attachBeforeRebindFilterableKPI(function(c1){var d1=c1.getParameters(),e1=d1.selectionVariant,f1=d1.entityType;b1.onBeforeRebindFilterableKPIExtension(e1,f1);},b1);}});}v.getUrlParameterInfo=function(){return u.oIappStateHandler.getUrlParameterInfo();};v.onComponentActivate=function(){};v.refreshBinding=function(){if(u.alr_visualFilterBar&&u.alr_visualFilterBar.updateVisualFilterBindings){u.alr_visualFilterBar.updateVisualFilterBindings();}if(u.oSmartChart&&u.oSmartChart.rebindChart){u.oSmartChart.rebindChart();}if(u.oSmartTable){t.oCommonUtils.refreshSmartTable(u.oSmartTable);}if(u.oKpiTagContainer){var c1=u.oKpiTagContainer.mAggregations.content;for(var i in c1){if(c1[i]._createGlobalKpi){c1[i]._createGlobalKpi();}}}if(u.oFilterableKpiTagContainer){var c1=u.oFilterableKpiTagContainer.mAggregations.content;for(var i in c1){if(c1[i]._createFilterableKpi){c1[i]._createFilterableKpi();}}}};u.oSmartFilterbar.attachFilterChange(function(i){var c1=u.oSmartChart&&u.oSmartChart.getChart()&&u.oSmartChart.getDrillStackFilters();var Q=e.getModel("_templPriv");if(c1&&c1.length){Q.setProperty('/alp/_ignoreChartSelections',false);}else{Q.setProperty('/alp/_ignoreChartSelections',true);}u.oIappStateHandler.fnCheckMandatory();var d1=i.getSource(),e1=q.extend(true,{},d1.getFilterData(true)),f1=u.oController.getOwnerComponent().getModel("_filter");f1.setData(e1);if(i.getParameters().filterItem){if(!u.hideVisualFilter){u.filterBarController.changeVisibility(i);}Q.setProperty('/alp/_ignoreChartSelections',false);}u.filterBarController._updateFilterLink();if(!u.oSmartFilterbar.isLiveMode()&&!u.oSmartFilterbar.isDialogOpen()){if(u.oSmartFilterableKPI&&u.oSmartFilterableKPI.getEnabled()){Q.setProperty('/alp/filterChanged',true);}}});},handlers:{onBack:function(){t.oServices.oNavigationController.navigateBack();},addEntry:function(e){var i=e.getSource();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){t.oCommonEventHandlers.addEntry(i,false,u.oSmartFilterbar);},q.noop,u);},deleteEntries:function(e){t.oCommonEventHandlers.deleteEntries(e);},onSelectionChange:function(e){var Q=e.getSource(),U=Q.getModel(),W=Q.getModel("_templPriv");var X=U.getMetaModel(),Y=X.getODataEntitySet(this.getOwnerComponent().getEntitySet()),Z=Y["Org.OData.Capabilities.V1.DeleteRestrictions"];var $=(Z&&Z.Deletable&&Z.Deletable.Path)?Z.Deletable.Path:"";var _=false;var a1=true;var b1=($&&$!=="");var c1=t.oCommonUtils.getSelectedContexts(Q);if(c1.length>0){for(var i=0;i<c1.length;i++){var d1=U.getObject(c1[i].getPath());if(!(d1.IsActiveEntity&&d1.HasDraftEntity&&d1.DraftAdministrativeData&&d1.DraftAdministrativeData.InProcessByUser)){a1=false;}if(b1){if(U.getProperty($,c1[i])){b1=false;}}if(!a1&&!b1){_=true;break;}}}W.setProperty("/listReport/deleteEnabled",_);},onChange:function(e){t.oCommonEventHandlers.onChange(e);},onSmartFieldUrlPressed:function(e){t.oCommonEventHandlers.onSmartFieldUrlPressed(e,u);},onContactDetails:function(e){t.oCommonEventHandlers.onContactDetails(e);},onSmartFilterBarInitialise:H,onSmartFilterBarInitialized:K,onEditStateFilterChanged:function(e){e.getSource().fireChange();},onFilterPress:function(e){u.filterBarController.showDialog.call(u.filterBarController);},onClearPress:function(e){u.filterBarController.clearFilters();s.onClearFilterExtension(e);},onGoPress:function(e){u.filterBarController.onGoFilter();},onBeforeSFBVariantSave:function(){var e=u.oIappStateHandler.getCurrentAppState();if(!this.getOwnerComponent().getProperty('smartVariantManagement')){delete e.customData["sap.suite.ui.generic.template.genericData"].contentView;}u.oSmartFilterbar.setFilterData({_CUSTOM:e.customData});},onAfterSFBVariantLoad:function(){var e=u.oSmartFilterbar.getFilterData();if(e._CUSTOM!==undefined){u.oIappStateHandler.fnRestoreFilterState(e._CUSTOM);}else{var i=u.oIappStateHandler.getFilterState();k.nullify(i[m]);k.nullify(i[n]);u.oIappStateHandler.fnRestoreFilterState(i);}P();},onBeforeRebindTable:function(e){t.oCommonEventHandlers.onBeforeRebindTable(e);s.onBeforeRebindTableExtension(e);},onBeforeRebindChart:function(e){},onShowDetails:function(e){t.oCommonEventHandlers.onShowDetails(e.getSource(),u);},onListNavigate:function(e){if(!s.onListNavigationExtension(e)){t.oCommonEventHandlers.onListNavigate(e.getSource(),u);}},onCallActionFromToolBar:function(e){var i=t.oCommonUtils.getParentTable;t.oCommonUtils.getParentTable=function(){return u.oSmartTable;};t.oCommonEventHandlers.onCallActionFromToolBar(e,u);t.oCommonUtils.getParentTable=i;i=null;},onShowDetailsIntent:function(e){t.oCommonEventHandlers.onShowDetailsIntent(e,u.oSmartFilterbar);},onCallActionFromList:function(e){},onDataFieldForIntentBasedNavigation:function(e){t.oCommonEventHandlers.onDataFieldForIntentBasedNavigation(e,u);},onDataFieldWithIntentBasedNavigation:function(e){t.oCommonEventHandlers.onDataFieldWithIntentBasedNavigation(e,u);},onBeforeSemanticObjectLinkPopoverOpens:function(e){var i=e.getParameters();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){var Q=u.oSmartFilterbar.getUiState({allFilters:false}).getSelectionVariant();t.oCommonUtils.semanticObjectLinkNavigation(i,Q,s);},q.noop,u,q.noop);},onAssignedFiltersChanged:function(e){if(e&&e.getSource()){if(u&&u.oSmartFilterbar&&u.filterBarController){s.byId("template::FilterText").setText(u.oSmartFilterbar.retrieveFiltersWithValuesAsText());}}},onToggleFiltersPressed:function(){var e=s.getOwnerComponent();var i=e.getModel("_templPriv");i.setProperty("/listReport/isHeaderExpanded",(i.getProperty("/listReport/isHeaderExpanded")===true)?false:true);},onSearchButtonPressed:function(){if(D.system.phone&&u.oPage.getHeaderExpanded()){u.oPage.setHeaderExpanded(false);}var e=s.getOwnerComponent().getModel();if(u.oSmartFilterableKPI&&!u.oSmartFilterableKPI.getEnabled()){u.oController.getOwnerComponent().getModel("_templPriv").setProperty('/alp/filterChanged',false);}e.attachEventOnce("requestSent",function(){if(!w){P();}else{u.oIappStateHandler.fnResolveStartUpPromise();}});t.oCommonUtils.refreshModel(u.oSmartTable);var i=function(Q){M.handleError("getCollection",this,t.oServices,Q.getParameters());var U=this.getView().byId("table");U.getTable().setBusy(false);var W=s&&s.customizeMsgModelforTransientMessages();if(W){W.then(function(){M.handleTransientMessages(t.oServices.oApplication.getDialogFragmentForView.bind(null,null));},function(){M.handleTransientMessages(t.oServices.oApplication.getDialogFragmentForView.bind(null,null));});}else{M.handleTransientMessages(t.oServices.oApplication.getDialogFragmentForView.bind(null,null));}}.bind(this);e.attachEventOnce("requestFailed",i);e.attachEventOnce("requestCompleted",function(Q){if(Q.getParameter("success")){e.detachEvent("requestFailed",i);}});},onSemanticObjectLinkPopoverLinkPressed:function(e){t.oCommonEventHandlers.onSemanticObjectLinkPopoverLinkPressed(e,u);},onSemanticObjectLinkNavigationPressed:L,onSemanticObjectLinkNavigationTargetObtained:N,onAfterTableVariantSave:function(){P();},onAfterApplyTableVariant:function(){P();},onAfterChartVariantSave:function(e){P();t.oCommonUtils.setEnabledToolbarButtons(e.getSource());},onAfterApplyChartVariant:function(){P();},onFilterModeSegmentedButtonChange:function(e){u.filterBarController.handleFilterSwitch(e.getParameter("key"),e.oSource._bApplyingVariant);u.oController._templateEventHandlers.onSegmentButtonPressed();},onContentViewSegmentButtonPressed:function(){u.oController._templateEventHandlers.onSegmentButtonPressed(!u.oController.getOwnerComponent().getProperty('smartVariantManagement'));},onSegmentButtonPressed:function(i){if(!i){u.oController.byId('template::PageVariant').currentVariantSetModified(true);u.oSmartFilterbar.setFilterData({_CUSTOM:u.oIappStateHandler.getFilterState()});}P();},onShareListReportActionButtonPress:function(e){if(!u.oShareActionSheet){u.oShareActionSheet=t.oCommonUtils.getDialogFragment("sap.suite.ui.generic.template.fragments.lists.ShareSheet",{shareEmailPressed:function(){P();sap.m.URLHelper.triggerEmail(null,t.oCommonUtils.getText("EMAIL_HEADER",[t.oServices.oApplication.getAppTitle()]),document.URL);},shareJamPressed:function(){P();var i=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:document.URL,share:t.oServices.oApplication.getAppTitle()}}});i.open();}},"share",function(i,Q){var U=sap.ui.getCore().getLibraryResourceBundle("sap.m");Q.setProperty("/emailButtonText",U.getText("SEMANTIC_CONTROL_SEND_EMAIL"));Q.setProperty("/jamButtonText",U.getText("SEMANTIC_CONTROL_SHARE_IN_JAM"));Q.setProperty("/bookmarkButtonText",U.getText("SEMANTIC_CONTROL_SAVE_AS_TILE"));var W=q.sap.getObject("sap.ushell.Container.getUser");Q.setProperty("/jamVisible",!!W&&W().isJamActive());i.openBy(e.getSource());});}else{u.oShareActionSheet.openBy(e.getSource());}},onDeterminingDataFieldForAction:function(e){var i=u.oController.getOwnerComponent().getModel("_templPriv");var Q=i.getProperty('/alp/contentView');var U=(Q===o)?u.oSmartChart:u.oSmartTable;t.oCommonEventHandlers.onDeterminingDataFieldForAction(e,U);},onDeterminingDataFieldForIntentBasedNavigation:function(e){var i=e.getSource();var Q=u.oController.getOwnerComponent().getModel("_templPriv");var U=Q.getProperty('/alp/contentView');var W=(U===o)?u.oSmartChart:u.oSmartTable.getTable();t.oCommonEventHandlers.onDeterminingDataFieldForIntentBasedNavigation(i,W,u);},onInlineDataFieldForAction:function(e){t.oCommonEventHandlers.onInlineDataFieldForAction(e,u);},onInlineDataFieldForIntentBasedNavigation:function(e){t.oCommonEventHandlers.onInlineDataFieldForIntentBasedNavigation(e.getSource(),u);},onAutoHideToggle:function(){u.oSmartTable.getModel("_tableHighlight").setProperty("/highlightMode","eyeModeSwitch");u.chartController&&u.chartController._updateTable();P();},onFullScreenToggled:function(e){var i=e.getParameter("fullScreen");var Q=e.getSource().getModel("_templPriv");Q.setProperty("/alp/fullScreen",i);},onDialogOpened:function(e){var i=u.oSmartFilterbar.getFilterDialogContent();if(!u.visualFilterDialogContainer){u.visualFilterDialogContainer=new f();u.visualFilterDialogContainer.init(u);}if(i.length<2){var Q=[new sap.m.SegmentedButtonItem({icon:"sap-icon://filter-fields",width:"inherit",key:r,tooltip:"{i18n>FILTER_COMPACT}"}),new sap.m.SegmentedButtonItem({icon:"sap-icon://filter-analytics",width:"inherit",key:p,tooltip:"{i18n>FILTER_VISUAL}",enabled:"{_templPriv>/alp/searchable}"})];var U=new sap.m.SegmentedButton({width:"inherit",selectedKey:r,items:Q,select:function(e){var Z=e.getSource();Z.setSelectedKey(r);u.visualFilterDialogContainer._toggle.call(u.visualFilterDialogContainer);}}).addEventDelegate({onAfterRendering:function(e){if(e.srcControl.getCustomData()[0]&&e.srcControl.getCustomData()[0].getValue()){e.srcControl.focus();e.srcControl.removeAllCustomData();}}});var W=u.visualFilterDialogContainer._createForm();u.oSmartFilterbar.addFilterDialogContent(W);var X=new sap.m.OverflowToolbar({design:sap.m.ToolbarDesign.Transparent,content:[new sap.m.ToolbarSpacer(),U]}).addStyleClass("sapSmartTemplatesAnalyticalListPageFilterDialogToolbar");i[0].setToolbar(X);U.setModel(u.oController.getView().getModel("_templPriv"),"_templPriv");}var Y=u.oController.getView().getModel("_templPriv");if(Y.getProperty("/alp/searchable")){if(Y.getProperty("/alp/filterMode")===p){u.oSmartFilterbar.addFilterDialogContent(i[1]);if(D.system.desktop&&(!D.system.phone||!D.system.tablet)){u.oSmartFilterbar.setContentWidth(790);u.oSmartFilterbar.setContentHeight(685);}else if(D.system.tablet){if(D.orientation.portrait){u.oSmartFilterbar.setContentWidth(400);u.oSmartFilterbar.setContentHeight(720);}else if(D.orientation.landscape){u.oSmartFilterbar.setContentWidth(512);u.oSmartFilterbar.setContentHeight(861);}}}else{u.oSmartFilterbar.addFilterDialogContent(i[0]);}}else{u.oSmartFilterbar.addFilterDialogContent(i[0]);}},onSearchForFilters:function(e){u.visualFilterDialogContainer._triggerSearchInFilterDialog.call(u.visualFilterDialogContainer,e);},onDialogSearch:function(e){u.visualFilterDialogContainer._searchDialog.call(u.visualFilterDialogContainer);},onDialogCancel:function(e){u.visualFilterDialogContainer._cancelDialog.call(u.visualFilterDialogContainer);},onDialogClear:function(e){s.onClearFilterExtension(e);},onRestore:function(e){u.visualFilterDialogContainer._restoreDialog.call(u.visualFilterDialogContainer);},onDataReceived:function(e){u.oContentArea.enableToolbar();t.oCommonEventHandlers.onDataReceived(e);},onRowSelectionChange:function(e){var i=e.getSource();t.oCommonUtils.setEnabledToolbarButtons(i);}},extensionAPI:new c(t,s,u)};}};});

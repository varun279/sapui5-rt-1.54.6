sap.ui.define(["jquery.sap.global","sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/thirdparty/d3","sap/suite/ui/generic/template/AnalyticalListPage/util/KpiUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms"],function(q,F,C,J,D,K,V){"use strict";q.sap.require("sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationFormatter");var n,s,S;var c=C.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiCardController",{onInit:function(e){q.sap.require("sap.ovp.cards.CommonUtils");},onExit:function(){},onBeforeRendering:function(){var o=sap.ovp.cards.CommonUtils;var v=this.getView();var a=v.data("qualifierSettings");var Q=a.qualifier;var m=v.getModel();var M=m.getMetaModel();var e=M.getODataEntitySet(a.entitySet);var E=M.getODataEntityType(e.entityType);var f=v.data("mergedSelectionVariant");var k=v.data("kpiAnnotationPath");var b=v.data("selectionPresentationVariantPath");var d=v.data("dataPointPath");var g="kpiCard"+Q;var h={"cards":{}};h["cards"][g]={"model":a.model,"template":"sap.ovp.cards.charts.analytical","settings":{"title":v.data("kpiTitle"),"entitySet":a.entitySet,"showFilterInHeader":true,"navigation":"chartNav"}};if(k){h["cards"][g].settings.kpiAnnotationPath=k;}else{h["cards"][g].settings.dataPointAnnotationPath=d;h["cards"][g].settings.selectionPresentationAnnotationPath=b;}if(E[d]&&E[d].hasOwnProperty("Description")){h["cards"][g]["settings"].subTitle=E[d]["Description"].String;}o.createCardComponent(v,h,"template::ALPcardContainer",f);o.onHeaderClicked=function(i){this.handleNavigationPress(v);}.bind(this);o.onContentClicked=function(i){var j=i.getObject();this.handleNavigationPress(v,j);}.bind(this);},handleNavigationPress:function(v,o){var N=v.getModel("detailNavigation");if(N){var t=N.getProperty("/target");var a=N.getProperty("/action");if(t&&a){if(!n){n=s.getNavigationHandler();}var O={semanticObject:t,action:a};this._oSelectionVariant=new sap.ui.generic.app.navigation.service.SelectionVariant();var b=JSON.parse(N.getProperty("/parameters"));this._createNavigationContext(b,true);this._getSelectOptionsFromAnnotation(v);if(o){this._createNavigationContext(o);}S.adaptNavigationParameterExtension(this._oSelectionVariant,O);this._oSelectionVariant=this._oSelectionVariant.toJSONString();n.navigate(t,a,this._oSelectionVariant,null,function(e){if(e instanceof sap.ui.generic.app.navigation.service.NavError){if(e.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){sap.m.MessageBox.show(s.getText("ST_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:s.getText("ST_GENERIC_ERROR_TITLE")});}else{sap.m.MessageBox.show(e.getErrorCode(),{title:s.getText("ST_GENERIC_ERROR_TITLE")});}}});}}},_assignSmartTemplateDependencies:function(o,a){s=o;S=a;n=s.getNavigationHandler();},_createNavigationContext:function(p,I){var k=Object.keys(p);for(var i=0;i<k.length;i++){var e=k[i];if(!p[e]&&p[e]!==""){return;}if(I){this._oSelectionVariant.addParameter(e,p[e]);}else{if(this._oSelectionVariant.getSelectOption(e)){this._oSelectionVariant.removeSelectOption(e);}this._oSelectionVariant.addSelectOption(e,"I","EQ",p[e]);}}},_getSelectOptionsFromAnnotation:function(v){var t=this;var I=v.data("qualifierSettings").filterable;if(I){var m=v.data("mergedSelectionVariant");var p=this._oSelectionVariant.getParameterNames();if(p){for(var i=0;i<p.length;i++){if(!m.getParameter(p[i])){m.addParameter(p[i],this._oSelectionVariant.getParameter(p[i]));}}}this._oSelectionVariant=m;return;}var o=v.data("selectionVariant");var a=o.SelectOptions;var b=o.Parameters;if(b&&b.length){b.forEach(function(P){var d=P.PropertyName.PropertyPath;var e=P.PropertyValue.String;if(t._oSelectionVariant.getParameter(d)){t._oSelectionVariant.removeParameter(d);}t._oSelectionVariant.addParameter(d,e);});}if(a&&a.length){a.forEach(function(d){var P=d.PropertyName.PropertyPath;var r=d.Ranges;r.forEach(function(R){var l=R.Low.String;var h=(R.High&&R.High.String)?R.High.String:null;var e=R.Sign.EnumMember.split("/")[1];var O=R.Option.EnumMember.split("/")[1];t._oSelectionVariant.addSelectOption(P,e,O,l,h);});});}}});return c;});

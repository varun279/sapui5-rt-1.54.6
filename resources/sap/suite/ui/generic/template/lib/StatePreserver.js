sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/suite/ui/generic/template/lib/testableHelper"],function(q,B,t){"use strict";var c=(sap&&sap.ushell&&sap.ushell.Container)?sap.ushell.Container.getService("CrossApplicationNavigation"):(function(){var r=q.Deferred();r.resolve(Object.create(null));return{createEmptyAppState:function(){return{getKey:function(){return"";},setData:q.noop,save:function(){return Promise.resolve();}};},getAppState:function(){return r;}};})();t.testableStatic(function setCrossAppNavService(s){c=s;},"StatePreserver_setCrossAppNavService");function g(T,s){var r="";var i=false;var a=Promise.resolve();var n=null;var A=false;var S=null;var b=null;var l,L,d;var C=Object.create(null);var o={};var e={};function I(){C.permanentEntries=Object.create(null);C.sessionEntries=Object.create(null);C.pageEntries=Object.create(null);C.allEntries=Object.create(null);}I();function f(H){I();for(var K in H){var J=q.extend(true,{},H[K]);C.allEntries[K]=J;var M=J.lifecycle||Object.create(null);if(M.permanent){C.permanentEntries[K]=J;}else if(M.session){C.sessionEntries[K]=J;}if(M.page||M.pagination){C.pageEntries[K]=J;}}return C;}function m(H,P){if(P===H){return;}var N=P.next.next;P.next.next=H.next;H.next=P.next;P.next=N;}function h(H,J,P){if(q.isEmptyObject(J)){return{appStateKey:""};}var K=JSON.stringify(J);var M=0;var N;for(N=H;N.next&&M<10;M++){if(N.next.serialize===K){m(H,N);return{appStateKey:H.next.appStateKey};}N=N.next;}N.next=null;var O=c.createEmptyAppState(s.oComponent.getAppComponent(),!P);var Q={next:H.next,serialize:K,appStateKey:O.getKey()};O.setData(J);O.save();H.next=Q;return{appStateKey:Q.appStateKey};}function j(){var H=h(e,C.sessionEntries,false);var J=Object.create(null);if(H.appStateKey){J.sessionAppStateKey=H.appStateKey;}if(!q.isEmptyObject(C.permanentEntries)){J.permanentEntries=C.permanentEntries;}S=h(o,J,true);A=false;if(b===S.appStateKey){S=null;}else{T.oNavigationControllerProxy.navigateByExchangingQueryParam(s.appStateName,S.appStateKey,true);}}function k(){if(!A){return;}var H=s.getCurrentState()||Object.create(null);f(H);j();}function p(P){return a.then(function(){var H=Object.create(null);var K=(l===P)&&L;if(K){H[s.appStateName]=[K];}return H;});}function u(){if(i){return;}if(!A){A=true;if(n){k();}else{setTimeout(k,0);}}}function v(H){r=H;S=null;var J=T.componentRegistry[s.oComponent.getId()];var P=T.oNavigationControllerProxy.getCurrentHash(J.viewLevel);l=P;L=H;}function w(H,J,U){if(!J){return;}for(var K in J){var M=J[K];if(U||M.lifecycle.page){H[K]=M;}}}function R(H,J,N){f(N);var K=Object.create(null);for(var M in N){K[M]=N[M].data;}s.applyState(K,H);if(n){n();n=null;}v(J);j();}function x(H,J,K){for(var M=H;M.next;M=M.next){if(M.next.appStateKey===K){m(H,M);return;}}var N={next:H.next,serialize:JSON.stringify(J),appStateKey:K};H.next=N;}function y(H,J,K,M,N,P,O,Q){if(i){J();return;}if(b===null){b=K;}else if(K!==b){J();return;}if(Q){var U=Q.getData();x(e,U,O);w(N,U,true);}w(N,P,true);R(M,b,N);H();}function z(H,J,K,M,N,O){var P=O.getData();x(o,P,K);if(P.sessionAppStateKey){var Q=c.getAppState(s.oComponent.getAppComponent(),P.sessionAppStateKey);Q.done(y.bind(null,H,J,K,M,N,P.permanentEntries,P.sessionAppStateKey));Q.fail(y.bind(null,H,J,K,M,N,P.permanentEntries,"",null));}else{y(H,J,K,M,N,P.permanentEntries,"",null);}}function D(H){var J=T.componentRegistry[s.oComponent.getId()];var K=J.utils.getHeaderDataAvailablePromise()||Promise.resolve();return K.then(function(){return T.oApplicationProxy.areTwoKnownPathesIdentical(d,H,J.viewLevel===1);});}function E(H,J){var K=new Promise(function(M,N){D(H).then(function(O){d=H;var P=Object.create(null);w(P,C[O?"allEntries":"pageEntries"],O||J);if(b===r||!b){if(b||O){w(P,C.sessionEntries,true);w(P,C.permanentEntries,true);}R(O,b,P);M();return;}if(!n){a=new Promise(function(U){n=U;});}var Q=c.getAppState(s.oComponent.getAppComponent(),b);Q.done(z.bind(null,M,N,b,O,P));Q.fail(N);},N);});return K;}function F(H){var J=H.getParameter("arguments");var Q=J&&J["?query"];b=(Q&&Q[s.appStateName])||"";if(S){if(S.appStateKey!==b){q.sap.log.error("StatePreserver: Got AppstateKey "+b+" expected "+S.appStateKey);return false;}v(b);return true;}return false;}function G(){return{isStateChange:F};}return{getUrlParameterInfo:p,stateChanged:u,applyAppState:E,getAsStateChanger:G};}return B.extend("sap.suite.ui.generic.template.lib.StatePreserver",{constructor:function(T,s){q.extend(this,g(T,s));}});});

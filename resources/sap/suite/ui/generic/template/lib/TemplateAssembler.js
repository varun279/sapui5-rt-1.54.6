sap.ui.define(["jquery.sap.global","sap/ui/core/mvc/View","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/suite/ui/generic/template/lib/TemplateViewController","sap/suite/ui/generic/template/lib/TemplateComponent","sap/suite/ui/generic/template/lib/Application","sap/suite/ui/generic/template/lib/CRUDManager","sap/suite/ui/generic/template/lib/CommonUtils","sap/suite/ui/generic/template/lib/ComponentUtils","sap/suite/ui/generic/template/lib/CommonEventHandlers","sap/suite/ui/generic/template/lib/ViewDependencyHelper","sap/suite/ui/generic/template/lib/routingHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/support/lib/CommonMethods"],function(q,V,J,R,T,a,A,C,b,c,d,e,r,t,f){"use strict";var m=Object.create(null);var g=Object.create(null);var h=function(o){var s=o.appComponent.getId();m[s]=o;return function(){delete m[s];};};function i(o){var s=o.getId();var p=m[s];return p;}function j(o){return i(o.getAppComponent()).oTemplateContract.componentRegistry[o.getId()];}function F(o){while(o&&!(o instanceof V)){o=o.getParent();}return o;}function G(o){while(o){var v=F(o);var p=v&&v.getController();var s=p&&p.getOwnerComponent();if(s instanceof a){var u=j(s);return u;}else{o=s&&s.oContainer;}}}function k(o,s,p,u,v){p=p||{};p.constructor=function(){T.prototype.constructor.apply(this,arguments);var M=o(u,this);this._templateEventHandlers=Object.freeze(M.handlers||{});this._templateFormatters=Object.freeze(M.formatters||{});this.extensionAPI=Object.freeze(M.extensionAPI||{});this.fnGenericOnInit=function(w){var x=w.getView();var y=x.getId();q.sap.log.info("Init view "+y+" of template "+s);var z=w.getOwnerComponent();var B=j(z);B.oControllerRegistryEntry={onExit:M.onExit||q.noop,oTemplateUtils:u,oAppRegistryEntry:v};g[y]=B.oControllerRegistryEntry;u.oServices.oApplicationController.registerView(x);u.oCommonUtils=new b(w,u.oServices,u.oComponentUtils);u.oServices.oCRUDManager=new C(w,u.oComponentUtils,u.oServices,u.oCommonUtils,v.oTemplateContract.oBusyHelper);u.oCommonEventHandlers=new d(w,u.oComponentUtils,u.oServices,u.oCommonUtils);(M.onInit||q.noop)();B.oController=this;B.fnViewRegisteredResolve();};};p.onInit=function(){this.fnGenericOnInit(this);delete this.fnGenericOnInit;};p.onExit=function(){var w=this.getView().getId();var x=g[w];x.oAppRegistryEntry.oTemplateContract.oApplicationProxy.destroyView(w);x.onExit();delete g[w];q.sap.log.info("View "+w+" of template "+s+" exited");};return T.extend(s,p);}function l(o){var p=o.methods.oControllerSpecification;return p&&function(){var s=o.oComponent.getAppComponent();var u=i(s);var v=s.getTransactionController();var N=s.getNavigationController();var w={oComponentUtils:o.utils,oServices:{oTemplateCapabilities:{},oApplicationController:s.getApplicationController(),oTransactionController:v,oNavigationController:N,oDraftController:v.getDraftController(),oApplication:u.application,oViewDependencyHelper:u.oViewDependencyHelper}};o.viewRegisterd.catch(function(x){N.navigateToMessagePage({viewLevel:o.viewLevel,title:o.oTemplateContract.getText("ST_ERROR"),text:o.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),description:""});});return k(p.getMethods,o.oComponent.getTemplateName(),p.oControllerDefinition,w,u);};}function n(o,p){var s=o.oComponent.getEntitySet();var u=i(o.oComponent.getAppComponent()).oTemplateContract;var v=u.mEntityTree[s];var w=v.embeddedComponents;for(var x in w){var y=w[x];if(o.oController.byId(y.containerId)===p){var z=p.getComponentInstance();o.reuseComponentProxies[x]=z._stProxy;var B=o.utils.getTemplatePrivateModel();B.setProperty("/generic/embeddedComponents/"+x,{});return{embeddedKey:x,embeddedComponent:y,templateContract:u,reuseComponent:z};}}}function E(o,p){var s=o.oController.extensionAPI;var u=q.extend({},s);if(s.getNavigationController){var N=q.extend({},s.getNavigationController());var v=N.navigateInternal;N.navigateInternal=function(w,x){var y=x&&x.routeName;if(y){o.utils.navigateRoute(y,w,p.embeddedKey,x&&x.replaceInHistory);}else{v(w,x);}};u.getNavigationController=function(){return N;};N.getSubCommunicationModel=function(){return p.embeddedComponent.communicationModel;};}u.getCommunicationObject=function(L){return L===1?p.embeddedComponent.communicationObject:o.utils.getCommunicationObject(L);};(o.methods.enhanceExtensionAPI4Reuse||q.noop)(u,p);return u;}h=t.testableStatic(h,"TemplateComponent_RegisterAppComponent");return{getTemplateComponent:function(o,s,p){var u=s+".Component";p=p||{};p.init=function(){var v=this.getComponentData();var w=v.registryEntry;w.viewRegisterd=new Promise(function(z,B){w.fnViewRegisteredResolve=function(D){if(D){w.fnViewRegisteredResolve=q.noop;w.oAppComponent.getNavigationController().navigateToMessagePage({title:w.oTemplateContract.getText("ST_ERROR"),text:w.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),description:D});B(D);}else{delete w.fnViewRegisteredResolve;z();}};});w.oViewRenderedPromise=new Promise(function(z){w.fnViewRenderdResolve=z;});w.oViewRenderedPromise.then(function(){f.setApplicationStatus(f.mApplicationStatus.RENDERED);f.publishEvent("elements","ViewRendered",{});});w.reuseComponentProxies=Object.create(null);(a.prototype.init||q.noop).apply(this,arguments);w.componentName=u;w.oComponent=this;w.activationTakt=0;w.utils=new c(this,w);w.methods=o(this,w.utils)||{};w.oGenericData={mRefreshInfos:{}};var x=this.getId();var y=i(w.oAppComponent);y.oTemplateContract.componentRegistry[x]=w;y.oTemplateContract.oBusyHelper.setBusy(w.viewRegisterd,true);w.oApplication=y.application;w.createViewController=l(w);w.componentCreateResolve(this);delete w.componentCreateResolve;delete v.registryEntry;(w.methods.init||q.noop)();};p.exit=function(){var v=this.getId();var w=j(this);var x=i(this.getAppComponent());var M=w.methods;(M.exit||q.noop)();delete x.oTemplateContract.componentRegistry[v];(a.prototype.exit||q.noop).apply(this,arguments);};p.onBeforeRendering=function(){var v=j(this);if(!v.oTemplateContract){var w=i(this.getAppComponent());v.oTemplateContract=w.oTemplateContract;}(a.prototype.onBeforeRendering||q.noop).bind(this,v).apply(this,arguments);var M=v.methods;(M.onBeforeRendering||q.noop)();};p.onAfterRendering=function(){var v=j(this);if(v.fnViewRenderdResolve&&!v.fnViewRegisteredResolve){v.fnViewRenderdResolve();delete v.fnViewRenderdResolve;}(a.prototype.onAfterRendering||q.noop).bind(this,v).apply(this,arguments);var M=v.methods;(M.onAftereRendering||q.noop)();};p.onActivate=function(B,I){var v=j(this);v.sCurrentBindingPath=B;var w=function(){v.utils.bindComponent(v.sCurrentBindingPath,I);v.utils.refreshBinding();return(v.methods.onActivate||q.noop)(B,I);};return v.fnViewRegisteredResolve?v.viewRegisterd.then(w):(w()||Promise.resolve());};p.setIsRefreshRequired=function(I){if(I){var v=j(this);if(v.utils.isComponentActive()){v.viewRegisterd.then(v.utils.refreshBinding.bind(null,true,{}));I=false;}}this.setProperty("isRefreshRequired",I);};p.onDeactivate=q.noop;return a.extend(u,p);},getRegisterAppComponent:function(){var o=h;h=null;return o;},getExtensionAPIPromise:function(o){var p=G(o);if(!p){return Promise.reject();}return p.viewRegisterd.then(function(){var s=n(p,o);if(s){return E(p,s);}return p.oController.extensionAPI;});},getExtensionAPI:function(o){var p=G(o);return p&&p.oController&&p.oController.extensionAPI;}};});

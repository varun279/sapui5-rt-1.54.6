/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/core/ComponentContainer","sap/ui/core/routing/HashChanger","sap/ui/core/routing/History","sap/ui/core/routing/HistoryDirection","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/m/MessagePage","sap/m/Link","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/routingHelper","sap/suite/ui/generic/template/lib/TemplateComponent","sap/suite/ui/generic/template/lib/testableHelper"],function(q,B,C,H,a,b,F,c,M,d,L,P,r,T,t){"use strict";var h=a.getInstance();function n(s){if(s.indexOf("/")===0){return s;}return"/"+s;}function f(o,R,i){var s=R.template;var E=R.entitySet;var v=R.viewLevel;var O=-1;if(o.oFlexibleColumnLayoutHandler){O=v<3?v:0;}var j=O<0?o.oNavigationObserver:o.aNavigationObservers[O];var k=new P();var m=O<0?o.oHeaderLoadingObserver:o.aHeaderLoadingObservers[O];m.addObserver(k);var p={};var S={appComponent:o.oAppComponent,isLeaf:!R.pages||!R.pages.length,entitySet:E,navigationProperty:R.navigationProperty,componentData:{registryEntry:{oAppComponent:o.oAppComponent,componentCreateResolve:i,route:R.name,routeConfig:R,viewLevel:v,routingSpec:R.routingSpec,oNavigationObserver:j,oHeaderLoadingObserver:k,preprocessorsData:p}}};if(R.component.settings){q.extend(S,R.component.settings);}var u;o.oAppComponent.runAsOwner(function(){try{var w=sap.ui.component({name:s,settings:S,handleValidation:true,async:true});var x;u=new C({propagateModel:true,width:"100%",height:"100%",settings:S});x=w.then(function(y){u.setComponent(y);return u;});u.loaded=function(){return x;};}catch(e){throw new Error("Component "+s+" could not be loaded");}});return u;}function g(o,e){t.testable(f,"fnCreateComponentInstance");var m={};var p={iHashChangeCount:0,backTarget:0};var s=[];var A=Promise.resolve();var u=[];var v=[];var w=[];function G(){var i=e.oRouter,j=i.getTargets()._mTargets,k=[];Object.keys(j).forEach(function(D1){var E1=j[D1],F1=E1._oOptions,G1=i.getRoute(F1.viewName),H1=G1&&G1._oConfig;if(H1&&(!H1.navigation||!H1.navigation.display)){k.push({oConfig:H1});}});return k;}t.testable(G,"fnGetAllPages");function x(i){var j=i||G();if(!Array.isArray(j)){j=[j];}j.forEach(function(k){k.oComponentContainer=f(o,k.oConfig,function(){});});return j;}t.testable(x,"fnCreatePages");function y(){var i=e.oRouter.getViews();i.getView({viewName:"root"});return o.mRouteToTemplateComponentPromise.root;}function z(){return e.oAppComponent.getManifestEntry("sap.app").title;}function D(){return p.iHashChangeCount;}function E(i,j,k){var D1=function(H1){q.extend(j,H1);};for(var E1 in o.componentRegistry){var F1=o.componentRegistry[E1];if(F1.route===i){var G1=F1.methods.getUrlParameterInfo;return G1?G1(k).then(D1):Promise.resolve();}}return Promise.resolve();}function I(j,k){var D1=k?E("root",j):Promise.resolve();return D1.then(function(){var E1="";var F1="";for(var G1 in j){var H1=j[G1];for(var i=0;i<H1.length;i++){var I1=H1[i];F1=F1+E1+G1+"="+I1;E1="&";}}return F1;});}function J(i,j){var D1=location.hash.split("&")[0]+"&/";for(var k=0;k<j;k++){D1=D1+i[k];if(k<(j-1)){D1=D1+"/";}}return D1;}function K(j){for(var i=0;i<j.length;i++){if(j[i].title!==u[j.length-i-1]||""){j[i].subtitle=u[j.length-i-1]||"";}}v=j;o.oShellServicePromise.then(function(k){k.setHierarchy(j);});}function S(i,j){u[i]=j;var k=v[v.length-i-1];if(k){if(k.title!==j){k.subtitle=j;}o.oShellServicePromise.then(function(D1){D1.setHierarchy(v);});}}function O(i,j,k){var D1=j.headerTitle;var E1=j.titleIconUrl;var F1=o.oFlexibleColumnLayoutHandler.getFullscreenLayout(j.level);var G1=J(k,j.level)+"?"+"FCLLayout="+F1;var H1={title:D1,icon:E1,intent:G1};var I1=o.oTemplatePrivateGlobalModel.getProperty("/generic/FCL/isVisuallyFullScreen");if(j.level<3&&!I1){i.push(H1);}}var Q;function R(){var i,k,D1,E1;var F1=o.oApplicationProxy.getHierarchySectionsFromCurrentHash();if(Q&&Q instanceof T){var G1=Q.getProperty("entitySet");E1=e.oTemplateContract.mEntityTree[G1];}else{return;}var H1=[];var I1,J1;if(o.oFlexibleColumnLayoutHandler){I1=E1;}if(F1.length>0){if(o.oFlexibleColumnLayoutHandler){O(H1,I1,F1);}for(var j=0;j<F1.length-1;j++){if(E1.parent){var K1=e.oTemplateContract.mEntityTree[E1.parent];if(o.oFlexibleColumnLayoutHandler){J1=J(F1,K1.level)+"?"+"FCLLayout="+o.oFlexibleColumnLayoutHandler.getFullscreenLayout(K1.level);}else{J1=J(F1,K1.level);}i=K1.headerTitle;D1=K1.titleIconUrl;E1=K1;}else{if(o.oFlexibleColumnLayoutHandler){J1=J(F1,E1.level)+"?"+"FCLLayout="+o.oFlexibleColumnLayoutHandler.getFullscreenLayout(E1.level);}else{J1=J(F1,E1.level);}i=e.oTemplateContract.mEntityTree[E1.entitySet].headerTitle;D1=e.oTemplateContract.mEntityTree[E1.entitySet].titleIconUrl;}k={title:i,icon:D1,intent:J1};H1.push(k);}k={title:z()};var L1=location.hash;(L1.indexOf("?")!==-1&&L1.indexOf("?")<L1.indexOf("&"))?k.intent=L1.split("?")[0]:k.intent=L1.split("&")[0];if(o.oFlexibleColumnLayoutHandler&&o.oFlexibleColumnLayoutHandler.isListAndFirstEntryLoadedOnStartup()){k.intent=k.intent+"&/?"+"FCLLayout="+o.oFlexibleColumnLayoutHandler.getFullscreenLayout(0);}I({},true).then(function(M1){if(M1){if(o.oFlexibleColumnLayoutHandler&&o.oFlexibleColumnLayoutHandler.isListAndFirstEntryLoadedOnStartup()){k.intent=k.intent+"&"+M1;}else{k.intent=k.intent+"&/?"+M1;}}H1.push(k);K(H1);});}}function U(i,j){var k;if(!i&&j instanceof T){var D1=j&&o.componentRegistry[j.getId()];var E1=D1&&D1.methods.getTitle;k=E1&&E1();}else if(!i&&j&&j.title){k=j.title;}k=k||z();Q=j;o.oShellServicePromise.then(function(F1){F1.setTitle(k);R();});}function V(j,k){var D1;var E1=[];for(var i=0;i<=k;i++){var F1=j[i];if(F1){if(D1){E1.push(F1);}else{D1=F1;}}}if(D1){D1.resume(E1);}}function W(i){var j=[o.oPagesDataLoadedObserver.getProcessFinished(true)];var k=null;var D1=p.iHashChangeCount;var E1=-1;var F1={};for(var G1 in o.componentRegistry){var H1=o.componentRegistry[G1];var I1=H1.oControllerRegistryEntry&&H1.oControllerRegistryEntry.oTemplateUtils.oServices.oTemplateCapabilities.oMessageButtonHelper;var J1=H1.activationTakt===D1;var K1=H1.utils.getTemplatePrivateModel();K1.setProperty("/generic/isActive",J1);if(J1){j.push(H1.oViewRenderedPromise);if(H1.viewLevel>E1){E1=H1.viewLevel;k=H1.oComponent;}F1[H1.viewLevel]=I1;}else{H1.utils.suspendBinding();if(I1){I1.suspend();}}}V(F1,E1);var L1=o.oFlexibleColumnLayoutHandler&&o.oFlexibleColumnLayoutHandler.isAppTitlePrefered();U(L1,i||k);Promise.all(j).then(function(){if(D1===p.iHashChangeCount&&q.isEmptyObject(m)){o.oAppComponent.firePageDataLoaded();}});}var X=W.bind(null,null);function Y(){q.sap.log.info("Navigate back");if(p.backTarget&&n(h.getPreviousHash()||"")!==n(p.hash)){o.oBusyHelper.setBusyReason("HashChange",true);}p.LeaveByBack=true;window.history.back();}function Z(i,j){i=n(i||"");q.sap.log.info("Navigate to hash: "+i);if(i===p.hash){q.sap.log.info("Navigation suppressed since hash is the current hash");return;}o.oBusyHelper.setBusyReason("HashChange",true);p.targetHash=i;if(p.backTarget&&n(h.getPreviousHash()||"")===i){Y();return;}p.LeaveByReplace=j;if(j){e.oHashChanger.replaceHash(i);}else{e.oHashChanger.setHash(i);}}function $(i,j,k,D1){var E1=j.then(function(F1){if(F1){i=i+"?"+F1;}if(D1){p.backwardingInfo={backCount:D1.backCount,targetViewLevel:D1.targetViewLevel,targetHash:n(i)};Y();}else{Z(i,k);}return i;});o.oBusyHelper.setBusy(E1);return E1;}function _(i){var j=0;for(var k=p;k.oEvent;){var D1=k.oEvent.getParameter("config").viewLevel;if(D1===0){return j;}if(i&&j>0){return-1;}j++;k=s[k.backTarget];}return-1;}function a1(i,j,k){if(k===0){var D1=_(!i);return(D1>0)&&{backCount:D1,targetViewLevel:0};}var E1=s[p.backTarget];return E1&&E1.hash&&n(E1.hash.split("?")[0])===n(j)&&{backCount:1};}function b1(i){if(o.oFlexibleColumnLayoutHandler){o.oFlexibleColumnLayoutHandler.setStoredTargetLayoutToOneColumn();}g1("root","",0,i);}function c1(i){var j=o.mEntityTree[i.entitySet].sRouteName;var k=o.mRouteToTemplateComponentPromise[j];return[k];}function d1(j,k){var D1=p.iHashChangeCount;var E1=function(G1){var H1=o.componentRegistry[G1.getId()];(H1.methods.presetDisplayMode||q.noop)(k,D1===H1.activationTakt);};for(var i=0;i<j.length;i++){var F1=j[i];F1.then(E1);}}function e1(i){var j=i&&o.mEntityTree[i.entitySet];var k=j?j.level:1;return k;}function f1(j,k){var D1=o.oApplicationProxy.getHierarchySectionsFromCurrentHash();var E1=j;for(var i=k-2;i>=0;i--){E1=D1[i]+"/"+E1;}return"/"+E1;}function g1(i,j,k,D1){var E1={};var F1=new Promise(function(G1){E(i,E1,j).then(function(){var H1=o.oFlexibleColumnLayoutHandler?o.oFlexibleColumnLayoutHandler.getAppStateParStringForNavigation(k,E1):I(E1,false);var I1=a1(D1,j,k);$(j,H1,D1,I1).then(G1);});});o.oBusyHelper.setBusy(F1);return F1;}function h1(i,j,k,D1){var E1=f1(i,j);g1(k,E1,j,D1);}function i1(j,k,D1,E1,F1){var G1;var H1,I1;var J1=[];if(typeof j==="string"){G1=j;var K1=n(G1).split("/");H1=K1.length-1;switch(H1){case 0:I1="root";break;case 1:I1=o.routeViewLevel1.name;break;default:I1="";var L1="";for(var i=0;i<H1;i++){var M1=K1[i+1];var N1=M1.indexOf("(");if(N1>0){M1=M1.substring(0,N1);}I1=I1+L1+M1;L1="/";}}}else{var O1=r.determineNavigationPath(j,k);H1=e1(O1);G1=O1.path;J1=c1(O1);I1=o.mEntityTree[O1.entitySet].sRouteName;}if(G1){if(k){G1=f1(G1,H1);}d1(J1,E1||0);if(F1){var P1="";var Q1="&";for(var R1 in F1){P1=P1+Q1+R1+"="+F1[R1];}if(P1){G1=G1+"?"+P1;}Z(G1,D1);return Promise.resolve(G1);}else{return g1(I1,G1,H1,D1);}}}function j1(i,j,k,D1){return i1(i,j,k,D1);}function k1(){var i=p.oEvent?p.oEvent.getParameter("name"):"root";var j=i.substring(i.length-5,i.length);if(j==="query"){return i.substring(0,i.length-5);}return i;}function l1(){var i=p.oEvent?p.oEvent.getParameter("name"):"";return i.length>5&&i.lastIndexOf("query")===i.length-"query".length;}function m1(i,j,k){var D1=q.extend(Object.create(null),p.oEvent.getParameter("arguments"));var E1=p.oEvent?p.oEvent.getParameter("name"):"root";if(l1()){D1.query=D1["?query"];if(j){D1.query[i]=j;}else{delete D1.query[i];if(q.isEmptyObject(D1.query)){delete D1.query;E1=k1();}}}else if(j){E1=E1+"query";D1.query=Object.create(null);D1.query[i]=j;}var F1=e.oRouter.getURL(E1,D1);F1=F1.replace("/?","?");Z(F1,k);}function n1(i){var j=p.iHashChangeCount;p.iHashChangeCount++;s.push(null);if(i){for(var k in o.componentRegistry){var D1=o.componentRegistry[k];if(D1.activationTakt===j&&i[D1.viewLevel]){D1.activationTakt=p.iHashChangeCount;}}}return{iHashChangeCount:p.iHashChangeCount};}function o1(i){var j,k,D1,E1,F1,G1=null,H1,I1;if(i){j=i.entitySet;k=i.text;G1=i.icon;I1=i.description;}if(j){H1=o.oAppComponent.getModel().getMetaModel();if(H1){D1=H1.getODataEntitySet(j);E1=H1.getODataEntityType(D1.entityType);F1=E1["com.sap.vocabularies.UI.v1.HeaderInfo"];}if(F1&&F1.TypeImageUrl&&F1.TypeImageUrl.String){G1=F1.TypeImageUrl.String;}}o.oShellServicePromise.then(function(L1){if(L1.setBackNavigation){L1.setBackNavigation(undefined);}});o.oTemplatePrivateGlobalModel.setProperty("/generic/messagePage",{text:k,icon:G1,description:I1});var J1;if(e.oTemplateContract.oFlexibleColumnLayoutHandler){J1=e.oTemplateContract.oFlexibleColumnLayoutHandler.displayMessagePage(i);}else{var K1=e.oRouter.getTargets();K1.display("messagePage");}n1(J1);W(i);}function p1(){if(!q.isEmptyObject(m)){var j=null;for(var i=0;!j;i++){j=m[i];}m={};o1(j);}}function q1(i){if(e.oTemplateContract.oFlexibleColumnLayoutHandler){i.viewLevel=i.viewLevel||0;m[i.viewLevel]=i;var j=Promise.all([A,e.oTemplateContract.oPagesDataLoadedObserver.getProcessFinished(true)]);j.then(p1);return;}o1(i);}function r1(){var i=[];var j=p.iHashChangeCount;for(var k in o.componentRegistry){var D1=o.componentRegistry[k];if(D1.activationTakt===j){i.push(k);}}return i;}function s1(){var i=[];for(var j in o.componentRegistry){i.push(j);}return i;}function t1(i){return w.slice(0,i+1);}function u1(j){var k="";var D1=p.hash;var E1=D1.split("/");var F1="";for(var i=0;i<=j;i++){k=k+F1+E1[i];F1="/";}return k;}function v1(i,j,k){var D1=o.componentRegistry[k.getId()]||{};var E1=(D1.activationTakt===j.iHashChangeCount-1);D1.activationTakt=j.iHashChangeCount;var F1=k.onActivate(i,E1)||Promise.resolve();return Promise.all([F1,D1.viewRegisterd]);}function w1(i,j,k){return v1(i,j,k).then(X);}function x1(i,j,k){var D1={};if(j||k){var E1=i.getParameter("config").viewLevel;for(var F1=0;F1<E1;F1++){D1[F1]=o.oPaginatorInfo[F1];}}o.oPaginatorInfo=D1;}function y1(i){return o.oApplicationProxy.getAlternativeContextPromise(i);}function z1(i){if(o.oFlexibleColumnLayoutHandler){o.oFlexibleColumnLayoutHandler.handleBeforeRouteMatched(i);}}function A1(k,i){w=[""];for(var j=1;j<=i;j++){var D1="keys"+j;w.push(k[D1]);}}function B1(j){j=q.extend({},j);var k=j.getParameter("config").viewLevel;var D1=n(e.oHashChanger.getHash()||"");q.sap.log.info("Route matched with hash "+D1);var E1;if(p.backwardingInfo){E1=p;s.push(E1);var F1=E1.iHashChangeCount+1;p={iHashChangeCount:F1,forwardingInfo:{bIsProgrammatic:true,bIsBack:true,iHashChangeCount:F1,backCount:E1.backwardingInfo.backCount,targetHash:E1.backwardingInfo.targetHash,targetViewLevel:E1.backwardingInfo.targetViewLevel},backTarget:E1.backTarget};}if(p.forwardingInfo){if(p.forwardingInfo.backCount){p.backTarget=s[p.backTarget].backTarget;p.forwardingInfo.backCount--;if(p.forwardingInfo.backCount&&k!==p.forwardingInfo.targetViewLevel){p.hash=D1;Y();return;}delete p.forwardingInfo.backCount;}if(p.forwardingInfo.targetHash&&p.forwardingInfo.targetHash!==D1){p.hash=D1;var G1=p.forwardingInfo.targetHash;delete p.forwardingInfo.targetHash;Z(G1,true);return;}}var H1=false;for(var i=0;i<o.aStateChangers.length;i++){var I1=o.aStateChangers[i];if(I1.isStateChange(j)){H1=true;}}if(H1){p.hash=D1;R();o.oBusyHelper.setBusyReason("HashChange",false);return;}o.oTemplatePrivateGlobalModel.setProperty("/generic/routeLevel",k);var J1=p.forwardingInfo;delete p.forwardingInfo;if(!J1){J1={};var K1=p.iHashChangeCount;J1.iHashChangeCount=K1+1;J1.bIsProgrammatic=(D1===p.targetHash);var L1=h.getDirection();J1.bIsBack=!!(p.LeaveByBack||(!J1.bIsProgrammatic&&(L1===b.Backwards)));J1.bIsForward=!J1.bIsBack&&(L1===b.Forwards);p.LeaveByBack=J1.bIsBack;p.LeaveByReplace=J1.bIsProgrammatic&&p.LeaveByReplace;E1=p;s.push(E1);p={iHashChangeCount:J1.iHashChangeCount};if(E1.LeaveByReplace){p.backTarget=E1.backTarget;}else if(J1.bIsBack){p.backTarget=s[E1.backTarget].backTarget;}else{p.backTarget=K1;}}p.oEvent=j;p.hash=D1;var M1=j.getParameter("config");var N1=r.determinePath(M1,j);var O1=k<2?N1:r.determinePath(M1,j,o.routeViewLevel1.pattern);y1(O1).then(function(P1){var Q1=j.getParameter("arguments");if(P1){var R1=Q1["?query"];p.forwardingInfo=J1;i1(P1.context,null,true,P1.iDisplayMode,R1||{});return;}A1(Q1,k);K([]);x1(j,J1.bIsProgrammatic,J1.bIsBack);if(o.oFlexibleColumnLayoutHandler){A=o.oFlexibleColumnLayoutHandler.handleRouteMatched(j,M1,N1,J1);}else{if(M1.viewLevel===0||!(J1.bIsProgrammatic||J1.bIsBack)){o.oApplicationProxy.setEditableNDC(false);}var S1=M1.target;var T1=o.mRouteToTemplateComponentPromise[S1];A=new Promise(function(U1,V1){T1.then(function(W1){w1(N1,J1,W1).then(U1,V1);});});}A.then(o.oBusyHelper.setBusyReason.bind(null,"HashChange",false),q.noop);});}function C1(){q1({title:o.getText("ST_ERROR"),text:o.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),description:""});}if(o.sRoutingType==="f"){e.oRouter.attachBeforeRouteMatched(z1);}e.oRouter.attachRouteMatched(B1);e.oRouter.attachBypassed(C1);e.navigate=Z;e.navigateToParStringPromise=$;e.activateOneComponent=v1;e.afterActivation=X;e.addUrlParameterInfoForRoute=E;e.getParStringPromise=I;e.performPseudoHashChange=n1;e.getActiveComponents=r1;e.getAllComponents=s1;e.getRootComponentPromise=y;e.getCurrenActivationTakt=D;e.getCurrentKeys=t1;e.getCurrentHash=u1;e.getTargetLevel=e1;e.getAppTitle=z;e.subTitleForViewLevelChanged=S;e.navigateToSuffix=h1;e.navigateByExchangingQueryParam=m1;return{navigateToRoot:b1,navigateToContext:j1,navigateToMessagePage:q1,navigateBack:Y};}function l(o,e){var i={oAppComponent:e.oAppComponent,oRouter:e.oAppComponent.getRouter(),oTemplateContract:e,oHashChanger:H.getInstance(),mRouteToComponentResolve:{}};e.oNavigationControllerProxy=i;var j=new Promise(function(R){i.fnInitializationResolve=R;});e.oBusyHelper.setBusy(j);q.extend(o,g(e,i));q.extend(i,o);var v={};i.oRouter._oViews._getViewWithGlobalId=function(V){if(!v[V.viewName]){var R=i.oRouter.getRoute(V.viewName);var k;if(R&&R._oConfig){k=f(e,R._oConfig,i.mRouteToComponentResolve[V.viewName]);}else{k=sap.ui.view({viewName:V.viewName,type:V.type,height:"100%"});}v[V.viewName]=k;if(V.viewName==="root"){e.rootContainer=k;}}return v[V.viewName];};r.startupRouter(i);}var N=B.extend("sap.suite.ui.generic.template.lib.NavigationController",{metadata:{library:"sap.suite.ui.generic.template"},constructor:function(o){B.apply(this,arguments);t.testableStatic(l,"NavigationController")(this,o);}});N._sChanges="Changes";return N;});

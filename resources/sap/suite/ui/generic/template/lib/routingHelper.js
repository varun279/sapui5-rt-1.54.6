sap.ui.define(["sap/f/FlexibleColumnLayout","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/routing/Targets","sap/ui/generic/app/util/ModelUtil","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/FlexibleColumnLayoutHandler","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/js/AnnotationHelperReuseComponents","sap/m/MessageBox"],function(F,a,b,J,T,M,C,c,t,A,d){"use strict";var p="---";function e(i,j,X,Y,Z){var $={};$={viewName:X,controlId:j,controlAggregation:Z};var _=i.getTargets();_.addTarget(Y,$);}function f(i,j){if(i.oTemplateContract.oFlexibleColumnLayoutHandler){i.oTemplateContract.oFlexibleColumnLayoutHandler.createMessagePageTargets(e.bind(null,i.oRouter,j,"sap.suite.ui.generic.template.fragments.MessagePage"));}else{e(i.oRouter,j,"sap.suite.ui.generic.template.fragments.MessagePage","messagePage","pages");}}function E(i,j,X){var Y=i[j];if(!Y){Y={draftSpec:"OData",level:0,children:[]};for(var Z in i){var $=i[Z];if($.level===1){Y.children.push(Z);break;}}i[j]=Y;}if(Y.hasOwnProperty("isDraft")){return;}if(Y.draftSpec==="parent"){if(Y.parent){E(i,Y.parent,X);var _=i[Y.parent];Y.isDraft=_.isDraft;}else if(Y.level===1){for(var a1 in i){var b1=i[a1];if(b1.level===0){Y.isDraft=b1.isDraft;return;}}}return;}if(Y.draftSpec==="OData"){var c1=X.getDraftContext();Y.isDraft=c1.isDraftEnabled(j);return;}Y.isDraft=Y.draftSpec;}function g(i,j){var X=i.oAppComponent.getModel();var Y=X.getMetaModel();Y.loaded().then(function(){var Z=i.oTemplateContract.mEntityTree;var $=i.oAppComponent.getTransactionController().getDraftController();E(Z,j.entitySet,$);for(var _ in Z){E(Z,_,$);}});}function h(i){var j=i.oTemplateContract.oNavigationHost.getId();var X=i.oAppComponent.getConfig();if(!X.pages||!X.pages.length){throw new Error("Route Configuration missing");}if(X.pages.length>1){throw new Error("Currently only one Top route supported");}var Y=X.pages[0];i.oTemplateContract.mEntityTree={};var Z=s([],Y,"root",0,null,i,j);i.oRouter.addRoute(Z);o(Z,i);k(Z.target,Y,0,null,i,j);f(i,j);g(i,Z);return Y.entitySet;}function k(j,X,Y,Z,$,_,a1,b1,c1){var i,d1;if(X.pages){d1=X.pages.length;for(i=0;i<d1;i++){n(j,X.pages[i],(Y+1),Z,$,_,a1,b1,c1);}}}function H(i,j,X,Y,Z,$,_,a1){var b1=X.target;var c1={pages:i.pages};var d1={pattern:X.pattern+"/"+i.id,entitySet:X.entitySet,name:X.name+"/"+i.id,contextPath:X.contextPath,patternDelimiter:p,embeddedComponent:i.id};k(b1,c1,j,d1,Y,Z,$,_,a1);}function l(i,j,X,Y,Z,$,_,a1){var b1=new J();var c1={};var d1=_||"implementation";i.embeddedComponents[d1]={key:d1,componentName:a1.componentName,containerId:_?A.formatIdComponentContainer(a1):"template::ImplementingComponent",pages:a1.pages||[],communicationModel:b1,communicationObject:c1};if(a1.pages){H(a1,j,X,Y,Z,$,b1,c1);}}function m(i,j,X,Y,Z,$,_){i.embeddedComponents={};if(j.implementingComponent){l(i,X,Y,Z,$,_,null,j.implementingComponent);}else if(j.embeddedComponents){for(var a1 in j.embeddedComponents){var b1=j.embeddedComponents[a1];l(i,X,Y,Z,$,_,a1,b1);}}}function n(i,j,X,Y,Z,$,_,a1,b1){if(j.component){var c1={parent:Y&&Y.entitySet,parentEmbeddedComponent:Y&&Y.embeddedComponent,navigationProperty:j.navigationProperty,level:X,children:[],communicationModel:a1,communicationObject:b1,noKey:j.routingSpec&&j.routingSpec.noKey,draftSpec:j.routingSpec?j.routingSpec.draftSpec||"parent":"OData"};var d1=s(i,j,j.component.list?"aggregation":"detail",X,Y,Z,$);c1.sRouteName=d1.name;c1.entitySet=d1.entitySet;if(_){_.push(d1.entitySet);}var e1=Z.oTemplateContract.mEntityTree[d1.entitySet];if(!e1||e1.level>c1.level){Z.oTemplateContract.mEntityTree[d1.entitySet]=c1;}Z.oRouter.addRoute(d1);o(d1,Z);q(Z,d1);k(d1.target,j,X,d1,Z,$,c1.children,a1,b1);m(c1,j,X,d1,Z,$,_);}}function o(i,j){var X=jQuery.extend({},i);X.name=i.name+"query";X.pattern=i.pattern+"{?query}";j.oRouter.addRoute(X);}function q(i,j){var X=i.oTemplateContract.mEntityTree[j.entitySet];if(j.routingSpec&&j.routingSpec.noOData){X.headerTitle=j.routingSpec.headerTitle;X.titleIconUrl=j.routingSpec.titleIconUrl;}else{var Y=i.oAppComponent.getModel();var Z=Y.getMetaModel();Z.loaded().then(function(){var $=Z.getODataEntitySet(j.entitySet);var _=Z.getODataEntityType($.entityType);var a1=_["com.sap.vocabularies.UI.v1.HeaderInfo"];var b1=(a1&&a1.TypeName&&a1.TypeName.String)||"";if(b1.substr(0,7)==="{@i18n>"){var c1=b1.substring(1,b1.length-1);var d1=c1.split(">");b1=i.oAppComponent.getModel(d1[0]).getResourceBundle().getText(d1[1]);}X.headerTitle=b1;var e1=(a1&&a1.Title&&a1.Title.IconUrl&&a1.Title.IconUrl.String)||"";X.titleIconUrl=e1;});}}function D(i){var j,X,Y;if(i){j=i.pattern;X=i.navigationProperty||i.entitySet;if(j&&X){Y=j.indexOf("{?query}");if(Y>0){j=j.substring(0,Y);}Y=-1;X+="({keys";Y=j.indexOf(X);if(Y>0){j=j.substring(Y);}if(i.navigationProperty){j=j.replace(i.navigationProperty,i.entitySet);}j="/"+j;}}return j;}function r(i,j){return j?j.contextPath+(i.routingSpec.binding?("/"+i.routingSpec.binding):""):"";}function s(i,j,X,Y,Z,$,_){var a1=jQuery.isArray(i)?i:[i];var b1,c1;b1=(Y===1)?j.entitySet:j.navigationProperty;c1=jQuery.extend({},j);c1.path="/"+j.entitySet;c1.operation=X;c1.viewLevel=Y;c1.template=j.component?(j.component.name||j.component):j.template;switch(X){case"root":c1.name="root";c1.pattern="";break;case"aggregation":c1.name=b1+"~aggregation";c1.pattern=b1;break;default:c1.name=b1;var d1=j.routingSpec&&j.routingSpec.noKey?"":"({keys"+Y+"})";c1.pattern=b1+d1;break;}if(Z){c1.name=Z.name+"/"+c1.name;c1.pattern=Z.pattern+(Z.patternDelimiter||"/")+c1.pattern;c1.parentEntitySet=Z.entitySet;}if(c1.viewLevel===1){$.oTemplateContract.routeViewLevel1={pattern:c1.pattern,name:c1.name};}var e1;var f1=c1.name;if($.oTemplateContract.oFlexibleColumnLayoutHandler){e1=$.oTemplateContract.oFlexibleColumnLayoutHandler.adaptRoutingInfo(c1,f1,a1);}else{e1="pages";c1.target=f1;}e($.oRouter,_,c1.name,f1,e1);var g1=new Promise(function(h1){$.mRouteToComponentResolve[c1.name]=h1;});$.oTemplateContract.mRouteToTemplateComponentPromise[c1.name]=g1;c1.contextPath=(j.routingSpec&&j.routingSpec.noOData)?r(j,Z):D(c1);return c1;}function I(i,j){var X;if(!i.oHashChanger.getHash()){X="";if(j&&j.route&&j.route.length===1){X=j.route[0];i.navigate(X,true);}}i.oRouter.initialize();i.fnInitializationResolve();}function B(j,X,Y,Z){var i,$,_,a1,b1=[],c1;$=Y.length;for(i=0;i<$;i++){_=Y[i].PropertyPath;a1=Z[_][0];b1.push(new a(_,b.EQ,a1));}if(j.oAppComponent.getTransactionController().getDraftController().getDraftContext().isDraftEnabled(X)){var d1=new a({filters:[new a("IsActiveEntity","EQ",false),new a("SiblingEntity/IsActiveEntity","EQ",null)],and:false});b1.push(d1);}c1=new a(b1,true);return c1;}function R(i,j,X){jQuery.sap.require("sap.ui.model.analytics.odata4analytics");var Y="/"+j;try{var Z=new sap.ui.model.analytics.odata4analytics.Model(sap.ui.model.analytics.odata4analytics.Model.ReferenceByModel(i));var $=Z.findQueryResultByName(j);var _=new sap.ui.model.analytics.odata4analytics.QueryResultRequest($);var a1=$.getParameterization();var b1=false;if(a1){_.setParameterizationRequest(new sap.ui.model.analytics.odata4analytics.ParameterizationRequest(a1));var c1=a1.getAllParameterNames();jQuery.each(c1,function(){if(X.hasOwnProperty(this)){b1=true;_.getParameterizationRequest().setParameterValue(this,X[this][0]);}});if(X.hasOwnProperty("DisplayCurrency")){if(c1.indexOf("P_DisplayCurrency")>-1){b1=true;_.getParameterizationRequest().setParameterValue("P_DisplayCurrency",X["DisplayCurrency"][0]);}}if(b1){Y=_.getURIToQueryResultEntitySet();}}}catch(d1){jQuery.sap.log.info(d1.name+":"+d1.message);}return Y;}function u(i,j,X,Y,Z){return new Promise(function($,_){var a1=R(X,i,Y);X.read(a1,{filters:[j],success:function(b1){var c1=w(b1,X,Y);if(c1){var d1=X.getKey(c1);if(d1){$({"status":"success","value":d1,"iLevel":Z});}}$({"status":"noData"});},error:function(){$({"status":"error"});}});});}function v(j,X,Y,Z,$,_,a1){var b1=[],c1,d1,e1;var f1=new Promise(function(g1){g1({"status":"success","value":a1,"iLevel":0});});if(Y&&Z&&$){if(_.aNavigablePages){for(var i=0;i<_.aNavigablePages.length;i++){if(_.aNavigablePages&&_.aNavigablePages[i]&&_.aNavigablePages[i].bNavigationWithTechnicalKeyPossible){b1.push(f1);continue;}c1=_.aNavigablePages[i];d1=B(j,c1.sEntitySet,c1.aSemanticKey,Z);e1=u(c1.sEntitySet,d1,$,Z,c1.iLevel);b1.push(e1);}}return Promise.all(b1).then(function(g1){if(g1[0]&&g1[0].status&&g1[0].status==="success"){var i,h1="",i1;for(i=0;i<g1.length;i++){if(g1[i]&&g1[i].status&&g1[i].status==="success"){i1=g1[i].value;if(i>0){i1=i1.replace(_.aNavigablePages[i].sEntitySet,_.aNavigablePages[i].sNavigationProperty);i1='/'+i1;}h1=h1.concat(i1);continue;}else{break;}}j.navigate(h1,true);}I(j,Z);});}}function w(X,Y,Z){var $,i,_,a1;if(X&&X.results){_=X.results.length;if(_===0){a1=null;}else if(_===1){a1=X.results[0];}else if(_>=1){var b1=[];var c1=[];for(i=0;i<_;i++){$=X.results[i];if($&&$.IsActiveEntity){c1.push($);}else if($&&$.IsActiveEntity===false){b1.push($);}}if(c1.length===0&&b1.length>=2){var d1;for(var j=0;j<b1.length;j++){d1=b1[j];if(d1.DraftUUID===Z.DraftUUID){a1=d1;break;}}if(!a1){a1=b1[0];}}else if(c1.length===1&&b1.length===1){a1=c1[0];}else if(c1.length===1&&b1.length>=2){a1=c1[0];}}}return a1;}function x(i,j){if((i&&j)||(j==="display")){return{mode:"unsupported"};}var X={mode:"display",force:"false"};X.mode=j||i||X.mode;X.force=!!j;return X;}function y(j,X,Y,Z,$){var _=K(j,X,Y,Z,$);if(_.aNavigablePages&&_.aNavigablePages[0]&&_.aNavigablePages[0].aSemanticKey&&_.aNavigablePages[0].iLevel===0){v(X,Y,_.aNavigablePages[0].aSemanticKey,Z,j,_);return;}else if(_.aNavigablePages&&_.aNavigablePages[0]&&_.aNavigablePages[0].bNavigationWithTechnicalKeyPossible){if(Z.IsActiveEntity&&Z.IsActiveEntity[0]==="false"&&Z.DraftUUID&&Z.DraftUUID[0]!==""){var a1=[];for(var i=0;i<_.aNavigablePages[0].aTechnicalKey.length;i++){var b1=_.aNavigablePages[0].aTechnicalKey[i]&&_.aNavigablePages[0].aTechnicalKey[i].name;if(b1==="DraftUUID"||b1==="IsActiveEntity"){continue;}if(Z.hasOwnProperty(b1)){a1.push({PropertyPath:b1});}}var c1=j.createKey(Y,Z);v(X,Y,a1,Z,j,_,c1);return;}var c1=j.createKey(Y,Z);if(c1){if(_){var a1=[];for(var i=0;i<_.aNavigablePages[0].aTechnicalKey.length;i++){var b1=_.aNavigablePages[0].aTechnicalKey[i]&&_.aNavigablePages[0].aTechnicalKey[i].name;if(b1==="DraftUUID"||b1==="IsActiveEntity"){continue;}if(Z.hasOwnProperty(b1)){a1.push({PropertyPath:b1});}}v(X,Y,a1,Z,j,_,c1);return;}X.navigate(c1,true);}}I(X,Z);}function z(j,X){var i,Y,Z=false,$,_;if(X&&j){Y=j.length;for(i=0;i<Y;i++){Z=true;$=j[i];_=$.name||$.PropertyPath;if(!X[_]||X[_].length>1){Z=false;break;}}}return Z;}function G(j,X,Y,Z,$,_){var a1,b1,c1,d1,e1,f1,g1;for(var i=0;i<Z.length;i++){f1=Z[i];if(f1&&f1.navigation&&f1.navigation[Y.mode]){continue;}b1=j.getMetaModel().getODataEntitySet(f1.entitySet);c1=f1.component&&f1.component.settings&&f1.component.settings.allowDeepLinking;if(!b1||!($===0||c1)){continue;}d1=j.getMetaModel().getODataEntityType(b1.entityType);e1=d1["com.sap.vocabularies.Common.v1.SemanticKey"];a1={};g1={};if(e1&&z(e1,X)){a1["sEntitySet"]=f1.entitySet;a1["aSemanticKey"]=e1;a1["sNavigationProperty"]=f1.navigationProperty;a1["iLevel"]=$;_.push(a1);}else{if(d1.key.propertyRef&&($===0)&&z(d1.key.propertyRef,X)){g1.bNavigationWithTechnicalKeyPossible=z(d1.key.propertyRef,X);g1.aTechnicalKey=d1.key.propertyRef;_.push(g1);}}if(f1.pages){G(j,X,Y,f1.pages,++$,_);}else{break;}}return _;}function K(i,j,X,Y,Z){var $={},_=[],a1=[];var b1=j.oAppComponent.getConfig();_=b1.pages&&b1.pages[0]&&b1.pages[0].pages;if(!_){return{};}a1=G(i,Y,Z,_,0,a1);$.aNavigablePages=a1;return $;}function P(i){var j=i.oAppComponent.getModel("_templPrivGlobal");j.setProperty("/generic/forceFullscreenCreate",true);}function L(X,Y,Z){var $,_,a1,b1,c1,d1,i,e1,j,f1,g1;if(jQuery.isEmptyObject(Z)){return;}$=X&&X.getMetaModel();_=$&&$.getODataEntitySet(Y);a1=_&&_.entityType;b1=$&&$.getODataEntityType(a1);c1=b1&&b1.property;d1=[];g1=c1&&c1.length;for(i=0;i<g1;i++){e1=c1[i];if(e1["type"]==="Edm.Guid"){d1.push(e1["name"]);}}for(j=0;j<d1.length;j++){if(!Z[d1[j]]){continue;}f1=Z[d1[j]][0];f1=f1.toLowerCase().replace(/(guid')([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})(')/,"$2");if(!f1.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/)){f1=f1.replace(/([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12})/,"$1-$2-$3-$4-$5");}Z[d1[j]][0]=f1;}}function N(i){var j=i.oAppComponent.getConfig();var X=j.settings;var Y=X&&X.inboundParameters;var Z=[];if(Y){Object.keys(Y).forEach(function($){if(Y[$].useForCreate){Z.push($);}});}return Z;}function S(j,X){var Y;var Z=N(j);for(var i=0;i<Z.length;i++){var $=Z[i];var _=X[$];if(_&&_.length===1){Y=Y||Object.create(null);Y[$]=_[0];}}return Y;}function O(j,X,Y){var Z;Z=j.oAppComponent.getModel();Z.attachMetadataFailed(j.fnInitializationResolve);Z.getMetaModel().loaded().then(function(){var $;L(Z,X,Y);var _=Y.preferredMode&&Y.preferredMode[0];var a1=Y.mode&&Y.mode[0];var b1=x(_,a1);switch(b1.mode){case"create":P(j);var c1=S(j,Y);var d1=C.create(j.oAppComponent.getTransactionController().getDraftController(),X,"/"+X,Z,j.oTemplateContract.oApplicationProxy.setEditableNDC,c1);d1.then(function(i){j.navigateToContext(i,"",true,4).then(I.bind(null,j,Y));},function(i){I(j,Y);j.navigateToMessagePage({title:j.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),text:i.messageText,description:"",icon:"sap-icon://message-error"});});j.oTemplateContract.oBusyHelper.setBusy(d1,true);break;case"createWithContext":P(j);var e1=new Promise(function(i1,j1){var k1=function(q1){j1();I(j,Y);j.navigateToMessagePage({title:j.oTemplateContract.getText("ST_ERROR"),text:(q1&&q1.messageText)||j.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),icon:"sap-icon://message-error",description:""});};$=Z.getMetaModel().getODataEntitySet(X);var l1=$["com.sap.vocabularies.Common.v1.DraftRoot"];if(l1&&l1.NewAction){var m1=Z.getMetaModel().getODataFunctionImport(l1.NewAction.String.split("/")[1]);var n1={};if(m1){var o1=m1.parameter?m1.parameter.length:0;for(var i=0;i<o1;i++){var p1=m1.parameter[i];if(p1.mode==="In"&&Y[p1.name]&&Y[p1.name][0]){n1[p1.name]=Y[p1.name][0];}}Z.callFunction("/"+m1.name,{success:function(q1,r1){var s1=new M(Z);var t1=s1.getContextFromResponse(q1);if(t1){i1();j.navigateToContext(t1,null,true,4).then(I.bind(null,j,Y));}else{k1();}},error:k1,method:"POST",urlParameters:n1});}else{k1();}}else{k1();}});j.oTemplateContract.oBusyHelper.setBusy(e1,true);break;case"edit":var f1=K(Z,j,X,Y,b1);if(f1.aNavigablePages&&f1.aNavigablePages[0]&&(f1.aNavigablePages[0].bNavigationWithTechnicalKeyPossible||(f1.aNavigablePages[0].aSemanticKey&&f1.aNavigablePages[0].iLevel===0))){var g1="";var h1;if(f1.aNavigablePages[0].bNavigationWithTechnicalKeyPossible){g1=Z.createKey(X,Y);h1=C.edit(j.oAppComponent.getTransactionController(),X,"/"+g1,Z,j.oTemplateContract,j.fnInitializationResolve);}else if(f1.aNavigablePages&&f1.aNavigablePages[0]&&f1.aNavigablePages[0].aSemanticKey&&f1.aNavigablePages[0].iLevel===0){g1="";h1=C.edit(j.oAppComponent.getTransactionController(),X,g1,Z,j.oTemplateContract,j.fnInitializationResolve,f1.aNavigablePages[0].aSemanticKey,Y);}h1.then(function(i){j.navigate(i.context.getPath(),true);I(j);},function(i){if(i.lockedByUser){if(!b1.force){y(Z,j,X,Y,b1);}else{j.fnInitializationResolve();j.navigateToMessagePage({title:j.oTemplateContract.getText("LOCKED_OBJECT_POPOVER_TITLE"),text:j.oTemplateContract.getText("LOCKED_OBJECT_POPOVER_TITLE"),description:j.oTemplateContract.getText("ST_GENERIC_LOCKED_OBJECT_POPOVER_TEXT",[i.lockedByUser]),icon:"sap-icon://message-error",replaceURL:true});}}else if(i.draftAdminReadResponse){I(j,Y);}else{var i1=j.oTemplateContract.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_EDIT");d.warning(i1,{onClose:function(j1){y(Z,j,X,Y,{mode:"display",force:false});}});}});}else{I(j,Y);}break;case"display":y(Z,j,X,Y,b1);break;default:j.fnInitializationResolve();j.navigateToMessagePage({title:j.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),text:j.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),description:j.oTemplateContract.getText("PARAMETER_COMBINATION_NOT_SUPPORTED",[a1,_]),icon:"sap-icon://message-error",replaceURL:true});}});}function Q(i){var j=i.oAppComponent.getConfig();if(j.settings&&j.settings.flexibleColumnLayout){i.oTemplateContract.oFlexibleColumnLayoutHandler=new c(i.oTemplateContract.oNavigationHost,i);}var X=h(i);var Y=i.oAppComponent.getComponentData();var Z=Y&&Y.startupParameters;if(X&&Z&&!i.oHashChanger.getHash()){O(i,X,Z);}else{I(i);}}function U(i,j,X){var Y,Z,$;if(i.operation==="root"){return null;}if(i.operation==="aggregation"){Y=i.pattern;}else if(X){Y=X;}else{Y=i.contextPath;}if(!Y){return"";}if(Y.indexOf("/")!==0){Y="/"+Y;}Z=j.getParameter("arguments");if(Z){for($ in Z){if($!=="?query"){Y=Y.replace("{"+$+"}",Z[$]);}}return Y;}}function V(i,j){var X,Y,Z;X=i.getPath().substring(1);Y=X.split("(");if(Y[0]){Z=Y[0];}if(j){X=X.replace(Z,j);if(X.indexOf("/")===0){X=X.substring(1);}}return{entitySet:Z,path:X};}function W(){return p;}var h=t.testableStatic(h,"routingHelpergenerateRoutingMetadataAndGetRootEntitySet");var I=t.testableStatic(I,"routingHelper_initialiseRouting");var v=t.testableStatic(v,"routingHelper_readObject");var O=t.testableStatic(O,"routingHelper_processStartupParameters");var L=t.testableStatic(L,"routingHelper_transformStartupGuidParameters");return{startupRouter:Q,determinePath:U,determineNavigationPath:V,getPatternDelimiter:W,readObjectProcessResults:w};});

/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2018 SAP SE. All rights reserved
 */
sap.ui.define(['sap/viz/ui5/controls/common/utils/Constants','sap/ui/model/Sorter'],function(C,S){"use strict";function c(i){return Object.prototype.toString.call(i)==='[object Array]';}function e(a,m,b,k,F){var r={dataset:null,context:null};if(!b||b.length===0){return r;}var A=[],n=[],M=[],o=[],p=[];jQuery.each(a,function(i,l){if(l.getAxis()===1){A.push({def:l,adapter:l._getAdapter()});}else if(l.getAxis()===2){n.push({def:l,adapter:l._getAdapter()});}else{throw new Error("currently, only axis 1 and 2 are supported");}});jQuery.each(m,function(i,l){M.push({def:l,adapter:l._getAdapter()});o.push([]);});function q(z,B,D){var l=z.length,V,i;if(l===0){return 0;}V=[];for(i=0;i<l;i++){V.push(z[i].adapter(D));}for(i=0,l=B.length;i<l;i++){if(jQuery.sap.equal(B[i],V)){return i;}}B.push(V);return B.length-1;}var s=[];var t=[];jQuery.each(b,function(I,l){var z=q(A,s,l);var B=q(n,t,l);for(var i=0;i<M.length;i++){var D=M[i].adapter(l);if(A.length===0&&n.length===0){if(o[i][0]===undefined){o[i][0]=[];}o[i][0].push(D);}else{(o[i][B]=(o[i][B]||[]))[z]=D;}}if(A.length===0&&n.length===0){z=I;}(p[B]||(p[B]=[]))[z]=l;});var L=s.length;var u=Math.max(t.length,1);for(var j=0;j<u;j++){for(var i=0;i<M.length;i++){var d=o[i][j];if(!d){d=o[i][j]=[];}if(d.length<L){d[L-1]=undefined;}}if(!p[j]){p[j]=[];}if(!p[j].length<L){p[j][L]=undefined;}}var v={};if(A.length>0){if(v.analysisAxis===undefined){v.analysisAxis=[];}var w={index:1,data:[]};for(var i=0;i<A.length;i++){var x=[];for(var j=0;j<s.length;j++){x[j]=s[j][i];}w.data.push({name:A[i].def.getName(),values:x});}v.analysisAxis.push(w);}if(n.length>0){if(v.analysisAxis===undefined){v.analysisAxis=[];}var w={index:2,data:[]};for(var i=0;i<n.length;i++){var x=[];for(var j=0;j<t.length;j++){x[j]=t[j][i];}w.data.push({name:n[i].def.getName(),values:x});}v.analysisAxis.push(w);}if(M.length>0){v.measureValuesGroup=[];for(var i=0;i<M.length;i++){if(!v.measureValuesGroup[M[i].def.getGroup()-1]){v.measureValuesGroup[M[i].def.getGroup()-1]={index:M[i].def.getGroup(),data:[]};}v.measureValuesGroup[M[i].def.getGroup()-1].data.push({name:M[i].def.getName(),values:o[i]});}for(var i=0,y=v.measureValuesGroup.length;i<y;i++){if(v.measureValuesGroup[i]===undefined){throw new Error("Measure Group "+(i+1)+" is missing.");}}}r.dataset=F?new sap.viz.data.CrosstableDataset():new sap.viz.api.data.CrosstableDataset();r.dataset.data(v);if(k){r.dataset.info(k);}r.context=p;return r;}function f(v,d){var a=(v&&v.value)||v,b=(d&&d.value)||d;return S.defaultComparator(a,b);}function g(d,m,a,b,p,k){var r={dataset:null,context:null};var l=['_context_row_number'];if(a){if(!c(a)){a=[a];}for(var i=0;i<a.length;++i){var n=a[i];var s=!(n.showInTooltip===false);if(n.id){n=n.id;}l.push({id:n,showInTooltip:s});}}var A=[],M=[],o=[],q={'metadata':{'fields':[]},'context':l,'data':[]},t=[];jQuery.each(d,function(i,j){A.push({def:j,vAdapter:j._getAdapter(),dAdapter:j._getDisplayValueAdapter()});var u=j.getDataType();var v=j.getSorter();var w={'id':j.getIdentity()||j.getName(),'name':j.getName()||j.getIdentity(),'semanticType':'Dimension','dataType':u,'inResult':j._getInResult(),'timeUnitType':j._getTimeUnit()};if(v&&typeof v==="object"){var x={bDescending:v.bDescending};x.fnComparator=function(y,z){var B={value:y&&y.v||y,displayValue:y&&y.d},D={value:z&&z.v||z,displayValue:z&&z.d};var E=(v.fnComparator&&typeof v.fnComparator==="function")?v.fnComparator:f;return E(B,D);};w["sorter"]=x;}q.metadata.fields.push(w);});jQuery.each(m,function(i,j){M.push({def:j,adapter:j._getAdapter()});var u={'id':j.getIdentity()||j.getName(),'name':j.getName()||j.getIdentity(),'semanticType':'Measure'};u.formatString=j.getFormat();if(j.getUnit()){u.unit=j.getUnit();}u.unitBinding=j._getUnitBinding();var R=j.getRange();if(R&&R.length){u.min=R[0];u.max=R[1];}q.metadata.fields.push(u);});if(p){if(p.bEnabled){q.metadata.options={pagination:{mode:p.sMode,ratio:p.thumbRatio}};}}if(!b||b.length===0){r.dataset=new sap.viz.api.data.FlatTableDataset(q);return r;}if(p&&(!k||p.sMode==="reset")){k=[];}jQuery.each(b,function(I,u){if(!q.data[I]){q.data[I]=[];}for(var i=0;i<A.length;i++){var v=A[i].vAdapter(u);if(v instanceof Date){v=v.getTime();}var V=A[i].dAdapter(u);q.data[I].push(V.enableDisplayValue?{v:v,d:V.value}:v);}for(var j=0;j<M.length;j++){var v=M[j].adapter(u);q.data[I].push(v);var U=M[j].def._getUnitBinding();if(U){var w=u.getProperty(U);if(o[j]){if(o[j]==="*"||o[j]!==w||(p&&k[j]!==w)){throw C.ERROR_MESSAGE.MULTIPLEUNITS;}}else{o[j]=w;if(p&&!k[j]){k[j]=w;}}}}t[I]=u;});r.context=t;q.metadata.fields.filter(function(j){return(j.semanticType==="Measure");}).forEach(function(j,u){if(j.unitBinding&&o[u]){j.unit=o[u];delete j.unitBinding;}});r.dataset=new sap.viz.api.data.FlatTableDataset(q);return r;}var h=function(){this._oCVOMDataset=null;this._aContext=null;this._sDatasetType=null;this._pagingUnit=null;};h.prototype.getDataset=function(o){if(this._sDatasetType===o.type&&this._oCVOMDataset){return this._oCVOMDataset;}this.invalidate();this._sDatasetType=o.type;var r=null;if(this._sDatasetType===C.DATASET_TYPES.FLATTABLEDATASET){r=g(o.dimensions,o.measures,o.contexts,o.dataContexts,o.pagingOption,this._pagingUnit);}else{r=e(o.dimensions,o.measures,o.dataContexts,o.additionalInfo,this._sDatasetType==C.DATASET_TYPES.CROSSTABLEDATASET?false:true);}this._oCVOMDataset=r.dataset;this._aContext=r.context;return this._oCVOMDataset;};h.prototype.findContext=function(o){if(this._sDatasetType===C.DATASET_TYPES.FLATTABLEDATASET){if(this._aContext&&typeof o==='object'&&o._context_row_number!==undefined){return this._aContext[o._context_row_number];}}else{if(this._aContext&&typeof o==='object'){return this._aContext[o.dii_a2]&&this._aContext[o.dii_a2][o.dii_a1];}}return null;};h.prototype.invalidate=function(){this._oCVOMDataset=null;this._aContext=null;};return h;},true);

sap.ui.define(["sap/ovp/ui/DashboardLayoutRearrange","sap/ovp/ui/DashboardLayoutModel",'sap/ovp/cards/CommonUtils'],function(R,D,c){"use strict";var a=function(u){this.aCards=null;this.ROW_HEIGHT_PX=16;this.MIN_COL_WIDTH_PX=320;this.CARD_BORDER_PX=8;this.EXTRA_MARGIN=8;this.oLayoutData={layoutWidthPx:1680,contentWidthPx:1600,colCount:5,colWidthPx:this.MIN_COL_WIDTH_PX,rowHeightPx:this.ROW_HEIGHT_PX,marginPx:this.convertRemToPx(3)-this.CARD_BORDER_PX};this.dashboardLayoutModel=new D(u,this.oLayoutData.colCount,this.ROW_HEIGHT_PX,this.CARD_BORDER_PX);this.layoutDomId="";this.oLayoutCtrl={};this.componentDomId="";this.lastTriggeredColWidth=0.0;this.changedCards={};this.isRTLEnabled=sap.ui.getCore().getConfiguration().getRTL();switch(true){case sap.ui.Device.browser.webkit:this.cssVendorTransition="-webkit-transition";this.cssVendorTransform="-webkit-transform";break;case sap.ui.Device.browser.msie:this.cssVendorTransition="-ms-transition";this.cssVendorTransform="-ms-transform";break;case sap.ui.Device.browser.mozilla:this.cssVendorTransition="-moz-transition";this.cssVendorTransform="-moz-transform";break;default:this.cssVendorTransition="transition";this.cssVendorTransform="transform";}};a.prototype.setLayout=function(l){this.oLayoutCtrl=l;this.layoutDomId=l.getId();this.componentDomId=this.layoutDomId.split("--")[0];};a.prototype.getDashboardLayoutModel=function(){return this.dashboardLayoutModel;};a.prototype.updateCardVisibility=function(C){this.dashboardLayoutModel.updateCardVisibility(C);this.aCards=this.dashboardLayoutModel.getCards(this.oLayoutData.colCount);this.dashboardLayoutModel._removeSpaceBeforeCard();this._setCardsCssValues(this.aCards);this._positionCards(this.aCards);};a.prototype.updateLayoutData=function(d){if(this.oLayoutData.layoutWidthPx===d){return this.oLayoutData;}var i=this.oLayoutData.marginPx,e=0,s=320,m=1024,C=this.CARD_BORDER_PX,M=this.EXTRA_MARGIN,n=d+i,b,f;this.oLayoutData.layoutWidthPx=d;if(n<=s){i=this.convertRemToPx(0.5)-C;e=sap.ui.Device.system.desktop?16:0;}else if(n<=m){i=this.convertRemToPx(1)-C;e=sap.ui.Device.system.desktop?8:0;}else{i=this.convertRemToPx(3)-C;}if(i!==this.oLayoutData.marginPx){this.oLayoutData.marginPx=i;jQuery(".sapUshellEasyScanLayout").css({"margin-left":i+"px"});}this.oLayoutData.contentWidthPx=d-i-e;this.oLayoutData.colCount=Math.floor(this.oLayoutData.contentWidthPx/this.MIN_COL_WIDTH_PX);if(this.oLayoutData.colCount===0){this.oLayoutData.colCount=1;}this.oLayoutData.colWidthPx=this.oLayoutData.contentWidthPx/this.oLayoutData.colCount;if(jQuery(".sapOvpDashboardDragAndDrop").length>0&&jQuery(".easyScanLayoutItemWrapper").length>0){b=jQuery(".sapOvpDashboardDragAndDrop")[0].offsetLeft+M;if(jQuery(".sapOvpDashboardDragAndDrop")[0].offsetLeft<40){f=b+8;}else{f=b;}}else{b=i+M;f=i+e+M;}jQuery('.sapFDynamicPageTitle').css({"margin-left":b+"px","margin-right":f+"px","visibility":"visible"});jQuery('.sapFDynamicPageHeader').css({"margin-left":b+"px","margin-right":f+"px","visibility":"visible"});return this.oLayoutData;};a.prototype.getRearrange=function(s){var d={containerSelector:".sapUshellEasyScanLayoutInner",wrapper:".sapUshellEasyScanLayout",draggableSelector:".easyScanLayoutItemWrapper",placeHolderClass:"dashboardLayoutItemWrapper-placeHolder",cloneClass:"easyScanLayoutItemWrapperClone",moveTolerance:10,switchModeDelay:500,isTouch:!sap.ui.Device.system.desktop,debug:false,aCards:this.aCards,layoutUtil:this,rowHeight:this.oLayoutData.rowHeightPx,colWidth:this.oLayoutData.colWidthPx};return new R(jQuery.extend(d,s));};a.prototype.resizeLayout=function(w){var b=this.oLayoutData.colCount;var t=false;if(this.oLayoutData.layoutWidthPx!==w){this.updateLayoutData(w);t=Math.abs(this.lastTriggeredColWidth-this.oLayoutData.colWidthPx)>this.convertRemToPx(0.5);this.aCards=this.dashboardLayoutModel.getCards(this.oLayoutData.colCount);for(var i=0;i<this.aCards.length;i++){var C=this.aCards[i];this.setCardCssValues(C);var e=document.getElementById(this.getCardDomId(C.id));if(e){e.style.width=C.dashboardLayout.width;e.style.height=C.dashboardLayout.height;if(b!==this.oLayoutData.colCount){e.style[this.cssVendorTransition]='all 0.25s ease';}else{e.style[this.cssVendorTransition]='';}e.style[this.cssVendorTransform]='translate3d('+C.dashboardLayout.left+' ,'+C.dashboardLayout.top+', 0px)';this.setKpiNumericContentWidth(e);}if(b!==this.oLayoutData.colCount||t){this._triggerCardResize(C);}}this.dashboardLayoutModel._removeSpaceBeforeCard();this.oLayoutCtrl.fireAfterDragEnds();if(t){this.lastTriggeredColWidth=this.oLayoutData.colWidthPx;}}};a.prototype.getCards=function(C){if(this.aCards&&this.oLayoutData.colCount===C){return this.aCards;}this._setColCount(C);this.aCards=this.dashboardLayoutModel.getCards(C);this._setCardsCssValues(this.aCards);return this.aCards;};a.prototype.resetToManifest=function(){this.aCards=[];this.dashboardLayoutModel.resetToManifest();};a.prototype.getCardDomId=function(b){return this.layoutDomId+"--"+b;};a.prototype.getCardId=function(b){var d="";if(b){d=b.split("--")[2];}return d;};a.prototype.isCardAutoSpan=function(b){return this.dashboardLayoutModel.getCardById(b).dashboardLayout.autoSpan;};a.prototype.setAutoCardSpanHeight=function(e,b,h){var r,l,C;if(!b&&e&&e.target.parentElement){b=e.target.parentElement.parentElement.id.split("--")[1];}var H=h;if(!H&&e){H=e.size.height;}if(this.isCardAutoSpan(b)){C=this.dashboardLayoutModel.getCardById(b);if(C.dashboardLayout.showOnlyHeader){r=Math.ceil((H+2*this.CARD_BORDER_PX)/this.getRowHeightPx());}else{r=Math.round((H+2*this.CARD_BORDER_PX)/this.getRowHeightPx());}l=this.dashboardLayoutModel.resizeCard(b,{rowSpan:r,colSpan:1},false);this._sizeCard(l.resizeCard);this._positionCards(l.affectedCards);}};a.prototype.calculateCardProperties=function(C){var g=this._getCardController(C);var o=this.dashboardLayoutModel.getCardById(C);var i=250,h,d,l,m,H;if(g){H=g.getItemHeight(g,'ovpCardHeader');h=H===0?o.dashboardLayout.headerHeight:H;d=g.getItemHeight(g,'toolbar');if(o.template==='sap.ovp.cards.list'){l=o.dashboardLayout.itemHeight;m=h+d+l;}else if(o.template==='sap.ovp.cards.table'){l=o.dashboardLayout.itemHeight;m=h+d+2*l;}else if(o.template==='sap.ovp.cards.linklist'){if(o.settings.listFlavor==='carousel'){m=h+jQuery('.sapOvpCarouselContentHeader').outerHeight()+240+jQuery('.sapMCrslControlsBottom.sapMCrslControls').outerHeight();}else{l=g.getItemHeight(g,'ovpLinkList',true);var b=g.getView().getModel('ovpCardProperties').getProperty('/densityStyle');if(b==='cozy'){m=h+d+l+8;}else{m=h+d+l+4;}}}else if(o.template==='sap.ovp.cards.charts.analytical'){var B=g.getView().byId('bubbleText')?43:0;m=h+d+i+B+50;}else{m=h+d;}return{headerHeight:h,dropDownHeight:d,itemHeight:l,minCardHeight:m,leastHeight:h};}};a.prototype._sizeCard=function(C){if(!C){return;}var $=document.getElementById(this.getCardDomId(C.id));C.dashboardLayout.width=C.dashboardLayout.colSpan*this.oLayoutData.colWidthPx+"px";C.dashboardLayout.height=C.dashboardLayout.rowSpan*this.oLayoutData.rowHeightPx+"px";if($){$.style.height=C.dashboardLayout.height;$.style.width=C.dashboardLayout.width;this._triggerCardResize(C);}this.dashboardLayoutModel._removeSpaceBeforeCard();var i=(this.dashboardLayoutModel._findHighestOccupiedRow()*this.ROW_HEIGHT_PX)+32;jQuery(".sapUshellEasyScanLayoutInner").css({"height":i+"px"});};a.prototype._triggerCardResize=function(C){var b=C.dashboardLayout,d=C.id,e=this._getCardComponentDomId(d),$=document.getElementById(e),g=this._getCardController(d),f,o;try{if((b.autoSpan||!b.visible)&&g){o=g.getCardItemsBinding();f=this.calculateCardProperties(d);if(o&&f){if(C.template==='sap.ovp.cards.table'){g.addColumnInTable($,b);}}return;}}catch(h){jQuery.sap.log.warning("Card auto span failed for card "+d+" and error is  "+h.toString());}b.iRowHeightPx=this.getRowHeightPx();b.iCardBorderPx=this.CARD_BORDER_PX;try{if(g){var f=this.calculateCardProperties(d);g.resizeCard(b,f);}else{jQuery.sap.log.warning("OVP resize: no controller found for "+d);}}catch(i){jQuery.sap.log.warning("OVP resize: "+d+" catch "+i.toString());}};a.prototype._positionCards=function(C){if(!C){return;}var p={},s=false;C.forEach(function(o){if(!o.dashboardLayout.visible){return;}p=this._mapGridToPositionPx(o.dashboardLayout);o.dashboardLayout.top=p.top;o.dashboardLayout.left=p.left;var e=document.getElementById(this.getCardDomId(o.id));if(e){e.classList.remove('sapOvpNotResizableLeftRight','sapOvpNotResizableRight','sapOvpNotResizableDown');e.style[this.cssVendorTransition]='all 0.25s ease';e.style[this.cssVendorTransform]='translate3d('+p.left+' ,'+p.top+', 0px)';s=o.dashboardLayout.column+o.dashboardLayout.colSpan===this.oLayoutData.colCount+1;if(s){if(o.dashboardLayout.colSpan===1){e.classList.add('sapOvpNotResizableLeftRight');}else{e.classList.add('sapOvpNotResizableRight');}}if((o.template==="sap.ovp.cards.list"&&o.dashboardLayout.colSpan===2)||(o.template==="sap.ovp.cards.linklist"&&o.settings.listFlavor==='carousel'&&o.dashboardLayout.colSpan===3)){e.classList.add('sapOvpNotResizableRight');}if(o.template==="sap.ovp.cards.linklist"&&o.settings.listFlavor==='carousel'&&o.dashboardLayout.rowSpan===45){e.classList.add('sapOvpNotResizableDown');}}}.bind(this));};a.prototype.updateCardSize=function(C,g,b){var o=this.dashboardLayoutModel.getCardById(C);var d=this._getCardController(C);var $=document.getElementById(this.getCardDomId(C));$.style.height=g+'px';$.style.width=b+'px';$.style[this.cssVendorTransition]='none';$.style.zIndex=10;if(o.template==='sap.ovp.cards.linklist'&&o.settings.listFlavor==='carousel'){d.getView().byId('pictureCarousel').$().css('height',g-(o.dashboardLayout.headerHeight+2*this.CARD_BORDER_PX)+'px');}};a.prototype.resizeCard=function(b,s,d){this.changedCards=this.dashboardLayoutModel.resizeCard(this.getCardId(b),s,true,d);this._positionCards(this.changedCards.affectedCards);};a.prototype._mapGridToPositionPx=function(g){var l=(g.column-1)*this.getColWidthPx();var p={top:(g.row-1)*this.getRowHeightPx()+"px",left:this.isRTLEnabled?-l:l+"px"};return p;};a.prototype._getCardComponentDomId=function(b){return this.componentDomId+"--"+b;};a.prototype._getCardController=function(b){var C=null;var o=sap.ui.getCore().byId(this._getCardComponentDomId(b));if(o){var d=o.getComponentInstance();if(d){C=d.getAggregation("rootControl").getController();}}return C;};a.prototype._setCardsCssValues=function(C){var i=0;for(i=0;i<C.length;i++){this.setCardCssValues(C[i]);}};a.prototype.setCardCssValues=function(C){var l=(C.dashboardLayout.column-1)*this.oLayoutData.colWidthPx;C.dashboardLayout.top=((C.dashboardLayout.row-1)*this.oLayoutData.rowHeightPx)+"px";C.dashboardLayout.width=(C.dashboardLayout.colSpan*this.oLayoutData.colWidthPx)+"px";C.dashboardLayout.height=(C.dashboardLayout.rowSpan*this.oLayoutData.rowHeightPx)+"px";C.dashboardLayout.left=(this.isRTLEnabled?-l:l)+"px";};a.prototype.convertRemToPx=function(v){var b=v;if(typeof v==="string"||v instanceof String){b=v.length>0?parseInt(v.split("rem")[0],10):0;}return b*c.getPixelPerRem();};a.prototype.convertPxToRem=function(v){var b=v;if(typeof v==="string"||v instanceof String){b=v.length>0?parseFloat(v.split("px")[0],10):0;}return b/c.getPixelPerRem();};a.prototype.setKpiNumericContentWidth=function($){var o=$.getElementsByClassName("sapOvpKpiContent");if(!!o&&o.length>0){var b=o[0];var C=8;var p=16;b.style.width=(this.getColWidthPx()-(2*C+2*p))+"px";}};a.prototype.getLayoutWidthPx=function(){return this.oLayoutData.colCount*this.oLayoutData.colWidthPx;};a.prototype.getColWidthPx=function(){return this.oLayoutData.colWidthPx;};a.prototype.getRowHeightPx=function(){return this.oLayoutData.rowHeightPx;};a.prototype._setColCount=function(C){this.oLayoutData.colCount=C;};return a;},true);

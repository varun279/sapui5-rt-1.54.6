/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["jquery.sap.global","sap/ovp/ui/DashboardLayoutUtil","sap/ovp/library"],function(q,D){"use strict";var a=sap.ui.core.Control.extend("sap.ovp.ui.DashboardLayout",{metadata:{designTime:true,library:"sap.ovp",aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"}},defaultAggregation:"content",events:{afterRendering:{},afterDragEnds:{}},properties:{dragAndDropRootSelector:{group:"Misc",type:"string"},dragAndDropEnabled:{group:"Misc",type:"boolean",defaultValue:true},debounceTime:{group:"Misc",type:"int",defaultValue:150}}},renderer:{render:function(r,c){var b=c.$().width();var R=sap.ui.getCore().getConfiguration().getRTL();var l=c.dashboardLayoutUtil.updateLayoutData(b?b:q(window).width());var C=c.dashboardLayoutUtil.getCards(l.colCount);function f(k){return k.getVisible();}function d(k){return k.id===this.getId().split("--")[1];}var e=c.getContent().filter(f);r.write("<div");r.writeControlData(c);r.addClass("sapUshellEasyScanLayout");if(!sap.ui.Device.system.phone){r.addClass("sapOvpDashboardDragAndDrop");}r.addClass("sapOvpDashboard");r.writeClasses();R?r.addStyle("margin-right",l.marginPx+"px"):r.addStyle("margin-left",l.marginPx+"px");r.writeStyles();r.write(">");r.write("<div class='sapUshellEasyScanLayoutInner'>");if(C.length>0){var g={},h='',i,L,s,j=c.dashboardLayoutUtil.oLayoutData.colCount;for(i=0,L=e.length;i<L;i++){g=C.filter(d.bind(e[i]))[0];c.dashboardLayoutUtil.setCardCssValues(g);s=g.dashboardLayout.column+g.dashboardLayout.colSpan===j+1;if(s){if(g.dashboardLayout.colSpan===1){h='sapOvpNotResizableLeftRight';}else{h='sapOvpNotResizableRight';}}if(g.template==="sap.ovp.cards.stack"||g.settings.stopResizing||!sap.ui.Device.system.desktop){r.write("<div id='"+c.dashboardLayoutUtil.getCardDomId(g.id)+"' class='easyScanLayoutItemWrapper sapOvpDashboardLayoutItem sapOvpDashboardLayoutItemNoDragIcon' style='"+"; transform:translate3d("+g.dashboardLayout.left+" ,"+g.dashboardLayout.top+" ,0px)"+"; -ms-transform:translate3d("+g.dashboardLayout.left+" ,"+g.dashboardLayout.top+" ,0px)"+"; -moz-transform:translate3d("+g.dashboardLayout.left+" ,"+g.dashboardLayout.top+" ,0px)"+"; -webkit-transform:translate3d("+g.dashboardLayout.left+" ,"+g.dashboardLayout.top+" ,0px)"+"; height:"+g.dashboardLayout.height+"; width:"+g.dashboardLayout.width+";'"+" tabindex='0'; aria-setsize="+L+" aria-posinset="+i+">");}else{r.write("<div id='"+c.dashboardLayoutUtil.getCardDomId(g.id)+"' class='easyScanLayoutItemWrapper sapOvpDashboardLayoutItem "+h+"' style='"+"; transform:translate3d("+g.dashboardLayout.left+" ,"+g.dashboardLayout.top+" ,0px)"+"; -ms-transform:translate3d("+g.dashboardLayout.left+" ,"+g.dashboardLayout.top+" ,0px)"+"; -moz-transform:translate3d("+g.dashboardLayout.left+" ,"+g.dashboardLayout.top+" ,0px)"+"; -webkit-transform:translate3d("+g.dashboardLayout.left+" ,"+g.dashboardLayout.top+", 0px)"+"; height:"+g.dashboardLayout.height+"; width:"+g.dashboardLayout.width+";'"+" tabindex='0'; aria-setsize="+L+" aria-posinset="+i+">");}r.renderControl(e[i]);r.write("</div>");}}r.write("</div>");r.write("<div class='after' tabindex='0'></div>");r.write("</div>");}},init:function(){this.oColumnLayoutData={};this.resizeHandlerId=this.initResizeHandler();var c=sap.ui.getCore().getComponent(this._sOwnerId);this.dashboardLayoutUtil=c.getDashboardLayoutUtil();this.dashboardLayoutUtil.setLayout(this);},exit:function(){if(this.resizeHandlerId){sap.ui.core.ResizeHandler.deregister(this.resizeHandlerId);}if(this.layoutDragAndDrop){this.layoutDragAndDrop.destroy();delete this.layoutDragAndDrop;}},onBeforeRendering:function(){},onAfterRendering:function(){this.keyboardNavigation=new K(this);if(!this.getDragAndDropRootSelector()){this.setDragAndDropRootSelector("#"+this.getId());}if(this.layoutDragAndDrop){this.layoutDragAndDrop.destroy();}if(this.getDragAndDropEnabled()){this.layoutDragAndDrop=this.dashboardLayoutUtil.getRearrange({rootSelector:this.getDragAndDropRootSelector(),layout:this});this.fireAfterRendering();}},getLayoutDataJSON:function(){return this.dashboardLayoutUtil.getDashboardLayoutModel().getLayoutVariants4Pers();},filterVisibleCards:function(e){return e.getVisible();},getDashboardLayoutUtil:function(){return this.dashboardLayoutUtil;},getDashboardLayoutModel:function(){return this.dashboardLayoutUtil.getDashboardLayoutModel();},getVisibleLayoutItems:function(){var c=this.getContent();var f=c.filter(this.filterVisibleCards);return f;},initResizeHandler:function(){var r;var d=this.getDebounceTime();var b=function(e){window.clearTimeout(r);r=window.setTimeout(this.oControl.resizeHandler.bind(this,e),d);};return sap.ui.core.ResizeHandler.register(this,b);},resizeHandler:function(e){this.oControl.dashboardLayoutUtil.resizeLayout(e.size.width);}});var K=function(o){this.init(o);};K.prototype.init=function(o){this.layoutUtil=o.getDashboardLayoutUtil();this.layoutModel=o.getDashboardLayoutModel();this.keyCodes=q.sap.KeyCodes;this.jqElement=o.$();this.bIgnoreSelfFocus=false;this.jqElement.on('keydown',this.keyDownHandler.bind(this));};K.prototype.keyDownHandler=function(e){var b=document.activeElement,c=this.layoutUtil.getCardId(b.id),C=q.extend([],this.layoutModel.aCards),o=this.layoutModel.getCardById(c),d=this.layoutModel.iColCount,t={},f,g,h,r,l,m,n;this.layoutModel._sortCardsByRow(C);for(var i=1;i<=d;i++){t[i]=[];}for(var j=0;j<C.length;j++){f=C[j].dashboardLayout.column;g=C[j].dashboardLayout.colSpan;if(g===1){t[f].push(C[j]);}else{for(var k=f;k<f+g;k++){t[k].push(C[j]);}}}r=this.getCardPosition(c,t[o.dashboardLayout.column]);switch(e.keyCode){case this.keyCodes.F6:if(e.shiftKey){this.bIgnoreSelfFocus=true;this.jqElement.find(".sapUshellEasyScanLayoutInner").focus();q.sap.handleF6GroupNavigation(e);}else{this.bIgnoreSelfFocus=true;var p=this.jqElement.scrollTop();this.jqElement.find(".after").focus();q.sap.handleF6GroupNavigation(e);this.jqElement.scrollTop(p);}break;case this.keyCodes.F7:var s=q(document.activeElement);if(s.hasClass("easyScanLayoutItemWrapper")){s.find(":sapTabbable").first().focus();}else{s.closest(".easyScanLayoutItemWrapper").focus();}e.preventDefault();break;case this.keyCodes.ARROW_UP:h=o.dashboardLayout.column;r--;l=t[h][r]&&t[h][r].id;this.setFocusOnCard(l);break;case this.keyCodes.ARROW_DOWN:h=o.dashboardLayout.column;r++;l=t[h][r]&&t[h][r].id;this.setFocusOnCard(l);break;case this.keyCodes.ARROW_LEFT:h=o.dashboardLayout.column;h--;if(!t[h]||!t[h][r]){do{if(h===0){h=d;r--;break;}if(r<0){break;}h--;}while(!t[h]||!t[h][r])}l=t[h][r]&&t[h][r].id;this.setFocusOnCard(l);break;case this.keyCodes.ARROW_RIGHT:h=o.dashboardLayout.column+o.dashboardLayout.colSpan;if(!t[h]||!t[h][r]){do{if(h>d){h=1;r++;break;}h++;}while(!t[h]||!t[h][r])}l=t[h][r]&&t[h][r].id;this.setFocusOnCard(l);break;case this.keyCodes.PAGE_UP:e.preventDefault();h=o.dashboardLayout.column;if(e.altKey==true){(h===1)?r=0:h=1;l=t[h][r]&&t[h][r].id;}else{m=t[h].length-1;for(var i=m;i>0;i--){n=document.getElementById(this.layoutUtil.getCardDomId(t[h][i].id));if(n.getBoundingClientRect().bottom<0){l=t[h][i].id;break;}}if(!l){l=t[h][0].id;}}this.setFocusOnCard(l);break;case this.keyCodes.PAGE_DOWN:e.preventDefault();h=o.dashboardLayout.column;if(e.altKey==true){l=(h+o.dashboardLayout.colSpan)>d?C[C.length-1].id:t[d][r]&&t[d][r].id;}else{var w=q(window).height();m=t[h].length;for(var i=0;i<m;i++){n=document.getElementById(this.layoutUtil.getCardDomId(t[h][i].id));if(n.getBoundingClientRect().top>w){l=t[h][i].id;break;}}if(!l){l=t[h][m-1].id;}}this.setFocusOnCard(l);break;case this.keyCodes.HOME:e.preventDefault();h=o.dashboardLayout.column;if(e.ctrlKey==true){(r===0)?h=1:r=0;}else{(h===1)?r=0:h=1;}l=t[h][r]&&t[h][r].id;this.setFocusOnCard(l);break;case this.keyCodes.END:e.preventDefault();h=o.dashboardLayout.column;if(e.ctrlKey==true){var u=t[h].length-1;l=(u===r)?C[C.length-1].id:t[h][u]&&t[h][u].id;}else{l=(h+o.dashboardLayout.colSpan)>d?C[C.length-1].id:t[d][r]&&t[d][r].id;}this.setFocusOnCard(l);break;}};K.prototype.setFocusOnCard=function(c){if(c){var b=document.getElementById(this.layoutUtil.getCardDomId(c));b&&b.focus();}};K.prototype.getCardPosition=function(c,b){for(var i=0;i<b.length;i++){if(b[i].id===c){break;}}return i;};return a;},true);

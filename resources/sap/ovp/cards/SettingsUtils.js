/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(['jquery.sap.global',"sap/m/Dialog","sap/m/ToolbarSpacer","sap/m/Button",'sap/ovp/cards/PayLoadUtils','sap/ovp/cards/OVPCardAsAPIUtils','sap/ovp/cards/rta/SettingsDialogConstants','sap/ui/Device','sap/m/MessagePopover','sap/m/MessagePopoverItem','sap/m/Link'],function(q,D,T,B,P,O,S,a,M,b,L){"use strict";var r=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");function c(C,V){var i=C.getComponentInstance(),E=i.getComponentData(),F=E.appComponent,G=E.cardId,H=G+'Dialog',I=E.modelName,J=F.getModel(I),K=V.getModel().getData(),N={cards:{}};N.cards[H]={model:I,template:K.template,settings:K};if(!I&&K.staticContent){I="DialogCardDataModel";N.cards[H].model=I;}V.setModel(J,I);V.getController()._oManifest=N;O.createCardComponent(V,N,'dialogCard');}function g(i){if(i.indexOf('#')!==-1){return i.split('#')[1];}else{return"Default";}}function d(E,K){var i;if(K.indexOf(",")!==-1){K=K.split(",")[0];}if(K.indexOf(".Identification")!==-1){if(E[K]){var R=sap.ovp.cards.AnnotationHelper.sortCollectionByImportance(E[K]);for(var C=0;C<R.length;C++){var I=R[C];if(I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){if(I&&I["Label"]){return I["Label"].String;}else{return I["SemanticObject"].String+"-"+I["Action"].String;}}if(I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){if(I&&I["Label"]){return I["Label"].String;}else{return I["Url"].String;}}}}return"No Navigation";}else if(K.indexOf(".HeaderInfo")!==-1){i=g(K);if(E[K]&&E[K]["Description"]&&E[K]["Description"].Label){return E[K]["Description"].Label.String;}else{return i;}}else{var F="";i=g(K);if(i!=="Default"){F="#"+i;}var G="com.sap.vocabularies.Common.v1.Label"+F;if(E[K]&&E[K][G]){return E[K][G].String;}else{return i;}}}function e(i,C){switch(C){case"cardPreview":return(O.getSupportedCardTypes().indexOf(i)!==-1);case"listType":case"listFlavor":var E=["sap.ovp.cards.list"];return(E.indexOf(i)!==-1);case"listFlavorForLinkList":var F=["sap.ovp.cards.linklist"];return(F.indexOf(i)!==-1);case"isViewSwitchSupportedCard":case"kpiHeader":var G=["sap.ovp.cards.list","sap.ovp.cards.table","sap.ovp.cards.charts.analytical","sap.ovp.cards.charts.bubble","sap.ovp.cards.charts.donut","sap.ovp.cards.charts.line"];return(G.indexOf(i)!==-1);case"chart":var H=["sap.ovp.cards.charts.analytical","sap.ovp.cards.charts.bubble","sap.ovp.cards.charts.donut","sap.ovp.cards.charts.line"];return(H.indexOf(i)!==-1);case"sortOrder":case"sortBy":case"lineItem":var I=["sap.ovp.cards.list","sap.ovp.cards.table"];return(I.indexOf(i)!==-1);case"identification":var J=["sap.ovp.cards.stack"];return(J.indexOf(i)!==-1);default:break;}}function f(C,E,i,I){var F=true;var G=true;if(i){if(C.mainViewSelected){G=false;}else{F=false;}}switch(E){case"cardPreview":return e(C.template,"cardPreview");case"title":return F;case"dynamicSwitchSubTitle":return F&&!!C.dynamicSubTitle;case"dynamicSwitchStateSubTitle":return!!C.dynamicSubtitleAnnotationPath;case"subTitle":if(!C.subTitle){C.subTitle=' ';return true;}else{return F&&!C.dynamicSubtitleAnnotationPath;}break;case"dynamicSubTitle":return G&&!!C.dynamicSubtitleAnnotationPath;case"valueSelectionInfo":if(!C.valueSelectionInfo){C.valueSelectionInfo=' ';}return F&&(e(C.template,"kpiHeader")&&!!C.dataPointAnnotationPath);case"dataPoint":return G&&(e(C.template,"kpiHeader")&&!!C.dataPointAnnotationPath);case"listType":case"listFlavor":case"listFlavorForLinkList":return F&&e(C.template,E);case"sortOrder":return F&&(!C.staticContent)&&e(C.template,E)&&!!C.sortBy;case"sortBy":return F&&(!C.staticContent)&&e(C.template,E);case"identification":return G&&(!C.staticContent)&&!e(C.template,E);case"presentationVariant":case"selectionVariant":return G&&(!C.staticContent)&&e(C.template,"kpiHeader");case"kpiHeader":return F&&e(C.template,E);case"lineItem":case"chart":return G&&e(C.template,E);case"showViewName":return i&&G;case"showDefaultView":if(i&&G){if(C.defaultViewSelected!=C.selectedKey){return true;}}return false;case"showMore":case"removeVisual":case"lineItemSubTitle":case"lineItemTitle":case"staticLink":case"links":var H=(C.template==="sap.ovp.cards.linklist"&&!!C.staticContent);if(E==="staticLink"){return(H&&!!C.staticContent[I].targetUri);}else if(E==="links"){return(H&&!!C.staticContent[I].semanticObject);}else if(E==="removeVisual"){return(H&&(!!C.staticContent[I].targetUri||!!C.staticContent[I].semanticObject));}else{return H;}break;default:break;}}function s(C){var i=false;this.oVisibility.viewSwitchEnabled=false;this.oVisibility.showViewSwitch=false;if(e(C.template,'isViewSwitchSupportedCard')){if(C.tabs&&C.tabs.length){i=true;this.oVisibility.showViewSwitch=true;}this.oVisibility.viewSwitchEnabled=true;}this.oVisibility.cardPreview=f(C,"cardPreview");this.oVisibility.title=f(C,"title",i);this.oVisibility.subTitle=f(C,"subTitle",i);this.oVisibility.valueSelectionInfo=f(C,"valueSelectionInfo",i);this.oVisibility.listType=f(C,"listType",i);this.oVisibility.listFlavor=f(C,"listFlavor",i);this.oVisibility.listFlavorForLinkList=f(C,"listFlavorForLinkList",i);this.oVisibility.sortOrder=f(C,"sortOrder",i);this.oVisibility.sortBy=f(C,"sortBy",i);if(C.template==="sap.ovp.cards.linklist"&&!!C.staticContent){var E=C.staticContent,V={},F={},G={},H={};for(var I=0;I<E.length;I++){var J=E[I].index;V[J]=f(C,"staticLink",null,I);F[J]=f(C,"links",null,I);G[J]=f(C,"removeVisual",null,I);H[J]=f(C,"showMore",null,I);}this.oVisibility.staticLink=V;this.oVisibility.links=F;this.oVisibility.removeVisual=G;this.oVisibility.showMore=H;}this.oVisibility.lineItemTitle=f(C,"lineItemTitle");this.oVisibility.lineItemSubTitle=f(C,"lineItemSubTitle");this.oVisibility.showViewName=f(C,"showViewName",i);this.oVisibility.showDefaultView=f(C,"showDefaultView",i);this.aVariantNames.forEach(function(K){this.oVisibility[K.sPath]=f(C,K.sPath,i)&&!!C[K.sPath]&&!!C[K.sPath].length;}.bind(this));this.oVisibility.kpiHeader=f(C,"kpiHeader",i)&&!!C["dataPoint"]&&!!C["dataPoint"].length;this.oVisibility.dynamicSwitchSubTitle=f(C,"dynamicSwitchSubTitle",i);this.oVisibility.dynamicSwitchStateSubTitle=f(C,"dynamicSwitchStateSubTitle",i);this.oVisibility.moveToTheTop=false;this.oVisibility.moveUp=false;this.oVisibility.moveDown=false;this.oVisibility.moveToTheBottom=false;this.oVisibility.delete=false;}function _(){if(r){return r;}r=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");return r;}function h(C){var i=C.getProperty("/staticContent");for(var E=0;E<i.length;E++){i[E].index="Index--"+(E+1);}C.setProperty("/staticContent",i);}function j(i){if(i.lineItem){i.lineItem.forEach(function(E){if(E.value===i.annotationPath){i.lineItemQualifier=E.name;}});}if(i.tabs&&i.tabs.length&&i.selectedKey){i.viewName=i.tabs[i.selectedKey-1].value;i.isDefaultView=false;if(i.selectedKey===i.defaultViewSelected){i.isDefaultView=true;}}var C=i.sortOrder;i.sortOrder='descending';if(C&&C.toLowerCase()!=='descending'){i.sortOrder='ascending';}i.isExtendedList=false;if(i.listType==='extended'){i.isExtendedList=true;}i.isBarList=false;if(i.listFlavor==='bar'){i.isBarList=true;}i.hasKPIHeader=false;if(i.dataPointAnnotationPath){i.hasKPIHeader=true;}return i;}function k(i){var E=i.entityType;this.aVariantNames.forEach(function(V){var F=[];for(var G in E){if(E.hasOwnProperty(G)&&G.indexOf(V.sVariant)!==-1){if(V.sVariant===".LineItem"){var H={name:d(E,G),value:G,fields:sap.ovp.cards.AnnotationHelper.sortCollectionByImportance(E[G])};F.push(H);}else{F.push({name:d(E,G),value:G});}}}if(F.length!==0){i[V.sPath]=F;}});if(i.entityType&&i.entityType.property){i['modelProperties']=i.entityType.property.map(function(F){return{name:F.name,value:F.name};});}if(!!i.tabs&&i.tabs.length){var C=false;i.newViewCounter=0;i.defaultViewSelected=i.selectedKey;i.isViewResetEnabled=false;i.aViews=[{text:r&&r.getText("OVP_KEYUSER_LABEL_MAIN_VIEW"),key:0,isLaterAddedView:false,isViewResetEnabled:false}];C=i.tabs.some(function(F){return F.dataPointAnnotationPath;});i.tabs.forEach(function(F,G){var H=F.value;if(C&&!F.dataPointAnnotationPath&&F.dataPoint&&F.dataPoint.length){F.dataPointAnnotationPath=F.dataPoint[0].value;}if(G+1===i.selectedKey){H=F.value;if(r){H+=" ("+r.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";}else{H+=" (Default view)";}}i.aViews.push({text:H,key:G+1,initialSelectedKey:G+1,isLaterAddedView:false,isViewResetEnabled:false});});}else if(e(i.template,'isViewSwitchSupportedCard')){i.newViewCounter=0;i.aViews=[{text:'click "+" to add a view',key:0,initialSelectedKey:0,isLaterAddedView:false,isViewResetEnabled:false}];}return i;}function l(C){var E=C.getData();sap.ushell.Container.getService('CrossApplicationNavigation').getLinks().done(function(F){var G=[],H={};for(var i=0;i<F.length;i++){G.push(F[i].intent);H[F[i].intent]=F[i].text;}sap.ushell.Container.getService('CrossApplicationNavigation').isIntentSupported(G).done(function(R){var F=[];for(var I in R){if(R.hasOwnProperty(I)&&R[I].supported===true&&H&&H[I]){F.push({name:H[I],value:I});}}var J=E;if(F.length!==0||F.length!==0){J['links']=F;}C.refresh();}).fail(function(I){q.sap.log.error(I);});}).fail(function(i){q.sap.log.error(i);});}function m(E){this.oResetButton.setEnabled(E);}function n(E){this.oSaveButton.setEnabled(E);var i=this.oMessagePopOver.getModel(),C=i.getProperty("/Counter/Error");this.bError=(C>0);}function v(i){var C=new RegExp("((http|https)(:\/\/))?([a-zA-Z0-9]+[.]{1}){2}[a-zA-z0-9]+(\/{1}[a-zA-Z0-9]+)*\/?","i");return C.test(i);}function o(V,F){if(F==="targetUri"){return!v(V)&&(!!V||V==='');}else{return!(V.trim().length);}}function p(E){var F=E.getParameter("path"),C="",G,i,H,I,J,K;var N=_();if(F==="/title"||F==="title"||F==="/viewName"||F==="targetUri"||F==="value"){var Q=E.getParameter("value"),R=o(Q,F),U,V=E.getParameter("context");if(F==="/viewName"){U=E.getSource().getProperty("/selectedKey");C=N&&N.getText('OVP_KEYUSER_INPUT_ERROR_VIEW_NAME');F="/tabs/"+(U-1)+"/value";}if(F==="value"){C=N&&N.getText('OVP_KEYUSER_INPUT_ERROR_VIEW_NAME');F=V.getPath()+"/"+F;}if(F.indexOf("/title")!==-1){C=N&&N.getText('OVP_KEYUSER_INPUT_ERROR');}if(V&&V.getPath().indexOf("staticContent")!==-1){G=V.getPath().split("/");if(F==="title"){C=N.getText('OVP_KEYUSER_INPUT_ERROR_RECORD_TITLE')+(parseInt(G[G.length-1],10)+1);}else if(F==="targetUri"){C=N.getText('OVP_KEYUSER_INPUT_ERROR_RECORD_URL')+" "+(parseInt(G[G.length-1],10)+1);}F=V.getPath()+"/"+F;}H=this.oMessagePopOver.getModel();I=H.getProperty("/Messages");J=H.getProperty("/Counter/All");K=H.getProperty("/Counter/Error");if(R){n.bind(this)(true);for(i=0;i<I.length;i++){if(I[i].fieldName===F){I.splice(i,1);J--;K--;i--;}}I.push({'type':"Error",'title':C,'fieldName':F,'counter':K+1});J++;K++;}else{n.bind(this)(true);for(i=0;i<I.length;i++){if(I[i].fieldName===F){I.splice(i,1);J--;K--;i--;}}}H.setProperty("/Messages",I);H.setProperty("/Counter/All",J);H.setProperty("/Counter/Error",K);H.refresh(true);}else if(F==="/staticContent,title"||F==="/staticContent,targetUri"||F==="/tabs,value"){G=F.split(",");H=this.oMessagePopOver.getModel();I=H.getProperty("/Messages");J=H.getProperty("/Counter/All");K=H.getProperty("/Counter/Error");n.bind(this)(true);for(i=0;i<I.length;i++){if(I[i].fieldName.indexOf(G[0])!==-1&&I[i].fieldName.indexOf(G[1])!==-1){I.splice(i,1);J--;K--;i--;}}H.setProperty("/Messages",I);H.setProperty("/Counter/All",J);H.setProperty("/Counter/Error",K);H.refresh(true);}}function t(){var i=this.oMessagePopOver.getModel();i.setProperty("/Messages",[]);i.setProperty("/Counter/All",0);i.setProperty("/Counter/Error",0);i.setProperty("/Counter/Success",0);i.setProperty("/Counter/Warning",0);i.setProperty("/Counter/Information",0);i.refresh(true);}function u(){var i=new L({text:"Show more information",href:"",target:"_blank"});var C=new b({type:'{type}',title:'{title}',description:'{description}',subtitle:'{subtitle}',counter:'{counter}',fieldName:'{fieldName}',link:i});this.oMessagePopOver=new M({items:{path:'/Messages',template:C}});var E={'Counter':{'All':0,'Error':0,'Success':0,'Warning':0,'Information':0},'Messages':[]};var F=new sap.ui.model.json.JSONModel(E);this.oMessagePopOver.setModel(F);this.oMessagePopOverButton.setModel(F);}function w(V,W){var i=V.byId("sapOvpSettingsForm");if(i){var C=i.getDomRef();if(C){C.style.width=W;}}}function x(i){var V=this.dialogBox.getContent()[0],C=V.getModel(),E=V.getModel("deviceMediaProperties");switch(i.name){case"S":case"M":E.setProperty("/deviceMedia","Column");w(V,"100%");break;case"L":case"XL":default:E.setProperty("/deviceMedia","Row");w(V,"calc(100% - "+(C.getProperty("/dialogBoxWidth")+1)+"rem)");break;}E.refresh(true);}function y(){a.media.detachHandler(x.bind(this),null,"SettingsViewRangeSet");a.media.removeRangeSet("SettingsViewRangeSet");}function z(){a.media.initRangeSet("SettingsViewRangeSet",[520,760,960],"px",["S","M","L","XL"]);a.media.attachHandler(x.bind(this),null,"SettingsViewRangeSet");x.bind(this)(a.media.getCurrentRange("SettingsViewRangeSet"));}var A={oOvpResourceBundle:_(),dialogBox:undefined,oSaveButton:undefined,oResetButton:undefined,oMessagePopOverButton:undefined,oMessagePopOver:undefined,oAppDescriptor:undefined,oOriginalAppDescriptor:undefined,sApplicationId:"",iContentHeightForDialog:38,iContentHeightForDialogWithViewSwitch:33,aVariantNames:S.aVariantNames,attachWindowResizeHandler:z,detachWindowResizeHandler:y,settingFormWidth:w,addManifestSettings:j,setVisibilityForFormElements:s,getVisibilityOfElement:f,enableResetButton:m,enableSaveButton:n,resetErrorHandling:t,oVisibility:S.oVisibility,bError:false,getDialogBox:function(C){return new Promise(function(i,E){if(!this.dialogBox){this.oSaveButton=new B("settingsSaveBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("save"),type:"Emphasized"});var F=new B("settingsCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.oResetButton=new B("settingsResetBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("resetCardBtn")});this.oMessagePopOverButton=new B("settingsMessagePopOverBtn",{text:"{/Counter/All}",type:"Emphasized",icon:"sap-icon://message-popup",visible:"{= ${/Counter/All} === 0 ? false : true}"}).addStyleClass("sapOvpSettingsMessagePopOverBtn");this.dialogBox=new D("settingsDialog",{title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("settingsDialogTitle"),buttons:[this.oMessagePopOverButton,this.oSaveButton,F,this.oResetButton],afterClose:function(a1){var Z=this.dialogBox.getContent()[0],b1=Z.byId("sapOvpSettingsLineItemTitle"),c1=Z.byId("sapOvpSettingsLineItemSubTitle");if(b1){b1.destroy();}if(c1){c1.destroy();}this.dialogBox.destroyContent();this.detachWindowResizeHandler();}.bind(this)});this.dialogBox.setBusyIndicatorDelay(0);F.attachPress(function(a1){this.dialogBox.close();}.bind(this));}u.bind(this)();var G=C.getComponentInstance(),H=G.getRootControl().getModel("ovpCardProperties").getData(),I=q.extend(true,{},H);I=k.call(this,I);I=this.addManifestSettings(I);var J=new sap.ui.model.json.JSONModel(I),K=C.getDomRef().offsetHeight,N=new sap.ui.model.json.JSONModel(a.system),Q=new sap.ui.model.json.JSONModel({"deviceMedia":"Row"}),R=G.getComponentData(),U=R.mainComponent,V=R.appComponent;this.oAppDescriptor=U._getCardFromManifest(R.cardId);this.sApplicationId=U._getApplicationId();this.oOriginalAppDescriptor=V._getOvpCardOriginalConfig(R.cardId);N.setDefaultBindingMode("OneWay");I.dialogBoxHeight=K;I.dialogBoxWidth=20;if(I.template==="sap.ovp.cards.linklist"){J.setProperty("/listFlavorName",this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_CAROUSEL"));}else{J.setProperty("/listFlavorName",this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_BARLIST"));}if(I.template==="sap.ovp.cards.linklist"&&I.staticContent){var W={};var X=new sap.ui.model.json.JSONModel(W);l(X);h(J);J.setProperty("/lineItemId","linkListItem--1");J.setProperty("/lineItemIdCounter",I.staticContent.length);}this.setVisibilityForFormElements(I);var Y=new sap.ui.model.json.JSONModel(this.oVisibility);J.attachPropertyChange(p.bind(this));var Z=new sap.ui.view("settingsView",{viewName:"sap.ovp.cards.rta.SettingsDialog",type:sap.ui.core.mvc.ViewType.XML,preprocessors:{xml:{bindingContexts:{ovpCardProperties:J.createBindingContext("/")},models:{ovpCardProperties:J,deviceSystemProperties:N}}}});if(I.template==="sap.ovp.cards.linklist"&&I.staticContent){Z.setModel(X,"staticCardProperties");}var $=this.oOvpResourceBundle?new sap.ui.model.resource.ResourceModel({bundleUrl:this.oOvpResourceBundle.oUrlInfo.url}):null;Z.setModel(J);Z.setModel($,"ovpResourceModel");Z.setModel(Q,"deviceMediaProperties");Z.setModel(Y,"visibility");this.dialogBox.addContent(Z);this.attachWindowResizeHandler();Z.loaded().then(function(a1){var b1=a1.byId("dialogCard");if(!b1.getVisible()){b1=a1.byId("dialogCardNoPreview");var c1=Z.getModel().getProperty("/template").split("."),d1=c1[c1.length-1],e1=this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_NO_CARD_PREVIEW_MSG",[d1]);b1.setText(e1);}else{b1.setWidth(I.dialogBoxWidth+"rem");}c(C,a1);this.dialogBox.open();a1.getController().settingsResolve=i;}.bind(this));}.bind(this));}};A.fnEditCardHandler=function(i,G){return A.getDialogBox(i).then(function(C){return[{appComponent:i.getComponentInstance().getComponentData().appComponent,changeSpecificData:{appDescriptorChangeType:"appdescr_ovp_changeCard",content:C.appDescriptorChange}},{selectorControl:i.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"cardSettings",content:C.flexibilityChange}}];});};A.fnCloneCardHandler=function(i,G){return P.getPayLoadForCloneCard(i).then(function(C){return[{appComponent:i.getComponentInstance().getComponentData().appComponent,changeSpecificData:{appDescriptorChangeType:"appdescr_ovp_addNewCard",content:C.appDescriptorChange}},{selectorControl:i.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"cardSettings",content:C.flexibilityChange}}];});};A.fnAddCardHandler=function(i,G){};return A;},true);

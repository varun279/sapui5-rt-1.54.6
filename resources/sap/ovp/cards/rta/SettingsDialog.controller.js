sap.ui.define(['sap/ui/core/mvc/Controller','sap/ui/model/json/JSONModel','/sap/ui/fl/descriptorRelated/api/DescriptorChangeFactory','/sap/ui/fl/descriptorRelated/api/DescriptorInlineChangeFactory','sap/ovp/cards/OVPCardAsAPIUtils','sap/ovp/cards/SettingsUtils','sap/ovp/cards/PayLoadUtils','sap/m/Button','sap/m/Dialog','sap/m/Text','sap/ui/comp/valuehelpdialog/ValueHelpDialog','sap/ovp/cards/rta/SettingsDialogConstants','sap/m/MessageBox','sap/ui/model/Filter','sap/ui/model/FilterOperator'],function(C,J,D,a,O,s,P,B,b,T,V,S,M,F,c){'use strict';return C.extend('sap.ovp.cards.rta.SettingsDialog',{_oCardManifestSettings:{},_aRefreshNotRequired:S._aRefreshNotRequired,_aRefreshRequired:S._aRefreshRequired,oOvpResourceBundle:sap.ui.getCore().getLibraryResourceBundle("sap.ovp"),onInit:function(){s.oSaveButton.attachPress(this.onSaveButtonPress,this);s.oResetButton.attachPress(this.onResetButton,this);s.oMessagePopOverButton.attachPress(this.handleMessagePopoverPress,this);},onAfterRendering:function(){s.dialogBox.addStyleClass("sapOvpSettingsDialogBox");this.setEnablePropertyForResetAndSaveButton(false);this._oCardManifestSettings=this.getView().getModel().getData();this._oOriginalCardManifestSettings=jQuery.extend(true,{},this._oCardManifestSettings);var v=this.getView(),o=v.getModel(),d=v.byId("dialogCard");if(!d.getVisible()){d=v.byId("dialogCardNoPreview");}d.getDomRef().style.minHeight=this._oCardManifestSettings.dialogBoxHeight+'px';v.byId("dialogCardOverlay").getDomRef().style.minHeight=this._oCardManifestSettings.dialogBoxHeight+'px';s.settingFormWidth(v,"calc(100% - "+(this._oCardManifestSettings.dialogBoxWidth+1)+"rem)");setTimeout(function(){var d=this.getView().byId("dialogCard");if(d.getVisible()){d.setBusy(false);}}.bind(this),2000);if(this._oCardManifestSettings.staticContent){this.handleErrorHandling(o,"title","/staticContent");this.handleErrorHandling(o,"targetUri","/staticContent");}},validateInputField:function(e){var o=e.getSource();var l=o.getValue().trim().length;if(!l){o.setValue(o.getValue().trim());}this.updateCard(e);},addView:function(e){this.setEnablePropertyForResetAndSaveButton(true);var d,o=this._oCardManifestSettings,f=this.getView().getModel();if(o.dataPointAnnotationPath&&o.dataPoint&&o.dataPoint.length){d=o.dataPoint[0].value;}if(o.tabs&&o.tabs.length){o.newViewCounter++;o.tabs.push({annotationPath:o.lineItem[0].value,dataPointAnnotationPath:d,value:'View '+o.newViewCounter});var g=o.tabs.length;o.aViews.push({text:'View '+o.newViewCounter,key:g,isLaterAddedView:true,isViewResetEnabled:false});this.selectViewSwitch(e,g);}else{o.tabs=[{}];S.tabFields.forEach(function(t){o.tabs[0][t]=o[t];});o.tabs[0].value="View 1";if(o.template==="sap.ovp.cards.charts.analytical"){o.tabs.push({chartAnnotationPath:o.chart[0].value,dataPointAnnotationPath:d,value:'View 2'});}else{o.tabs.push({annotationPath:o.lineItem[0].value,dataPointAnnotationPath:d,value:'View 2'});}o.selectedKey=1;o.defaultViewSelected=1;o.aViews=[{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText('OVP_KEYUSER_LABEL_MAIN_VIEW'),key:0,isLaterAddedView:false,isViewResetEnabled:false},{text:'View 1 (Default view)',key:1,initialSelectedKey:1,isLaterAddedView:false,isViewResetEnabled:false},{text:'View 2',key:2,isLaterAddedView:true,isViewResetEnabled:false}];o.newViewCounter=2;this.selectViewSwitch(e,1);}this.handleErrorHandling(f,"value","/tabs");},deleteView:function(e){this.setEnablePropertyForResetAndSaveButton(true);var o=this._oCardManifestSettings,d=parseInt(o.selectedKey,10),f=this.getView().getModel();o.tabs.splice(d-1,1);o.aViews.splice(d,1);if(d===o.defaultViewSelected){o.defaultViewSelected=1;o.aViews[d].text=o.aViews[d].text+' (Default view)';}o.aViews.forEach(function(v,i){if(i>=d){v.key--;}});this.handleErrorHandling(f,"value","/tabs");if(o.tabs.length==1){S.tabFields.forEach(function(t){o[t]=o.tabs[0][t];});delete o.selectedKey;delete o.defaultViewSelected;delete o.tabs;delete o.aViews;o.aViews=[{text:'click "+" to add a view',key:0,initialSelectedKey:0,isLaterAddedView:false,isViewResetEnabled:false}];s.addManifestSettings(o);s.setVisibilityForFormElements(o);this.getView().getModel('visibility').refresh();this.getView().getModel().refresh();this._fCardWithRefresh();}else{o.selectedKey=1;this.selectViewSwitch(e,o.selectedKey);}},resetView:function(){var o=this._oCardManifestSettings,d=this.getView().getModel(),i=parseInt(o.selectedKey,10),e=o.aViews[i],f=o.defaultViewSelected;if(!e.isLaterAddedView){var k=o.dataPointAnnotationPath?true:false,g=this._oOriginalCardManifestSettings.dataPointAnnotationPath?true:false;if(i){var h=o.aViews[i].initialSelectedKey;S.tabFields.forEach(function(l){if(l!=='dataPointAnnotationPath'||k){if(this._oOriginalCardManifestSettings.tabs&&this._oOriginalCardManifestSettings.tabs.length){o[l]=this._oOriginalCardManifestSettings.tabs[h-1][l];}else{o[l]=this._oOriginalCardManifestSettings[l];}o.tabs[i-1][l]=o[l];}}.bind(this));if(!this._oOriginalCardManifestSettings.tabs||!this._oOriginalCardManifestSettings.tabs.length){o.newViewCounter++;o.tabs[i-1].value="View "+o.newViewCounter;}if(i===o.defaultViewSelected){o.aViews[i].text=o.tabs[i-1].value+' (Default view)';}else{o.aViews[i].text=o.tabs[i-1].value;}}else{S.mainFields.forEach(function(l){o[l]=this._oOriginalCardManifestSettings[l];}.bind(this));if(k!==g){if(g){o.tabs.forEach(function(t){if(t.prevDataPointAnnotationPath){t.dataPointAnnotationPath=t.prevDataPointAnnotationPath;}else{t.dataPointAnnotationPath=o.dataPoint[0].value;}});o.dataPointAnnotationPath=o.tabs[f].dataPointAnnotationPath;}else{o.tabs.forEach(function(t){t.prevDataPointAnnotationPath=t.dataPointAnnotationPath;t.dataPointAnnotationPath=undefined;});}}}}else{var j;if(o.dataPointAnnotationPath){j=o.dataPoint[0].value;}o.newViewCounter++;if(o.template==="sap.ovp.cards.charts.analytical"){o.tabs[i-1]={chartAnnotationPath:o.chart[0].value,dataPointAnnotationPath:j,value:'View '+o.newViewCounter};}else{o.tabs[i-1]={annotationPath:o.lineItem[0].value,dataPointAnnotationPath:j,value:'View '+o.newViewCounter};}if(i===o.defaultViewSelected){o.aViews[i].text='View '+o.newViewCounter+' (Default view)';}else{o.aViews[i].text='View '+o.newViewCounter;}S.tabFields.forEach(function(l){o[l]=o.tabs[i-1][l];});}this.handleErrorHandling(d,"value","/tabs");o.isViewResetEnabled=false;o.aViews[i].isViewResetEnabled=false;s.addManifestSettings(o);s.setVisibilityForFormElements(o);this.getView().getModel('visibility').refresh();this.getView().getModel().refresh();this._fCardWithRefresh();},selectViewSwitch:function(e,d){var o=this._oCardManifestSettings,f=this.getView().getModel();if(!d){d=e.getSource().getSelectedIndex();}if(this.defaultViewSwitch){this.defaultViewSwitch.setEnabled(true);}this.setEnablePropertyForResetAndSaveButton(true);if(!d){var i=o.defaultViewSelected;o.selectedKey=d;o.mainViewSelected=true;o.isViewResetEnabled=o.aViews[d].isViewResetEnabled;S.tabFields.forEach(function(j){o[j]=o.tabs[i-1][j];});this.handleErrorHandling(f,"value","/tabs");s.addManifestSettings(o);s.setVisibilityForFormElements(o);this.getView().getModel('visibility').refresh();this.getView().getModel().refresh();this._fCardWithRefresh();}else{o.mainViewSelected=false;o.isViewResetEnabled=o.aViews[d].isViewResetEnabled;var g=this.getView().byId("dialogCard");if(g.getVisible()){var r=g.getComponentInstance().getRootControl();var h=r.getController();h.changeSelection(d,true,o);this.handleErrorHandling(f,"value","/tabs");s.addManifestSettings(o);s.setVisibilityForFormElements(o);this.getView().getModel('visibility').refresh();this.getView().getModel().refresh();}}},setCurrentActivePageForCarouselCard:function(i){var d=this.getView().byId("dialogCard");if(d.getVisible()){var o=d.getComponentInstance(),r=o.getRootControl(),e=r.byId("pictureCarousel");if(e){var p=e.getPages(),n=p[i];e.setActivePage(n);}}},onSelectionChange:function(e){var o=e.getSource(),m=o.getModel(),d=m.getData().staticContent,f=o.getSelectedItem(),g=f.getBindingContext().getObject(),v=o.getModel("visibility");for(var i=0;i<d.length;i++){if(d[i].id===g.id){v.setProperty("/moveToTheTop",!(d.length===1||i===0));v.setProperty("/moveUp",!(d.length===1||i===0));v.setProperty("/moveDown",!(d.length===1||i===(d.length-1)));v.setProperty("/moveToTheBottom",!(d.length===1||i===(d.length-1)));v.setProperty("/delete",true);m.setProperty("/selectedItemIndex",i);v.refresh(true);if(e.getParameter("listItem")){this.setCurrentActivePageForCarouselCard(i);}break;}}},handleErrorForProperty:function(o,p,d){o.firePropertyChange({context:o.getContext(d?d:"/"),path:p,value:o.getProperty(d?(d+"/"+p):p),reason:sap.ui.model.ChangeReason.Change});},handleErrorHandling:function(o,p,d){var e=o.getProperty(d);o.firePropertyChange({context:o.getContext(d),path:d+","+p,value:o.getProperty(d),reason:sap.ui.model.ChangeReason.Change});for(var i=0;i<e.length;i++){var f=d+"/"+i;o.firePropertyChange({context:o.getContext(f),path:p,value:o.getProperty(f+"/"+p),reason:sap.ui.model.ChangeReason.Change});}},setEnablePropertyForResetAndSaveButton:function(e){s.enableResetButton(e);s.enableSaveButton(e);},getValueInRemString:function(v){return v+'rem';},_getSelectedItemIndex:function(m){return m.getProperty("/selectedItemIndex");},_getLastItemIndex:function(m){return this._getStaticContentArray(m).length-1;},_getStaticContentArray:function(m){return m.getProperty("/staticContent");},_setStaticContentArray:function(m,d){m.setProperty("/staticContent",d);},_setSelectedItemAndScrollToElement:function(i,h){var v=this.getView(),l=v.byId("sapOvpStaticLinkListLineItem"),o=v.byId("scrollContainer"),d=v.getModel();this.handleErrorHandling(d,"title","/staticContent");this.handleErrorHandling(d,"targetUri","/staticContent");var I=l.getItems()[i];if(h){this._oList=l;this._oItem=I;this._oScrollContainer=o;var e={onAfterRendering:function(E){this._oList.removeEventDelegate(this._oDelegateOnAfter);this._oScrollContainer.scrollToElement(this._oItem);delete this._oDelegateOnAfter;delete this._oList;delete this._oScrollContainer;delete this._oItem;}};this._oDelegateOnAfter=e;l.addEventDelegate(e,this);}else{o.scrollToElement(I);}l.setSelectedItem(I);l.fireSelectionChange();},_arrangeStaticContent:function(m,f,t){var d=this._getStaticContentArray(m);d.splice(t,0,d.splice(f,1)[0]);this._setStaticContentArray(m,d);this._setSelectedItemAndScrollToElement(t);},_filterTable:function(e,f,I){var q=e.getParameter("query"),g=null,d=[];for(var i=0;i<f.length;i++){d.push(new F(f[i],c.Contains,q));}if(q){g=new F(d,false);}this.getView().byId(I).getBinding("items").filter(g,"Application");},filterLinksTable:function(e){this._filterTable(e,["name","value"],"tableFilterLinks");},filterIconTable:function(e){this._filterTable(e,["Icon","Name"],"tableFilter");},filterImageTable:function(e){this._filterTable(e,["Name"],"tableFilterImage");},getIndexFromIdForStaticLinkList:function(i){var d=i.split("-");return d[d.length-1];},_createLabel:function(h){return new sap.m.Label({text:h});},_createIcon:function(d){return new sap.ui.core.Icon({src:"{"+d+"}"});},_createImage:function(d){return new sap.m.Image({src:"{"+d+"}",width:"3rem",height:"3rem"});},_createText:function(d){return new sap.m.Text({text:"{"+d+"}"});},_createColumnHeader:function(p){return new sap.m.Column({header:[this._createLabel(p)]});},_createColumnCells:function(t,p,i){var d;if(i==="tableFilterImage"){d=[this._createImage("Image"),this._createText("Name")];}else if(i==="tableFilterLinks"){d=[this._createText("name"),this._createText("value")];}else{d=[this._createIcon("Icon"),this._createText("Name")];}t.bindItems("/"+p,new sap.m.ColumnListItem({cells:d}));},_addColumnHeader:function(t,i){if(i==="tableFilterImage"){t.addColumn(this._createColumnHeader("Image"));t.addColumn(this._createColumnHeader("Name"));}else{t.addColumn(this._createColumnHeader("Icon"));t.addColumn(this._createColumnHeader("Name"));}},_getColumnHeader:function(i){if(i==="tableFilterImage"){return[this._createColumnHeader("Image"),this._createColumnHeader("Name")];}else if(i==="tableFilterLinks"){return[this._createColumnHeader("Application Name"),this._createColumnHeader("Technical Name")];}else{return[this._createColumnHeader("Icon"),this._createColumnHeader("Name")];}},_createTable:function(i,f){return new sap.m.Table({id:this.getView().getId()+"--"+i,mode:sap.m.ListMode.SingleSelectLeft,inset:false,fixedLayout:false,headerToolbar:new sap.m.Toolbar({content:[new sap.m.ToolbarSpacer({width:"60%"}),new sap.m.SearchField({placeholder:"Search",search:f.bind(this)})]}),columns:this._getColumnHeader(i)});},_getImageData:function(){var i=[];i.push({'Name':'AW.png','Image':sap.ovp.cards.linklist.AnnotationHelper.formUrl(this.getView().getModel().getProperty('/baseUrl'),'img/AW.png')});return i;},_getIconData:function(I){var o=sap.ui.core.IconPool,d=o.getIconNames(),e=[];if(I){var n=I.split("://")[1],f=d.indexOf(n);d.splice(f,1);e.push({'Name':n,'Icon':o.getIconURI(n)});}for(var i=0;i<d.length;i++){e.push({'Name':d[i],'Icon':o.getIconURI(d[i])});}return e;},_getLinkListItemId:function(m,i){return m.getProperty("/staticContent/"+i+"/index");},_makeLinkListItemId:function(i){return"linkListItem--"+i;},_makeLinkListItemIndex:function(i){return"Index--"+i;},getIconAndImageDataModel:function(i){return new sap.ui.model.json.JSONModel({'Icons':this._getIconData(i),'Images':[]});},getSubHeader:function(){var I=new sap.m.IconTabBar({selectedKey:"ICON",select:function(e){var k=e.getParameter("key");if(k==="IMAGE"){this.valueHelpDialog.setTable(this._oTableImage);if(typeof this._oTableImage.getColumns==="function"&&this._oTableImage.getColumns().length===0){this._addColumnHeader(this._oTableImage,"tableFilterImage");}}else{this.valueHelpDialog.setTable(this._oTable);if(typeof this._oTable.getColumns==="function"&&this._oTable.getColumns().length===0){this._addColumnHeader(this._oTable,"tableFilter");}}}.bind(this)});var t=["ICON","IMAGE"];for(var i=0;i<t.length;i++){var d=new sap.m.IconTabFilter({text:t[i],key:t[i]});I.addItem(d);}return new sap.m.Toolbar({content:[I]});},destroyTemplatesAndObjects:function(){var v=this.getView();var t=v.byId("tableFilterImage");if(t){t.destroy();}var o=v.byId("tableFilter");if(o){o.destroy();}var d=v.byId("tableFilterLinks");if(d){d.destroy();}delete this._oEvent;delete this._iCurrentRow;delete this._oModel;delete this._oVisibilityModel;},onExternalUrlChange:function(e){this.setEnablePropertyForResetAndSaveButton(true);},onLinkSourceChange:function(e){var o=e.getSource(),m=o.getModel(),v=o.getModel("visibility"),i=this.getIndexFromIdForStaticLinkList(o.getId()),d=e.getParameter("selectedIndex"),f=v.getProperty("/staticLink"),l=v.getProperty("/links"),I=this._getLinkListItemId(m,parseInt(i,10));if(d===0){f[I]=false;l[I]=true;m.setProperty("/staticContent/"+i+"/targetUri",undefined);}else{f[I]=true;l[I]=false;m.setProperty("/staticContent/"+i+"/semanticObject",undefined);m.setProperty("/staticContent/"+i+"/action",undefined);m.setProperty("/staticContent/"+i+"/targetUri","");}v.setProperty("/staticLink",f);v.setProperty("/links",l);v.refresh(true);m.refresh(true);this.handleErrorForProperty(m,"targetUri","/staticContent/"+i);this.setEnablePropertyForResetAndSaveButton(true);},onRemoveVisualPress:function(e){var o=e.getSource(),m=o.getModel(),v=o.getModel("visibility"),i=this.getIndexFromIdForStaticLinkList(o.getId()),I=this._getLinkListItemId(m,parseInt(i,10)),r=v.getProperty("/removeVisual");r[I]=false;v.setProperty("/removeVisual",r);v.refresh(true);m.setProperty("/staticContent/"+i+"/imageUri",undefined);m.refresh(true);this.updateCard(e,"sapOvpSettingsStaticLinkListRemoveVisual");},createValueHelpDialogForInternalUrl:function(e){var o=e.getSource(),m=o.getModel(),E=o.getModel("staticCardProperties"),v=o.getModel("visibility"),i=this.getIndexFromIdForStaticLinkList(o.getId());this._oEvent=jQuery.extend({},e);this._iCurrentRow=i;this._oModel=m;this._oVisibilityModel=v;var t=this._createTable("tableFilterLinks",this.filterLinksTable);t.setModel(E);this._createColumnCells(t,"links","tableFilterLinks");this._oTable=t;this.valueHelpDialog=new V({title:"Application",contentWidth:"100%",contentHeight:this.getValueInRemString(s.iContentHeightForDialog),supportMultiselect:false,ok:function(e){var d=this._oTable.getSelectedItem(),I=d.getBindingContext().getProperty("value"),f=I.slice(1).split("-"),g=f[0],A=f[1];this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/semanticObject",g);this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/action",A);this._oModel.refresh(true);this.setEnablePropertyForResetAndSaveButton(true);this.destroyTemplatesAndObjects();this.valueHelpDialog.close();}.bind(this)});this.valueHelpDialog.addStyleClass("sapOvpSettingsDialogBox");this.valueHelpDialog.attachCancel(function(){this.destroyTemplatesAndObjects();this.valueHelpDialog.close();}.bind(this));this.valueHelpDialog.setTable(t);t.setSelectedItem(t.getItems()[0]);this.valueHelpDialog.open();},onChangeVisualPress:function(e){var o=e.getSource(),m=o.getModel(),v=o.getModel("visibility"),i=this.getIndexFromIdForStaticLinkList(o.getId()),I=m.getProperty("/staticContent/"+i+"/imageUri"),n=sap.ovp.cards.linklist.AnnotationHelper.isImageUrlStaticData(I);this._oEvent=jQuery.extend({},e);this._iCurrentRow=i;this._oModel=m;this._oVisibilityModel=v;var t=this._createTable("tableFilter",this.filterIconTable);var r=(n)?this.getIconAndImageDataModel():this.getIconAndImageDataModel(I);t.setModel(r);this._createColumnCells(t,"Icons","tableFilter");this._oTable=t;var d=this._createTable("tableFilterImage",this.filterImageTable);d.setModel(r);this._createColumnCells(d,"Images","tableFilterImage");this._oTableImage=d;var f=this.getSubHeader();this.valueHelpDialog=new V({title:"Visual",contentWidth:"100%",contentHeight:this.getValueInRemString(s.iContentHeightForDialog),supportMultiselect:false,ok:function(e){var t,p,g=this._getLinkListItemId(this._oModel,parseInt(this._iCurrentRow,10)),R=this._oVisibilityModel.getProperty("/removeVisual");R[g]=true;this._oVisibilityModel.setProperty("/removeVisual",R);this._oVisibilityModel.refresh(true);if(this._sTableName==="tableFilterImage"){t=this._oTableImage;p="Image";}else{t=this._oTable;p="Icon";}var h=t.getSelectedItem(),j=h.getBindingContext(),u=j.getProperty(p);this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/imageUri",u);this._oModel.refresh(true);this.updateCard(this._oEvent,"sapOvpSettingsStaticLinkListChangeVisual");this.destroyTemplatesAndObjects();this.valueHelpDialog.close();}.bind(this)});this.valueHelpDialog.attachSelectionChange(function(e){var g=e.getParameter("tableSelectionParams");if(g.id.indexOf("tableFilterImage")===-1){this._sTableName="tableFilter";}else{this._sTableName="tableFilterImage";}}.bind(this));this.valueHelpDialog.addStyleClass("sapOvpSettingsDialogBox");this.valueHelpDialog.attachCancel(function(){this.destroyTemplatesAndObjects();this.valueHelpDialog.close();}.bind(this));this.valueHelpDialog.setTable(t);this.valueHelpDialog.setSubHeader(f);t.setSelectedItem(t.getItems()[0]);this.valueHelpDialog.open();},handleMessagePopoverPress:function(e){s.oMessagePopOver.openBy(e.getSource());},onShowMorePress:function(e){var o=e.getSource(),m=o.getModel(),v=o.getModel("visibility"),i=this.getIndexFromIdForStaticLinkList(o.getId()),I=this._getLinkListItemId(m,parseInt(i,10)),d=v.getProperty("/showMore/"+I);if(d){v.setProperty("/showMore/"+I,false);}else{v.setProperty("/showMore/"+I,true);}v.refresh(true);},onPressDelete:function(e){this._oEvent=jQuery.extend({},e);M.confirm("Do you want to delete the Line Item",{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],icon:M.Icon.INFORMATION,title:"Information",initialFocus:M.Action.CANCEL,onClose:function(A){if(A==="OK"){var o=this._oEvent.getSource(),v=o.getModel("visibility"),m=o.getModel(),d=this._getStaticContentArray(m),i=this._getSelectedItemIndex(m),I=this._getLinkListItemId(m,i),f=v.getProperty("/staticLink"),l=v.getProperty("/links"),r=v.getProperty("/removeVisual"),g=v.getProperty("/showMore");delete f[I];delete l[I];delete r[I];delete g[I];v.setProperty("/staticLink",f);v.setProperty("/links",l);v.setProperty("/removeVisual",r);v.setProperty("/showMore",g);d.splice(i,1);this._setStaticContentArray(m,d);m.refresh(true);if(d.length>0){this._setSelectedItemAndScrollToElement(Math.min(parseInt(i,10),d.length-1),true);}if(d.length<=1){v.setProperty("/delete",false);}v.refresh(true);this.updateCard(this._oEvent,"sapOvpSettingsStaticLinkListDelete");}delete this._oEvent;}.bind(this)});},onPressAdd:function(e){var o=e.getSource(),v=o.getModel("visibility"),m=o.getModel(),d=this._getStaticContentArray(m),l=m.getProperty("/lineItemIdCounter"),i=this._makeLinkListItemId(l+1),I=this._makeLinkListItemIndex(l+1),f=v.getProperty("/staticLink"),L=v.getProperty("/links"),r=v.getProperty("/removeVisual"),g=v.getProperty("/showMore");m.setProperty("/lineItemIdCounter",l+1);d.unshift({"id":i,"index":I,"title":"Default Title","subTitle":"Default SubTitle","imageUri":"","imageAltText":"","targetUri":"","openInNewWindow":""});f[I]=true;L[I]=false;r[I]=false;g[I]=false;v.setProperty("/staticLink",f);v.setProperty("/links",L);v.setProperty("/removeVisual",r);v.setProperty("/showMore",g);v.refresh(true);this._setStaticContentArray(m,d);m.refresh(true);this._setSelectedItemAndScrollToElement(0);this.updateCard(e,"sapOvpSettingsStaticLinkListAdd");},onPressMoveToTheTop:function(e){var m=e.getSource().getModel();this._arrangeStaticContent(m,this._getSelectedItemIndex(m),0);this.updateCard(e,"sapOvpSettingsStaticLinkListSort");},onPressMoveUp:function(e){var m=e.getSource().getModel(),i=this._getSelectedItemIndex(m);this._arrangeStaticContent(m,i,i-1);this.updateCard(e,"sapOvpSettingsStaticLinkListSort");},onPressMoveDown:function(e){var m=e.getSource().getModel(),i=this._getSelectedItemIndex(m);this._arrangeStaticContent(m,i,i+1);this.updateCard(e,"sapOvpSettingsStaticLinkListSort");},onPressMoveToTheBottom:function(e){var m=e.getSource().getModel(),i=this._getSelectedItemIndex(m),I=this._getLastItemIndex(m);this._arrangeStaticContent(m,i,I);this.updateCard(e,"sapOvpSettingsStaticLinkListSort");},onResetButton:function(){this._oCardManifestSettings=jQuery.extend(true,{},this._oOriginalCardManifestSettings);var o=this.getView().getModel();o.setProperty("/",this._oCardManifestSettings);s.setVisibilityForFormElements(this._oCardManifestSettings);this.getView().getModel('visibility').refresh();s.resetErrorHandling();this.setEnablePropertyForResetAndSaveButton(false);this._fCardWithRefresh();},onSaveButtonPress:function(){if(s.bError){s.oMessagePopOverButton.firePress();}else{this.createAndSubmitChange.bind(this)();}},setBusy:function(d){if(d){this.getView().addStyleClass("dialogContainerOverlay");var e=this.getView().byId("dialogCard");if(e.getVisible()){e.getComponentInstance().getRootControl().setBusy(d);}}else{this.getView().removeStyleClass("dialogContainerOverlay");setTimeout(function(){var e=this.getView().byId("dialogCard");if(e.getVisible()){e.getComponentInstance().getRootControl().setBusy(d);}}.bind(this),2000);}},_fCardWithoutRefresh:function(e,u){var v=this.getView(),o=this._oCardManifestSettings,d=v.byId("dialogCard").getComponentInstance(),r=d.getRootControl(),E,m,i=false,f;if(o.tabs&&o.tabs.length){i=true;f=parseInt(o.selectedKey,10);}if(u.formElementId==="sapOvpSettingsLineItemTitle"||u.formElementId==="sapOvpSettingsLineItemSubTitle"){E=r.byId(u.cardElementId+"--"+v.getModel().getProperty("/lineItemId"));}else{E=r.byId(u.cardElementId);if(!E){this._fCardWithRefresh(e,u.cardElementId);}}switch(u.formElementId){case"sapOvpSettingsLineItemTitle":case"sapOvpSettingsLineItemSubTitle":case"sapOvpSettingsTitle":case"sapOvpSettingsValueSelectionInfo":if(E){E.setText(e.getSource().getValue());}break;case"sapOvpSettingsSubTitle":var g=r.getController(),h=g.getCardPropertiesModel();h.setProperty("/subTitle",e.getSource().getValue());g._setSubTitleWithUnitOfMeasure();break;case"sapOvpSettingsViewName":var j=o.viewName;m=v.getModel();E.getItems()[f-1].setText(j);o.tabs[f-1].value=j;if(o.defaultViewSelected===f){j=j+" (Default view)";}o.aViews[f].text=j;m.refresh();break;case"sapOvpDefaultViewSwitch":if(e.getSource().getState()){var k=o.defaultViewSelected;m=v.getModel();o.defaultViewSelected=f;o.aViews[k].text=o.tabs[k-1].value;o.aViews[f].text+=" (Default view)";m.refresh();this.defaultViewSwitch=e.getSource();this.defaultViewSwitch.setEnabled(false);}break;case"sapOvpSettingsIdentification":if(i){o.tabs[f-1][u.updateProperty]=o[u.updateProperty];}break;case"sapOvpSettingsKPIHeaderSwitch":var l=v.getModel("visibility"),n=l.getData();n.dataPoint=false;n.valueSelectionInfo=false;if(i){o.tabs.forEach(function(t){t.prevDataPointAnnotationPath=t.dataPointAnnotationPath;t.dataPointAnnotationPath=undefined;});}else{var p=o.dataPointAnnotationPath;if(p){o.prevDataPointAnnotationPath=p;}o.dataPointAnnotationPath=undefined;}l.refresh(true);E.destroy();break;default:break;}},_fCardWithRefresh:function(e,u){var p,d,v,o,f,g=this._oCardManifestSettings,h=this.getView(),i=h.byId('dialogCard'),j=i.getComponentInstance().getComponentData(),k=j.cardId,m=j.manifest.cards[k].model,l={cards:{}},n=false,q;if(g.tabs&&g.tabs.length){n=true;q=parseInt(g.selectedKey,10);}switch(u){case"subTitleSwitch":v=this.getView();o=v.getModel("visibility");if(e.getSource().getState()){if(n){d=g.defaultViewSelected;g.tabs.forEach(function(w){p=w.prevDynamicSubtitleAnnotationPath;if(p){w.dynamicSubtitleAnnotationPath=p;}else{w.dynamicSubtitleAnnotationPath=g.dynamicSubTitle[0].value;}});g.dynamicSubtitleAnnotationPath=g.tabs[d-1].dynamicSubtitleAnnotationPath;}else{p=g.prevDynamicSubtitleAnnotationPath;if(p){g.dynamicSubtitleAnnotationPath=p;}else{g.dynamicSubtitleAnnotationPath=g.dynamicSubTitle[0].value;}}h.byId("sapOvpSettingsDynamicSubTitle").setSelectedKey(g.dynamicSubtitleAnnotationPath);}else{if(n){g.tabs.forEach(function(w){w.prevDynamicSubtitleAnnotationPath=w.dynamicSubtitleAnnotationPath;w.dynamicSubtitleAnnotationPath=undefined;});g.dynamicSubtitleAnnotationPath=undefined;}else{var r=g.dynamicSubtitleAnnotationPath;if(r){g.prevDynamicSubtitleAnnotationPath=r;}g.dynamicSubtitleAnnotationPath=undefined;}}o.setProperty("/subTitle",s.getVisibilityOfElement(g,'subTitle',n));o.setProperty("/dynamicSubTitle",s.getVisibilityOfElement(g,'dynamicSubTitle',n)&&!!g["dynamicSubTitle"]&&!!g["dynamicSubTitle"].length);o.refresh(true);break;case"kpiHeader":v=this.getView();o=v.getModel("visibility");f=o.getData();f.valueSelectionInfo=true;f.dataPoint=true;if(g.tabs&&g.tabs.length){f.dataPoint=s.getVisibilityOfElement(g,'dataPoint',true);}if(!g.valueSelectionInfo){g.valueSelectionInfo=" ";}if(n){d=g.defaultViewSelected;g.tabs.forEach(function(w){p=w.prevDataPointAnnotationPath;if(p){w.dataPointAnnotationPath=p;}else{w.dataPointAnnotationPath=g.dataPoint[0].value;}});g.dataPointAnnotationPath=g.tabs[d-1].dataPointAnnotationPath;}else{p=g.prevDataPointAnnotationPath;if(p){g.dataPointAnnotationPath=p;}else{g.dataPointAnnotationPath=g.dataPoint[0].value;}}o.refresh(true);break;case"listType":g[u]=(e.getSource().getState())?"extended":"condensed";break;case"listFlavor":g[u]=(e.getSource().getState())?"bar":"";break;case"sortBy":v=this.getView();o=v.getModel("visibility");f=o.getData();if(!!g.sortBy!==f.sortOrder){f.sortOrder=!!g.sortBy;o.refresh();}break;case"listFlavorForLinkList":case"sortOrder":break;case"annotationPath":case"chartAnnotationPath":case"presentationAnnotationPath":case"selectionAnnotationPath":case"dynamicSubtitleAnnotationPath":case"dataPointAnnotationPath":if(n){g.tabs[q-1][u]=g[u];}break;case"ovpHeaderTitle":case"add":case"removeVisual":case"changeVisual":case"sort":case"delete":break;default:break;}l.cards[k]={model:m,template:j.template,settings:g};this.setBusy(true);var t=O.createCardComponent(h,l,'dialogCard');t.then(function(){this.setBusy(false);var L=this.getView().byId("sapOvpStaticLinkListLineItem");if(L){var I=L.getSelectedItem();if(I){var w=I.getId(),x=this.getIndexFromIdForStaticLinkList(w);this.setCurrentActivePageForCarouselCard(x);}}}.bind(this));t.catch(function(){this.setBusy(false);}.bind(this));},updateCard:function(e,I){var o=this._oCardManifestSettings,d=this.getView().byId("dialogCard");this.setEnablePropertyForResetAndSaveButton(true);if(d.getVisible()){if(o.tabs&&o.tabs.length){var f=parseInt(o.selectedKey,10);o.isViewResetEnabled=true;o.aViews[f].isViewResetEnabled=true;}var g=e.getSource(),h=(I)?I:g.getId(),k=false;if(h.indexOf("sapOvpStaticLinkListLineItem")!==-1){var l=g.getModel(),m=l.getData().staticContent,n=this.getIndexFromIdForStaticLinkList(h);this.setCurrentActivePageForCarouselCard(n);l.setProperty("/lineItemId",m[n].id);if(h.indexOf("sapOvpSettingsLineItemTitle")!==-1){h="sapOvpSettingsLineItemTitle";}else if(h.indexOf("sapOvpSettingsLineItemSubTitle")!==-1){h="sapOvpSettingsLineItemSubTitle";}}for(var i=0;i<this._aRefreshNotRequired.length;i++){if(h.indexOf(this._aRefreshNotRequired[i].formElementId)>-1){if(this._aRefreshNotRequired[i].isKpiSwitch&&e.getSource().getState()){break;}this._fCardWithoutRefresh(e,this._aRefreshNotRequired[i]);k=true;break;}}if(!k){for(var j=0;j<this._aRefreshRequired.length;j++){if(h.indexOf(this._aRefreshRequired[j].formElementId)>-1){this.setBusy(true);this._fCardWithRefresh(e,this._aRefreshRequired[j].updateProperty);break;}}}}},onExit:function(){s.oSaveButton.detachPress(this.onSaveButtonPress,this);s.oResetButton.detachPress(this.onResetButton,this);s.oMessagePopOverButton.detachPress(this.handleMessagePopoverPress,this);},updateTheLineItemSelected:function(e){var d=e.getSource().getSelectedItem().getBindingContext().getObject().Qualifier,o=this._oCardManifestSettings,i;if(o.tabs&&o.tabs.length){i=parseInt(o.selectedKey,10);}o.lineItemQualifier=d;o.annotationPath='com.sap.vocabularies.UI.v1.LineItem#'+d;if(d==='Default'){o.annotationPath='com.sap.vocabularies.UI.v1.LineItem';}if(o.tabs&&o.tabs.length){o.tabs[i-1].annotationPath=o.annotationPath;}this.getView().byId("sapOvpSettingsLineItem").setValue(d);this._fCardWithRefresh(e,'annotationPath');this.setEnablePropertyForResetAndSaveButton(true);if(o.tabs&&o.tabs.length){o.isViewResetEnabled=true;o.aViews[i].isViewResetEnabled=true;}this.valueHelpDialog.close();},getListItems:function(){var i=[],o=this._oCardManifestSettings,d=this.getView(),e=d.byId('dialogCard'),f=e.getComponentInstance().getComponentData(),l=o.entityType.$path+'/'+o.annotationPath,m=f.model.getMetaModel(),g=m.getContext(m.resolve(l,this.oView.getBindingContext()));var h=2,j=1,n=0;if(o.listFlavor==='bar'){h=1;j=2;}if(o.listType&&o.listType.toLowerCase()==='extended'){h=6;j=3;n=3;if(o.listFlavor==='bar'){h=5;}}else if(o.contentFragment==="sap.ovp.cards.table.Table"){h=3;j=1;n=1;}o.lineItem.forEach(function(k){var p=sap.ovp.cards.AnnotationHelper.getSortedDataPoints(g,k.fields),q=sap.ovp.cards.AnnotationHelper.getSortedDataFields(g,k.fields),r=[],t=[];p.forEach(function(x){if(x.Title){t.push(x.Title.String);}});q.forEach(function(x){if(x.Label){r.push(x.Label.String);}});var u=Math.min(t.length,j),v=Math.min(n,u),w=r.slice(0,h-v).concat(t.slice(0,u));w.map(function(x){return x.charAt(0).toUpperCase()+x.substr(1);});i.push({Qualifier:k.name,VisibleFields:w.toString()});});return i;},openLineItemValueHelpDialog:function(e){var t=new sap.m.Table({mode:sap.m.ListMode.SingleSelectLeft,inset:false,fixedLayout:false,columns:[new sap.m.Column({header:[new sap.m.Label({text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText('OVP_KEYUSER_LINEITEM_QUAL')})]}),new sap.m.Column({header:[new sap.m.Label({text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_VISIBLE_FIELDS")})]})]});t.bindItems("/",new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{Qualifier}"}),new sap.m.Text({text:"{VisibleFields}"})]}));t.attachSelectionChange(this.updateTheLineItemSelected.bind(this));this.valueHelpDialog=new V({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LINEITEM_ANNO"),contentWidth:"100%",contentHeight:this.getValueInRemString(s.iContentHeightForDialog+0.125),supportMultiselect:false});this.valueHelpDialog.attachCancel(function(){this.valueHelpDialog.close();}.bind(this));this.valueHelpDialog.setTable(t);this.valueHelpDialog.addStyleClass("sapOvpSettingsDialogBox");this.aItemList=this.getListItems();var r=new sap.ui.model.json.JSONModel();r.setData(this.aItemList);this.valueHelpDialog.getTable().setModel(r);t.getItems().forEach(function(i){if(i.getBindingContext().getObject().Qualifier===this._oCardManifestSettings.lineItemQualifier){i.setSelected(true);}}.bind(this));this.valueHelpDialog.open();},createAndSubmitChange:function(){var p=P.getPayLoadForEditCard.bind(this)(s);this.settingsResolve(p);s.dialogBox.close();}});});

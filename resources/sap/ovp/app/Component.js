sap.ui.define(["sap/ui/core/UIComponent","sap/ui/model/odata/AnnotationHelper","sap/ovp/cards/rta/SettingsDialogConstants","sap/ui/rta/RuntimeAuthoring"],function(U,A,S){"use strict";return U.extend("sap.ovp.app.Component",{metadata:{routing:{config:{routerClass:sap.ui.core.routing.Router},targets:{},routes:[]},properties:{"cardContainerFragment":{"type":"string","defaultValue":"sap.ovp.app.CardContainer"},"dashboardLayoutUtil":{"type":"sap.ovp.ui.DashboardLayoutUtil"}},version:"1.54.4",library:"sap.ovp.app",dependencies:{libs:[],components:[]},config:{fullWidth:true,hideLightBackground:true}},_addModelsMeasurements:function(){var m=this.oModels;var M,s;for(s in m){M=this.getModel(s);if(M.getMetaModel()){this._addModelMeasurements(M,s);}}},_addModelMeasurements:function(m,M){var i="ovp:ModelLoading-"+M;var I="ovp:ModelBatchCall-"+M+":";jQuery.sap.measure.start(i,"Component createContent -> MetaData loaded","ovp");var g=m.getMetaModel().loaded();g.then(function(){jQuery.sap.measure.end(i);});m.attachBatchRequestSent(function(e){jQuery.sap.measure.start(I+e.getParameter("ID"),"BatchRequestSent -> BatchRequestCompleted","ovp");});m.attachBatchRequestCompleted(function(e){jQuery.sap.measure.end(I+e.getParameter("ID"));});},_getOvpCardOriginalConfig:function(c){var o=this.getOvpConfig();return o.cards[c];},getOvpConfig:function(){var o;var e=[];var m=this.getMetadata();while(m&&m.getComponentName()!=="sap.ovp.app"){o=m.getManifestEntry("sap.ovp");if(o){e.unshift(o);}m=m.getParent();}e.unshift({});e.unshift(true);o=jQuery.extend.apply(jQuery,e);return o;},_checkIfTextProperty:function(p){var a=S.allTexts,f=false;for(var i=0;i<a.length;i++){if(a[i]===p){f=true;break;}}return f;},_isEquivalent:function(o,O){var f=true;if((!o&&O)||(o&&!O)){return false;}for(var p in o){if(o.hasOwnProperty(p)){var v=o[p];if(typeof v=="object"){f=f&&this._isEquivalent(v,O[p]);}else{f=f&&((O[p]==v)||this._checkIfTextProperty(p));}}}return f;},_removeExtraArrayElements:function(s,c){var a=s["staticContent"],C=c["staticContent"],b=s["tabs"],d=c["tabs"];if(a&&C){if(a.length>C.length){s["staticContent"].splice(C.length,a.length-C.length);}}if(b&&d){if(b.length>d.length){s["tabs"].splice(d.length,b.length-d.length);}}},_emptyAllArrayElements:function(s){var a=s["staticContent"],b=s["tabs"],i;if(a){for(i=0;i<a.length;i++){s["staticContent"][i]={};}}if(b){for(i=0;i<b.length;i++){s["tabs"][i]={};}}},_mergeObjects:function(o,O){for(var p in O){if(O.hasOwnProperty(p)){var v=O[p];if(typeof v=="object"&&o[p]){if(v.operation==="DELETE"){delete o[p];}else{this._mergeObjects(o[p],v);}}else{o[p]=v;}}}return o;},_mergeKeyUserChanges:function(c){if(!(c.hasOwnProperty("customer.settings")&&c.hasOwnProperty("vendor.settings"))){return c;}if(!this._isEquivalent(c["settings"],c["vendor.settings"])){delete c["customer.settings"];delete c["vendor.settings"];return c;}var s=jQuery.extend(true,{},c["settings"]),C=jQuery.extend(true,{},c["customer.settings"]);this._removeExtraArrayElements(s,C);this._emptyAllArrayElements(s);c["settings"]=this._mergeObjects(s,C);return c;},_getFullyQualifiedNameForEntity:function(e,f){var n,r;if(!e){return"";}if(e.indexOf(".")>-1){return e;}var d=f&&f.getODataEntityContainer();n=d&&d.namespace;if(n&&!(e.indexOf(n)>-1)){r=n+"."+e;}else{r=e;}return r;},createXMLView:function(o){jQuery.sap.measure.start("ovp:AppCreateContent","OVP app Component createContent","ovp");this._addModelsMeasurements();if(this.getRouter()){this.getRouter().initialize();}var a=this.getMetadata().getManifestEntry("sap.app");var u=this.getMetadata().getManifestEntry("sap.ui");var i=jQuery.sap.getObject("icons.icon",undefined,u);var c=this.getMetadata().getComponentName();o.baseUrl=jQuery.sap.getModulePath(c);if(o.smartVariantRequired===undefined||o.smartVariantRequired===null){o.smartVariantRequired=true;}if(o.enableLiveFilter===undefined||o.enableLiveFilter===null){o.enableLiveFilter=true;}if(o.showDateInRelativeFormat===undefined||o.showDateInRelativeFormat===null){o.showDateInRelativeFormat=true;}if(o.useDateRangeType||o.useDateRangeType===undefined||o.useDateRangeType===null){o.useDateRangeType=false;}var f=this.getModel(o.globalFilterModel);var F=f&&f.getMetaModel();this.setModel(f);if(o.globalFilterEntitySet&&o.globalFilterEntitySet!==" "){var e=F&&F.getODataEntitySet(o.globalFilterEntitySet);o.globalFilterEntityType=e&&e.entityType;}if(o.globalFilterEntityType&&o.globalFilterEntityType!==" "&&o.globalFilterEntityType.length>0){o.globalFilterEntityType=this._getFullyQualifiedNameForEntity(o.globalFilterEntityType,F);o.globalFilterEntityTypeNQ=o.globalFilterEntityType.split(".").pop();}var b=new sap.ui.model.json.JSONModel(o);b.setProperty("/applicationId",jQuery.sap.getObject("id",undefined,a));b.setProperty("/title",jQuery.sap.getObject("title",undefined,a));b.setProperty("/description",jQuery.sap.getObject("description",undefined,a));if(i){if(i.indexOf("sap-icon")<0&&i.charAt(0)!=='/'){i=o.baseUrl+"/"+i;}b.setProperty("/icon",i);}var C=o.cards;var d=[];var g;for(var h in C){if(C.hasOwnProperty(h)&&C[h]){g=this._mergeKeyUserChanges(C[h]);g.id=h;d.push(g);}}d.sort(function(k,l){if(k.id<l.id){return-1;}else if(k.id>l.id){return 1;}else{return 0;}});b.setProperty("/cards",d);if(this.inResizableTestMode()===true){o.containerLayout="resizable";}if(o.containerLayout&&o.containerLayout==="resizable"){jQuery.sap.require("sap.ovp.ui.DashboardLayoutUtil");b.setProperty("/cardContainerFragment","sap.ovp.app.DashboardCardContainer");b.setProperty("/dashboardLayout",o.resizableLayout);var D=new sap.ovp.ui.DashboardLayoutUtil(b);this.setDashboardLayoutUtil(D);}else{b.setProperty("/cardContainerFragment",this.getCardContainerFragment());}var v=this.createMapForValueHelpEntity(o);b.setProperty("/ValueHelpEntityMap",v);this.setModel(b,"ui");var j=this._getOvpLibResourceBundle();this.setModel(j,"ovplibResourceBundle");var E=F&&F.getODataEntityType(o.globalFilterEntityType,true);var V=sap.ui.view("mainView",{height:"100%",preprocessors:{xml:{bindingContexts:{ui:b.createBindingContext("/"),meta:F.createBindingContext(E)},models:{ui:b,meta:F}}},type:sap.ui.core.mvc.ViewType.XML,viewName:"sap.ovp.app.Main"});jQuery.sap.measure.end("ovp:AppCreateContent");return V;},_showErrorPage:function(){var v=sap.ui.view({height:"100%",type:sap.ui.core.mvc.ViewType.XML,viewName:"sap.ovp.app.Error"});var o=this._getOvpLibResourceBundle();v.setModel(o,"ovplibResourceBundle");this.setAggregation("rootControl",v);this.oContainer.invalidate();},_formParamString:function(p){var k=Object.keys(p);var i;var P="?";for(i=0;i<k.length;i++){P=P+k[i]+"="+p[k[i]]+"&";}return P.slice(0,-1);},_checkForAuthorizationForLineItems:function(){return new Promise(function(r,a){var b=[],c=[];var o=this.getOvpConfig();var C=o["cards"];for(var s in C){if(C.hasOwnProperty(s)&&C[s]){var d=C[s];var e=d.settings;if(d.template==="sap.ovp.cards.linklist"&&e.listFlavor==="standard"&&e.staticContent){var f=e.staticContent;for(var i=0;i<f.length;i++){if(f[i].semanticObject||f[i].action){var I="#"+f[i].semanticObject+"-"+f[i].action;if(f[i].params){var p=this._formParamString(f[i].params);I=I+p;}if(c.indexOf(s)===-1){c.push(s);}if(b.indexOf(I)===-1){b.push(I);}}}}}}this._oCardsWithStaticContent=c;sap.ushell.Container.getService('CrossApplicationNavigation').isIntentSupported(b).done(function(R){var o=this.getOvpConfig();for(var k in R){if(R.hasOwnProperty(k)&&R[k].supported===false){for(var i=0;i<this._oCardsWithStaticContent.length;i++){var f=o["cards"][this._oCardsWithStaticContent[i]].settings.staticContent;for(var j=f.length-1;j>=0;j--){var I="#"+f[j].semanticObject+"-"+f[j].action;if(f[j].params){var p=this._formParamString(f[j].params);I=I+p;}if(k===I){f.splice(j,1);}}o["cards"][this._oCardsWithStaticContent[i]].settings.staticContent=f;}}}delete this._oCardsWithStaticContent;r(o);}.bind(this)).fail(function(E){jQuery.sap.log.error(E);});}.bind(this));},setContainer:function(){var o=this.getOvpConfig();var f=this.getModel(o.globalFilterModel);U.prototype.setContainer.apply(this,arguments);if(f&&!this.getAggregation("rootControl")){Promise.all([f.getMetaModel().loaded(),this._checkForAuthorizationForLineItems(o)]).then(function(r){this.oOvpConfig=r[1];this.runAsOwner(function(){var v=this.createXMLView(this.oOvpConfig);this.setAggregation("rootControl",v);this.oContainer.invalidate();}.bind(this));}.bind(this));f.attachMetadataFailed(function(){this._showErrorPage();}.bind(this));}},_getOvpLibResourceBundle:function(){if(!this.ovplibResourceBundle){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");this.ovplibResourceBundle=r?new sap.ui.model.resource.ResourceModel({bundleUrl:r.oUrlInfo.url,bundle:r}):null;}return this.ovplibResourceBundle;},createMapForEntityContainer:function(e){var E={};var o=e.entitySet;for(var i=0;i<o.length;i++){E[o[i].name]=o[i].entityType;}return E;},createMapForValueHelpEntity:function(o){var f=this.getModel(o.globalFilterModel);var v=[];var F=f.getMetaModel().getODataEntityType(o.globalFilterEntityType);if(!F){return v;}var e=[];e.push(F);var c=0;var n=false;var E=this.createMapForEntityContainer(f.getMetaModel().getODataEntityContainer());if(F.navigationProperty){n=true;}while(e.length!=0){var a=e.shift();for(var i=0;i<a.property.length;i++){var p=a.property[i];if(p["com.sap.vocabularies.Common.v1.ValueList"]){v.push(E[p["com.sap.vocabularies.Common.v1.ValueList"].CollectionPath.String]);}}if(!n||!(F.navigationProperty[c])){break;}var s=f.getMetaModel().getODataAssociationEnd(F,F.navigationProperty[c].name).type;var N=f.getMetaModel().getODataEntityType(s);e.push(N);c++;}return v;},inResizableTestMode:function(){return this._getQueryParamUpToTop('resizableTest')=='true';},_getQueryParamUpToTop:function(n){var w=window;var v=this.getQueryParam(w.location.search,n);if(v!=null){return v;}if(w==w.parent){return null;}w=w.parent;return null;},getQueryParam:function(q,n){var v=null;if(!q){return v;}if(q.indexOf('?')!=-1){q=q.substring(q.indexOf('?'));}if(q.length>1&&q.indexOf(n)!=-1){q=q.substring(1);var p=q.split('&');for(var i=0;i<p.length;i++){var a=p[i].split('=');if(a[0]==n){v=a[1];break;}}}return v;}});});

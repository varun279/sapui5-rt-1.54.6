/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2018 SAP SE. All rights reserved
 */
sap.ui.define(['sap/chart/data/TimeDimension','sap/chart/utils/MeasureSemanticsUtils','sap/chart/utils/ChartUtils','sap/chart/utils/DateFormatUtil','sap/chart/data/MeasureSemantics','sap/chart/ChartLog'],function(T,M,C,D,c,d){"use strict";function R(F){this._bTimeFed=false;}R.prototype.toFeedingId=function(o){if(o instanceof T&&!this._bTimeFed){this._bTimeFed=true;return"timeAxis";}else{return"@context";}};function e(a){return C.CONFIG.timeChartTypes.indexOf(a)>-1;}function s(S,m,o){var a={actualValues:[],targetValues:[]};jQuery.each(S,function(i,t){if(t.actual){a.actualValues.push(m[t.actual]);t.valueAxisID='actualValues';}if(t.projected){a.actualValues.push(m[t.projected]);t.valueAxisID='actualValues';}if(t.reference){if((t.actual||t.projected)){a.targetValues.push(m[t.reference]);t.valueAxisID='targetValues';}else{a.actualValues.push(m[t.reference]);t.valueAxisID='actualValues';}}});delete o["@semanticBulletMsrs"];jQuery.extend(o,a);}function f(S,m){var a=m["@semanticBulletMsrs"];if(a){var F={actualValues:[]};for(var i=0;i<a.length;i++){F.actualValues.push(a[i]);}for(var i=0;i<S.length;i++){S[i].valueAxisID='actualValues';}delete m["@semanticBulletMsrs"];jQuery.extend(m,F);}}R.semantics={hasSemanticMeasures:function(F){return Object.keys(F.msrs).some(function(k){var r=false;var m=F.msrs[k];r=m.some(function(a){if(a.getSemantics){var b=a.getSemantics();return b&&b!=='actual';}});return r;});},semanticPatternMsrs:function(F,g,I){var A=[],h=[],m={},j,k;var n=e(g)&&(F.dims.timeAxis&&F.dims.timeAxis.length===1);var p;var o;if(n){var t=F.dims.timeAxis[0];p=t.getProjectedValueStartTime();if(p){var q=t.getTimeUnit();if(q==='fiscalyearperiod'||q==='fiscalyear'){o=p;}else{var r=D.getInstance(q);if(r){if(r.parse(p)){o=r.parse(p).getTime();}}else{o=new Date(p).getTime();}}}}var u=['valueAxis','valueAxis2'];var v=Object.keys(F.msrs).sort(function(a,b){return u.indexOf(a)-u.indexOf(b);});var w=this.hasSemanticMeasures(F);v.forEach(function(a){var b=F.msrs[a],G;k=null;jQuery.extend(true,m,b.reduce(function(m,L){m[L.getName()]=L;return m;},{}));if(g&&g.indexOf('bullet')>-1&&F.invisibleMsrs){G=F.invisibleMsrs.filter(function(L){return L.getSemantics()==='actual'&&L.getSemanticallyRelatedMeasures();});}if(jQuery.isEmptyObject(F.dims)){k=new d('error','Semantic Pattern',"Semantic Pattern doesn't work when there is no dimension.");I=I||true;}else if(F.dims.color&&F.dims.color.length>0){k=new d('error','Semantic Pattern',"Semantic pattern doesn't work when there is series dimension.");I=I||true;}var H;H=M.getTuples(b,G,I);if(g&&(g.indexOf('stacked_column')>-1||g.indexOf('stacked_bar')>-1)){var J=false;if(n&&p){if(!o){k=new d('error','Semantic Pattern',"The value of projectedValueStartTime is invalid.");k.display();J=true;}for(var l=0;l<H.length;l++){if(H[l].hasOwnProperty('actual')){if(!(H[l].hasOwnProperty('projected'))){J=true;break;}if(H[l].hasOwnProperty('reference')){J=true;break;}}else{J=true;break;}}}else{var K='';if(H[0].hasOwnProperty('actual')){K='actual';}else if(H[0].hasOwnProperty('projected')){K='projected';}else if(H[0].hasOwnProperty('reference')){K='reference';}if(K==='projected'||K==='reference'){for(var l=0;l<H.length;l++){if(!(H[l].hasOwnProperty(K))){J=true;break;}}}else{for(var l=0;l<H.length;l++){if(H[l].hasOwnProperty('projected')||H[l].hasOwnProperty('reference')){J=true;break;}}}}if(g.indexOf('dual')>-1&&v.length<=1){J=false;}if(J){k=new d('error','Semantic Pattern',"Actual, forecast or target can't be stacked in one bar or column.");I=true;H=M.getTuples(b,G,I);}}H.forEach(function(L){L.valueAxisID=a;});if(w&&I&&k){k.display();}A=A.concat(H);});if(g&&g.indexOf('bullet')>-1){n=n&&A.some(function(y){return y.actual&&y.projected;});j=A.some(function(y){return(y.actual&&y.projected)||(y.actual&&y.reference)||(y.projected&&y.reference);});if(j&&(!n)){s(A,m,F.msrs);}else{f(A,F.msrs);}}if((!I)&&n){k=null;var S=[];var x=function(a){var b=S.indexOf(a.getName())===-1;if(!b){h.push(a);}return b;};for(var i=0;i<A.length;i++){var y=A[i];if(p){if(o){var z=F.msrs[y.valueAxisID];if(y.actual&&y.projected){y.timeAxis=F.dims.timeAxis[0].getName();y.projectedValueStartTime=o;y.semanticMsrName=y.actual+"-"+y.projected;S.push(y.actual);S.push(y.projected);z.push(m[y.actual].clone().setName(y.semanticMsrName));if(A.length===1&&g.indexOf('combination')>-1){k=new d('error','Semantic Pattern',"Do not satisfy the minimum number of measure to work "+"with Projected Value Start Time in Time Series Combination.");}}F.msrs[y.valueAxisID]=z.filter(x);}else{k=new d('error','Semantic Pattern',"The value of projectedValueStartTime is invalid.");}}}if(k){k.display();}}if((A.length>0)&&(!I)){var B=[];var E=['actual','projected','semanticMsrName','reference'];A.forEach(function(a){for(var i=0;i<E.length;i++){if(a[E[i]]){B.push(a[E[i]]);}}});jQuery.each(F.msrs,function(l){F.msrs[l].sort(function(a,b){return B.indexOf(a.getName())-B.indexOf(b.getName());});});}return{semanticTuples:A,contexts:h};}};return R;});

/*
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2018 SAP SE. All rights reserved
 */
sap.ui.define(['sap/chart/data/Dimension','sap/chart/data/TimeDimension','sap/chart/data/HierarchyDimension','sap/chart/data/Measure','sap/chart/TimeUnitType'],function(D,T,H,M,a){"use strict";function g(i,B){var p=B.path;var n=(B.parameters||{}).entitySet;if(!n){n=p.split("/")[1];if(n.indexOf("(")!=-1){n=n.split("(")[0]+(i?"Results":"Set");}}return n;}function _(r,s,t){return"{/#"+r+"/"+s+"/@sap:"+t+"}";}var b={"com.sap.vocabularies.Common.v1.IsCalendarDate":"yearmonthday","com.sap.vocabularies.Common.v1.IsCalendarYearQuarter":"yearquarter","com.sap.vocabularies.Common.v1.IsCalendarYearMonth":"yearmonth","com.sap.vocabularies.Common.v1.IsCalendarYearWeek":"yearweek","com.sap.vocabularies.Common.v1.IsFiscalYear":"fiscalyear","com.sap.vocabularies.Common.v1.IsFiscalYearPeriod":"fiscalyearperiod"};function d(p,C){var h=D;if(p.type==="Edm.DateTime"&&p['sap:display-format']==="Date"){h=T;C.timeUnit=a.Date;}else if(p['sap:hierarchy-node-for']){h=H;}else if(p.type==="Edm.String"){var t=Object.keys(b);for(var i=0;i<t.length;i++){var j=t[i];if(p[j]&&p[j].Bool){var k=b[j];if(a[k]){h=T;C.timeUnit=k;}break;}}}return h;}var c={getEntitySet:g.bind(null,true),deriveColumns:function(m,B){var r=m.getAnalyticalExtensions().findQueryResultByName(c.getEntitySet(B));if(!r){throw new Error("value of the \"isAnalytical\" property does not match the Data Service in use");}var R=r.getEntityType().getQName();R=R.slice(R.lastIndexOf(".")+1);var s=r.getEntityType().getSchema().namespace;var h=c.makeDimension.bind(this,R,s,r);var i=c.makeMeasure.bind(this,R);var j=r.getEntityType().getAllHierarchyPropertyNames().map(function(l){return r.findDimensionByPropertyName(l).getHierarchy().getNodeIDProperty().name;});var k=r.getAllDimensionNames().concat(j);return{dimensions:jQuery.map(k,h),measures:jQuery.map(r.getAllMeasures(),i)};},makeDimension:function(r,R,o,s){var C={name:s,label:_(r,s,"label"),textProperty:_(r,s,"text")};var A=c.ANNOTATION_ACCESS_TEMPLATE.replace(/%SCHEMANS/,R).replace(/%RESULTTYPE/,r).replace(/%DIMENSION/,s);var u=o.getModel().getODataModel().getMetaModel().getProperty(A);var h=d(u,C);return new h(C);},makeMeasure:function(r,m){return new M({name:m.getName(),label:_(r,m.getName(),"label")});},updateModel:function(C){function h(r,s,t,u){var l=[];var v={name:r.getName(),grouped:false,inResult:!!t,visible:!u};if(s!=null){v.level=s;}l.push(v);var w=r.getTextProperty();if(r.getDisplayText()&&w){v={name:w,grouped:false,inResult:!!t,visible:!u};l.push(v);}return l;}function i(r,k){var u=r.getUnitBinding(),l=[{name:r.getName(),total:false,inResult:false,visible:true}];if(u&&k.indexOf(u)===-1){l.push({name:u,inResult:false,visible:true});}return l;}var B=C.getBinding("data");if(!B){return;}var j=C._getVisibleDimensions(true);var m=C._getVisibleMeasures(true);var I=C._normalizeDorM(C.getInResultDimensions(),true);var o=C._getDrillStateTop().hierarchylevel;var k=j.map(function(r){return r.getName();}).concat(I.map(function(r){return r.getName();})).concat(m.map(function(r){return r.getName();}));var l=j.reduce(function(l,r){return l.concat(h(r,o[r.getName()]));},[]).concat(I.reduce(function(l,r){var s=r instanceof H?r.getLevel():null;return l.concat(h(r,s,true,true));},[])).concat(m.reduce(function(l,r){return l.concat(i(r,k));},[]));var n=C._getCandidateColoringSetting();var p=n.additionalMeasures||[];var q=n.additionalDimensions||[];if(p.length){l=l.concat(C._normalizeDorM(p).reduce(function(r,s){return r.concat(i(s));},[]));}if(q.length){l=l.concat(C._normalizeDorM(q,true).reduce(function(r,s){return r.concat(h(s,o[s.getName()]));},[]));}B.updateAnalyticalInfo(l);},ANNOTATION_ACCESS_TEMPLATE:"/dataServices/schema/[${"+"namespace"+"}==='%SCHEMANS']/entityType/[${"+"name"+"}==='%RESULTTYPE']/property/[${"+"name"+"}==='%DIMENSION']/"};var e={getEntitySet:g.bind(null,false),deriveColumns:function(m,B){var o=m.getMetaModel(),C={dimensions:[],measures:[]};if(o){var q=o.getODataEntitySet(e.getEntitySet(B)).entityType;var E=o.getODataEntityType(q);jQuery.each(E.property,function(i,p){var h=e.CLAZZ[p.type];if(!h){throw new Error("Unsupported type: "+p.type);}var j={name:p.name};if(p.hasOwnProperty("com.sap.vocabularies.Common.v1.Label")){j.label=p["com.sap.vocabularies.Common.v1.Label"].String;}if(h===M){C.measures.push(new h(j));}else{if(p.hasOwnProperty("com.sap.vocabularies.Common.v1.Text")){j.textProperty=p["com.sap.vocabularies.Common.v1.Text"].Path;}h=d(p,j);C.dimensions.push(new h(j));}});}return C;},CLAZZ:{"Null":D,"Edm.Binary":D,"Edm.Boolean":D,"Edm.Byte":M,"Edm.DateTime":D,"Edm.Decimal":M,"Edm.Double":M,"Edm.Single":M,"Edm.Guid":D,"Edm.Int16":M,"Edm.Int32":M,"Edm.Int64":M,"Edm.SByte":M,"Edm.String":D,"Edm.Time":D,"Edm.DateTimeOffset":D},updateModel:function(C,h,m){if(C.getModel()instanceof sap.ui.model.odata.ODataModel){var i=h.reduce(function(i,o){if(o.getTextProperty()){return i.concat(o.getName(),o.getTextProperty());}else{return i.concat(o.getName());}},[]);var j=m.reduce(function(j,o){if(o.getUnitBinding()){return j.concat(o.getName(),o.getUnitBinding());}else{return j.concat(o.getName());}},[]);C._oBindingInfo.parameters=C._oBindingInfo.parameters||{};C._oBindingInfo.parameters.entitySet=e.getEntitySet(C._oBindingInfo);C._oBindingInfo.parameters.select=i.concat(j).join(",");C.bindData(C._oBindingInfo);if(C._isEnablePaging()&&C._getPagingController().getPagingSorters()){C.getBinding("data").sort(C._getPagingController().getPagingSorters());}}else{return;}}};function f(m){return function(i){var h=i?c:e;return h[m];};}return{deriveColumns:f("deriveColumns"),updateModel:f("updateModel"),getEntitySet:f("getEntitySet")};});

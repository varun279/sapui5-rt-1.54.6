/*!
* SAP APF Analysis Path Framework
*
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
sap.ui.define(["sap/apf/modeler/ui/utils/representationHandler","sap/apf/ui/utils/constants","sap/apf/core/constants","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/sortDataHandler","sap/apf/modeler/ui/utils/representationBasicDataHandler","sap/apf/modeler/ui/utils/stepPropertyMetadataHandler","sap/apf/modeler/ui/utils/representationTypesHandler","sap/apf/modeler/ui/utils/viewValidator"],function(R,u,c,n,o,S,a,b,d,V){'use strict';var p,C,e,r,P,f,s,g,h,i;var l=c.representationMetadata.labelDisplayOptions;function _(K){K.byId("idVisualization").setText(C.getText("visualization"));K.byId("idChartTypeLabel").setText(C.getText("chartType"));K.byId("idChartTypeLabel").setTooltip(C.getText("chartType"));K.byId("idBasicData").setText(C.getText("basicData"));K.byId("idSorting").setText(C.getText("sorting"));K.byId("idChartType").setValueStateText(C.getText("modeler.ui.representation.invalidChartTypeError"));}function j(K,L){var M;var N=f.getPictureOfRepresentationType(r.getRepresentationType());var O=e.getCategoriesForStep(P.getId());if(O.length===1){M={id:r.getId(),icon:N};if(L){M.name=L;}K.getView().getViewData().updateSelectedNode(M);}else{K.getView().getViewData().updateTree();}}function k(K,L){var T=C.getText("representation")+": "+L;K.getView().getViewData().updateTitleAndBreadCrumb(T);}function m(K){r.setRepresentationType(K);var L="TableRepresentation";if(K===u.representationTypes.TABLE_REPRESENTATION||K===u.representationTypes.TREE_TABLE_REPRESENTATION){L=undefined;}r.setAlternateRepresentationType(L);}function q(K){var L;var M=jQuery.Deferred();s.getEntityTypeMetadataAsPromise().done(function(N){var O=s.getDimensionsProperties(N);var Q=f.getKindsForDimensionPropertyType(K);Q.forEach(function(T,U){L=false;var W;var X;var Y=O[U];if(r.getDimensions().length!==0){if(r.getDimensions()[U]){if(r.getDimensionKind(r.getDimensions()[U])){L=true;}}}if(!L&&Y){W=s.hasTextPropertyOfDimension(N,Y);X=W?l.KEY_AND_TEXT:l.KEY;r.addDimension(Y);r.setLabelDisplayOption(Y,X);r.setDimensionKind(Y,Q[0]);}});M.resolve();});return M.promise();}function t(K){var L;var M=s.oStep.getService();var N=s.oStep.getEntitySet();var O=s.oStep.getHierarchyProperty();e.getHierarchyNodeIdAsPromise(M,N,O).done(function(Q){L=s.hasTextPropertyOfDimension(K,Q);});return L;}function v(K){var L,M;var N=jQuery.Deferred();s.getEntityTypeMetadataAsPromise().done(function(O){var Q=s.getHierarchicalProperty();if(Q&&(r.getHierarchyPropertyLabelDisplayOption()===undefined)){L=t(O);M=L?l.TEXT:l.KEY;r.setHierarchyPropertyLabelDisplayOption(M);}N.resolve();});return N.promise();}function w(K){var L=jQuery.Deferred(),M,N;var O;s.getEntityTypeMetadataAsPromise().done(function(Q){O=f.getKindsForMeasurePropertyType(K);M=s.getMeasures(Q);O.forEach(function(T,U){N=false;var W=M[U];if(r.getMeasures().length!==0){if(r.getMeasures()[U]){if(r.getMeasureKind(r.getMeasures()[U])){N=true;}}}if(!N&&W){r.addMeasure(W);r.setMeasureKind(W,T);}});L.resolve();});return L.promise();}function x(K){var L=jQuery.Deferred();var M,N;if(K==="TableRepresentation"){if(r.getProperties().length===0){N=f.getKindsForPropertyType(K);M=s.getProperties()[0];r.addProperty(M);r.setPropertyKind(M,N[0]);L.resolve();}else{L.resolve();}}else if(K==="TreeTableRepresentation"){v(K).done(function(){L.resolve();});}else{q(K).done(function(){w(K).done(function(){L.resolve();});});}return L.promise();}function y(){if(p&&p.arguments&&p.arguments.stepId){P=e.getStep(p.arguments.stepId);}}function z(){var K=C.getRepresentationTypes()[0].id;if(P.getType()==="hierarchicalStep"){K="TreeTableRepresentation";}return K;}function A(K){var L;var M=jQuery.Deferred();if(p&&p.arguments&&p.arguments.representationId){r=P.getRepresentation(p.arguments.representationId);}if(!n.checkIsNotUndefined(r)){r=P.createRepresentation();L=z();m(L);j(K,C.getText(L));e.setIsUnsaved();x(L).done(function(){return M.resolve();});}else{L=r.getRepresentationType();I().done(function(){x(L).done(function(){return M.resolve();});});}return M.promise();}function B(K){var L=new sap.m.Button({id:K.createId("idPreviewButton"),text:C.getText("preview"),press:K.handlePreviewButtonPress.bind(K)});var M=K.getView().getViewData().oFooter;M.addContentRight(L);}function D(K){var T=K.getView().getViewData().oConfigurationHandler.getTextPool();var L={oTextReader:C.getText,oConfigurationEditor:e,oTextPool:T,oParentObject:r,oParentStep:P,oRepresentationTypeHandler:f};var M=new sap.ui.controller("sap.apf.modeler.ui.controller.representationCornerTexts");var N=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.cornerTexts",type:sap.ui.core.mvc.ViewType.XML,id:K.createId("representationCornerTexts"),viewData:L,controller:M});K.byId("idCornerTextsVBox").insertItem(N);K.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON,N.getController().setChartIcon.bind(N.getController()));}function E(){r.getDimensions().forEach(function(K){r.removeDimension(K);});r.getMeasures().forEach(function(M){r.removeMeasure(M);});}function F(){var K,M;if(r.getRepresentationType()==="TableRepresentation"){K=r.getDimensions();M=r.getMeasures();K.forEach(function(L){r.addProperty(L);r.setPropertyTextLabelKey(L,r.getDimensionTextLabelKey(L));r.setPropertyKind(L,c.representationMetadata.kind.COLUMN);e.setIsUnsaved();});M.forEach(function(L){r.addProperty(L);r.setPropertyTextLabelKey(L,r.getMeasureTextLabelKey(L));r.setPropertyKind(L,c.representationMetadata.kind.COLUMN);e.setIsUnsaved();});E();}}function G(K){var L;s.getEntityTypeMetadataAsPromise().done(function(M){L=s.hasTextPropertyOfDimension(M,K);if(L){r.setLabelDisplayOption(K,l.KEY_AND_TEXT);}else{r.setLabelDisplayOption(K,l.KEY);}e.setIsUnsaved();});}function H(){var K=jQuery.Deferred();s.getEntityTypeMetadataAsPromise().done(function(L){r.getDimensions().forEach(function(M){if(r.getLabelDisplayOption(M)===undefined){G(M);}});K.resolve();});return K.promise();}function I(){F();return H();}function J(K){i.instantiateRepresentationSortData();D(K);return h.instantiateBasicDataAsPromise();}sap.ui.controller("sap.apf.modeler.ui.controller.representation",{onInit:function(){var K=this;var L=K.getView().getViewData();C=L.oCoreApi;p=L.oParams;e=L.oConfigurationEditor;f=new d(C.getRepresentationTypes());this.oViewValidator=new V(this.getView());_(K);y();if(P.getType()!=="hierarchicalStep"){B(K);}s=new sap.apf.modeler.ui.utils.StepPropertyMetadataHandler(C,P);A(K).done(function(){g=new R(r,f,C.getText);h=new a(K.getView(),s,g,K.oViewValidator);i=new S(K.getView(),r,s,C.getText);J(K).then(function(){K.setDetailData();});});},setDetailData:function(){var K=this;K._setChartType();},handleChangeForChartType:function(K){var L=this;var N=K.getParameter("selectedItem").getKey();var M=C.getText(N);var O=r.getRepresentationType();m(N);j(L,M);k(L,M);if(!f.isChartTypeSimilar(O,N)){L.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.REMOVEALLPROPERTIESFROMPARENTOBJECT);E();x(N).done(function(){h.instantiateBasicDataAsPromise();L.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON);e.setIsUnsaved();});}else{h.instantiateBasicDataAsPromise();L.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON);e.setIsUnsaved();}if(!L.getValidationState()){if(L.byId("idChartType").getValueState("None")){L.byId("idChartType").setValueState("Error");}}else{L.byId("idChartType").setValueState("None");}},handlePreviewButtonPress:function(){var K=this;var L={oParentStep:P,oRepresentation:r,oConfigurationHandler:K.getView().getViewData().oConfigurationHandler,oCoreApi:C,oRepresentationHandler:g,oStepPropertyMetadataHandler:s,oRepresentationTypeHandler:f};sap.ui.view({id:K.createId("idPreviewContentView"),viewName:"sap.apf.modeler.ui.view.previewContent",type:sap.ui.core.mvc.ViewType.XML,viewData:L});},onExit:function(){var K=this;K.getView().getViewData().oFooter.removeContentRight(K.byId("idPreviewButton"));h.destroyBasicData();i.destroySortData();K.byId("idCornerTextsVBox").destroyItems();},getValidationState:function(){return this.oViewValidator.getValidationState();},_setChartType:function(){var K=this;s.getEntityTypeMetadataAsPromise().done(function(L){var M;var N=s.getDimensionsProperties(L);var O=s.getMeasures(L);var Q=K._getAnnotatedChartTypes(f.aRepresentationTypes,s.getRepresentationTypesArray(),N,O,C);M=o.prepareModel(Q);K.byId("idChartType").setModel(M);K.byId("idChartType").setSelectedKey(r.getRepresentationType());if(!K.getValidationState()){K.byId("idChartType").setValueState("Error");}else{K.byId("idChartType").setValueState("None");}});},_getAnnotatedChartTypes:function(K,L,M,N,C){function O(T,U){var W;T.forEach(function(X){if(X["id"]===U){W=X;}});return W;}var Q=jQuery.extend(true,[],L);Q.forEach(function(T){var U=0,W=0;var X=O(K,T.key);if(X.metadata&&X.id!=="TableRepresentation"&&X.id!=="TreeTableRepresentation"){X.metadata.dimensions.supportedKinds.forEach(function(Y){U+=parseInt(Y.min,10);});X.metadata.measures.supportedKinds.forEach(function(Y){W+=parseInt(Y.min,10);});if(M.length<U||N.length<W){T.name=C.getText("modeler.ui.representation.invalidChartTypes",[T.name]);}}});return Q;}});});

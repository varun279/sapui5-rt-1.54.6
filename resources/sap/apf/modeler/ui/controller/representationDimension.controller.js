/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/core/constants","sap/apf/modeler/ui/controller/propertyType","sap/apf/modeler/ui/utils/displayOptionsValueBuilder","sap/apf/modeler/ui/utils/textManipulator"],function(c,B,D,t){"use strict";c=c||sap.apf.core.constants;D=D||sap.apf.modeler.ui.utils.DisplayOptionsValueBuilder;var r=c.representationMetadata;return B.extend("sap.apf.modeler.ui.controller.representationDimension",{setLabelDisplayOptionTypeAsPromise:function(o){var d=jQuery.Deferred();var a,l,m,p,L,C=this,b=[];a=new D(C.oTextReader,o);l=c.representationMetadata.labelDisplayOptions;p=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));L=C.oRepresentation.getLabelDisplayOption(p);m=a.getLabelDisplayOptions();C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().done(function(e){if((L===l.KEY_AND_TEXT||L===l.TEXT)&&!C.oStepPropertyMetadataHandler.hasTextPropertyOfDimension(e,p)){m=a.getValidatedLabelDisplayOptions();b=t.addPrefixText([L],C.oTextReader);L=b[0];}C.byId("idLabelDisplayOptionType").setModel(m);C.byId("idLabelDisplayOptionType").setSelectedKey(L);d.resolve();});return d.promise();},getAllPropertiesAsPromise:function(){var C=this,a,s,p,A,d=[];var S=C.oStepPropertyMetadataHandler.oStep;var o=sap.apf.modeler.ui.utils.CONSTANTS;var b=jQuery.Deferred();C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().done(function(e){S.getConsumablePropertiesForRepresentation(C.oRepresentation.getId()).done(function(R){a=R.consumable;a.forEach(function(P){if(C.oStepPropertyMetadataHandler.getPropertyMetadata(e,P)){A=C.oStepPropertyMetadataHandler.getPropertyMetadata(e,P)["aggregation-role"];if(A===o.aggregationRoles.DIMENSION){d.push(P);}}});s=C.getSelectedProperty();if(s!==undefined){p=d.indexOf(s)!==-1?d:d.concat(s);d=R.available.indexOf(s)!==-1?p:d.concat(t.addPrefixText([s],C.oTextReader));s=R.available.indexOf(s)!==-1?s:t.addPrefixText([s],C.oTextReader)[0];}b.resolve({aAllProperties:d,sSelectedKey:s});});});return b.promise();},getPropertyTextLabelKey:function(p){var C=this;return C.oRepresentation.getDimensionTextLabelKey(p);},removeProperties:function(){var C=this;C.getView().getViewData().oRepresentationHandler.getActualDimensions().forEach(function(p){C.oRepresentation.removeDimension(p.sProperty);});},updateProperties:function(p){var C=this;C.removeProperties();p.forEach(function(P){C.oRepresentation.addDimension(P.sProperty);C.oRepresentation.setDimensionKind(P.sProperty,P.sKind);C.oRepresentation.setLabelDisplayOption(P.sProperty,P.sLabelDisplayOption);C.oRepresentation.setDimensionTextLabelKey(P.sProperty,P.sTextLabelKey);});},createNewPropertyInfoAsPromise:function(n){var d=jQuery.Deferred();var C=this,N={};C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().done(function(e){var i=C.oStepPropertyMetadataHandler.hasTextPropertyOfDimension(e,n);N.sProperty=n;N.sKind=C.getView().getViewData().oPropertyTypeData.sContext;N.sLabelDisplayOption=i?r.labelDisplayOptions.KEY_AND_TEXT:r.labelDisplayOptions.KEY;N.sTextLabelKey=undefined;d.resolve(N);});return d.promise();},createCurrentProperiesInfo:function(d){var C={},o=this;C.sProperty=d;C.sKind=o.oRepresentation.getDimensionKind(d);C.sLabelDisplayOption=o.oRepresentation.getLabelDisplayOption(d);C.sTextLabelKey=o.oRepresentation.getDimensionTextLabelKey(d);return C;},setPropertyTextLabelKey:function(p,l){var C=this;C.oRepresentation.setDimensionTextLabelKey(p,l);},setNextPropertyInParentObject:function(){var C=this;var p=C.getView().getViewData().oPropertyTypeData.sProperty;C.updatePropertyTypeAsPromise(p).done(function(){C.setDetailData();});},enableDisableLabelDisplayOptionTypeAsPromise:function(){var i,C=this;var d=jQuery.Deferred();var a=C.byId("idLabelDisplayOptionType");var p=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().done(function(e){var I=C.oStepPropertyMetadataHandler.hasTextPropertyOfDimension(e,p);for(i=0;i<a.getItems().length;i++){a.getItems()[i].setEnabled(true);if(i>0&&!I){a.getItems()[i].setEnabled(false);}}d.resolve();});return d.promise();},changeLabelDisplayOption:function(l){var C=this;var p=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));C.oRepresentation.setLabelDisplayOption(p,l);},removePropertyFromParentObject:function(){var C=this;C.oRepresentation.removeDimension(t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE)));},addPropertyAsPromise:function(){var d=jQuery.Deferred();var C=this,a,b=[];var s=C.oStepPropertyMetadataHandler.oStep;var o=sap.apf.modeler.ui.utils.CONSTANTS;C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().done(function(e){s.getConsumablePropertiesForRepresentation(C.oRepresentation.getId()).done(function(R){R.consumable.forEach(function(p){if(C.oStepPropertyMetadataHandler.getPropertyMetadata(e,p)){a=C.oStepPropertyMetadataHandler.getPropertyMetadata(e,p)["aggregation-role"];if(a===o.aggregationRoles.DIMENSION){b.push(p);}}});C.getView().fireEvent(o.events.ADDPROPERTY,{"sProperty":b[0],"sContext":C.getView().getViewData().oPropertyTypeData.sContext});C.oConfigurationEditor.setIsUnsaved();d.resolve();});});return d.promise();}});});

/*!
* SAP APF Analysis Path Framework
* 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
*/
(function(){"use strict";var c,u,a,r=false;function _(){var R=a.getSelectedRepresentation();if(R.type===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){return true;}return false;}function b(){var R=a.getSelectedRepresentation();if(R.type===sap.apf.ui.utils.CONSTANTS.representationTypes.TREE_TABLE_REPRESENTATION){return true;}return false;}function d(){if(a.getSelectedRepresentation().bIsAlternateView===undefined||a.getSelectedRepresentation().bIsAlternateView===false){return false;}return true;}function e(C){var R=C.getCurrentRepresentation();var i=R.getParameter().requiredFilters;if(i===undefined||i.length===0){return undefined;}return i[0];}function f(C,i){var j=C.byId("idChartContainer");var z="0";var A=jQuery(window).width();var B=j.getId();if(jQuery("#"+B).length!==0){z=jQuery("#"+B+" > div:first-child > div:nth-child(2)").offset().top;A=jQuery("#"+B+" > div:first-child > div:nth-child(2)").width();}var D=(jQuery(window).height()-z)-jQuery(".applicationFooter").height();var E=A;i.setHeight(D+"px");i.setWidth(E+"px");}function g(C){var i=C.byId("idChartContainer");var R=C.getCurrentRepresentation();var T=a.longTitle&&!c.isInitialTextKey(a.longTitle.key)?a.longTitle:a.title;var S=c.getTextNotHtmlEncoded(T);var j=R.getMainContent(S);var z={onBeforeRendering:function(){f(C,j);}};j.addEventDelegate(z);i.removeAllContent();var A=new sap.suite.ui.commons.ChartContainerContent({content:j});i.addContent(A);}function h(C,i){var S=C.byId("idSelectedText");var j=C.getCurrentRepresentation();var z=w(C);var A=j.getSelectionFilterLabel();var B=A+" ("+z+") ";var D=C.byId("idSelPropertyAndCount");if(!D){D=new sap.m.Link({id:C.createId("idSelPropertyAndCount"),press:C.handlePressSelectedPropertyCountLink.bind(C)});D.addAriaLabelledBy(S.getId());}else{if(D&&(j.chart!==undefined)&&(j.chart!==null)){j.chart.detachEvent("setFocusOnSelectedLinkEvent",j.chart.setFocusOnSelectLink);}}if(D&&(j.chart!==undefined)&&(j.chart!==null)){j.chart.setFocusOnSelectLink=function(){D.focus();};}D.setVisible(true);D.setText(B);i.addContent(D);i.onAfterRendering=function(){if(D&&(j.chart!==undefined)&&(j.chart!==null)){j.chart.fireEvent("setFocusOnSelectedLinkEvent");j.chart.detachEvent("setFocusOnSelectedLinkEvent",j.chart.setFocusOnSelectLink);}};}function k(C){var i=C.byId("idChartContainer");i.removeAllCustomIcons();l(C);m(C);n(C);}function l(C){var j=C.byId("idChartContainer");var z=a.getSelectedRepresentationInfo();var A;if(z.parameter&&z.parameter.orderby){new sap.apf.ui.utils.Helper(c).getRepresentationSortInfo(z).done(function(E){var S=[];for(var i=0;i<E.length;i++){E[i].done(function(F){S.push(F);});}A=S.join(", ");var B=c.getTextNotHtmlEncoded(z.label)+"\n"+((A!==undefined)?c.getTextNotHtmlEncoded("sortBy")+": "+A:"");var D=new sap.ui.core.Icon({src:z.picture,tooltip:B,press:function(F){C.handlePressChartIcon(F);}});j.addCustomIcon(D);});}else{var B=c.getTextNotHtmlEncoded(z.label)+"\n"+((A!==undefined)?c.getTextNotHtmlEncoded("sortBy")+": "+A:"");var D=new sap.ui.core.Icon({src:z.picture,tooltip:B,press:function(E){C.handlePressChartIcon(E);}});j.addCustomIcon(D);}}function m(C){if(_()||b()){return;}var i=C.byId("idChartContainer");var j=c.getTextNotHtmlEncoded("listView");var z=new sap.ui.core.Icon({src:"sap-icon://table-view",tooltip:j,press:C.handlePressAlternateRepIcon.bind(C)});i.addCustomIcon(z);}function n(C){if((C.getCurrentRepresentation().topN!==undefined)||(!d()&&!_())||(b())){return;}var i=C.byId("idChartContainer");var j=c.getTextNotHtmlEncoded("view-Settings-Button");var z=new sap.ui.core.Icon({src:"sap-icon://drop-down-list",tooltip:j,press:function(){C.getCurrentRepresentation().getViewSettingDialog().open();}});i.addCustomIcon(z);}function o(C,i){var S=C.byId("idSelectedText");if(!S){S=new sap.m.Label({id:C.createId("idSelectedText"),text:c.getTextNotHtmlEncoded("selectedValue")});}S.setVisible(true);i.addContent(S);}function p(C,i){var R=C.byId("idReset");if(!R){R=new sap.m.Button({text:c.getTextNotHtmlEncoded("reset"),id:C.createId("idReset"),type:"Transparent",press:C.handlePressResetButton.bind(C)}).addStyleClass("chartContainerResetStyle");}R.setVisible(true);i.addContent(R);}function q(C,i){var j=w(C);if(j>0&&e(C)!==undefined){o(C,i);h(C,i);p(C,i);}}function s(C,i){var P=C.byId("idPathFilterDisplayButton");if(!P){P=new sap.m.Button({text:c.getTextNotHtmlEncoded("pathFilterDisplayButton"),id:C.createId("idPathFilterDisplayButton"),icon:"sap-icon://message-information",type:"Transparent",press:function(){if(C.byId("idStepLayout").getBusy()===false){c.getPathFilterInformation().done(function(j){var z=new sap.ui.xmlview({viewName:"sap.apf.ui.reuse.view.pathFilterDisplay",viewData:{pathFilterInformation:j,oCoreApi:c,oUiApi:u},id:C.createId("pathFilterDisplay")});z.setParent(C.getView());z.getContent()[0].open();});}}});}i.addContent(P);}function t(C){var i=C.byId("idChartContainer");var j=i.getToolbar();if(j){j.removeAllContent();}else{j=new sap.m.OverflowToolbar();}var z=new sap.m.Label({text:c.getTextNotHtmlEncoded("currentStep")});j.addContent(z);var S=new sap.m.ToolbarSpacer();j.addContent(S);q(C,j);s(C,j);j.addContent(new sap.suite.ui.commons.ChartContainerToolbarPlaceholder());i.setToolbar(j);}function v(C){if(a===undefined){return;}g(C);k(C);t(C);}function w(C){var i=C.getCurrentRepresentation();var j=i.getSelections().length;return j;}function x(C,z){var A=new sap.m.List({mode:sap.m.ListMode.SingleSelectMaster,showSeparators:sap.m.ListSeparators.None,includeItemInSelection:true,selectionChange:C.handleSelectionChartSwitchIcon.bind(C)});var B;var R;for(var j=0;j<a.getRepresentationInfo().length;j++){R=a.getRepresentationInfo()[j];B=undefined;if(R.parameter&&R.parameter.orderby){new sap.apf.ui.utils.Helper(c).getRepresentationSortInfo(R).done(function(E){var F=[];for(var i=0;i<E.length;i++){E[i].done(function(G){F.push(G);});}B=F.join(", ");var D=B!==undefined?c.getTextNotHtmlEncoded("sortBy")+": "+B:"";var I=new sap.m.StandardListItem({description:D,icon:R.picture,title:c.getTextNotHtmlEncoded(R.label),customData:[new sap.ui.core.CustomData({key:'data',value:{oRepresentationType:R,icon:R.picture}})]});A.addItem(I);});}else{var D=B!==undefined?c.getTextNotHtmlEncoded("sortBy")+": "+B:"";var I=new sap.m.StandardListItem({description:D,icon:R.picture,title:c.getTextNotHtmlEncoded(R.label),customData:[new sap.ui.core.CustomData({key:'data',value:{oRepresentationType:R,icon:R.picture}})]});A.addItem(I);}}if(!C.byId("idAllChartPopover")){var S=new sap.m.Popover({id:C.createId("idAllChartPopover"),placement:sap.m.PlacementType.Bottom,showHeader:false,content:[A],afterClose:function(){S.destroy();}});}C.byId("idAllChartPopover").openBy(z);}function y(C,i){C.byId("idReset").setVisible(i);C.byId("idSelPropertyAndCount").setVisible(i);C.byId("idSelectedText").setVisible(i);}sap.ui.controller("sap.apf.ui.reuse.controller.stepContainer",{onInit:function(){var C=this;c=C.getView().getViewData().oCoreApi;u=C.getView().getViewData().uiApi;a=c.getActiveStep();this.initialText=new sap.m.Label({id:this.createId("idInitialText")}).addStyleClass('initialText');this.initialText.setText(c.getTextNotHtmlEncoded('initialText'));},onAfterRendering:function(){var C=this;jQuery(window).resize(function(){var i=90;c.getSmartFilterBarConfigurationAsPromise().done(function(j){if(j){i=165;}var z=jQuery(window).height()-i;jQuery('.layoutView').css({"height":z});C.drawStepContent();});});jQuery(u.getStepContainer().getDomRef()).hide();if(jQuery("#"+this.initialText.getId()).length===0&&c.getSteps().length===0){jQuery('#'+u.getStepContainer().getId()).parent().append(sap.ui.getCore().getRenderManager().getHTML(this.initialText));}else if(c.getSteps().length>0){jQuery(u.getStepContainer().getDomRef()).show();}if(u.getAnalysisPath().getController().isOpenPath){jQuery(".initialText").remove();}},getCurrentRepresentation:function(){var i=a.getSelectedRepresentation();if(d()){i=a.getSelectedRepresentation().toggleInstance;}return i;},handlePressSelectedPropertyCountLink:function(){var C=this;C.oCoreApi=c;var i=new sap.ui.jsfragment("idSelectionDisplayFragment","sap.apf.ui.reuse.fragment.selectionDisplay",C);i.open();},handlePressResetButton:function(){var C=this;if(d()){C.getCurrentRepresentation().removeAllSelection();}C.getCurrentRepresentation().removeAllSelection();y(C,false);},createToggleRepresentationInstance:function(R,j){var z={};function A(E){var F=E.dimensions;var D=R.getMetaData();E.isAlternateRepresentation=true;if(D===undefined){return E;}var i,G;for(i=0;i<F.length;i++){var S=D.getPropertyMetadata(F[i].fieldName).hasOwnProperty('text');if(S&&F[i].labelDisplayOption===sap.apf.core.constants.representationMetadata.labelDisplayOptions.KEY_AND_TEXT){G={};G.fieldName=D.getPropertyMetadata(F[i].fieldName).text;E.dimensions.splice(i+1,0,G);}else if(S&&F[i].labelDisplayOption===sap.apf.core.constants.representationMetadata.labelDisplayOptions.TEXT){G={};G.fieldName=D.getPropertyMetadata(F[i].fieldName).text;E.dimensions.splice(i,1,G);}}return E;}var B=jQuery.extend(true,{},R.getParameter());delete B.alternateRepresentationTypeId;delete B.alternateRepresentationType;B=A(B);if(j){B.orderby=j;}z=c.createRepresentation(R.getParameter().alternateRepresentationType.constructor,B);var C=R.getData(),D=R.getMetaData();if(C!==undefined&&D!==undefined){z.setData(C,D);}return z;},handlePressAlternateRepIcon:function(){var C=this;var i=a.getSelectedRepresentation();i.bIsAlternateView=true;if(d()){i.toggleInstance=C.createToggleRepresentationInstance(i);}r=true;C.getView().getViewData().uiApi.selectionChanged(true);},handlePressChartIcon:function(E){var C=this;var i=a.getSelectedRepresentation();var j=c.getSteps().indexOf(a);if(a.getRepresentationInfo().length>1){var z=E.getParameter("controlReference");x(C,z);}else{i.bIsAlternateView=false;r=true;u.getAnalysisPath().getCarousel().getStepView(j).getController().drawThumbnailContent(true);C.drawStepContent();}},handleSelectionChartSwitchIcon:function(E){var C=this;C.byId("idAllChartPopover").close();var S=E.getParameter("listItem").getCustomData()[0].getValue();var i=c.getSteps().indexOf(a);var j=a.getSelectedRepresentationInfo().representationId;var z=S.oRepresentationType.representationId;if(j===z&&a.getSelectedRepresentation().bIsAlternateView===false){return;}r=true;a.getSelectedRepresentation().bIsAlternateView=false;a.setSelectedRepresentation(S.oRepresentationType.representationId);u.getAnalysisPath().getController().refresh(S.nActiveStepIndex);c.updatePath(u.getAnalysisPath().getController().callBackForUpdatePath.bind(u.getAnalysisPath().getController()));u.getAnalysisPath().getCarousel().getStepView(i).getController().drawThumbnailContent(true);},drawStepContent:function(S){var C=this,i=false;var P=a;a=c.getActiveStep();if(P!==a){i=true;}var j=c.getSteps().indexOf(a);var z=u.getAnalysisPath().getCarousel().getStepView(j);if(z===undefined){return;}var T=z.oThumbnailChartLayout.isBusy();if(T){C.byId("idStepLayout").setBusy(true);}if(S||r||i){v(C);}else{t(C);}r=false;C.byId("idStepLayout").setBusy(false);}});}());

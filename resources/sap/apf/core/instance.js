/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.instance");jQuery.sap.require('sap.apf.utils.utils');jQuery.sap.require("sap.apf.core.utils.checkForTimeout");jQuery.sap.require("sap.apf.core.utils.uriGenerator");jQuery.sap.require("sap.apf.core.metadata");jQuery.sap.require("sap.apf.core.metadataFacade");jQuery.sap.require("sap.apf.core.metadataProperty");jQuery.sap.require("sap.apf.core.ajax");jQuery.sap.require("sap.apf.core.odataRequest");jQuery.sap.require("sap.apf.core.messageHandler");jQuery.sap.require("sap.apf.core.entityTypeMetadata");jQuery.sap.require("sap.apf.core.metadataFactory");jQuery.sap.require("sap.apf.core.textResourceHandler");jQuery.sap.require("sap.apf.core.configurationFactory");jQuery.sap.require("sap.apf.core.path");jQuery.sap.require("sap.apf.core.sessionHandler");jQuery.sap.require("sap.apf.core.resourcePathHandler");jQuery.sap.require("sap.apf.core.persistence");jQuery.sap.require("sap.apf.cloudFoundry.analysisPathProxy");jQuery.sap.require("sap.apf.cloudFoundry.ajaxHandler");jQuery.sap.require("sap.apf.core.readRequest");jQuery.sap.require("sap.apf.core.readRequestByRequiredFilter");jQuery.sap.require("sap.apf.core.utils.fileExists");jQuery.sap.require("sap.apf.core.utils.annotationHandler");jQuery.sap.require("sap.ui.comp.smartfilterbar.ControlConfiguration");jQuery.sap.require("sap.ui.thirdparty.datajs");(function(){'use strict';sap.apf.core.Instance=function(a){var t=this;var b;var c,A,o;var m=a.instances.messageHandler;var s=a.instances.startParameter;a.constructors=a.constructors||{};var d=(a.functions&&a.functions.checkForTimeout)||sap.apf.core.utils.checkForTimeout;var I={instances:{messageHandler:m,coreApi:this},constructors:{Request:a.constructors.Request},exits:{binding:{afterGetFilter:a.exits&&a.exits.binding&&a.exits.binding.afterGetFilter},path:{beforeAddingToCumulatedFilter:a.exits&&a.exits.path&&a.exits.path.beforeAddingToCumulatedFilter}},functions:a.functions};var r;var M;var T;var C;var p;var S;var P;var e;var f;var g;var h=a&&a.instances&&a.instances.datajs||OData;this.destroy=function(){p.destroy();};this.ajax=function(i){var q=jQuery.extend(true,{},i);q.functions=q.functions||{};q.functions.getSapSystem=s.getSapSystem;if(a.functions&&a.functions.ajax){q.functions.ajax=a.functions.ajax;}q.instances=q.instances||{};q.instances.messageHandler=m;return sap.apf.core.ajax(q);};this.odataRequest=function(R,i,E,B){var I={instances:{datajs:h},functions:{getSapSystem:s.getSapSystem}};var q=(a&&a.functions&&a.functions.odataRequest)||sap.apf.core.odataRequestWrapper;q(I,R,i,E,B);};this.getStartParameterFacade=function(){return s;};this.getMessageHandler=function(){return m;};this.putMessage=function(i){return m.putMessage(i);};this.check=function(E,i,q){return m.check(E,i,q);};this.createMessageObject=function(i){return m.createMessageObject(i);};this.activateOnErrorHandling=function(O){m.activateOnErrorHandling(O);};this.setCallbackForMessageHandling=function(i){m.setMessageCallback(i);};this.getLogMessages=function(){return m.getLogMessages();};this.checkForTimeout=function(i){var q=d(i);if(q){m.putMessage(q);}return q;};this.getUriGenerator=function(){return sap.apf.core.utils.uriGenerator;};this.getMetadata=function(i){return M.getMetadata(i);};this.getMetadataFacade=function(){return M.getMetadataFacade();};this.getEntityTypeMetadata=function(i,E){return M.getEntityTypeMetadata(i,E);};this.loadApplicationConfig=function(F){r.loadConfigFromFilePath(F);};this.loadTextElements=function(i){T.loadTextElements(i);};this.registerTextWithKey=function(i,q){T.registerTextWithKey(i,q);};this.getApplicationConfigProperties=function(){return r.getConfigurationProperties();};this.getResourceLocation=function(R){return r.getResourceLocation(R);};this.getPersistenceConfiguration=function(){return r.getPersistenceConfiguration();};this.getCategories=function(){return C.getCategories();};this.existsConfiguration=function(i){return C.existsConfiguration(i);};this.getStepTemplates=function(){return C.getStepTemplates();};this.getConfigurationObjectById=function(i){return C.getConfigurationById(i);};this.registerSmartFilterBarInstance=function(i){if(!g){g=jQuery.Deferred();}g.resolve(i);};this.getSmartFilterBarAsPromise=function(){if(!g){g=jQuery.Deferred();}this.getSmartFilterBarConfigurationAsPromise().done(function(i){if(!i){g.resolve(null);}});return g;};this.getSmartFilterBarConfigurationAsPromise=function(){return C.getSmartFilterBarConfiguration();};this.getSmartFilterBarPersistenceKey=function(i){return"APF"+C.getConfigHeader().AnalyticalConfiguration+i;};this.getSmartFilterbarDefaultFilterValues=function(){var i=jQuery.Deferred();var q=[];a.functions.getCombinedContext().done(function(v){v.getProperties().forEach(function(w){var x={key:w,visibleInAdvancedArea:true,defaultFilterValues:u(v,w)};q.push(new sap.ui.comp.smartfilterbar.ControlConfiguration(x));});i.resolve(q);});return i;function u(v,w){var x=v.getFilterTermsForProperty(w);var i=[];x.forEach(function(y){var z=new sap.ui.comp.smartfilterbar.SelectOption({low:y.getValue(),operator:y.getOp(),high:y.getHighValue(),sign:'I'});i.push(z);});return i;}};this.getReducedCombinedContext=function(){var i=jQuery.Deferred();a.functions.getCombinedContext().done(function(q){var u=t.getSmartFilterBarAsPromise();u.done(function(v){if(!v){i.resolve(q);return;}var w=new sap.apf.core.utils.Filter(a.instances.messageHandler);var x=v.getFilters();x.forEach(function(y){w.addAnd(sap.apf.core.utils.Filter.transformUI5FilterToInternal(a.instances.messageHandler,y));});i.resolve(q.removeTermsByProperty(w.getProperties()));});});return i;};this.getFacetFilterConfigurations=function(){return C.getFacetFilterConfigurations();};this.getNavigationTargets=function(){return C.getNavigationTargets();};this.createStep=function(i,q,R){var u;m.check(i!==undefined&&typeof i==="string"&&i.length!==0,"sStepID is  unknown or undefined");u=C.createStep(i,R);p.addStep(u,q);return u;};this.getSteps=function(){return p.getSteps();};this.moveStepToPosition=function(i,q,u){p.moveStepToPosition(i,q,u);};this.updatePath=function(i){p.update(i);};this.removeStep=function(i,q){p.removeStep(i,q);};this.resetPath=function(){if(p){p.destroy();}p=new sap.apf.core.Path(I);};this.stepIsActive=function(i){return p.stepIsActive(i);};this.isApfStateAvailable=function(){return S.isApfStateAvailable();};this.storeApfState=function(){S.storeApfState();};this.restoreApfState=function(){return S.restoreApfState();};this.serialize=function(){var i=p.serialize();t.getSmartFilterBarAsPromise().done(function(q){if(q){i.smartFilterBar=q.fetchVariant();}});return i;};this.deserialize=function(i){if(i.smartFilterBar){if(!g){g=jQuery.Deferred();}g.done(function(q){q.applyVariant(i.smartFilterBar);q.clearVariantSelection();q.fireFilterChange();});}p.deserialize(i);};this.getTextNotHtmlEncoded=function(L,i){return T.getTextNotHtmlEncoded(L,i);};this.getTextHtmlEncoded=function(L,i){return T.getTextHtmlEncoded(L,i);};this.isInitialTextKey=function(i){return(i===sap.apf.core.constants.textKeyForInitialText);};this.getMessageText=function(i,q){return T.getMessageText(i,q);};this.getXsrfToken=function(i){return S.getXsrfToken(i);};this.setDirtyState=function(i){S.setDirtyState(i);};this.isDirty=function(){return S.isDirty();};this.setPathName=function(i){S.setPathName(i);};this.getPathName=function(){return S.getPathName();};this.getCumulativeFilter=function(){return a.functions.getCumulativeFilter();};this.createReadRequest=function(i){var R=C.createRequest(i);var q;if(typeof i==='string'){q=C.getConfigurationById(i);}else{q=i;}return new sap.apf.core.ReadRequest(I,R,q.service,q.entityType);};this.createReadRequestByRequiredFilter=function(i){var R=C.createRequest(i);var q;if(typeof i==='string'){q=C.getConfigurationById(i);}else{q=i;}return new sap.apf.core.ReadRequestByRequiredFilter(I,R,q.service,q.entityType);};this.loadMessageConfiguration=function(i,R){m.loadConfig(i,R);};this.loadAnalyticalConfiguration=function(i){C.loadConfig(i);};this.savePath=function(i,q,u,v){var w;var N;var x;var y;if(typeof i==='string'&&typeof q==='string'&&typeof u==='function'){w=i;N=q;x=u;y=v;this.setPathName(N);P.modifyPath(w,N,x,y);}else if(typeof i==='string'&&typeof q==='function'){N=i;x=q;y=u;this.setPathName(N);P.createPath(N,x,y);}else{m.putMessage(sap.apf.core.createMessageObject({code:"5027",aParameters:[i,q,u]}));}};this.readPaths=function(i){P.readPaths(i);};this.openPath=function(i,q){function u(R,E,v){if(!v){t.setPathName(R.path.AnalysisPathName);}q(R,E,v);}return P.openPath(i,u);};this.deletePath=function(i,q){P.deletePath(i,q);};this.createFilter=function(i){return new sap.apf.utils.Filter(m,i);};this.getActiveStep=function(){return p.getActiveSteps()[0];};this.getCumulativeFilterUpToActiveStep=function(){return p.getCumulativeFilterUpToActiveStep();};this.setActiveStep=function(q){p.makeStepActive(q);var u=p.getActiveSteps();var i;for(i=0;i<u.length;++i){p.makeStepInactive(u[i]);}return p.makeStepActive(q);};this.createFirstStep=function(i,R,q){var u=false;var v;v=t.getStepTemplates();v.forEach(function(w){u=w.id===i?true:u;});if(!u){m.putMessage(m.createMessageObject({code:'5036',aParameters:[i]}));}else{t.createStep(i,q,R);}};this.getFunctionCreateRequest=function(){return C.createRequest;};this.getAnnotationsForService=function(i){return e.getAnnotationsForService(i);};this.checkAddStep=function(i){return p.checkAddStep(i);};this.getPathFilterInformation=function(){return p.getFilterInformation();};T=new((a.constructors.TextResourceHandler)||sap.apf.core.TextResourceHandler)(I);m.setTextResourceHandler(T);if(a.manifests){I.manifests=a.manifests;}f=new((a.constructors.FileExists)||sap.apf.core.utils.FileExists)({functions:{ajax:t.ajax,getSapSystem:s.getSapSystem}});var j={manifests:a.manifests,functions:{getSapSystem:s.getSapSystem,getComponentNameFromManifest:sap.apf.utils.getComponentNameFromManifest,getODataPath:sap.apf.core.utils.uriGenerator.getODataPath,getBaseURLOfComponent:sap.apf.core.utils.uriGenerator.getBaseURLOfComponent,addRelativeToAbsoluteURL:sap.apf.core.utils.uriGenerator.addRelativeToAbsoluteURL},instances:{fileExists:f}};e=new((a.constructors.AnnotationHandler)||sap.apf.core.utils.AnnotationHandler)(j);C=new((a.constructors.ConfigurationFactory)||sap.apf.core.ConfigurationFactory)(I);var k={constructors:{EntityTypeMetadata:sap.apf.core.EntityTypeMetadata,Hashtable:(a.constructors.Hashtable)||sap.apf.utils.Hashtable,Metadata:(a.constructors.Metadata)||sap.apf.core.Metadata,MetadataFacade:(a.constructors.MetadataFacade)||sap.apf.core.MetadataFacade,MetadataProperty:(a.constructors.MetadataProperty)||sap.apf.core.MetadataProperty,ODataModel:(a.constructors.ODataModel)||sap.ui.model.odata.v2.ODataModel},instances:{messageHandler:I.instances.messageHandler,coreApi:t,annotationHandler:e},functions:{getServiceDocuments:C.getServiceDocuments,getSapSystem:s.getSapSystem}};M=new(a.constructors.MetadataFactory||sap.apf.core.MetadataFactory)(k);p=new(a.constructors.Path||sap.apf.core.Path)(I);S=new(a.constructors.SessionHandler||sap.apf.core.SessionHandler)(I);if(a.functions&&a.functions.isUsingCloudFoundryProxy){b=a.functions.isUsingCloudFoundryProxy;}else{b=function(){return false;};}if(b()){c={instances:{messageHandler:m},functions:{coreAjax:this.ajax}};A=(a.constructors.AjaxHandler||sap.apf.cloudFoundry.AjaxHandler);o=new A(c);}var l={instances:{messageHandler:m,coreApi:this},functions:{getComponentName:a.functions&&a.functions.getComponentName},manifests:a.manifests};if(a.constructors.Persistence){l.instances.ajaxHandler=o;P=new a.constructors.Persistence(l);}else if(b()){l.instances.ajaxHandler=o;P=new sap.apf.cloudFoundry.AnalysisPathProxy(l);}else{P=new sap.apf.core.Persistence(l);}var n={instances:{coreApi:t,messageHandler:I.instances.messageHandler,fileExists:f},functions:{checkForTimeout:d,initTextResourceHandlerAsPromise:T.loadResourceModelAsPromise,isUsingCloudFoundryProxy:b},corePromise:a.corePromise,manifests:a.manifests};if(a.constructors&&a.constructors.ProxyForAnalyticalConfiguration){n.constructors={ProxyForAnalyticalConfiguration:a.constructors.ProxyForAnalyticalConfiguration};}r=new(a.constructors.ResourcePathHandler||sap.apf.core.ResourcePathHandler)(n);if(a&&a.coreProbe){a.coreProbe({coreApi:this,startParameter:s,resourcePathHandler:r,textResourceHandler:T,configurationFactory:C,path:p,sessionHandler:S,persistence:P,fileExists:f,corePromise:a.corePromise});}};}());

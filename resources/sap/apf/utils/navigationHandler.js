/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.utils.navigationHandler");jQuery.sap.require("sap.apf.core.utils.filterSimplify");jQuery.sap.require("sap.apf.utils.utils");jQuery.sap.require("sap.ui.core.routing.HashChanger");sap.apf.utils.NavigationHandler=function(I){var c;var e;var l;var m=I.instances.messageHandler;var n=this;var F=I.constructors&&I.constructors.FilterReduction||sap.apf.core.utils.FilterReduction;var f;var a=false;this.getNavigationTargets=function(){var i,o;var p=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(!p){if(!a){o=m.createMessageObject({code:5074});m.putMessage(o);a=true;}e={global:[],stepSpecific:[]};return sap.apf.utils.createPromise(e);}i=jQuery.Deferred();I.functions.getCumulativeFilterUpToActiveStep().done(function(C){if(e&&C.isEqual(l)){i.resolve(h(e));return i.promise();}l=C;if(!c){b();}e=jQuery.extend(true,[],c);e.forEach(function(r){r.text="";});q(C).done(function(r){e=r;i.resolve(h(e));});});return i.promise();function q(r){var i=jQuery.Deferred();var s=[];var D=[];var t;e.forEach(function(u){var v;if(u.useDynamicParameters){t=t||j(r);u.parameters=k(u.parameters,t);}v=jQuery.Deferred();D.push(v);p.getLinks({semanticObject:u.semanticObject,action:u.action,params:d(u.parameters),ignoreFormFactor:false,ui5Component:I.instances.component}).then(function(w){w.forEach(function(x){var y=x.intent.split("-");var z=y[1].split("?");z=z[0].split("~");if(x.text!==""&&z[0]===u.action){u.text=x.text;s.push(u);}});v.resolve();},function(){v.resolve();});});jQuery.when.apply(jQuery,D).done(function(){i.resolve(s);});return i.promise();}};this.navigateToApp=function(i){if(!c){b();}var N=g(i);if(!N){return;}var o=sap.ui.core.routing.HashChanger&&sap.ui.core.routing.HashChanger.getInstance();I.functions.getCumulativeFilterUpToActiveStep().done(function(C){if(I.functions.isFilterReductionActive&&I.functions.isFilterReductionActive()){f=f||new F();var p=f.filterReduction(m,C);if(p===null){m.putMessage(m.createMessageObject({code:5235}));}else{C=p;}}if(!N.filterMapping||!N.filterMapping.requestForMappedFilter){q(null,null);}else{var M=I.functions.createRequest(N.filterMapping.requestForMappedFilter);sap.apf.utils.executeFilterMapping(C,M,N.filterMapping.target,q,m);}function q(r,s){var t;if(s){return;}if(r){C=C.addAnd(r);}var u=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(u){I.instances.serializationMediator.serialize(true).done(function(v){n.generateSelectionVariant(C).done(function(w){var x;var y={};if(N.useDynamicParameters){x=j(C);}y.sapApfState=v;y.sapApfCumulativeFilter=C.mapToSapUI5FilterExpression();y.selectionVariant=w;t=u.createEmptyAppState(I.instances.component);t.setData(y);t.save();if(o){o.replaceHash("sap-iapp-state="+t.getKey());}var z=N.parameters;if(N.useDynamicParameters){z=k(z,x);}u.toExternal({target:{semanticObject:N.semanticObject,action:N.action},appStateKey:t.getKey(),params:d(z)},I.instances.component);});});}}});};this.checkMode=function(){var i=jQuery.Deferred();var o=sap.ui.core.routing.HashChanger&&sap.ui.core.routing.HashChanger.getInstance&&sap.ui.core.routing.HashChanger.getInstance();var p=/(?:sap-iapp-state=)([^&=]+)/;var q,r,s,t;if(o){s=p.exec(o.getHash());if(s){q=s[1];}}r=I.functions.getXappStateId();if(q){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,q).done(function(u){t=u.getData();if(t.sapApfState){I.instances.serializationMediator.deserialize(t.sapApfState).done(function(){i.resolve({navigationMode:"backward"});});}});}else if(r){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,r).done(function(u){t=u.getData();if(t&&t.sapApfCumulativeFilter){i.resolve({navigationMode:"forward",sapApfCumulativeFilter:t.sapApfCumulativeFilter});}else{i.resolve({navigationMode:"forward"});}});}else{i.resolve({navigationMode:"forward"});}if(o){o.replaceHash("");}return i.promise();};this.generateSelectionVariant=function(i){var o=jQuery.Deferred();if(!I.functions.isFilterReductionActive||!I.functions.isFilterReductionActive()){f=f||new F();i=f.filterReduction(m,i);}if(!f||!f.isContradicted()){var s=i.mapToSelectOptions(I.functions.getAllParameterEntitySetKeyProperties);s.done(function(p){p.SelectionVariantID=jQuery.sap.uid();o.resolve(p);});}else{var p={};p={SelectionVariantID:jQuery.sap.uid(),Text:'Filter could not be converted to a selectionVariant'};o.resolve(p);}return o.promise();};function b(){c=I.functions.getNavigationTargets();}function g(o){for(var i=0,p=c.length;i<p;i++){if(c[i].id===o){return c[i];}}}function d(p){var i;if(p&&p.length>0){i={};p.forEach(function(o){i[o.key]=o.value;});}return i;}function h(t){var i=jQuery.extend(true,[],t);var r={global:[],stepSpecific:[]};i.forEach(function(p){if(p.isStepSpecific&&o(p.id)){delete p.isStepSpecific;r.stepSpecific.push(p);}else if(!p.isStepSpecific){delete p.isStepSpecific;r.global.push(p);}});return r;function o(p){var q=false;var s;var u=I.functions.getActiveStep();if(u&&u.getAssignedNavigationTargets){s=u.getAssignedNavigationTargets();if(s&&jQuery.isArray(s)){s.forEach(function(v){if(p===v.id){q=true;}});}}return q;}}function j(i){f=f||new F();var o=f.filterReduction(m,i)||i;return o.getSingleValueTerms();}function k(p,t){t.forEach(function(i){p=p||[];p.push({'key':i.property,'value':i.value});});return p;}};}());

/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/base/ManagedObject','./Util','./ColumnHelper'],function(M,U,C){"use strict";var B=M.extend("sap.ui.comp.personalization.BaseController",{metadata:{"abstract":true,library:"sap.ui.comp",properties:{type:{type:"string",defaultValue:null},itemType:{type:"string",defaultValue:null},ignoreColumnKeys:{type:"object",defaultValue:[]},additionalIgnoreColumnKeys:{type:"object",defaultValue:[]},columnHelper:{type:"sap.ui.comp.personalization.ColumnHelper",defaultValue:null},columnKeys:{type:"string[]",defaultValue:[]},tableType:{type:"string",defaultValue:null}},associations:{table:{type:"sap.ui.core.Control",multiple:false}},events:{beforePotentialTableChange:{},afterPotentialTableChange:{}}}});B.prototype.exit=function(){if(this.getModel()){this.getModel().destroy();}};B.prototype.setModelFunction=function(){var t=this;return function(){if(!this.getModel("$sapmP13nPanel")){this.setModel(t.getInternalModel(),"$sapmP13nPanel");}};};B.prototype.setTable=function(t){this.setAssociation("table",t);this.setTableType(U.getTableType(this.getTable()));return this;};B.prototype.getTable=function(){var t=this.getAssociation("table");if(typeof t==="string"){t=sap.ui.getCore().byId(t);}return t;};B.prototype.getColumnMap=function(){return this.getColumnHelper().getColumnMap();};B.prototype.createControlDataStructure=function(i){i=i||[];var j={};j[this.getType()]={};j[this.getType()][this.getItemType()]=i;return j;};B.prototype.createColumnKeysStructure=function(c){c=c||[];var j={};j[this.getType()]={};j[this.getType()][this.getItemType()]=c.map(function(s){return{columnKey:s};});return j;};B.prototype.checkConsistencyOfIgnoreColumnKeys=function(){var c=this.getColumnMap();this.getIgnoreColumnKeys().some(function(s){if(c[s]&&c[s].getVisible()){throw"The provided 'ignoreColumnKeys' for '"+this.getType()+"' are inconsistent. No columns specified as ignored is allowed to be visible.";}},this);};B.prototype.initializeInternalModel=function(m){["controlDataInitial","controlDataBase","controlData","alreadyKnownRuntimeData","alreadyKnownPersistentData"].forEach(function(p){if(!m.getProperty("/"+p)){m.setProperty("/"+p,{});}m.setProperty("/"+p+"/"+this.getType(),this.createControlDataStructure()[this.getType()]);},this);["ignoreData"].forEach(function(p){if(!m.getProperty("/"+p)){m.setProperty("/"+p,{});}m.setProperty("/"+p+"/"+this.getType(),this.createColumnKeysStructure()[this.getType()]);},this);["controlDataReduce","transientData","beforeOpenData","variantDataInitial"].forEach(function(p){if(!m.getProperty("/"+p)){m.setProperty("/"+p,undefined);}});this.setModel(m,"$sapuicomppersonalizationBaseController");};B.prototype._extendPropertyWithControlDataStructure=function(p){var m=this.getInternalModel();if(m.getProperty("/"+p)){return;}m.setProperty("/"+p,{});m.setProperty("/"+p+"/"+this.getType(),this.createControlDataStructure()[this.getType()]);};B.prototype.getInternalModel=function(){return this.getModel("$sapuicomppersonalizationBaseController");};B.prototype.calculateIgnoreData=function(){var i=this.getIgnoreColumnKeys().concat(this.getAdditionalIgnoreColumnKeys());i=i.filter(function(c,I){return i.indexOf(c)===I;});var j=this.createColumnKeysStructure(i);this.setIgnoreData2Model(j);};B.prototype.calculateControlData=function(){var j=U.copy(this.getControlDataBase());this._deselectIgnoreDataFromJson(j);this.setControlData2Model(j);};B.prototype.calculateControlDataReduce=function(){var j=U.copy(this.getControlDataBase());this._removeIgnoreDataFromJson(j);this.setControlDataReduce2Model(j);};B.prototype.calculateTransientData=function(j){j=U.copy(j);this._removeIgnoreDataFromJson(j);this.setTransientData2Model(j);};B.prototype._removeIgnoreDataFromJson=function(j){if(!this.getIgnoreData()[this.getType()]){return;}this.getIgnoreData()[this.getType()][this.getItemType()].forEach(function(i){var I=U.getIndexByKey("columnKey",i.columnKey,j[this.getType()][this.getItemType()]);if(I>-1){j[this.getType()][this.getItemType()].splice(I,1);}},this);};B.prototype._deselectIgnoreDataFromJson=function(j){if(!this.getIgnoreData()[this.getType()]){return;}this.getIgnoreData()[this.getType()][this.getItemType()].forEach(function(i){var I=U.getIndexByKey("columnKey",i.columnKey,j[this.getType()][this.getItemType()]);if(I>-1){this.handleIgnore(j,I);}},this);};B.prototype.updateControlDataBaseFromJson=function(j){var i=this.getIgnoreData();var b=U.copy(this.getControlDataBase());var o=U.copy(this.getControlDataBase());var J=U.copy(j);b[this.getType()][this.getItemType()]=this.getControlDataBase()[this.getType()][this.getItemType()].filter(function(I){return U.getIndexByKey("columnKey",I.columnKey,i[this.getType()][this.getItemType()])>-1;},this);J[this.getType()][this.getItemType()]=j[this.getType()][this.getItemType()].filter(function(I){return U.getIndexByKey("columnKey",I.columnKey,i[this.getType()][this.getItemType()])<0;},this);o[this.getType()][this.getItemType()]=J[this.getType()][this.getItemType()];if(this.getType()==="columns"){if(o[this.getType()][this.getItemType()].length!==J[this.getType()][this.getItemType()].length){throw"the updated columns are inconsistent with 'controlDataBase'";}o[this.getType()][this.getItemType()].some(function(I){if(U.getIndexByKey("columnKey",I.columnKey,J[this.getType()][this.getItemType()])<0){throw"the columnKey '"+I.columnKey+"' is not contained in 'controlDataBase'";}},this);}var a=U.copy(this.getControlDataBase());a[this.getType()][this.getItemType()]=o[this.getType()][this.getItemType()].concat(b[this.getType()][this.getItemType()]);Object.keys(a[this.getType()]).forEach(function(A){if(!jQuery.isArray(a[this.getType()][A])){a[this.getType()][A]=j[this.getType()][A];}},this);this.setControlDataBase2Model(a);};B.prototype.extendControlDataInitial=function(j){this._extendData("controlDataInitial",j);};B.prototype.extendControlDataBase=function(j){this._extendData("controlDataBase",j);};B.prototype.extendVariantDataInitial=function(j){this._extendData("variantDataInitial",j);};B.prototype.extendAlreadyKnownRuntimeData=function(j){this._extendData("alreadyKnownRuntimeData",j);};B.prototype.extendAlreadyKnownPersistentData=function(j){this._extendData("alreadyKnownPersistentData",j);};B.prototype._extendData=function(p,j){if(!j||!j[this.getType()]||!this._getInternalModelData(p)){return;}var J=U.copy(j);var m=this.getInternalModel();Object.keys(J[this.getType()]).forEach(function(a){if(jQuery.isArray(J[this.getType()][a])){J[this.getType()][a].forEach(function(i){var I=this._getInternalModelData(p)[this.getType()][a];if(U.getIndexByKey("columnKey",i.columnKey,I)>-1){throw"columnKey '"+i.columnKey+"' does already exist in internal model";}m.setProperty("/"+p+"/"+this.getType()+"/"+a+"/"+I.length+"/",i);},this);return;}m.setProperty("/"+p+"/"+this.getType()+"/"+a+"/",J[this.getType()][a]);},this);};B.prototype.setControlDataInitial2Model=function(j){this._setModelData("controlDataInitial",j);};B.prototype.setControlDataBase2Model=function(j){this._setModelData("controlDataBase",j);};B.prototype.setControlData2Model=function(j){this._setModelData("controlData",j);};B.prototype.setAlreadyKnownRuntimeData2Model=function(j){this._setModelData("alreadyKnownRuntimeData",j);};B.prototype.setAlreadyKnownPersistentData2Model=function(j){this._setModelData("alreadyKnownPersistentData",j);};B.prototype.setVariantDataInitial2Model=function(j){this._extendPropertyWithControlDataStructure("variantDataInitial");this._setModelData("variantDataInitial",j);};B.prototype.setIgnoreData2Model=function(j){this._setModelData("ignoreData",j);};B.prototype.setControlDataReduce2Model=function(j){this._extendPropertyWithControlDataStructure("controlDataReduce");this._setModelData("controlDataReduce",j);};B.prototype.setTransientData2Model=function(j){this._extendPropertyWithControlDataStructure("transientData");this._setModelData("transientData",j);};B.prototype.setBeforeOpenData2Model=function(j){this._extendPropertyWithControlDataStructure("beforeOpenData");this._setModelData("beforeOpenData",j);};B.prototype._setModelData=function(p,j){this.getInternalModel().setProperty("/"+p+"/"+this.getType(),(j?U.copy(j)[this.getType()]:undefined));};B.prototype.getControlDataInitial=function(){return this._getInternalModelData("controlDataInitial");};B.prototype.getControlDataBase=function(){return this._getInternalModelData("controlDataBase");};B.prototype.getControlData=function(){return this._getInternalModelData("controlData");};B.prototype.getAlreadyKnownRuntimeData=function(){return this._getInternalModelData("alreadyKnownRuntimeData");};B.prototype.getAlreadyKnownPersistentData=function(){return this._getInternalModelData("alreadyKnownPersistentData");};B.prototype.getVariantDataInitial=function(){return this._getInternalModelData("variantDataInitial");};B.prototype.getIgnoreData=function(){return this._getInternalModelData("ignoreData");};B.prototype.getControlDataReduce=function(){return this._getInternalModelData("controlDataReduce");};B.prototype.getTransientData=function(){return this._getInternalModelData("transientData");};B.prototype.getBeforeOpenData=function(){return this._getInternalModelData("beforeOpenData");};B.prototype._getInternalModelData=function(p){return this.getInternalModel().getProperty("/"+p);};B.prototype.determineMissingColumnKeys=function(j){if(!j||!j[this.getType()]||!j[this.getType()][this.getItemType()]){return this.createColumnKeysStructure();}var c=this.getColumnMap();var i=this.getIgnoreData();var m=j[this.getType()][this.getItemType()].filter(function(I){return!c[I.columnKey];}).filter(function(I){return U.getIndexByKey("columnKey",I.columnKey,i[this.getType()][this.getItemType()])<0;},this).map(function(I){return I.columnKey;});return this.createColumnKeysStructure(m);};B.prototype.extractIgnoreDataFromJson=function(j){if(!j||!j[this.getType()]||!j[this.getType()][this.getItemType()]){return null;}var J=this.createControlDataStructure();var i=this.getIgnoreData();J[this.getType()][this.getItemType()]=j[this.getType()][this.getItemType()].filter(function(m){return U.getIndexByKey("columnKey",m.columnKey,i[this.getType()][this.getItemType()])>-1;},this);return J;};B.prototype.getTable2Json=function(j){var J=this.createControlDataStructure();var c=this.getColumnMap();var a=this.getColumnKeys();j[this.getType()][this.getItemType()].forEach(function(o){var b=c[o.columnKey];if(!b){jQuery.sap.log.warning("Column with columnKey '"+o.columnKey+"' does not exist.");return;}var m=this.getColumn2Json(b,o.columnKey,a.indexOf(o.columnKey));if(m){J[this.getType()][this.getItemType()].push(m);}},this);this.getAdditionalData2Json(J,this.getTable());return J;};B.prototype.getTable2JsonTransient=function(j){var J=this.createControlDataStructure();var c=this.getColumnMap();var t,T;j[this.getType()][this.getItemType()].forEach(function(o){var a=c[o.columnKey];if(!a){return;}var s=U.getColumnBaseType(a);if(s===sap.ui.comp.personalization.ColumnType.TableColumn){if(!a.getLabel()){throw"The column '"+o.columnKey+"' should have a 'label' aggregation otherwise the column can not be identified in the personalization dialog.";}t=a.getLabel().getText();T=(a.getTooltip()instanceof sap.ui.core.TooltipBase)?a.getTooltip().getTooltip_Text():a.getTooltip_Text();}if(s===sap.ui.comp.personalization.ColumnType.ResponsiveColumn){if(!a.getHeader()){throw"The column '"+o.columnKey+"' should have a 'header' aggregation otherwise the column can not be identified in the personalization dialog.";}t=a.getHeader().getText();T=(a.getHeader().getTooltip()instanceof sap.ui.core.TooltipBase)?a.getHeader().getTooltip().getTooltip_Text():a.getHeader().getTooltip_Text();}if(s===sap.ui.comp.personalization.ColumnType.ColumnWrapper){if(!a.getLabel()){throw"The column '"+o.columnKey+"' should have a 'label' aggregation otherwise the column can not be identified in the personalization dialog.";}t=a.getLabel();T=(a.getTooltip()instanceof sap.ui.core.TooltipBase)?a.getTooltip().getTooltip_Text():a.getTooltip_Text();}var m=this.getColumn2JsonTransient(a,o.columnKey,t,T);if(m){J[this.getType()][this.getItemType()].push(m);}},this);U.sortItemsByText(J[this.getType()][this.getItemType()],"text");return J;};B.prototype.getColumn2Json=function(c,s,i){};B.prototype.getAdditionalData2Json=function(j,t){};B.prototype.getColumn2JsonTransient=function(c,s){};B.prototype.handleIgnore=function(j,i){};B.prototype.fixConflictWithIgnore=function(j,J){};B.prototype.syncJson2Table=function(j){};B.prototype.getPanel=function(){};B.prototype.getChangeType=function(c,o){};B.prototype.getChangeData=function(c,o){};B.prototype.getUnionData=function(c,o){};return B;},true);

/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./BaseController','sap/m/library','sap/ui/comp/library','./ChartWrapper','./Util'],function(q,B,M,C,c,U){"use strict";var D=B.extend("sap.ui.comp.personalization.DimeasureController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.dimeasure);this.setItemType(sap.m.P13nPanelType.dimeasure+"Items");},metadata:{events:{afterDimeasureModelDataChange:{}}}});D.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);if(this.getTableType()!==sap.ui.comp.personalization.TableType.ChartWrapper){throw"The provided object is incorrect. 'oTable' has to be an instance of sap.ui.comp.personalization.ChartWrapper. ";}var o=t.getChartObject();o.detachDrilledDown(this._onDrilledDown,this);o.attachDrilledDown(this._onDrilledDown,this);o.detachDrilledUp(this._onDrilledUp,this);o.attachDrilledUp(this._onDrilledUp,this);this._monkeyPatchTable(o);};D.prototype._monkeyPatchTable=function(o){var t=this;var s=o.setChartType.bind(o);var S=function(a){s(a);t._onSetChartType(a);};if(o.setChartType.toString()===S.toString()){return;}o.setChartType=S;};D.prototype._onSetChartType=function(s){var o=this.getControlData();if(!s||s===o.dimeasure.chartTypeKey){return;}this.fireBeforePotentialTableChange();o.dimeasure.chartTypeKey=s;this.updateControlDataBaseFromJson(o);this.fireAfterPotentialTableChange();this.fireAfterDimeasureModelDataChange();};D.prototype._onDrilledDown=function(e){this.fireBeforePotentialTableChange();this._addVisibleDimensions(e.getParameter("dimensions")||[]);this.fireAfterPotentialTableChange();this.fireAfterDimeasureModelDataChange();};D.prototype._addVisibleDimensions=function(d){if(!d.length){return;}var o=this.getControlData();var v=o.dimeasure.dimeasureItems.filter(function(m){return m.aggregationRole===C.personalization.AggregationRole.Dimension&&d.indexOf(m.columnKey)<0;}).reduce(function(i,m){return m.visible?i+1:i;},0);d.forEach(function(s,i){var I=v+i;var a=U.getIndexByKey("columnKey",s,o.dimeasure.dimeasureItems);if(a<0||I<0||a>o.dimeasure.dimeasureItems.length-1||I>o.dimeasure.dimeasureItems.length-1){return;}var m=o.dimeasure.dimeasureItems.splice(a,1);m[0].visible=true;o.dimeasure.dimeasureItems.splice(I,0,m[0]);var b=-1;o.dimeasure.dimeasureItems.forEach(function(e){if(e.index!==undefined){e.index=++b;}});this.updateControlDataBaseFromJson(o);},this);};D.prototype._onDrilledUp=function(e){this.fireBeforePotentialTableChange();var o=this.getControlData();var i=e.getParameter("dimensions")||[];i.forEach(function(s){var m=U.getArrayElementByKey("columnKey",s,o.dimeasure.dimeasureItems);if(!m){throw"No entry found in 'controlDataBase' for columnKey '"+s+"'";}m.visible=false;this.updateControlDataBaseFromJson(o);},this);this.fireAfterPotentialTableChange();this.fireAfterDimeasureModelDataChange();};D.prototype.getColumn2Json=function(o,s,i){if(!U.isAggregatable(o)){return null;}return{columnKey:s,index:i,visible:o.getVisible(),role:o.getRole(),aggregationRole:o.getAggregationRole()};};D.prototype.getAdditionalData2Json=function(j,t){var o=t.getChartObject();j.dimeasure.chartTypeKey=o.getChartType();};D.prototype.getColumn2JsonTransient=function(o,s,t,T){if(!U.isAggregatable(o)){return null;}return{columnKey:s,text:t,tooltip:T,aggregationRole:o.getAggregationRole()};};D.prototype.handleIgnore=function(j,i){j.dimeasure.dimeasureItems[i].visible=false;};D.prototype.syncJson2Table=function(j){var o=this.getTable().getChartObject();var u=function(a,s,S,g){var b=U.copy(a);b.sort(D._sortByIndex);var e=[];b.forEach(function(f){if(f.visible===true){e.push(f.columnKey);var h=g(f.columnKey);if(h){h.setRole(f.role);}}});if(JSON.stringify(e)!==JSON.stringify(s)){S(e);}};this.fireBeforePotentialTableChange();var d=j.dimeasure.dimeasureItems.filter(function(a){return a.aggregationRole===sap.ui.comp.personalization.AggregationRole.Dimension;});var m=j.dimeasure.dimeasureItems.filter(function(a){return a.aggregationRole===sap.ui.comp.personalization.AggregationRole.Measure;});var v=o.getVisibleDimensions();u(d,v,o.setVisibleDimensions.bind(o),o.getDimensionByName.bind(o));var V=o.getVisibleMeasures();u(m,V,o.setVisibleMeasures.bind(o),o.getMeasureByName.bind(o));o.setChartType(j.dimeasure.chartTypeKey);this.fireAfterPotentialTableChange();};D.prototype.getDataSuiteFormat2Json=function(d){var j=this.createControlDataStructure();var a=function(s,p,P){var i=U.getIndexByKey("columnKey",s,j.dimeasure.dimeasureItems);if(i<0){i=j.dimeasure.dimeasureItems.length;j.dimeasure.dimeasureItems.splice(i,0,{columnKey:s});}j.dimeasure.dimeasureItems[i][p]=P;};this.getControlDataInitial().dimeasure.dimeasureItems.filter(function(m){return m.visible===true;}).forEach(function(m){a(m.columnKey,"visible",false);});if(d.Visualizations&&d.Visualizations.length){var b=d.Visualizations.filter(function(V){return V.Type==="Chart";});if(b.length){var v=0;if(b[0].Content.Dimensions.length){v=b[0].Content.Dimensions.length;b[0].Content.Dimensions.forEach(function(n,i){var A=U.getArrayElementByKey("Dimension",n,b[0].Content.DimensionAttributes);a(n,"visible",true);a(n,"index",i);if(A&&A.Role){a(n,"role",sap.ui.comp.odata.ChartMetadata.getDimensionRole(A.Role));}a(n,"aggregationRole",sap.ui.comp.personalization.AggregationRole.Dimension);},this);}if(b[0].Content.Measures.length){b[0].Content.Measures.forEach(function(n,i){var A=U.getArrayElementByKey("Measure",n,b[0].Content.MeasureAttributes);a(n,"visible",true);a(n,"index",v+i);if(A&&A.Role){a(n,"role",sap.ui.comp.odata.ChartMetadata.getMeasureRole(A.Role));}a(n,"aggregationRole",sap.ui.comp.personalization.AggregationRole.Measure);},this);}}j.dimeasure.chartTypeKey=sap.ui.comp.odata.ChartMetadata.getChartType(b[0].Content.ChartType);}return j;};D.prototype.getDataSuiteFormatSnapshot=function(d){var o=this.getUnionData(this.getControlDataInitial(),this.getControlData());if(!o.dimeasure||!o.dimeasure.dimeasureItems||!o.dimeasure.dimeasureItems.length){return;}var a=o.dimeasure.dimeasureItems.filter(function(b){return b.aggregationRole===sap.ui.comp.personalization.AggregationRole.Dimension;}).filter(function(b){return b.visible===true;});var m=o.dimeasure.dimeasureItems.filter(function(b){return b.aggregationRole===sap.ui.comp.personalization.AggregationRole.Measure;}).filter(function(b){return b.visible===true;});if(a.length||m.length){if(!d.Visualizations){d.Visualizations=[];}d.Visualizations.push({Type:"Chart",Content:{ChartType:sap.ui.comp.odata.ChartMetadata.getAnnotationChartType(o.dimeasure.chartTypeKey),Dimensions:a.map(function(b){return b.columnKey;}),DimensionAttributes:a.map(function(b){return{Dimension:b.columnKey,Role:sap.ui.comp.odata.ChartMetadata.getAnnotationDimensionRole(b.role)};}),Measures:m.map(function(b){return b.columnKey;}),MeasureAttributes:m.map(function(b){return{Measure:b.columnKey,Role:sap.ui.comp.odata.ChartMetadata.getAnnotationMeasureRole(b.role)};})}});}};D.prototype.getPanel=function(p){if(!U.hasAggregatableColumns(this.getColumnMap())){return null;}sap.ui.getCore().loadLibrary("sap.m");q.sap.require("sap/m/P13nDimMeasurePanel");q.sap.require("sap/m/P13nItem");q.sap.require("sap/m/P13nDimMeasureItem");var t=this;var a=[];if(p&&p.availableChartTypes){a=p.availableChartTypes;}return new sap.m.P13nDimMeasurePanel({availableChartTypes:a,chartTypeKey:"{$sapmP13nPanel>/controlDataReduce/dimeasure/chartTypeKey}",items:{path:'$sapmP13nPanel>/transientData/dimeasure/dimeasureItems',template:new sap.m.P13nItem({columnKey:'{$sapmP13nPanel>columnKey}',text:'{$sapmP13nPanel>text}',tooltip:'{$sapmP13nPanel>tooltip}',aggregationRole:'{$sapmP13nPanel>aggregationRole}'})},dimMeasureItems:{path:"$sapmP13nPanel>/controlDataReduce/dimeasure/dimeasureItems",template:new sap.m.P13nDimMeasureItem({columnKey:"{$sapmP13nPanel>columnKey}",index:"{$sapmP13nPanel>index}",visible:"{$sapmP13nPanel>visible}",role:"{$sapmP13nPanel>role}"})},beforeNavigationTo:t.setModelFunction(),changeChartType:function(e){var o=t.getControlDataReduce();o.dimeasure.chartTypeKey=e.getParameter("chartTypeKey");t.setControlDataReduce2Model(o);},changeDimMeasureItems:function(e){if(!e.getParameter("items")){return;}var i=e.getParameter("items");var o=t.getControlDataReduce();o.dimeasure.dimeasureItems.forEach(function(m){var b=U.getArrayElementByKey("columnKey",m.columnKey,i);if(!b){return;}m.index=b.index;m.visible=b.visible;m.role=b.role;});t.setControlDataReduce2Model(o);}});};D.prototype._isDimMeasureItemEqual=function(d,o){if(!d&&!o){return true;}if(d&&!o){if(d.index===-1&&d.visible===false){return true;}return false;}if(o&&!d){if(o.index===-1&&o.visible===false){return true;}return false;}for(var p in d){if(o[p]===undefined||d[p]!==o[p]){return false;}}return true;};D.prototype._isSemanticEqual=function(p,P){if(p.dimeasure.chartTypeKey!==P.dimeasure.chartTypeKey){return false;}var s=function(a,b){if(a.visible===true&&(b.visible===false||b.visible===undefined)){return-1;}else if((a.visible===false||a.visible===undefined)&&b.visible===true){return 1;}else if(a.visible===true&&b.visible===true){if(a.index<b.index){return-1;}else if(a.index>b.index){return 1;}else{return 0;}}else if((a.visible===false||a.visible===undefined)&&(b.visible===false||b.visible===undefined)){if(a.columnKey<b.columnKey){return-1;}else if(a.columnKey>b.columnKey){return 1;}else{return 0;}}};var d=U.copy(p.dimeasure.dimeasureItems).sort(s);var e=U.copy(P.dimeasure.dimeasureItems).sort(s);var i=true;d.some(function(o,I){if(!this._isDimMeasureItemEqual(o,e[I])){i=false;return true;}},this);return i;};D.prototype.getChangeType=function(p,P){if(!P||!P.dimeasure||!P.dimeasure.dimeasureItems){return sap.ui.comp.personalization.ChangeType.Unchanged;}return this._isSemanticEqual(p,P)?sap.ui.comp.personalization.ChangeType.Unchanged:sap.ui.comp.personalization.ChangeType.TableChanged;};D.prototype.getChangeData=function(p,P){if(!p||!p.dimeasure||!p.dimeasure.dimeasureItems){return this.createControlDataStructure();}if(!P||!P.dimeasure||!P.dimeasure.dimeasureItems){return{chartTypeKey:p.dimeasure.chartTypeKey,dimeasure:U.copy(p.dimeasure)};}if(!this._isSemanticEqual(p,P)){return{chartTypeKey:p.dimeasure.chartTypeKey,dimeasure:U.copy(p.dimeasure)};}return null;};D.prototype.getUnionData=function(j,J){if(!J||!J.dimeasure||!J.dimeasure.dimeasureItems){return U.copy(j);}var u=U.copy(J);Object.keys(j.dimeasure).forEach(function(a){if(q.isArray(j.dimeasure[a])){j.dimeasure[a].forEach(function(m){var o=U.getArrayElementByKey("columnKey",m.columnKey,u.dimeasure[a]);if(!o){u.dimeasure[a].push(m);return;}if(o.visible===undefined&&m.visible!==undefined){o.visible=m.visible;}if(o.role===undefined&&m.role!==undefined){o.role=m.role;}if(o.index===undefined&&m.index!==undefined){o.index=m.index;}if(o.aggregationRole===undefined&&m.aggregationRole!==undefined){o.aggregationRole=m.aggregationRole;}});return;}if(u.dimeasure[a]===undefined&&j.dimeasure[a]!==undefined){u.dimeasure[a]=j.dimeasure[a];}},this);return u;};D._sortByIndex=function(a,b){if(a.index<b.index){return-1;}else if(a.index>b.index){return 1;}else{return 0;}};D.prototype.exit=function(){B.prototype.exit.apply(this,arguments);var t=this.getTable();if(t){var o=t.getChartObject();if(o){o.detachDrilledDown(this._onDrilledDown,this);o.detachDrilledUp(this._onDrilledUp,this);}}};return D;},true);

/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./BaseController','sap/m/library','./Util','sap/m/P13nConditionPanel'],function(q,B,l,U,P){"use strict";var G=B.extend("sap.ui.comp.personalization.GroupController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.group);this.setItemType(sap.m.P13nPanelType.group+"Items");},metadata:{events:{afterGroupModelDataChange:{}}}});G.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);if(this.getTableType()===sap.ui.comp.personalization.TableType.AnalyticalTable||this.getTableType()===sap.ui.comp.personalization.TableType.Table||this.getTableType()===sap.ui.comp.personalization.TableType.TreeTable){t.detachGroup(this._onGroup,this);t.attachGroup(this._onGroup,this);}};G.prototype.getColumn2Json=function(c,C,i){if(this.getTableType()!==sap.ui.comp.personalization.TableType.AnalyticalTable){return null;}if(!c.getGrouped()){return null;}return{columnKey:C,isGrouped:c.getGrouped(),operation:c.getSortOrder&&c.getSortOrder()===sap.ui.table.SortOrder.Ascending?sap.m.P13nConditionOperation.GroupAscending:sap.m.P13nConditionOperation.GroupDescending,showIfGrouped:c.getShowIfGrouped?c.getShowIfGrouped():false};};G.prototype.getAdditionalData2Json=function(j,t){if(this.getTableType()!==sap.ui.comp.personalization.TableType.AnalyticalTable){return;}if(!j.group.groupItems.length){return;}t.getGroupedColumns().forEach(function(c,i){if(typeof c==="string"){c=sap.ui.getCore().byId(c);}var I=U.getIndexByKey("columnKey",U.getColumnKey(c),j.group.groupItems);if(I>-1&&i===I){return;}var o=j.group.groupItems.splice(I,1);j.group.groupItems.splice(i,0,o);});};G.prototype.getColumn2JsonTransient=function(c,C,t,T){if(!U.isGroupable(c)){return null;}return{columnKey:C,text:t,tooltip:T};};G.prototype.handleIgnore=function(j,i){j.sort.sortItems.splice(i,1);};G.prototype.syncJson2Table=function(j){var c=this.getColumnMap();var t=this.getTable();var C;this.fireBeforePotentialTableChange();if(this.getTableType()===sap.ui.comp.personalization.TableType.TreeTable){return;}else if(this.getTableType()===sap.ui.comp.personalization.TableType.AnalyticalTable){for(var s in c){C=c[s];if(!C){return;}if(C.getGrouped()){C.setGrouped(false);C.setShowIfGrouped(false);}}j.group.groupItems.forEach(function(m){C=c[m.columnKey];if(!C){return;}C.setGrouped(true);C.setShowIfGrouped(m.showIfGrouped);});}else if(this.getTableType()===sap.ui.comp.personalization.TableType.Table||this.getTableType()===sap.ui.comp.personalization.TableType.AnalyticalTable||this.getTableType()===sap.ui.comp.personalization.TableType.TreeTable){if(j.group.groupItems.length>0){j.group.groupItems.some(function(m){C=c[m.columnKey];if(C){t.setGroupBy(C);return true;}});}else{t.setGroupBy(null);}}this.fireAfterPotentialTableChange();};G.prototype.getDataSuiteFormat2Json=function(d){var j=this.createControlDataStructure();if(!d.GroupBy||!d.GroupBy.length){return j;}j.group.groupItems=d.GroupBy.map(function(g){return{columnKey:g,operation:sap.m.P13nConditionOperation.GroupAscending,showIfGrouped:false};});return j;};G.prototype.getDataSuiteFormatSnapshot=function(d){var c=this.getUnionData(this.getControlDataInitial(),this.getControlData());if(!c.group||!c.group.groupItems||!c.group.groupItems.length){return;}d.GroupBy=c.group.groupItems.map(function(m){return m.columnKey;});};G.prototype._onGroup=function(e){this.fireBeforePotentialTableChange();this._updateInternalModel(e.getParameter("groupedColumns"));this.fireAfterPotentialTableChange();this.fireAfterGroupModelDataChange();};G.prototype._updateInternalModel=function(g){this.getInternalModel().setProperty("/controlData/group/groupItems",[]);var c=this.getControlData();g.forEach(function(C){if(typeof C==="string"){C=sap.ui.getCore().byId(C);}var s=U.getColumnKey(C);var i=U.getIndexByKey("columnKey",s,c.group.groupItems);i=(i>-1)?i:c.group.groupItems.length;this.getInternalModel().setProperty("/controlData/group/groupItems/"+i+"/",{columnKey:s,showIfGrouped:C.getShowIfGrouped?C.getShowIfGrouped():false});},this);this.updateControlDataBaseFromJson(c);};G.prototype.getPanel=function(){sap.ui.getCore().loadLibrary("sap.m");q.sap.require("sap/m/P13nGroupPanel");q.sap.require("sap/m/P13nItem");q.sap.require("sap/m/P13nGroupItem");if(!U.hasGroupableColumns(this.getColumnMap())){return null;}var t=this;return new sap.m.P13nGroupPanel({maxGroups:this.getTableType()===sap.ui.comp.personalization.TableType.AnalyticalTable?"-1":"1",containerQuery:true,items:{path:"$sapmP13nPanel>/transientData/group/groupItems",template:new sap.m.P13nItem({columnKey:"{$sapmP13nPanel>columnKey}",text:"{$sapmP13nPanel>text}",tooltip:"{$sapmP13nPanel>tooltip}"})},groupItems:{path:"$sapmP13nPanel>/controlDataReduce/group/groupItems",template:new sap.m.P13nGroupItem({columnKey:"{$sapmP13nPanel>columnKey}",operation:"{$sapmP13nPanel>operation}",showIfGrouped:"{$sapmP13nPanel>showIfGrouped}"})},beforeNavigationTo:this.setModelFunction(),addGroupItem:function(e){if(!e.getParameter("groupItemData")){return;}var i=e.getParameter("index");var g=e.getParameter("groupItemData");var o={columnKey:g.getColumnKey(),operation:g.getOperation(),showIfGrouped:g.getShowIfGrouped()};var c=t.getControlDataReduce();if(i>-1){c.group.groupItems.splice(i,0,o);}else{c.group.groupItems.push(o);}t.setControlDataReduce2Model(c);},removeGroupItem:function(e){var i=e.getParameter("index");if(i<0){return;}var c=t.getControlDataReduce();c.group.groupItems.splice(i,1);t.setControlDataReduce2Model(c);}});};G.prototype.getChangeType=function(p,o){if(!o||!o.group||!o.group.groupItems){return sap.ui.comp.personalization.ChangeType.Unchanged;}var i=JSON.stringify(p.group.groupItems)!==JSON.stringify(o.group.groupItems);return i?sap.ui.comp.personalization.ChangeType.ModelChanged:sap.ui.comp.personalization.ChangeType.Unchanged;};G.prototype.getChangeData=function(p,o){if(!p||!p.group||!p.group.groupItems){return this.createControlDataStructure();}if(!o||!o.group||!o.group.groupItems){return{group:U.copy(p.group)};}if(JSON.stringify(p.group.groupItems)!==JSON.stringify(o.group.groupItems)){return{group:U.copy(p.group)};}return null;};G.prototype.getUnionData=function(j,J){if(!J||!J.group||!J.group.groupItems){return{group:U.copy(j.group)};}return{group:U.copy(J.group)};};G.prototype.isGroupSelected=function(p,o,c){var i;if(!p){o.groupItems.some(function(m,I){if(m.columnKey===c){i=I;return true;}});return i>-1;}if(!p.selectedColumnKeys){return false;}if(p.selectedColumnKeys){p.selectedColumnKeys.some(function(s,I){if(s===c){i=I;return true;}});}return i>-1;};G.prototype.exit=function(){B.prototype.exit.apply(this,arguments);if(this.getTable()&&(this.getTableType()===sap.ui.comp.personalization.TableType.AnalyticalTable||this.getTableType()===sap.ui.comp.personalization.TableType.Table||this.getTableType()===sap.ui.comp.personalization.TableType.TreeTable)){this.getTable().detachGroup(this._onGroup,this);}};return G;},true);

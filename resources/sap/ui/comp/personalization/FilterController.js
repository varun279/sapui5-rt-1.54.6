/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./BaseController','sap/m/library','./Util','./ChartWrapper','sap/ui/comp/filterbar/VariantConverterTo','sap/ui/comp/filterbar/VariantConverterFrom'],function(q,B,l,U,C,V,a){"use strict";var F=B.extend("sap.ui.comp.personalization.FilterController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.filter);this.setItemType(sap.m.P13nPanelType.filter+"Items");},metadata:{events:{afterFilterModelDataChange:{}}}});F.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);};F.prototype.getColumn2Json=function(c,s,i){if(this.getTableType()!==sap.ui.comp.personalization.TableType.AnalyticalTable&&this.getTableType()!==sap.ui.comp.personalization.TableType.Table&&this.getTableType()!==sap.ui.comp.personalization.TableType.TreeTable){return null;}if(!U.isFilterable(c)){return null;}if(!c.getFiltered||(c.getFiltered&&!c.getFiltered())){return null;}return{columnKey:s,exclude:false,operation:c.getFilterOperator(),value1:c.getFilterValue(),value2:""};};F.prototype.getColumn2JsonTransient=function(c,s,t,T){if(!U.isFilterable(c)){return null;}var o=this.getTable();var b;if(o.getModel()instanceof sap.ui.model.odata.ODataModel||o.getModel()instanceof sap.ui.model.odata.v2.ODataModel){q.sap.require("sap.ui.model.odata.type.Boolean");b=new sap.ui.model.odata.type.Boolean();}else if(o.getModel()instanceof sap.ui.model.Model){q.sap.require("sap.ui.model.type.Boolean");b=new sap.ui.model.type.Boolean();}var d;if(b){d=["",b.formatValue(false,"string"),b.formatValue(true,"string")];}var v;if(this.getTableType()===sap.ui.comp.personalization.TableType.AnalyticalTable||this.getTableType()===sap.ui.comp.personalization.TableType.Table||this.getTableType()===sap.ui.comp.personalization.TableType.TreeTable){if(U.getColumnType(c)==="boolean"){v=U._getCustomProperty(c,"values")||d;}return{columnKey:s,text:t,tooltip:T,maxLength:U._getCustomProperty(c,"maxLength"),precision:U._getCustomProperty(c,"precision"),scale:U._getCustomProperty(c,"scale"),type:U.getColumnType(c),values:v};}if(this.getTableType()===sap.ui.comp.personalization.TableType.ResponsiveTable){if(U.getColumnType(c)==="boolean"){v=U._getCustomProperty(c,"values")||d;}return{columnKey:s,text:t,tooltip:T,maxLength:U._getCustomProperty(c,"maxLength"),precision:U._getCustomProperty(c,"precision"),scale:U._getCustomProperty(c,"scale"),type:U.getColumnType(c),values:v};}if(this.getTableType()===sap.ui.comp.personalization.TableType.ChartWrapper){return{columnKey:s,text:t,tooltip:T,maxLength:U._getCustomProperty(c,"maxLength"),precision:U._getCustomProperty(c,"precision"),scale:U._getCustomProperty(c,"scale"),type:U.getColumnType(c),values:v};}};F.prototype.handleIgnore=function(j,i){j.sort.sortItems.splice(i,1);};F.prototype.syncJson2Table=function(j){var c=this.getColumnMap();var o=q.extend(true,{},c);this.fireBeforePotentialTableChange();if(this.getTableType()===sap.ui.comp.personalization.TableType.AnalyticalTable||this.getTableType()===sap.ui.comp.personalization.TableType.Table||this.getTableType()===sap.ui.comp.personalization.TableType.TreeTable){j.filter.filterItems.forEach(function(f){var b=c[f.columnKey];if(b){if(!b.getFiltered()){b.setFiltered(true);}delete o[f.columnKey];}});for(var s in o){var b=o[s];if(b&&b.getFiltered()){b.setFiltered(false);}}}this.fireAfterPotentialTableChange();};F.prototype.getDataSuiteFormat2Json=function(d){var j=this.createControlDataStructure();if(!d.SelectOptions||!d.SelectOptions.length){return j;}j.filter.filterItems=d.SelectOptions.map(function(s){var c=a.convertOption(s.Ranges[0].Option,s.Ranges[0].Low);return{columnKey:s.PropertyName,exclude:(s.Ranges[0].Sign==="E"),operation:c.op,value1:c.v,value2:s.Ranges[0].High};});return j;};F.prototype.getDataSuiteFormatSnapshot=function(d){var c=this.getUnionData(this.getControlDataInitial(),this.getControlData());if(!c.filter||!c.filter.filterItems||!c.filter.filterItems.length){return;}c.filter.filterItems.forEach(function(f){var r=V.addRangeEntry(d,f.columnKey);V.addRanges(r,[f]);});};F.prototype.getPanel=function(p){sap.ui.getCore().loadLibrary("sap.m");q.sap.require("sap/m/P13nFilterPanel");q.sap.require("sap/m/P13nItem");q.sap.require("sap/m/P13nFilterItem");if(!U.hasFilterableColumns(this.getColumnMap())){return null;}if(p&&p.column){var c=U.getColumnKey(p.column);if(c){var j=this.getTransientData();j.filter.filterItems.forEach(function(i){i["isDefault"]=i.columnKey===c;});}}var t=this;var P=new sap.m.P13nFilterPanel({containerQuery:true,items:{path:"$sapmP13nPanel>/transientData/filter/filterItems",template:new sap.m.P13nItem({columnKey:'{$sapmP13nPanel>columnKey}',text:"{$sapmP13nPanel>text}",tooltip:"{$sapmP13nPanel>tooltip}",maxLength:"{$sapmP13nPanel>maxLength}",precision:"{$sapmP13nPanel>precision}",scale:"{$sapmP13nPanel>scale}",type:"{$sapmP13nPanel>type}",isDefault:"{$sapmP13nPanel>isDefault}",values:"{$sapmP13nPanel>values}"})},filterItems:{path:"$sapmP13nPanel>/controlDataReduce/filter/filterItems",template:new sap.m.P13nFilterItem({key:"{$sapmP13nPanel>key}",columnKey:"{$sapmP13nPanel>columnKey}",exclude:"{$sapmP13nPanel>exclude}",operation:"{$sapmP13nPanel>operation}",value1:"{$sapmP13nPanel>value1}",value2:"{$sapmP13nPanel>value2}"})},beforeNavigationTo:this.setModelFunction(),addFilterItem:function(e){if(!e.getParameter("filterItemData")){return;}var i=e.getParameter("index");var f=e.getParameter("filterItemData");var o={columnKey:f.getColumnKey(),operation:f.getOperation(),exclude:f.getExclude(),value1:f.getValue1(),value2:f.getValue2()};var b=t.getControlDataReduce();if(i>-1){b.filter.filterItems.splice(i,0,o);}else{b.filter.filterItems.push(o);}t.setControlDataReduce2Model(b);},removeFilterItem:function(e){var i=e.getParameter("index");if(i<0){return;}var o=t.getControlDataReduce();o[t.getType()][t.getItemType()].splice(i,1);t.setControlDataReduce2Model(o);}});var s=function(o,f){var b=this.getColumnMap(true);var d=b[f];var e=U._getCustomProperty(d,"fullName");if(e){q.sap.require("sap.ui.comp.providers.ValueListProvider");o.setShowSuggestion(true);o.setFilterSuggests(false);o.setModel(this.getTable().getModel());return new sap.ui.comp.providers.ValueListProvider({control:o,fieldName:f,typeAheadEnabled:true,aggregation:"suggestionRows",resolveInOutParams:false,loadAnnotation:true,fullyQualifiedFieldName:e,model:this.getTable().getModel(),enableShowTableSuggestionValueHelp:false});}}.bind(this);P._oIncludeFilterPanel._fSuggestCallback=s;P._oExcludeFilterPanel._fSuggestCallback=s;return P;};F.prototype.getChangeType=function(p,P){if(!P||!P.filter||!P.filter.filterItems){return sap.ui.comp.personalization.ChangeType.Unchanged;}if(P&&P.filter&&P.filter.filterItems){P.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}if(p&&p.filter&&p.filter.filterItems){p.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}var i=JSON.stringify(p.filter.filterItems)!==JSON.stringify(P.filter.filterItems);return i?sap.ui.comp.personalization.ChangeType.ModelChanged:sap.ui.comp.personalization.ChangeType.Unchanged;};F.prototype.getChangeData=function(p,P){if(!p||!p.filter||!p.filter.filterItems){return this.createControlDataStructure();}if(P&&P.filter&&P.filter.filterItems){P.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}if(p&&p.filter&&p.filter.filterItems){p.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}if(!P||!P.filter||!P.filter.filterItems){return{filter:U.copy(p.filter)};}if(JSON.stringify(p.filter.filterItems)!==JSON.stringify(P.filter.filterItems)){return{filter:U.copy(p.filter)};}return null;};F.prototype.getUnionData=function(j,J){if(!J||!J.filter||!J.filter.filterItems){return{filter:U.copy(j.filter)};}return{filter:U.copy(J.filter)};};F.prototype.exit=function(){B.prototype.exit.apply(this,arguments);};return F;},true);

/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./BaseController','sap/m/library','./Util'],function(q,B,l,U){"use strict";var C=B.extend("sap.ui.comp.personalization.ColumnsController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.columns);this.setItemType(sap.m.P13nPanelType.columns+"Items");},metadata:{properties:{triggerModelChangeOnColumnInvisible:{type:"boolean",group:"Misc",defaultValue:false}},events:{afterColumnsModelDataChange:{}}}});C.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);if(this.getTableType()===sap.ui.comp.personalization.TableType.AnalyticalTable||this.getTableType()===sap.ui.comp.personalization.TableType.Table||this.getTableType()===sap.ui.comp.personalization.TableType.TreeTable){t.detachColumnMove(this._onColumnMove,this);t.detachColumnVisibility(this._onColumnVisibility,this);t.detachColumnResize(this._onColumnResize,this);t.attachColumnMove(this._onColumnMove,this);t.attachColumnVisibility(this._onColumnVisibility,this);t.attachColumnResize(this._onColumnResize,this);}this._monkeyPatchTable(t);};C.prototype.getColumn2Json=function(c,s,i){return{columnKey:s,index:i,visible:c.getVisible(),width:c.getWidth?c.getWidth():undefined,total:c.getSummed?c.getSummed():undefined};};C.prototype.getAdditionalData2Json=function(j,t){j.columns.fixedColumnCount=t&&t.getFixedColumnCount?t.getFixedColumnCount():undefined;};C.prototype.getColumn2JsonTransient=function(c,s,t,T){return{columnKey:s,text:t,tooltip:T};};C.prototype.handleIgnore=function(j,i){j.columns.columnsItems[i].visible=false;};C.prototype.syncJson2Table=function(j){var t=this.getTable();var c=this.getColumnMap();this.fireBeforePotentialTableChange();if(this.getTable()&&(this.getTableType()===sap.ui.comp.personalization.TableType.AnalyticalTable||this.getTableType()===sap.ui.comp.personalization.TableType.Table||this.getTableType()===sap.ui.comp.personalization.TableType.TreeTable)){this._applyChangesToUiTableType(t,j,c);}else if(this.getTableType()===sap.ui.comp.personalization.TableType.ResponsiveTable){this._applyChangesToMTableType(t,j,c);}this.fireAfterPotentialTableChange();};C.prototype.getDataSuiteFormat2Json=function(d){var j=this.createControlDataStructure();var a=function(c,p,P){var i=U.getIndexByKey("columnKey",c,j.columns.columnsItems);if(i<0){i=j.columns.columnsItems.length;j.columns.columnsItems.splice(i,0,{columnKey:c});}j.columns.columnsItems[i][p]=P;};this.getControlDataInitial().columns.columnsItems.filter(function(m){return m.visible===true;}).forEach(function(m){a(m.columnKey,"visible",false);});if(d.Visualizations&&d.Visualizations.length){var L=d.Visualizations.filter(function(v){return v.Type==="LineItem";});if(L.length){L[0].Content.forEach(function(c,i){a(c.Value,"visible",true);a(c.Value,"index",i);},this);}}if(d.Total&&d.Total.length){d.Total.forEach(function(c){a(c,"total",true);});}return j;};C.prototype.getDataSuiteFormatSnapshot=function(d){var c=this.getUnionData(this.getControlDataInitial(),this.getControlData());if(!c.columns||!c.columns.columnsItems||!c.columns.columnsItems.length){return;}var a=c.columns.columnsItems.filter(function(o){return!!o.total;});if(a.length){d.Total=a.map(function(o){return o.columnKey;});}var b=c.columns.columnsItems.filter(function(o){return!!o.visible;});if(b.length){if(!d.Visualizations){d.Visualizations=[];}b.sort(this._sortByIndex);d.Visualizations.push({Type:"LineItem",Content:b.map(function(o){return{Value:o.columnKey,Label:undefined};})});}};C.prototype._onColumnMove=function(e){var i=e.getParameter("newPos");var c=U.getColumnKey(e.getParameter("column"));var o=this.getControlData();var I=U.getIndexByKey("columnKey",c,o.columns.columnsItems);if(I<0||i<0||I>o.columns.columnsItems.length-1||i>o.columns.columnsItems.length-1){return;}this.fireBeforePotentialTableChange();var m=o.columns.columnsItems.splice(I,1);o.columns.columnsItems.splice(i,0,m[0]);var a=-1;o.columns.columnsItems.forEach(function(M){if(M.index!==undefined){M.index=++a;}});this.updateControlDataBaseFromJson(o);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();};C.prototype._onColumnVisibility=function(e){this.fireBeforePotentialTableChange();this._updateInternalModel(U.getColumnKey(e.getParameter("column")),"visible",e.getParameter("newVisible"));this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();};C.prototype._onColumnTotal=function(p){this.fireBeforePotentialTableChange();this._updateInternalModel(U.getColumnKey(p.column),"total",p.isSummed);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();};C.prototype._onColumnResize=function(e){this.fireBeforePotentialTableChange();this._updateInternalModel(U.getColumnKey(e.getParameter("column")),"width",e.getParameter("width"));this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();};C.prototype._onColumnFixedCount=function(f){this.fireBeforePotentialTableChange();var c=this.getControlData();this.getInternalModel().setProperty("/controlData/columns/fixedColumnCount",f);this.updateControlDataBaseFromJson(c);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();};C.prototype._updateInternalModel=function(c,p,P){if(!c||!p){return;}var o=this.getControlData();var i=U.getIndexByKey("columnKey",c,o.columns.columnsItems);if(i<0){throw"No entry found in 'controlDataBase' for columnKey '"+c+"'";}this.getInternalModel().setProperty("/controlData/columns/columnsItems/"+i+"/"+p,P);this.updateControlDataBaseFromJson(o);};C.prototype.getPanel=function(p){sap.ui.getCore().loadLibrary("sap.m");q.sap.require("sap/m/P13nColumnsPanel");q.sap.require("sap/m/P13nItem");q.sap.require("sap/m/P13nColumnsItem");var t=this;var v=-1;if(p&&p.visibleItemsThreshold){v=p.visibleItemsThreshold;}return new sap.m.P13nColumnsPanel({visibleItemsThreshold:v,items:{path:'$sapmP13nPanel>/transientData/columns/columnsItems',template:new sap.m.P13nItem({columnKey:'{$sapmP13nPanel>columnKey}',text:'{$sapmP13nPanel>text}',tooltip:'{$sapmP13nPanel>tooltip}'})},columnsItems:{path:"$sapmP13nPanel>/controlDataReduce/columns/columnsItems",template:new sap.m.P13nColumnsItem({columnKey:"{$sapmP13nPanel>columnKey}",index:"{$sapmP13nPanel>index}",visible:"{$sapmP13nPanel>visible}",width:"{$sapmP13nPanel>width}",total:"{$sapmP13nPanel>total}"})},beforeNavigationTo:this.setModelFunction(),changeColumnsItems:function(e){if(!e.getParameter("items")){return;}var c=t.getControlDataReduce();c.columns.columnsItems=e.getParameter("items");t.setControlDataReduce2Model(c);}});};C.prototype._sortByIndex=function(a,b){if(a.index!==undefined&&b.index===undefined){return-1;}if(b.index!==undefined&&a.index===undefined){return 1;}if(a.index<b.index){return-1;}if(a.index>b.index){return 1;}return 0;};C.prototype._applyChangesToUiTableType=function(t,j,c){var o=null;var a={};var b=this;var s=function(h,i){h.forEach(function(m){a[m.columnKey]=m;});h.sort(b._sortByIndex);var k=h.map(function(m){return m.columnKey;});i.forEach(function(m,I){if(k.indexOf(m)<0){k.splice(I,0,m);}});return k;};var S=function(h,o){var i=a[h];if(i&&i.visible!==undefined&&o.getVisible()!==i.visible){o.setVisible(i.visible,true);}};var f=function(i,h,o){var T=t.indexOfColumn(o);var m=i;if(m!==undefined&&T!==m){if(T>-1){t.removeColumn(o,true);}t.insertColumn(o,m,true);}};var d=function(h,o){var i=a[h];if(i&&i.width!==undefined&&o.getWidth()!==i.width){o.setWidth(i.width,true);}};var e=function(h,o){var i=a[h];if(i&&i.total!==undefined&&o.getSummed&&o.getSummed()!==i.total){o.setSummed(i.total,true);}};if(j.columns.columnsItems.length){var g=s(j.columns.columnsItems,this.getColumnKeys());g.forEach(function(h,i){o=c[h];if(o){S(h,o);f(i,h,o);d(h,o);e(h,o);}});}var F=j.columns.fixedColumnCount||0;if(t.getFixedColumnCount&&t.getFixedColumnCount()!==F){t.setFixedColumnCount(F,true);}};C.prototype._applyChangesToMTableType=function(t,j,c){var T=false;var s=function(o,a){var m=o.index;if(m!==undefined){a.setOrder(m,true);T=true;}};var S=function(o,a){if(o.visible!==undefined&&a.getVisible()!==o.visible){a.setVisible(o.visible,true);T=true;}};if(j.columns.columnsItems.length){j.columns.columnsItems.sort(function(a,b){if(a.index<b.index){return-1;}if(a.index>b.index){return 1;}return 0;});j.columns.columnsItems.forEach(function(o){var a=c[o.columnKey];if(a){s(o,a);S(o,a);}},this);}if(T){t.invalidate();}};C.prototype.getChangeType=function(c,o){var a=this.getChangeData(c,o);var n=this.getTableType()===sap.ui.comp.personalization.TableType.AnalyticalTable||this.getTriggerModelChangeOnColumnInvisible();if(a){var b=sap.ui.comp.personalization.ChangeType.TableChanged;a.columns.columnsItems.some(function(i){if(i.visible||(i.visible===false&&n)){b=sap.ui.comp.personalization.ChangeType.ModelChanged;return true;}if(i.total===false||i.total===true){b=sap.ui.comp.personalization.ChangeType.ModelChanged;return true;}});return b;}return sap.ui.comp.personalization.ChangeType.Unchanged;};C.prototype.getChangeData=function(c,o){if(!o||!o.columns||!o.columns.columnsItems){return null;}var a={columns:U.copy(c.columns)};var i=true;i=(c.columns.fixedColumnCount===o.columns.fixedColumnCount);c.columns.columnsItems.some(function(I){var b=U.getArrayElementByKey("columnKey",I.columnKey,o.columns.columnsItems);if(!U.semanticEqual(I,b)){i=false;return true;}});if(i){return null;}var t=[];a.columns.columnsItems.forEach(function(I,b){var d=U.getArrayElementByKey("columnKey",I.columnKey,o.columns.columnsItems);if(U.semanticEqual(I,d)){t.push(I);return;}for(var p in I){if(p==="columnKey"||!d){if(d&&d[p]===undefined){delete I[p];}else{continue;}}if(I[p]===d[p]){delete I[p];}}if(Object.keys(I).length<2){t.push(I);}});t.forEach(function(I){var b=U.getIndexByKey("columnKey",I.columnKey,a.columns.columnsItems);a.columns.columnsItems.splice(b,1);});if(a.columns.fixedColumnCount===0){delete a.columns.fixedColumnCount;}return a;};C.prototype._sortArrayByPropertyName=function(A,p,t){var s=[];if(t===null||t===undefined){t=false;}if(A&&A.length>0&&p!==undefined&&p!==null&&p!==""){if(t){s=q.extend(true,[],A);}else{s=A;}s.sort(function(a,b){var c=a[p];var d=b[p];if(c<d||(c!==undefined&&d===undefined)){return-1;}if(c>d||(c===undefined&&d!==undefined)){return 1;}return 0;});}return s;};C.prototype.getUnionData=function(j,J){if(!J||!J.columns||!J.columns.columnsItems){return U.copy(j);}var u=U.copy(J);Object.keys(j.columns).forEach(function(a){if(q.isArray(j.columns[a])){j.columns[a].forEach(function(m){var M=U.getArrayElementByKey("columnKey",m.columnKey,u.columns[a]);if(!M){u.columns[a].push(m);return;}if(M.visible===undefined&&m.visible!==undefined){M.visible=m.visible;}if(M.width===undefined&&m.width!==undefined){M.width=m.width;}if(M.total===undefined&&m.total!==undefined){M.total=m.total;}if(M.index===undefined&&m.index!==undefined){M.index=m.index;}});return;}if(u.columns[a]===undefined&&j.columns[a]!==undefined){u.columns[a]=j.columns[a];}},this);return u;};C.prototype.fixConflictWithIgnore=function(j,J){if(!j||!j.columns||!j.columns.columnsItems||!J||!J.columns||!J.columns.columnsItems||!J.columns.columnsItems.length){return j;}this._sortArrayByPropertyName(j.columns.columnsItems,"index");var i=false;J.columns.columnsItems.forEach(function(m){var a=U.getIndexByKey("columnKey",m.columnKey,j.columns.columnsItems);if(a<0||j.columns.columnsItems[a].index===undefined){return;}if((a+1<=j.columns.columnsItems.length-1&&j.columns.columnsItems[a+1].index===j.columns.columnsItems[a].index)||(a-1>=0&&j.columns.columnsItems[a-1].index===j.columns.columnsItems[a].index)){i=true;}if(a+1<=j.columns.columnsItems.length-1&&j.columns.columnsItems[a+1].index===j.columns.columnsItems[a].index){var M=j.columns.columnsItems.splice(a,1);j.columns.columnsItems.splice(a+1,0,M[0]);}});if(i){var I=-1;j.columns.columnsItems.forEach(function(m){if(m.index!==undefined){m.index=++I;}});}};C.prototype.isColumnSelected=function(p,c,s){var i;if(!p){i=U.getIndexByKey("columnKey",s,c.columnsItems);return(i>-1)?c.columnsItems[i].visible:false;}if(!p.selectedItems){return false;}i=U.getIndexByKey("columnKey",s,p.selectedItems);return i>-1;};C.prototype._monkeyPatchTable=function(t){if(this.getTableType()!==sap.ui.comp.personalization.TableType.AnalyticalTable&&this.getTableType()!==sap.ui.comp.personalization.TableType.Table&&this.getTableType()!==sap.ui.comp.personalization.TableType.TreeTable){return;}var a=this;var s=t.setFixedColumnCount.bind(t);var S=function(f,b){a._onColumnFixedCount(f);s(f,b);};if(t.setFixedColumnCount.toString()===S.toString()){return;}t.setFixedColumnCount=S;};C.prototype.exit=function(){B.prototype.exit.apply(this,arguments);var t=this.getTable();if(this.getTable()&&(this.getTableType()===sap.ui.comp.personalization.TableType.AnalyticalTable||this.getTableType()===sap.ui.comp.personalization.TableType.Table||this.getTableType()===sap.ui.comp.personalization.TableType.TreeTable)){t.detachColumnMove(this._onColumnMove,this);t.detachColumnVisibility(this._onColumnVisibility,this);t.detachColumnResize(this._onColumnResize,this);}};return C;},true);

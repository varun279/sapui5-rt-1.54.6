/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library','sap/ui/comp/valuehelpdialog/ValueHelpDialog','sap/ui/comp/odata/ODataType','sap/ui/comp/util/FormatUtil','sap/ui/core/format/DateFormat'],function(q,l,V,O,F,D){"use strict";var a=function(){};a.prototype.convert=function(k,f,d,o,v){var b,i,j,J,n=null,B,s;var S={SelectionVariantID:k};this._sAPILevel=v;if(d&&f){j=JSON.parse(d);if(j){b=this._getFields(f);if(b&&b.length>0){for(i=0;i<b.length;i++){this._convertField(S,b[i],j,o);}}if(j._CUSTOM){if(typeof j._CUSTOM==="string"){J=JSON.parse(j._CUSTOM);}else{J=j._CUSTOM;}for(n in J){if(n){this._addSingleValue(S,n,a._getValue(J[n],true));}}}if(o&&o.getBasicSearchName){B=o.getBasicSearchName();if(B){s=o.getBasicSearchValue();this._addSingleValue(S,B,a._getValue(s,true));}}}}return JSON.stringify(S);};a.prototype._getParameterMetaData=function(n,f){var i,j,g;var b=f.getFilterBarViewMetadata();if(b){for(i=0;i<b.length;i++){g=b[i];for(j=0;j<g.fields.length;j++){if(n===g.fields[j].fieldName){return g.fields[j];}}}}if(f.getAnalyticalParameters){var A=f.getAnalyticalParameters();if(A){for(j=0;j<A.length;j++){if(n===A[j].fieldName){return A[j];}}}}return null;};a.prototype._convertField=function(s,f,c,o){var b,v,d=null,r,e,g,h,i;if(c&&f&&s){b=c[f];if(b){e=this._getParameterMetaData(f,o);if(e){if(e.isCustomFilterField){return;}if(e.filterRestriction===sap.ui.comp.smartfilterbar.FilterType.single){v=(b.value===undefined)?b:b.value;v=a._getValueWithMetadata(o,e,v,true);this._addSingleValue(s,f,v);}else if(e.filterRestriction===sap.ui.comp.smartfilterbar.FilterType.interval){if(b.conditionTypeInfo){this._convertFieldByValue(s,f,c,o,e);}else{r=a.addRangeEntry(s,f);if((e.type==="Edm.DateTime")&&!b.high){b.high=b.low;}else if((e.type==="Edm.String")&&!b.high){d="EQ";}if(e.type==="Edm.Time"){this._addRangeMultipleRangeValues(o,e,r,b.ranges,true);}else if(e.type==="Edm.DateTimeOffset"&&!b.high){if(!this._oFormat){this._oFormat=D.getDateTimeInstance({UTC:false});}d="BT";g=F.parseDateTimeOffsetInterval(b.low);if(g&&(g.length===2)&&g[0]){h={low:g[0],high:g[1]};i=this._oFormat.parse(g[0]);if(i){h.low=i.toISOString();}i=this._oFormat.parse(g[1]);if(i){h.high=i.toISOString();}this._addRangeLowHigh(o,e,r,h,"BT");}else{this._addRangeLowHigh(o,e,r,b,"EQ");}}else if(O.isNumeric(e.type)&&!b.high){g=F.parseFilterNumericIntervalData(b.low);if(g&&(g.length===2)&&g[0]){this._addRangeLowHigh(o,e,r,{low:g[0],high:g[1]},"BT");}else{this._addRangeLowHigh(o,e,r,b,"EQ");}}else{this._addRangeLowHigh(o,e,r,b,d);}}}else if(e.filterRestriction===sap.ui.comp.smartfilterbar.FilterType.multiple){r=a.addRangeEntry(s,f);if(b.items&&b.items.length>0){this._addRangeMultipleSingleValues(o,e,r,b.items);}else if(b.ranges&&b.ranges.length>0){this._addRangeMultipleRangeValues(o,e,r,b.ranges);}else{this._addRangeSingleValue(r,b.value);}}else{this._convertFieldByValue(s,f,c,o,e);}}else{this._convertFieldByValue(s,f,c,o,e);}}}};a.prototype._convertFieldByValue=function(s,f,c,o,b){var d;var r;if(c&&f&&s){d=c[f];if(d){if(d.conditionTypeInfo){if(d.ranges&&d.ranges.length>0){r=a.addRangeEntry(s,f);a.addRanges(r,d.ranges,o,b);}}else if((d.ranges!==undefined)&&(d.items!==undefined)&&(d.value!==undefined)){r=a.addRangeEntry(s,f);if(d.ranges&&d.ranges.length>0){a.addRanges(r,d.ranges,o,b);}if(d.items&&d.items.length>0){this._addRangeMultipleSingleValues(o,b,r,d.items);}if(d.value){this._addRangeSingleValue(r,a._getValueWithMetadata(o,b,d.value));}}else if((d.items!==undefined)&&d.items&&(d.items.length>0)){r=a.addRangeEntry(s,f);this._addRangeMultipleSingleValues(o,b,r,d.items);}else if((d.low!==undefined)&&d.low&&(d.high!==undefined)&&d.high){r=a.addRangeEntry(s,f);this._addRangeLowHigh(o,b,r,d);}else if((d.value!==undefined)&&d.value){this._addSingleValue(s,f,d.value);}else if(d){this._addSingleValue(s,f,d);}}}};a.addRangeEntry=function(s,f){var o={PropertyName:f,Ranges:[]};if(!s.SelectOptions){s.SelectOptions=[];}s.SelectOptions.push(o);return o.Ranges;};a.addRanges=function(r,R,f,o){var s,b,L,h;for(var i=0;i<R.length;i++){s=R[i].exclude?"E":"I";L=a._getValueWithMetadata(f,o,R[i].value1,true);h=null;if(R[i].operation===sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.BT){h=a._getValueWithMetadata(f,o,R[i].value2);}switch(R[i].operation){case sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.Contains:b="CP";if(L){L="*"+L+"*";}break;case sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.StartsWith:b="CP";if(L){L=L+"*";}break;case sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EndsWith:b="CP";if(L){L="*"+L;}break;case sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EQ:case sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.BT:case sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.LE:case sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.GE:case sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.GT:case sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.LT:b=R[i].operation;break;default:q.sap.log.error("ValueHelpRangeOperation is not supported '"+R[i].operation+"'");return;}r.push({Sign:s,Option:b,Low:L,High:h});}};a.prototype._addRangeMultipleSingleValues=function(f,o,r,I){for(var i=0;i<I.length;i++){r.push({Sign:"I",Option:"EQ",Low:a._getValueWithMetadata(f,o,I[i].key,true),High:null});}};a.prototype._addRangeMultipleRangeValues=function(f,o,r,I,t){for(var i=0;i<I.length;i++){r.push({Sign:"I",Option:t?"BT":"EQ",Low:a._getValueWithMetadata(f,o,I[i].value1,true),High:t?a._getValueWithMetadata(f,o,I[i].value2):null});}};a.prototype._addRangeSingleValue=function(r,v){r.push({Sign:"I",Option:"EQ",Low:a._getValue(v,true),High:null});};a.prototype._addRangeLowHigh=function(f,o,r,L,s){var b=s||"BT";r.push({Sign:"I",Option:b,Low:a._getValueWithMetadata(f,o,L.low,true),High:a._getValueWithMetadata(f,o,L.high)});};a.prototype._addParamaterSingleValue=function(s,f,v){if(!s.Parameters){s.Parameters=[];}s.Parameters.push({PropertyName:f,PropertyValue:v});};a.prototype._createRangeSingleValue=function(s,f,v){var r=a.addRangeEntry(s,f);this._addRangeSingleValue(r,v);};a.prototype._addSingleValue=function(s,f,v){var n;if(this._sAPILevel){n=f.split(sap.ui.comp.ANALYTICAL_PARAMETER_PREFIX);if(n.length>1){this._addParamaterSingleValue(s,n[n.length-1],v);}else{this._createRangeSingleValue(s,f,v);}}else{this._addParamaterSingleValue(s,f,v);}};a.prototype._getFields=function(f){var r=[];if(f){for(var i=0;i<f.length;i++){r.push(f[i].name);}}return r;};a._getValue=function(v,u){if((v===null)||(v===undefined)||(v==="")){return(u?"":null);}return""+v;};a._getValueWithMetadata=function(f,o,v,u){if((v===null)||(v===undefined)||(v==="")){return(u?"":null);}else if(f&&o){if((o.type==="Edm.DateTimeOffset")||(o.type==="Edm.DateTime")||(o.type==="Edm.Time")){if(f&&f.isInUTCMode&&f.isInUTCMode()&&f.getDateInUTCOffset){v=f.getDateInUTCOffset(new Date(v)).toJSON();}if(v.indexOf('Z')===(v.length-1)){v=v.substr(0,v.length-1);}}}return""+v;};return a;},true);

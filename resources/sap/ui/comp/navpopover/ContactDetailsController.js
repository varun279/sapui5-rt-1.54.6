/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library','sap/ui/core/Element','sap/ui/layout/form/SimpleForm','sap/ui/layout/form/SimpleFormLayout','sap/m/Title','sap/ui/core/TitleLevel','sap/m/Label','sap/m/Text','sap/m/Image','sap/m/Link','sap/ui/base/ManagedObjectObserver','sap/ui/comp/odata/MetadataAnalyser'],function(q,C,E,S,c,T,d,L,e,I,f,M,g){"use strict";var h=E.extend("sap.ui.comp.navpopover.ContactDetailsController",{metadata:{library:"sap.ui.comp"}});h.prototype.init=function(){this._oObserver=null;};h.prototype.exit=function(){if(this._oObserver){this._oObserver.disconnect();this._oObserver=null;}};h.prototype.getBindingPath4ContactAnnotation=function(b,s,k){if(s===undefined||s===null||!b){return Promise.resolve(null);}if(!this.getModel()){return Promise.resolve(null);}if(!this.getModel().getMetaModel()){return Promise.resolve(null);}var m=this.getModel().getMetaModel();return m.loaded().then(function(){var p;try{m.getMetaContext(b);}catch(o){q.sap.log.error("sap.ui.comp.navpopover.ContactDetailsController.getBindingPath4ContactAnnotation: binding path '"+b+"' is not valid. Error has been caught: "+o);return null;}try{p="/"+s+"('"+k+"')";m.getMetaContext(p);return p;}catch(o){}try{p=s?b+"/"+s:b;m.getMetaContext(p);return p;}catch(o){q.sap.log.error("sap.ui.comp.navpopover.ContactDetailsController.getBindingPath4ContactAnnotation: the path of sContactAnnotationPath '"+b+"/"+s+"' is not valid. Error has been caught: "+o);return null;}});};h.prototype.getContactDetailsAnnotation=function(b){if(!b){return null;}var m=new g(this.getModel());var o=m.getContactAnnotation(b);if(!o){return null;}return o;};h.prototype.getContactDetailsContainers=function(b){var o=this.getContactDetailsAnnotation(b);if(!o){return[];}var a=[];var i=[];var s=[];var j;this._oObserver=new M(function(k){if(k.type==="property"&&k.name==="visible"){var v=false;for(var l=1;l<j.getContent().length;l++){if(j.getContent()[l].getLabelFor&&j.getContent()[l].getLabelFor()){continue;}if(j.getContent()[l].getVisible()){v=true;}}j.setVisible(v);}});var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");this.addProperty2ExpandAndSelect("photo",o,b,i,s);this._addPhoto("photo",o,b,a,this._oObserver);this.addProperty2ExpandAndSelect("fn",o,b,i,s);this._addLabeledText("fn",r.getText("POPOVER_CONTACT_SECTION_NAME"),o,b,a,this._oObserver);this.addProperty2ExpandAndSelect("role",o,b,i,s);this._addLabeledText("role",r.getText("POPOVER_CONTACT_SECTION_ROLE"),o,b,a,this._oObserver);this.addProperty2ExpandAndSelect("title",o,b,i,s);this._addLabeledText("title",r.getText("POPOVER_CONTACT_SECTION_JOBTITLE"),o,b,a,this._oObserver);this.addProperty2ExpandAndSelect("org",o,b,i,s);this._addLabeledText("org",r.getText("POPOVER_CONTACT_SECTION_DEPARTMENT"),o,b,a,this._oObserver);this._addEmails(o,b,i,s,a,this._oObserver);this._addTels(o,b,i,s,a,this._oObserver);this._addAddresses(o,b,i,s,a,this._oObserver);if(!a.length){return[];}a.splice(0,0,new T({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_CONTACT_SECTION_TITLE"),level:d.H2}));j=new S({maxContainerCols:1,editable:false,layout:c.ResponsiveGridLayout,content:a});this._requestData(j,b,i,s);return[j];};h.prototype._addPhoto=function(a,o,b,i,O){if(!o[a]){return;}var B=b+"/"+o[a].Path;if(this.isPropertyHidden(B)){return;}var j=new I({src:{path:B},visible:{path:B,formatter:function(v){return!!v;}},decorative:false});j.addStyleClass("sapUiIcon");j.addStyleClass("navigationPopoverThumbnail");O.observe(j,{properties:["visible"]});i.push(j);};h.prototype._addLabeledText=function(a,l,o,b,i,O){if(!o[a]){return;}var B=b+"/"+o[a].Path;if(this.isPropertyHidden(B)){return;}var j=new e({text:{path:B},visible:{path:B,formatter:function(v){return!!v;}}});var k=new L({text:l,labelFor:j.getId()});O.observe(j,{properties:["visible"]});i.push(k);i.push(j);};h.prototype._addEmails=function(o,B,i,s,j,O){if(!o.email||!o.email.length){return;}var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");var k=q.extend(true,[],o.email);k.filter(function(a){return!a.processed&&a.type&&(a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")>-1||a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/work")>-1);}).sort(function(a,b){if(a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")>-1&&b.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")<0){return-1;}if(b.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")>-1&&a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")<0){return 1;}return 0;}).forEach(function(a){this.addProperty2ExpandAndSelect("address",a,B,i,s);this._addLabeledEmail("address",r.getText("POPOVER_CONTACT_SECTION_EMAIL"),a,B,j,O);a.processed=true;},this);};h.prototype._addTels=function(o,B,i,s,j,O){if(!o.tel||!o.tel.length){return;}var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");var t=q.extend(true,[],o.tel);t.filter(function(a){return!a.processed&&a.type&&a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/work")>-1;}).sort(function(a,b){if(a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/preferred")>-1){return-1;}if(b.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/preferred")>-1){return 1;}return 0;}).forEach(function(a){this.addProperty2ExpandAndSelect("uri",a,B,i,s);this._addLabeledTel("uri",r.getText("POPOVER_CONTACT_SECTION_PHONE"),a,B,j,O);a.processed=true;},this);t.filter(function(a){return!a.processed&&a.type&&a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/cell")>-1;}).sort(function(a,b){if(a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/preferred")>-1){return-1;}if(b.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/preferred")>-1){return 1;}return 0;}).forEach(function(a){this.addProperty2ExpandAndSelect("uri",a,B,i,s);this._addLabeledTel("uri",r.getText("POPOVER_CONTACT_SECTION_MOBILE"),a,B,j,O);a.processed=true;},this);t.filter(function(a){return!a.processed&&a.type&&a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/fax")>-1;}).sort(function(a,b){if(a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/preferred")>-1){return-1;}if(b.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/preferred")>-1){return 1;}return 0;}).forEach(function(a){this.addProperty2ExpandAndSelect("uri",a,B,i,s);this._addLabeledTel("uri",r.getText("POPOVER_CONTACT_SECTION_FAX"),a,B,j,O);a.processed=true;},this);t.filter(function(a){return!a.processed&&a.type&&a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.PhoneType/preferred")>-1;}).forEach(function(a){this.addProperty2ExpandAndSelect("uri",a,B,i,s);this._addLabeledTel("uri",r.getText("POPOVER_CONTACT_SECTION_PHONE"),a,B,j,O);a.processed=true;},this);};h.prototype._addAddresses=function(o,B,i,s,j,O){if(!o.adr||!o.adr.length){return;}var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");var A=q.extend(true,[],o.adr);A.filter(function(a){return!a.processed&&a.type&&(a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")>-1||a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/work")>-1);}).sort(function(a,b){if(a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")>-1&&b.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")<0){return-1;}if(b.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")>-1&&a.type.EnumMember.indexOf("com.sap.vocabularies.Communication.v1.ContactInformationType/preferred")<0){return 1;}return 0;}).forEach(function(a){this._addLabeledAddress(r.getText("POPOVER_CONTACT_SECTION_ADR"),a,B,i,s,j,O);a.processed=true;},this);};h.prototype._addLabeledAddress=function(l,a,b,i,s,j,o){var p=[];["street","code","locality","region","country"].forEach(function(A){this.addProperty2ExpandAndSelect(A,a,b,i,s);var B;if(a[A]){B=b+"/"+a[A].Path;}p.push(B&&!this.isPropertyHidden(B)?{path:B}:{path:"$notExisting"});},this);if(!p.length){return;}var k=new e({text:{parts:p,formatter:function(n,r,t,R,u){var v=[];if(n){v.push(n);}if(r&&t){v.push(r+" "+t);}else{if(r){v.push(r);}if(t){v.push(t);}}if(R){v.push(R);}if(u){v.push(u);}return v.join(', ');}},visible:{parts:p,formatter:function(n,r,t,R,u){return!!(n||r||t||R||u);}}});var m=new L({text:l,labelFor:k.getId()});o.observe(k,{properties:["visible"]});j.push(m);j.push(k);};h.prototype._addLabeledTel=function(a,l,t,b,i,o){if(!t[a]||!b){return;}var B=b+"/"+t[a].Path;if(this.isPropertyHidden(B)){return;}var j=new f({href:{path:B,formatter:function(v){return v?"tel:"+v:v;}},text:{path:B},visible:{path:B,formatter:function(v){return!!v;}}});var k=new L({text:l,labelFor:j.getId()});o.observe(j,{properties:["visible"]});i.push(k);i.push(j);};h.prototype._addLabeledEmail=function(a,l,o,b,i,O){if(!o[a]||!b){return;}var B=b+"/"+o[a].Path;if(this.isPropertyHidden(B)){return;}var j=new f({href:{path:B,formatter:function(v){return v?"mailto:"+v:v;}},text:{path:B},visible:{path:B,formatter:function(v){return!!v;}}});var k=new L({text:l,labelFor:j.getId()});O.observe(j,{properties:["visible"]});i.push(k);i.push(j);};h.prototype.addProperty2ExpandAndSelect=function(a,A,b,i,s){if(!A[a]||!b){return;}var B=b+"/"+A[a].Path;if(!B){return;}if(B.indexOf("/")!==0){throw("sap.ui.comp.navpopover.ContactDetailsController.addProperty2ExpandAndSelect: the path of sBindingPathOfProperty '"+B+"' is not valid.");}var p=B.split("/");p.shift();p.shift();var j=p.join("/");if(j){s.push(j);}p.pop();var k=p.join("/");if(!k){return;}var l=i.filter(function(P){return P===k;});if(!l.length){i.push(k);}};h.prototype.isPropertyHidden=function(p){var m;if(!this.getModel()){q.sap.log.error("sap.ui.comp.navpopover.ContactDetailsController.isPropertyHidden: the model does not exist");return false;}if(!this.getModel().getMetaModel()){q.sap.log.error("sap.ui.comp.navpopover.ContactDetailsController.isPropertyHidden: the model should be the ODataModel");return false;}try{m=this.getModel().getMetaModel().getMetaContext(p);}catch(o){q.sap.log.error("sap.ui.comp.navpopover.ContactDetailsController.isPropertyHidden: the path of property path '"+p+"' is not valid. Error has been caught: "+o);return false;}var P=m.getProperty(m.getPath());return g.isHidden(P);};h.prototype._requestData=function(s,b,a,i){var p={};if(a.length){p.expand=a.join(",");}if(i.length){p.select=i.join(",");}var B="/"+b.split("/")[1];s.bindContext({path:B,parameters:p,events:{change:function(){s.invalidate();}}});};return h;},true);

/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object","./Utilities","./thirdparty/three","./thirdparty/ColladaLoader"],function(q,B,U,T,C){"use strict";var t="sap.ui.vbm.adapter3d.SceneBuilder";var l=q.sap.log;var d=T.Math.degToRad;var a=T.Box3;var F=T.Face3;var M=T.Matrix4;var V=T.Vector2;var b=T.Vector3;var r="_sapRefCount";var c;var f;var n;var g=U.toBoolean;var h=U.toFloat;var i=U.toVector3;var j=U.toColor;var k=U.toDeltaColor;var m=U.applyColor;var S=B.extend("sap.ui.vbm.adapter3d.SceneBuilder",{constructor:function(e,o,p){B.call(this);this._context=e;this._controller=p;this._root=o;this._textureLoader=null;this._colladaLoader=null;this._textures=new Map();this._boxGeometryWith4SidedTexture=null;this._boxGeometryWith6SidedTexture=null;}});S.prototype.destroy=function(){this._context=null;this._root=null;B.prototype.destroy.call(this);};S.prototype.synchronize=function(){var e=this;return new Promise(function(o,p){var s=new Map();var u=function(E){if(s.has(E)){s.get(E).refCount+=1;}else{s.set(E,{object3D:null,refCount:1});}};var v=new Set();var w=sap.ui.vbm.findInArray(e._context.windows,function(w){return w.type==="default";});var x=w&&sap.ui.vbm.findInArray(e._context.scenes,function(x){return x.id===w.refScene;});if(!x){o();return;}if(e._context.setupView){e._setupView(x.position,x.zoom,x.pitch,x.yaw);e._context.setupView=false;}var y=e._context.voQueues.toAdd.get(x)||[];var z=e._context.voQueues.toUpdate.get(x)||[];var A=e._context.voQueues.toRemove.get(x)||[];var D=[].concat(y,z);D.filter(function(E){return E.isColladaModel&&E.model&&E.model!==E._lastModel;}).map(function(E){return E.model;}).forEach(u);D.filter(function(E){return E.texture&&E.texture!==E._lastTexture;}).map(function(E){return E.texture;}).forEach(v.add,v);e._loadTextures(v).then(function(){return e._loadModels(s);}).then(function(){A.forEach(e._destroyVisualObjectInstance.bind(e,e._root));z.forEach(e._updateVisualObjectInstance.bind(e,e._root,s));y.forEach(e._addVisualObjectInstance.bind(e,e._root,s));e._cleanupCache();o();}).catch(function(E){p(E);});});};S.prototype._getGeometrySize=function(){return 2.0;};S.prototype._setupView=function(p,z,e,y){var o=new b(0,0,-5);var s=new b(0,0,0);p=p||"0;0;0";var u=p.split(";");p=new b(parseFloat(u[0]),parseFloat(u[1]),parseFloat(u[2]));var v=new b(p.x,p.z,-p.y);this._root.position.copy(v);z=parseFloat(z||"1");if(z===0){z=1;}else if(z<0){z=0.1;}var w=this._getGeometrySize()*2/z;e=parseFloat(e||"0");y=parseFloat(y||"0");e=(e%180===0?e+1:e);var x=new M();x.makeRotationX(d(e+180));var A=new M();A.makeRotationZ(d(-(y+180)));var D=new M();D.multiplyMatrices(A,x);var E=new b();E.subVectors(s,o);E.normalize();E.multiplyScalar(w);E.applyMatrix4(D);this._controller.reset({target:s.clone(),zoom:this._controller.saveState().zoom,position:new b(-E.x,-E.z,E.y)});};S.prototype._loadTextures=function(e){var p=[];e.forEach(function(o){if(!this._textures.has(o)){p.push(this._loadTexture(o));}},this);return Promise.all(p);};S.prototype._loadTexture=function(e){var o=this;return new Promise(function(p,s){o._getTextureLoader().load(o._context.resources.get(e),function(u){u.flipY=false;u[r]=0;o._textures.set(e,u);p();},null,function(x){l.error("Failed to load texture from Data URI: "+e,"status: "+x.status+", status text: "+x.statusText,t);p();});});};S.prototype._loadModels=function(e){var p=[];e.forEach(function(o,s){p.push(this._loadModel(s,o));},this);return Promise.all(p);};S.prototype._loadModel=function(o,p){var s=this;return new Promise(function(u,v){try{s._getColladaLoader().parse(s._context.resources.get(o),function(w){f(w.scene);p.object3D=w.scene;w.scene.scale.set(1,1,-1);u();});}catch(e){l.error("Failed to load Collada model from resource: "+o,e instanceof Error?e.message:"",t);u();}});};S.prototype._releaseTexture=function(e){if(e.hasOwnProperty(r)){e[r]-=1;}else{e.dispose();}return this;};S.prototype._addRefTexture=function(e){if(!e.hasOwnProperty(r)){e[r]=0;}e[r]+=1;return this;};S.prototype._releaseGeometry=function(e){if(e.hasOwnProperty(r)){e[r]-=1;}else{e.dispose();}return this;};S.prototype._addRefGeometry=function(e){if(!e.hasOwnProperty(r)){e[r]=0;}e[r]+=1;return this;};S.prototype._cleanupCache=function(){this._textures.forEach(function(e){if(e[r]===0){e.dispose();this._textures.delete(e);}},this);if(this._boxGeometryWith4SidedTexture&&this._boxGeometryWith4SidedTexture[r]===0){this._boxGeometryWith4SidedTexture.dispose();this._boxGeometryWith4SidedTexture=null;}if(this._boxGeometryWith6SidedTexture&&this._boxGeometryWith6SidedTexture[r]===0){this._boxGeometryWith6SidedTexture.dispose();this._boxGeometryWith6SidedTexture=null;}return this;};S.prototype._destroyVisualObjectInstance=function(e,o){var p=this;if(o.object3D){o.object3D.traverse(function(s){if(s.isMesh){var u=s.material;if(u){var v=u.map;if(v){p._releaseTexture(v);u.map=null;}u.dispose();s.material=null;}var w=s.geometry;if(w){p._releaseGeometry(w);s.geometry=null;}}});e.remove(o.object3D);o.object3D=null;o._lastModel=null;o._lastTexture=null;o._lastTexture6=null;}return this;};S.prototype._updateVisualObjectInstance=function(e,o,p){if(p.isColladaModel){if(p.model!==p._lastModel){return this._destroyVisualObjectInstance(e,p)._addVisualObjectInstance(e,o,p);}this._assignColladaModelProperties(p);}else if(p.isBox){this._assignBoxProperties(p);}return this;};S.prototype._addVisualObjectInstance=function(e,o,p){if(p.isColladaModel){p._lastModel=p.model;var s=o.get(p.model);var u=--s.refCount===0?s.object3D:s.object3D.clone();p.object3D=new T.Group();p.object3D.add(u);if(g(p.normalize)){n(u);}this._assignMaterial(p.object3D,this._createMaterial());this._assignColladaModelProperties(p);}else if(p.isBox){p.object3D=new T.Group();p.object3D.add(new T.Mesh(undefined,this._createMaterial()));this._assignBoxProperties(p);}if(p.object3D){e.add(p.object3D);}return this;};S.prototype._assignColladaModelProperties=function(e){this._assignProperties(e);return this;};S.prototype._assignBoxProperties=function(e){if(e._lastTexture6!==e.texture6){var o=e.object3D.children[0];if(o.geometry){this._releaseGeometry(o.geometry);}o.geometry=this._getBoxGeometry(g(e.texture6));this._addRefGeometry(o.geometry);if(g(e.normalize)){n(o);}e._lastTexture6=e.texture6;}this._assignProperties(e);return this;};S.prototype._assignProperties=function(e){if(e._lastTexture&&e._lastTexture!==e.texture){this._removeTexture(e);}if(e.texture){this._assignTexture(e);}e._lastTexture=e.texture;m(e,e[g(e["VB:s"])?"selectColor":"color"]);var s=i(e.scale);e.object3D.scale.set(s[0],s[1],s[2]);var o=i(e.rot);e.object3D.rotation.set(d(o[0]),d(o[1]),d(o[2]),"YXZ");var p;if(e.isBox){p=new b(0,0,-1);}else{var u=e.object3D.children[0].vbBox;p=new b(0,0,-1.0*(u.min.z>0?u.min.z:u.max.z));}var v=new M();v.makeRotationFromEuler(new T.Euler(d(o[0]),d(o[1]),d(o[2]),"YXZ"));var w=new M();w.makeScale(s[0],s[1],s[2]);w.multiply(v);p.applyMatrix4(w);p.z=-p.z;var x=i(e.pos);var y=new b(x[0],x[1],x[2]);y.sub(p);e.object3D.position.set(y.x,y.y,y.z);e.object3D.traverse(function(z){z._sapInstance=e;});return this;};S.prototype._removeTexture=function(e){if(e.object3D){var o=this;e.object3D.traverse(function(p){if(p.isMesh&&p.material&&p.material.map){o._releaseTexture(p.material.texture);p.material.map=null;}});}return this;};S.prototype._assignTexture=function(e){if(e.object3D){var o=this;var p=this._textures.get(e.texture);e.object3D.traverse(function(s){if(s.isMesh&&s.material){s.material.map=p;o._addRefTexture(p);}});}return this;};S.prototype._createMaterial=function(){return new T.MeshPhongMaterial({shininess:1,specular:0x101009,side:T.FrontSide});};S.prototype._assignMaterial=function(o,e){o.traverse(function(p){if(p.isMesh){p.material=e;}});return this;};S.prototype._getBoxGeometry=function(e){var o=e?"_boxGeometryWith6SidedTexture":"_boxGeometryWith4SidedTexture";return this[o]||(this[o]=c(e));};S.prototype._getTextureLoader=function(){return this._textureLoader||(this._textureLoader=new T.TextureLoader());};S.prototype._getColladaLoader=function(){return this._colladaLoader||(this._colladaLoader=new C());};f=function(e){var o=[];e.traverse(function(p){if(p.isLight||p.isCamera){o.push(p);}});o.forEach(function(p){while(p&&p!==e){var s=p.parent;if(p.children.length===0){s.remove(p);}p=s;}});return e;};n=function(e){var o=new a().setFromObject(e);var p=o.getCenter();o.min.sub(new b(p.x,p.y,-p.z));o.max.sub(new b(p.x,p.y,-p.z));var s=Math.max(Math.abs(o.min.x),Math.abs(o.min.y),Math.abs(o.min.z),Math.abs(o.max.x),Math.abs(o.max.y),Math.abs(o.max.z));if(s){s=1/s;}o.min.set(o.min.x*s,o.min.y*s,-o.min.z*s);o.max.set(o.max.x*s,o.max.y*s,-o.max.z*s);U.swap(o,"min","max");e.vbBox=o;var u=new M().makeScale(s,s,s);var v=new M().makeTranslation(-p.x,-p.y,-p.z);e.updateMatrix();u.multiply(v);u.multiply(e.matrix);u.decompose(e.position,e.quaternion,e.scale);return e;};c=function(e){var o=new T.Geometry();var p=0.1;o.vertices.push(new b(p,p,-p),new b(p,-p,-p),new b(-p,-p,-p),new b(-p,p,-p),new b(p,p,p),new b(-p,p,p),new b(-p,-p,p),new b(p,-p,p),new b(p,p,-p),new b(p,p,p),new b(p,-p,p),new b(p,-p,-p),new b(p,-p,-p),new b(p,-p,p),new b(-p,-p,p),new b(-p,-p,-p),new b(-p,-p,-p),new b(-p,-p,p),new b(-p,p,p),new b(-p,p,-p),new b(p,p,p),new b(p,p,-p),new b(-p,p,-p),new b(-p,p,p));var s=new T.Color(0.5,0.5,0.5);o.faces.push(new F(0,2,3,new b(0,0,-1),s),new F(0,1,2,new b(0,0,-1),s),new F(4,5,6,new b(0,0,1),s),new F(4,6,7,new b(0,0,1),s),new F(8,10,11,new b(1,0,0),s),new F(8,9,10,new b(1,0,0),s),new F(12,14,15,new b(0,-1,0),s),new F(12,13,14,new b(0,-1,0),s),new F(16,18,19,new b(-1,0,0),s),new F(16,17,18,new b(-1,0,0),s),new F(20,22,23,new b(0,1,0),s),new F(20,21,22,new b(0,1,0),s));var u;if(e){u=[new V(2/3,0.5),new V(1.0,0.5),new V(1.0,1.0),new V(2/3,1.0),new V(2/3,0.5),new V(2/3,0.0),new V(1.0,0.0),new V(1.0,0.5),new V(2/3,0.5),new V(2/3,1.0),new V(1/3,1.0),new V(1/3,0.5),new V(2/3,0.0),new V(2/3,0.5),new V(1/3,0.5),new V(1/3,0.0),new V(1/3,0.5),new V(1/3,1.0),new V(0.0,1.0),new V(0.0,0.5),new V(0.0,0.5),new V(0.0,0.0),new V(1/3,0.0),new V(1/3,0.5)];}else{u=[new V(0.5,0.5),new V(1.0,0.5),new V(1.0,1.0),new V(0.5,1.0),new V(0.5,0.5),new V(1.0,0.5),new V(1.0,1.0),new V(0.5,1.0),new V(0.5,0.5),new V(0.5,1.0),new V(0.0,1.0),new V(0.0,0.5),new V(0.5,0.5),new V(0.5,0.0),new V(1.0,0.0),new V(1.0,0.5),new V(0.5,0.5),new V(0.5,1.0),new V(0.0,1.0),new V(0.0,0.5),new V(0.0,0.5),new V(0.0,0.0),new V(0.5,0.0),new V(0.5,0.5)];}o.faceVertexUvs[0].push([u[0],u[2],u[3]],[u[0],u[1],u[2]],[u[5],u[6],u[7]],[u[5],u[7],u[4]],[u[8],u[10],u[11]],[u[8],u[9],u[10]],[u[12],u[14],u[15]],[u[12],u[13],u[14]],[u[16],u[18],u[19]],[u[16],u[17],u[18]],[u[20],u[22],u[23]],[u[20],u[21],u[22]]);return o;};return S;});

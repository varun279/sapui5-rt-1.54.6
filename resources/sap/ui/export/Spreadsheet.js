/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./library','./ExportDialog','sap/ui/Device'],function(q,l,E,D){'use strict';var S=function(s){this.mSettings=q.extend(true,{},s);};S.prototype.cancel=function(){if(this.process){this.process.cancel();this.process=null;}};S.prototype.onprogress=function(P){q.sap.log.debug("Spreadsheet export: "+P+"% loaded.");};var p=(function(){var r={};for(var k in l.EdmType){r[k.toLowerCase()]=k;}return r;})();var a="Spreadsheet export: ";function v(P){var b=a;var o="odata";var e=".xlsx";var c=P.count||1;var s;P.fileName=P.fileName||'export';if(!q.sap.endsWith(P.fileName,e)){P.fileName+=e;}var d=P.dataSource;if(typeof d==="string"){P.dataSource={dataUrl:d,type:o,count:c};P.count=c;}else if(Array.isArray(d)){var f=d.map(function(r){return q.extend(true,{},r);});P.dataSource={data:f,type:"array"};}else if(d&&d.dataUrl){s=(d.type||o).toLowerCase();P.dataSource.type=s;if(d.useBatch){}}var g=P.dataSource.sizeLimit;if(s===o&&(!g||isNaN(g))){g=Math.round(c/1000)*200;g=Math.min(10000,Math.max(g,200));q.sap.log.error(b+"dataSource.sizeLimit is not provided. sizeLimit is set to "+g);P.dataSource.sizeLimit=g;}var h=P&&P.workbook;h.columns.forEach(function(i){i.label=i.label||(i.property instanceof Array?i.property[0]:i.property)||"";var w=i.width;if(typeof w==="string"){var W=w.toLowerCase();w=parseFloat(W);if(W.indexOf("em")>0){w=w*2;}else if(W.indexOf("px")>0){w=w/8;}}if(isNaN(w)||w<1){w=10;}if(i.label.length<30){w=Math.max(i.label.length,w);}i.width=Math.round(w);if(i.type){i.type=i.type.toLowerCase();if(!p[i.type]){q.sap.log.error(b+"insupported column property type "+i.type+". Type is reverted to 'string'.");i.type="";}if(i.type==="currency"&&!i.unitProperty){q.sap.log.error(b+"missing unit property for currency column. Type is reverted to 'string'.");i.type="";}}var j=i.scale;if(i.type==="number"&&isNaN(j)&&j!=="variable"){q.sap.log.warning(b+"scale parameter for numerical column configuration is missing.");}if(typeof j==="string"){j=parseInt(j,10);}if(isNaN(j)){j=null;}i.scale=j;var t=(i.textAlign+"").toLowerCase();if(t!==""&&["left","right","center","begin","end"].indexOf(t)==-1){q.sap.log.warning(b+"incorrect column alignment property: "+t+". Default alignment is used.");t="";}i.textAlign=t;});}S.prototype.build=function(){var s=this;var P=q.extend(true,{},this.mSettings);v(P);return new Promise(function(r,R){var b;var c=D.system.desktop?2000000:100000;var n=P.dataSource.count;var d=P.workbook.columns.length;function o(m){if(!isNaN(m.progress)){if(b){b.updateStatus(m.progress);}s.onprogress(m.progress);}if(m.error||m.finish){s.process=null;if(b){b.finish();}if(m.error){R(m.error);E.showErrorMessage(m.error);}else if(m.finish){r();}}}if(s.process){R("Cannot start export: the process is already running");return;}function e(){if(P.showProgress!==false){b=E.getProgressDialog();b.oncancel=function(){return s.process&&s.process.cancel();};b.open();}s.process=sap.ui.requireSync("sap/ui/export/SpreadsheetExport").execute(P,o);}if(n*d>c){E.showWarningDialog({rows:n,columns:d}).then(e).catch(function(){R('Export cancelled by the user.');});}else{e();}});};return S;},true);

/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2018 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/mdc/base/FieldInfoBase','sap/ui/mdc/base/linkinfo/Panel','sap/ui/mdc/base/linkinfo/Item','sap/m/Link','sap/ui/mdc/base/linkinfo/Util','sap/ui/model/json/JSONModel','sap/ui/core/InvisibleText','sap/m/ResponsivePopover','sap/ui/mdc/base/linkinfo/Factory'],function(F,L,a,b,U,J,I,R,c){"use strict";var d=F.extend("sap.ui.mdc.FlpActionHandler",{metadata:{library:"sap.ui.mdc",specialSettings:{metadataContexts:{provider:"sap/ui/mdc/experimental/provider/control/FlpActionHandler"}},properties:{semanticObject:{type:"string"},additionalSemanticObjects:{type:"string[]",defaultValue:[]},contactAnnotationPath:{type:"string",defaultValue:undefined},semanticObjectMapping:{type:"object",defaultValue:{}},enablePersonalization:{type:"boolean",defaultValue:true}}}});d.prototype.init=function(){var m=new J({availableActions:[],mainAction:undefined,bindingPathOfAnnotation:undefined});m.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);m.setSizeLimit(1000);this.setModel(m,"$sapuimdcFlpActionHandler");this._proxyOnModelContextChange=jQuery.proxy(this._onModelContextChange,this);this.attachModelContextChange(this._proxyOnModelContextChange);};d.prototype.exit=function(){this.detachModelContextChange(this._proxyOnModelContextChange);};d.prototype.setContactAnnotationPath=function(C){this.setProperty("contactAnnotationPath",C);this._setBindingPath4ContactAnnotation();return this;};d.prototype.setSemanticObject=function(s){this.setProperty("semanticObject",s);this._retrieveNavigationTargets();return this;};d.prototype.isTriggerable=function(){if(this._hasExtraContent()){return true;}return this._getTriggerableActions().length>0;};d.prototype.getDirectLink=function(){if(this._hasExtraContent()){return null;}var A=this._getTriggerableActions();if(A.length!==1){return null;}return new b({text:A[0].text,target:A[0].target,href:A[0].href});};d.prototype.createPopover=function(){var m=this._getInternalModel();var i=new I({text:m.getProperty("/mainAction/text")?m.getProperty("/mainAction/text"):""});return this.getPopoverContent().then(function(p){return new R({contentWidth:"380px",horizontalScrolling:false,showHeader:sap.ui.Device.system.phone,placement:sap.m.PlacementType.Auto,ariaLabelledBy:i,content:[p,i],beforeClose:function(){this.destroyContent();}});});};d.prototype.getPopoverContent=function(){var s=this._getNavigationContainerStableId();if(!s){jQuery.sap.log.error("FlpActionHandler: Due to undefined stable ID the button of action personalization is set to disabled");}var m=this._getInternalModel();var p=new L({mainItem:new a({href:{path:"$sapuimdcFlpActionHandler>/mainAction/href"},text:{path:"$sapuimdcFlpActionHandler>/mainAction/text"},target:{path:"$sapuimdcFlpActionHandler>/mainAction/target"},description:{path:"$sapuimdcFlpActionHandler>/mainAction/description"}}),items:{path:'$sapuimdcFlpActionHandler>/availableActions',templateShareable:false,template:new a({href:"{$sapuimdcFlpActionHandler>href}",text:"{$sapuimdcFlpActionHandler>text}",target:"{$sapuimdcFlpActionHandler>target}",description:"{$sapuimdcFlpActionHandler>description}"})},enablePersonalization:this.getEnablePersonalization()&&!!s});p.setModel(m,"$sapuimdcFlpActionHandler");return Promise.resolve(p);};d.prototype._onModelContextChange=function(){if(!this.getBindingContext()){return;}this._setBindingPath4ContactAnnotation();};d.prototype._setBindingPath4ContactAnnotation=function(){var B=this.getBindingContext()?this.getBindingContext().getPath():undefined;var C=this.getContactAnnotationPath();if(!this.getModel()||!B||C===undefined){return;}};d.prototype._retrieveNavigationTargets=function(){var s=this.getSemanticObject();var A=this.getAdditionalSemanticObjects()||[];var e="";var C=this.getControl();var o=this._getAppComponentForControl(C);var S=this._calculateSemanticAttributes(s,A,this.getSemanticObjectMapping(),C);var m=this._getInternalModel();U.retrieveNavigationTargets(s,A,e,o,S).then(function(n){m.setProperty("/availableActions",this._updateVisibilityOfAvailableActions(n.availableActions));m.setProperty("/mainAction",n.mainNavigation);this.fireDataUpdate();}.bind(this));};d.prototype._calculateSemanticAttributes=function(s,A,S,C){var B=C&&C.getBindingContext();if(!B||!S||(!s&&!(A&&A.length))){return{};}var r={};var o=B.getObject(B.getPath());var e=[s].concat(A);e.forEach(function(f){r[f]={};for(var g in o){if(g==="__metadata"){continue;}if(o[g]===undefined||o[g]===null){continue;}if(jQuery.isPlainObject(o[g])){continue;}var h=(S&&S[f]&&S[f][g])?S[f][g]:g;if(r[f][h]){jQuery.sap.log.error("During the mapping of the attribute "+g+" a clash situation is occurred. This can lead to wrong navigation later on.");}r[f][h]=o[g];}});return r;};d.prototype._onAvailableActionsPersonalizationPress=function(e){var t=this;var p=e.getSource();this.getPopover().setModal(true);p.openSelectionDialog(false,true,undefined,true,undefined).then(function(){if(t.getPopover()){t.getPopover().setModal(false);}});};d.prototype._updateVisibilityOfAvailableActions=function(m){var M=U.getStorableAvailableActions(m);var h=M.some(function(o){return!!o.isSuperiorAction;});M.forEach(function(o,i){if(m.length>10){o.visible=false;}if(h){o.visible=false;}if(o.isSuperiorAction){o.visible=true;}});return m;};d.prototype._getNavigationContainerStableId=function(){var C=this.getControl();if(!C){jQuery.sap.log.error("FlpActionHandler: Stable ID could not be determined because the control is undefined");return undefined;}var A=this._getAppComponentForControl(C);if(!A){jQuery.sap.log.error("FlpActionHandler: Stable ID could not be determined because the app component is not defined for control '"+C.getId()+"'");return undefined;}var s=[this.getSemanticObject()].concat(this.getAdditionalSemanticObjects());U.sortArrayAlphabetical(s);if(!s.length){jQuery.sap.log.error("FlpActionHandler: Stable ID could not be determined because the property 'persistencyKey' is not defined");return undefined;}return A.createId("sapuimdcbaseactionActionHandler---"+s.join("--"));};d.prototype._getTriggerableActions=function(){var m=this._getInternalModel();var A=m.getProperty('/availableActions').concat(m.getProperty('/mainAction')?m.getProperty('/mainAction'):[]);return A.filter(function(o){return!!o.href;});};d.prototype._hasExtraContent=function(){return this._getInternalModel().getProperty("/bindingPathOfAnnotation");};d.prototype._getInternalModel=function(){return this.getModel("$sapuimdcFlpActionHandler");};d.prototype._getAppComponentForControl=function(C){return c.getService("FlUtils").getAppComponentForControl(C);};return d;},true);

/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2018 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/core/Control','sap/ui/model/json/JSONModel','./FilterFieldRenderer','sap/m/MultiInput','sap/m/Token','sap/ui/model/Filter','sap/ui/model/Sorter',"sap/ui/model/base/ManagedObjectModel","sap/ui/base/ManagedObjectObserver","sap/ui/mdc/base/type/DateRange",'sap/ui/mdc/library'],function(q,C,J,F,M,T,a,S,b,c,D,l){"use strict";var E=l.EditMode;var d=C.extend("sap.ui.mdc.base.FilterField",{constructor:function(i,s){this._oManagedObjectModel=null;this._oActiveDelegate=null;C.apply(this,arguments);},metadata:{properties:{showValueHelp:{type:"boolean",group:"Data",defaultValue:true},dataType:{type:"any",group:"Data",defaultValue:"sap.ui.model.type.String"},dataTypeConstraints:{type:"object",group:"Data",defaultValue:null},dataTypeFormatOptions:{type:"object",group:"Data",defaultValue:null},fieldPath:{type:"string",group:"Data",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"15rem"},editable:{type:"boolean",group:"Data",defaultValue:true},editMode:{type:"sap.ui.mdc.EditMode",group:"Data",defaultValue:E.Editable},maxConditions:{type:"int",group:"Behavior",defaultValue:-1},placeholder:{type:"string",group:"Behavior",defaultValue:""},required:{type:"boolean",group:"Misc",defaultValue:false},valueState:{type:"sap.ui.core.ValueState",group:"Appearance",defaultValue:sap.ui.core.ValueState.None},valueStateText:{type:"string",group:"Misc",defaultValue:null}},events:{valueHelpRequest:{},change:{parameters:{value:{type:"object"},type:{type:"string"},valid:{type:"boolean"}}},liveChange:{parameters:{value:{type:"string"},escPressed:{type:"boolean"}}}},aggregations:{_input:{type:"sap.ui.core.Control",multiple:false,hidden:true},conditions:{type:"sap.ui.mdc.Condition",multiple:true,_doesNotRequireFactory:true},content:{type:"sap.ui.core.Control",multiple:false},fieldHelp:{type:"sap.ui.mdc.base.FieldHelpBase",multiple:false}},publicMethods:[],defaultAggregation:"content"}});d.prototype.init=function(){this._oManagedObjectModel=new b(this);this._oManagedObjectModel.setSizeLimit(1000);this._oManagedObjectModel.attachEvent("propertyChange",this._updateConditionModel.bind(this));this._oObserver=new c(_.bind(this));this._oObserver.observe(this,{aggregations:["fieldHelp"]});};d.prototype.onAfterRendering=function(){var o=this.getAggregation("_input");if(o){var i=o.getFocusDomRef();q(i).attr("autocomplete","off");}};function _(o){if(o.name=="fieldHelp"&&o.child){e.call(this,o.child,o.mutation);}}function e(o,m){var i=false;if(m=="remove"){o.detachEvent("select",f,this);o.detachEvent("navigate",g,this);}else if(m=="insert"){o.attachEvent("select",f,this);o.attachEvent("navigate",g,this);i=true;}var n=this.getAggregation("_input");if(n&&n.setShowValueHelp){n.setShowValueHelp(i);}}function f(o){}function g(o){var v=o.getParameter("value");var i=this.getAggregation("_input");if(i&&i.setDOMValue){i.setDOMValue(v);i._doSelect();}this.fireLiveChange({value:v});}d.prototype._fireValueHelpRequest=function(o){if(this.hasListeners("valueHelpRequest")){this.fireValueHelpRequest(o);return;}var i=this.getFieldHelp();if(i){i.setFilterValue(" ");i.setSelectedKey();i.toggleOpen();}};d.prototype.onsapup=function(o){var i=this.getFieldHelp();if(i){o.preventDefault();o.stopPropagation();i.navigate(-1);}};d.prototype.onsapdown=function(o){var i=this.getFieldHelp();if(i){o.preventDefault();o.stopPropagation();i.navigate(1);}};d.prototype.getFilterOperatorConfig=function(){if(!this._oFilterOpConfig&&this.getBinding("conditions")){var o=this.getBinding("conditions").getModel();this._oFilterOpConfig=o.getFilterOperatorConfig();}return this._oFilterOpConfig;};d.prototype.updateConditions=function(){var B=this.getBinding("conditions");if(B&&this._oManagedObjectModel){this._oManagedObjectModel.checkUpdate(true,true);B.getModel().addFilterField(this);}return this;};d.prototype.setWidth=function(w){var o=this.getWidth();this.setProperty("width",w,true);if(o!=this.getWidth()){var i=this.getAggregation("_input");if(i){i.setWidth(w);}}return this;};d.prototype.setEditable=function(i){var o=this.getEditable();this.setProperty("editable",i,true);if(o!=this.getEditable()){var I=this.getAggregation("_input");if(I){I.setEditable(i);}}return this;};d.prototype.setPlaceholder=function(p){var o=this.getPlaceholder();this.setProperty("placeholder",p,true);if(o!=this.getPlaceholder()){var i=this.getAggregation("_input");if(i){i.setPlaceholder(p);}}return this;};d.prototype.setMaxConditions=function(m){this.setProperty("maxConditions",m,true);return this;};d.prototype.setRequired=function(r){var o=this.getRequired();this.setProperty("required",r,true);if(o!=this.getRequired()){var i=this.getAggregation("_input");if(i){i.setRequired(r);}}return this;};d.prototype.bindAggregation=function(n,B){if(n==="conditions"){var s=this.getFieldPath();this.sFieldPathUpper=this.getFieldPath().toUpperCase();if(s&&!B.filters){B.filters=new sap.ui.model.Filter({path:"fieldPath",test:this._matchFieldPath.bind(this)});}if(!B.sorter){B.sorter=new sap.ui.model.Sorter("position",false);}}return C.prototype.bindAggregation.apply(this,[n,B]);};d.prototype._matchFieldPath=function(v){var s=this.sFieldPathUpper;return s===v;};d.prototype.setFieldPath=function(v){var o=this.getFieldPath();this.setProperty("fieldPath",v);if(o!==this.getFieldPath()&&this.mBindingInfos["conditions"]){this.sFieldPathUpper=this.getFieldPath().toUpperCase();var i=new a({path:"fieldPath",test:this._matchFieldPath.bind(this)});var B=this.getBinding("conditions");if(B){B.filter(i);}else{this.mBindingInfos["conditions"].filters=i;}}return this;};d.prototype._handleTokenUpdate=function(i){var s=i.getId(),v,B,m,O,n,p;if(s==="tokenUpdate"){if(i.getParameter("type")==="added"){s="change";v=i.getParameter("addedTokens")[0].getText().trim();}if(i.getParameter("type")==="removed"){var r=i.getParameter("removedTokens"),t=[];r.forEach(function(o){t.push(o.getBindingContext("$filterField"));});B=this.getBinding("conditions");B.getModel().deleteConditions(t,B);}}if(s==="change"){q.sap.log.info("mdc:FilterField","_handleTokenUpdate for "+s);var u=i.getSource(),w=this._getDataType(),x=w.getMetadata().getName();B=this.getBinding("conditions");if(u instanceof sap.m.Select){v=i.getParameter("selectedItem").getText();}else{v=v||i.getParameter("value");v=v.trim();}if(i.oSource.setSelectedKey){i.oSource.setSelectedKey();}q.sap.log.info("mdc:FilterField","_handleTokenUpdate sValue "+v);if(!v){if(u instanceof sap.m.MultiInput){}else if(this.getMaxConditions()>=0&&B.getModel().getConditions(this.getFieldPath()).length>0){B.getModel().removeCondition(this.getFieldPath(),0);}B.getModel().removeUIMessage(this.getFieldPath());return;}if(u instanceof sap.m.DateRangeSelection){p=this.getFilterOperatorConfig().getOperator("BT");v=v.replace(" - ","...");m=p.getCondition(v,w);if(m){m.fieldPath=this.getFieldPath();B.getModel().addCondition(m);this.fireChange({value:m,type:"added",valid:true});if(this.getMaxConditions()>=0&&B.getModel().getConditions(this.getFieldPath()).length>1){B.getModel().removeCondition(this.getFieldPath(),0);}return;}}if(this.getFieldHelp()){if(q.sap.containsOrEquals(this.getFieldHelp()._getPopover().getFocusDomRef(),document.activeElement)){return;}if(this.getFieldHelp()._getPopover().isOpen()&&this.getFieldHelp().getProperty("selectedKey")){return;}}O=this.getFilterOperatorConfig().getMatchingOperators(x,v);if(O.length===0){var y=this.getFilterOperatorConfig().getDefaultOperator(x);n=this.getFilterOperatorConfig().getOperator(y);v=n?n.format([v]):v;}else{n=O[0];}try{if(n&&n.test(v,w)){p=n;B.getModel().removeUIMessage(this.getFieldPath());}}catch(z){B.getModel().setUIMessage(this.getFieldPath(),z.message);}if(p){m=p.getCondition(v,w);if(m){m.fieldPath=this.getFieldPath();B.getModel().addCondition(m);this.fireChange({value:m,type:"added",valid:true});if(u instanceof sap.m.MultiInput){u.setValue("");}if(u instanceof sap.m.Select||u instanceof sap.m.DatePicker||u instanceof sap.m.TimePicker){if(this.getMaxConditions()>=0&&B.getModel().getConditions(this.getFieldPath()).length>1){B.getModel().removeCondition(this.getFieldPath(),0);}}}}}};d.prototype.getConditions=function(){if(this.getBinding("conditions")){var m=this.getBinding("conditions").getContexts(),n=[];for(var i=0;i<m.length;i++){n.push(m[i].getProperty());}return n;}return[];};var h=function(o){var r="";if(o){var O=this.getFilterOperatorConfig().getOperator(o.operator);var v=o.values;r=O.format(v,o,this._getDataType());}return r;};d.prototype._getDefaultInput=function(){var o;if(!this.getAggregation("_input")){if(this.getProperty("dataType").indexOf("Boolean")>-1&&this.getMaxConditions()===1){o=new sap.m.Select(this.getId()+"-inner",{width:this.getWidth(),selectedKey:"{$filterField>conditions/0/values/0}",valueState:{path:"$filterField>/valueState",mode:"OneWay"},valueStateText:{path:"$filterField>/valueStateText",mode:"OneWay"},items:[new sap.ui.core.Item({key:"",text:""}),new sap.ui.core.Item({key:false,text:this._getDataType().formatValue(false,"string")}),new sap.ui.core.Item({key:true,text:this._getDataType().formatValue(true,"string")})]});}else if(this.getProperty("dataType").indexOf(".Time")>-1&&this.getMaxConditions()===1){o=new sap.m.TimePicker(this.getId()+"-inner",{editable:{path:"$filterField>editMode",formatter:j},enabled:{path:"$filterField>editMode",formatter:k},width:"{$filterField>width}",required:"{$filterField>required}",value:{path:"$filterField>conditions/0/values/0",type:this._getDataType(),mode:"OneWay"},valueState:{path:"$filterField>/valueState",mode:"OneWay"},valueStateText:{path:"$filterField>/valueStateText",mode:"OneWay"}});}else if(this.getProperty("dataType").indexOf("Date")>-1&&this.getMaxConditions()===1){o=new sap.m.DatePicker(this.getId()+"-inner",{editable:{path:"$filterField>editMode",formatter:j},enabled:{path:"$filterField>editMode",formatter:k},width:"{$filterField>width}",required:"{$filterField>required}",value:{path:"$filterField>conditions/0/values/0",type:this._getDataType(),mode:"OneWay"},valueState:{path:"$filterField>/valueState",mode:"OneWay"},valueStateText:{path:"$filterField>/valueStateText",mode:"OneWay"}});}else if(this.getProperty("dataType").indexOf("Date")>-1&&this.getMaxConditions()===2){o=new sap.m.DateRangeSelection(this.getId()+"-inner",{editable:{path:"$filterField>editMode",formatter:j},enabled:{path:"$filterField>editMode",formatter:k},width:"{$filterField>width}",required:"{$filterField>required}",value:{parts:[{path:"$filterField>conditions/0/values/0",type:this._getDataType()},{path:"$filterField>conditions/0/values/1",type:this._getDataType()}],mode:"OneWay",type:"sap.ui.mdc.base.type.DateRange"},valueState:{path:"$filterField>/valueState",mode:"OneWay"},valueStateText:{path:"$filterField>/valueStateText",mode:"OneWay"}});}else{var t={};t.path="conditions";t.model="$filterField";t.template=new T({text:{path:'$filterField>',formatter:h.bind(this)},tooltip:{path:'$filterField>',formatter:h.bind(this)}});t.templateShareable=false;o=new M(this.getId()+"-inner",{tokens:t,editable:{path:"$filterField>editMode",formatter:j},enabled:{path:"$filterField>editMode",formatter:k},width:"{$filterField>width}",required:"{$filterField>required}",placeholder:"{$filterField>placeholder}",enableMultiLineMode:true,showSuggestion:false,valueState:{path:"$filterField>/valueState",mode:"OneWay"},valueStateText:{path:"$filterField>/valueStateText",mode:"OneWay"},showValueHelp:"{$filterField>showValueHelp}"});o._tokenizer.updateTokens=function(){this.updateAggregation("tokens");};o.attachTokenUpdate(this._handleTokenUpdate,this);o.attachValueHelpRequest(this._fireValueHelpRequest,this);o.attachLiveChange(this._handleLiveChange,this);o.onpaste=this._paste.bind(this);o.updateTokens=null;}o.attachChange(this._handleTokenUpdate,this);this.setAggregation("_input",o);this._input=o;this._activateManagedObjectModel();}return this.getAggregation("_input");};d.prototype._paste=function(o){var O,s=o.srcControl;if(window.clipboardData){O=window.clipboardData.getData("Text");}else{O=o.originalEvent.clipboardData.getData('text/plain');}var m=O.split(/\r\n|\r|\n/g);if(m&&m.length>1){setTimeout(function(){var t=this._getDataType(),n=t.getMetadata().getName(),B=this.getBinding("conditions");var L=m.length;for(var i=0;i<L;i++){if(m[i]){var v=m[i];var V=v.split(/\t/g);var p,r;if(V.length==2&&V[0]&&V[1]){p="BT";r=this.getFilterOperatorConfig().getOperator(p);}else{V=[v.trim()];p=this.getFilterOperatorConfig().getDefaultOperator(n);r=this.getFilterOperatorConfig().getOperator(p);}v=r?r.format(V):V[0];if(r){var u=r.getCondition(v,t);if(u){u.fieldPath=this.getFieldPath();B.getModel().addCondition(u);this.fireChange({value:u,type:"added",valid:true});}}}}if(s instanceof sap.m.MultiInput){s.setValue("");}}.bind(this),0);}};function j(s){if(s&&s==E.Editable){return true;}else{return false;}}function k(s){if(s&&s!=E.Disabled){return true;}else{return false;}}d.prototype._handleLiveChange=function(o){var v;var i=false;if("value"in o.getParameters()){v=o.getParameter("value");}if("escPressed"in o.getParameters()){i=o.getParameter("escPressed");}var m=this.getFieldHelp();if(m){m.setFilterValue(v);if(m.openByTyping()){m.setSelectedKey();m.open();}}this.fireLiveChange({value:v,escPressed:i});};d.prototype.getContent=function(){if(!this.getAggregation("content")){return this._getDefaultInput();}return this.getAggregation("content");};d.prototype.clone=function(){var o;if(this._input){this._input.detachChange(this._handleTokenUpdate,this);this._input.detachTokenUpdate(this._handleTokenUpdate,this);this._input.detachValueHelpRequest(this._fireValueHelpRequest,this);o=C.prototype.clone.apply(this,arguments);this._input.attachChange(this._handleTokenUpdate,this);this._input.attachTokenUpdate(this._handleTokenUpdate,this);this._input.attachValueHelpRequest(this._fireValueHelpRequest,this);var i=o.getAggregation("_input");i.attachChange(o._handleTokenUpdate,o);i.attachTokenUpdate(o._handleTokenUpdate,o);i.attachValueHelpRequest(o._fireValueHelpRequest,o);}return o;};d.prototype.setContent=function(o){this._deactivateManagedObjectModel();this.setAggregation("content",o);this._activateManagedObjectModel();return this;};d.prototype.destroyContent=function(){this._deactivateManagedObjectModel();this.destroyAggregation("content");this._activateManagedObjectModel();return this;};d.prototype._updateConditionModel=function(o){var B=this.getBinding("conditions");if(B&&o.getParameter("resolvedPath").indexOf("/conditions")===0){B.getModel().checkUpdate(true,true);}};d.prototype._activateManagedObjectModel=function(){var o=this.getContent();if(o){if(!this._oManagedObjectModel){this._oManagedObjectModel=new b(this);this._oManagedObjectModel.setSizeLimit(1000);this._oManagedObjectModel.attachEvent("propertyChange",this._updateConditionModel.bind(this));}o.setModel(this._oManagedObjectModel,"$filterField");o.bindElement({path:"/",model:"$filterField"});}};d.prototype._deactivateManagedObjectModel=function(){var o=this.getContent();if(o){o.unbindElement("$filterField");this._oManagedObjectModel.destroy();this._oManagedObjectModel=null;}};d.prototype.setParent=function(){C.prototype.setParent.apply(this,arguments);if(!this.getParent()){this._deactivateManagedObjectModel();}else{this._activateManagedObjectModel();}};d.prototype.setDataType=function(v){delete this._oDataType;this.setProperty("dataType",v,true);};d.mapEdmTypes={"Edm.Boolean":"sap.ui.model.odata.type.Boolean","Edm.Byte":"sap.ui.model.odata.type.Byte","Edm.Date":"sap.ui.model.odata.type.Date","Edm.DateTime":"sap.ui.model.odata.type.DateTime","Edm.DateTimeOffset":"sap.ui.model.odata.type.DateTimeOffset","Edm.Decimal":"sap.ui.model.odata.type.Decimal","Edm.Double":"sap.ui.model.odata.type.Double","Edm.Single":"sap.ui.model.odata.type.Single","Edm.Guid":"sap.ui.model.odata.type.Guid","Edm.Int16":"sap.ui.model.odata.type.Int16","Edm.Int32":"sap.ui.model.odata.type.Int32","Edm.Int64":"sap.ui.model.odata.type.Int64","Edm.SByte":"sap.ui.model.odata.type.SByte","Edm.String":"sap.ui.model.odata.type.String","Edm.Time":"sap.ui.model.odata.type.Time","Edm.TimeOfDay":"sap.ui.model.odata.type.TimeOfDay"};d.prototype._createDataType=function(t){var O=q.sap.getObject(t);if(!O){var o=this.getFilterOperatorConfig(),n;if(o){n=o.getParentType(t);}else{n=d.mapEdmTypes[t];}if(!n){q.sap.log.error("FilterField","dataType for "+t+" can not be created!");return null;}return this._createDataType(n);}return new O(this.getDataTypeFormatOptions(),this.getDataTypeConstraints());};d.prototype._getDataType=function(t){if(!this._oDataType){this._oDataType=this.getProperty("dataType");if(typeof this._oDataType==="string"){this._oDataType=this._createDataType(this._oDataType);}}return this._oDataType;};return d;},true);

/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2018 SAP SE. All rights reserved
 */
sap.ui.define(['./FieldHelpBase','sap/ui/model/base/ManagedObjectModel','sap/ui/base/ManagedObjectObserver',"sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(F,M,a,b,c){"use strict";var T=F.extend("sap.ui.mdc.base.TableFieldHelp",{metadata:{library:"sap.ui.mdc",properties:{getTextForKey:{type:"function",group:"Data"},getKeyForText:{type:"function",group:"Data"},getKeyFromItem:{type:"function",group:"Data"},getTextFromItem:{type:"function",group:"Data"}},aggregations:{table:{type:"sap.m.Table",multiple:false}},defaultAggregation:"table",events:{itemSelect:{parameters:{item:{type:"sap.m.ListItemBase"}}},navigateToItem:{parameters:{step:{type:"int"},selectedItem:{type:"sap.m.ListItemBase"}}},filterItems:{parameters:{filterText:{type:"string"}}}}}});T.prototype.init=function(){F.prototype.init.apply(this,arguments);this._oObserver=new a(_.bind(this));this._oObserver.observe(this,{properties:["selectedKey","filterValue"],aggregations:["table"]});};T.prototype.exit=function(){F.prototype.exit.apply(this,arguments);this._oObserver.disconnect();this._oObserver=undefined;};T.prototype._createPopover=function(){var p=F.prototype._createPopover.apply(this,arguments);if(p){var o=this._getField();if(o){p.setInitialFocus(o);}p._getAllContent=function(){var P=this.getParent();if(P){var C=[];C.push(P.getTable());return C;}else{return this.getContent();}};if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);this._iStep=null;}}return p;};T.prototype._handleAfterOpen=function(E){F.prototype._handleAfterOpen.apply(this,arguments);var t=this.getTable();var s=t.getSelectedItem();if(s){s.getDomRef().scrollIntoView();}};T.prototype.open=function(){var p=this.getAggregation("_popover");if(p){var o=this._getField();p.setInitialFocus(o);}F.prototype.open.apply(this,arguments);return this;};T.prototype._handleAfterClose=function(E){F.prototype._handleAfterClose.apply(this,arguments);if(this._bUpdateFilterAfterClose){this._bUpdateFilterAfterClose=false;j.call(this,this._sFilterValueAfterClose);this._sFilterValueAfterClose=null;}};function _(C){if(C.name=="table"){this.fireDataUpdate();var t=C.child;var p=this.getAggregation("_popover");if(C.mutation=="remove"){t.detachEvent("itemPress",d,this);t.detachEvent("updateFinished",g,this);}else{t.setMode(sap.m.ListMode.SingleSelectMaster);t.setRememberSelections(false);t.attachEvent("itemPress",d,this);t.attachEvent("updateFinished",g,this);h.call(this,this.getSelectedKey());}if(p){p.invalidate();}}if(C.name=="selectedKey"){h.call(this,C.current);}if(C.name=="filterValue"){if(this._bClosing){this._bUpdateFilterAfterClose=true;this._sFilterValueAfterClose=C.current;}else{j.call(this,C.current);}}}T.prototype.openByTyping=function(){return true;};T.prototype.navigate=function(s){var p=this._getPopover();if(!p){this._bNavigate=true;this._iStep=s;return;}var t=this.getTable();var S=t.getSelectedItem();if(this.hasListeners("navigateToItem")){if(!p.isOpen()){this.open();}this.fireNavigateToItem({step:s,selectedItem:S});}else{var i=t.getItems();var I=i.length;var k=0;if(S){k=t.indexOfItem(S);k=k+s;if(k<0){k=0;}else if(k>=I-1){k=I-1;}}else if(s>=0){k=s-1;}else{k=I+s;}var o=i[k];if(o&&o!==S){o.setSelected(true);var K=e.call(this,o);var l=f.call(this,o);this.setProperty("selectedKey",K,true);if(!p.isOpen()){this.open();}else{o.getDomRef().scrollIntoView();}this.fireNavigate({value:l,key:K});}}};T.prototype.getTextForKey=function(k){var t="";var l=this.getGetTextForKey();if(l){t=l(k);if(typeof t!=="string"){throw new Error("function getTextForKey must return a string");}}else{var o=this.getTable();var n=false;if(o){var I=o.getItems();if(I.length>0){for(var i=0;i<I.length;i++){var m=I[i];if(m.getCells){var C=m.getCells();if(C.length>1){if(C[0].getText&&C[1].getText){if(C[0].getText()==k){t=C[1].getText();break;}}else{n=true;}}else{n=true;}}else{n=true;}}if(n){throw new Error("function getTextForKey is missing");}}}}return t;};T.prototype.getKeyForText=function(t){var k="";var K=this.getGetKeyForText();if(K){k=K(t);if(typeof k!=="string"){throw new Error("function getKeyForText must return a string");}}else{var o=this.getTable();var n=false;if(o){var I=o.getItems();if(I.length>0){for(var i=0;i<I.length;i++){var l=I[i];if(l.getCells){var C=l.getCells();if(C.length>1){if(C[0].getText&&C[1].getText){if(C[1].getText()==t){k=C[0].getText();break;}}else{n=true;}}else{n=true;}}else{n=true;}}if(n){throw new Error("function getKeyForText is missing");}}}}return k;};function d(E){var i=E.getParameter("listItem");var s=i.getSelected();if(s){if(this.hasListeners("itemSelect")){this.close();this.fireItemSelect({item:i});}else{var k=e.call(this,i);var t=f.call(this,i);this.setProperty("selectedKey",k,true);this.close();this.fireSelect({value:t,key:k});}}}function e(i){var k;var K=this.getGetKeyFromItem();if(K){k=K(i);if(typeof k!=="string"){throw new Error("function getKeyFromItem must return a string");}}else{if(i.getCells){var C=i.getCells();if(C.length>0){if(C[0].getText){k=C[0].getText();}}}if(!k){throw new Error("function getKeyFromItem is missing");}}return k;}function f(i){var t;var k=this.getGetTextFromItem();if(k){t=k(i);if(typeof t!=="string"){throw new Error("function getTextFromItem must return a string");}}else{if(i.getCells){var C=i.getCells();if(C.length>1){if(C[1].getText){t=C[1].getText();}}}if(!t){throw new Error("function getTextFromItem is missing");}}return t;}function g(){h.call(this,this.getSelectedKey());this.fireDataUpdate();}function h(s){var t=this.getTable();if(t){var I=t.getItems();for(var i=0;i<I.length;i++){var o=I[i];var k=e.call(this,o);if(k==s){o.setSelected(true);}else{o.setSelected(false);}}}}function j(s){if(this.hasListeners("filterItems")){this.fireFilterItems({filterText:s});}else{var t=this.getTable();var S=false;var B=t.getBinding("items");if(B){var o=t.getBindingInfo("items");if(o&&o.template.getCells&&o.template.getCells().length>1){o=o.template.getCells()[1].getBindingInfo("text");if(o&&o.parts&&o.parts.length>0){var p=o.parts[0].path;var i=new b(p,c.StartsWith,s);B.filter(i);S=true;}}if(!S){throw new Error("event filterItems must be implemented");}}}}return T;},true);

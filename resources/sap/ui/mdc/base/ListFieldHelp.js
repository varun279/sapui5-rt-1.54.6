/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2018 SAP SE. All rights reserved
 */
sap.ui.define(['./FieldHelpBase','sap/ui/model/base/ManagedObjectModel','sap/ui/base/ManagedObjectObserver','sap/ui/mdc/library'],function(F,M,a,l){"use strict";var L;var D;var m;var b;var c=F.extend("sap.ui.mdc.base.ListFieldHelp",{metadata:{library:"sap.ui.mdc",aggregations:{items:{type:"sap.ui.core.ListItem",multiple:true,singularName:"item"}},defaultAggregation:"items"}});c.prototype.init=function(){F.prototype.init.apply(this,arguments);this._oManagedObjectModel=new M(this);this._oObserver=new a(e.bind(this));this._oObserver.observe(this,{properties:["selectedKey","filterValue"],aggregations:["items"]});};c.prototype.exit=function(){F.prototype.exit.apply(this,arguments);this._oManagedObjectModel.destroy();delete this._oManagedObjectModel;this._oObserver.disconnect();this._oObserver=undefined;};c.prototype._createPopover=function(){var p=F.prototype._createPopover.apply(this,arguments);if((!L||!D||!m)&&!this._bListRequested){L=sap.ui.require("sap/m/List");D=sap.ui.require("sap/m/DisplayListItem");m=sap.ui.require("sap/m/library");b=sap.ui.require("sap/ui/model/Filter");if(!L||!D||!m){sap.ui.require(["sap/m/List","sap/m/DisplayListItem","sap/m/library","sap/ui/model/Filter"],d.bind(this));this._bListRequested=true;}}if(p){var o=this._getField();if(o){p.setInitialFocus(o);}_.call(this);}return p;};function _(){if(L&&D&&m&&!this._bListRequested){var i=new D({type:m.ListType.Active,label:"{$field>text}",value:"{$field>additionalText}"});var o=new b("text",j.bind(this));this._oList=new L(this.getId()+"-List",{width:"100%",showNoData:false,mode:m.ListMode.SingleSelectMaster,rememberSelections:false,items:{path:"$field>items",template:i,filters:o},itemPress:f.bind(this)});this._oList.setModel(this._oManagedObjectModel,"$field");this._oList.bindElement({path:"/",model:"$field"});k.call(this,this.getSelectedKey());this._setContent(this._oList);if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);this._iStep=null;}}}function d(i,n,o,p){L=i;D=n;m=o;b=p;this._bListRequested=false;if(!this._bIsBeingDestroyed){_.call(this);}}c.prototype.open=function(){var p=this.getAggregation("_popover");if(p){var o=this._getField();p.setInitialFocus(o);}F.prototype.open.apply(this,arguments);return this;};c.prototype._handleAfterClose=function(E){F.prototype._handleAfterClose.apply(this,arguments);if(this._bUpdateFilterAfterClose){this._bUpdateFilterAfterClose=false;h.call(this);}};function e(C){if(C.object==this){if(C.name=="items"){if(C.mutation=="insert"){this._oObserver.observe(C.child,{properties:true});}else{this._oObserver.unobserve(C.child);}this.fireDataUpdate();}if(C.name=="selectedKey"){k.call(this,C.current);}if(C.name=="filterValue"){if(this._oList){if(this._bClosing){this._bUpdateFilterAfterClose=true;}else{h.call(this);}}}}else{this.fireDataUpdate();}}c.prototype.openByTyping=function(){return true;};c.prototype.navigate=function(s){var p=this._getPopover();if(!p||!this._oList){this._bNavigate=true;this._iStep=s;return;}var S=this._oList.getSelectedItem();var i=this._oList.getItems();var I=i.length;var n=0;if(S){n=this._oList.indexOfItem(S);n=n+s;if(n<0){n=0;}else if(n>=I-1){n=I-1;}}else if(s>=0){n=s-1;}else{n=I+s;}var o=i[n];if(o&&o!==S){var O=g.call(this,o);o.setSelected(true);this.setProperty("selectedKey",O.getKey(),true);if(!p.isOpen()){this.open();}this.fireNavigate({value:o.getLabel(),additionalValue:o.getValue(),key:O.getKey()});}};c.prototype.getTextForKey=function(K){var I=this.getItems();for(var i=0;i<I.length;i++){var o=I[i];if(o.getKey()==K){return o.getText();}}return"";};c.prototype.getKeyForText=function(t){var I=this.getItems();for(var i=0;i<I.length;i++){var o=I[i];if(o.getText()==t){return o.getKey();}}return"";};function f(E){var i=E.getParameter("listItem");var s=i.getSelected();if(s){var o=g.call(this,i);this.setProperty("selectedKey",o.getKey(),true);this.close();this.fireSelect({value:i.getLabel(),additionalValue:i.getValue(),key:o.getKey()});}}function g(i){var p=i.getBindingContextPath();return this._oManagedObjectModel.getProperty(p);}function h(){var B=this._oList.getBinding("items");B.update();this._oList.updateItems();this._oList.invalidate();k.call(this,this.getSelectedKey());}function j(t){var s=this.getFilterValue();if(!s||jQuery.sap.startsWithIgnoreCase(t,s)){return true;}else{return false;}}function k(s){if(this._oList){var I=this._oList.getItems();for(var i=0;i<I.length;i++){var o=I[i];var O=g.call(this,o);if(O.getKey()==s){o.setSelected(true);}else{o.setSelected(false);}}}}return c;},true);

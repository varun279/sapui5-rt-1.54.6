/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2018 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/mdc/base/TableFieldHelp"],function(q,B,T){"use strict";var O=B.extend("sap.ui.mdc.base.ODataSuggestProvider",{constructor:function(p){B.apply(this);this._bShowHint=false;this._bFixedValues=false;if(p){this._fInit=p.init;this._fSuggest=p.suggest;this._fSelect=p.select;this._bShowHint=p.showHint!==undefined?p.showHint:false;this._bFixedValues=p.fixedValues!==undefined?p.fixedValues:false;this._keyPath=p.keyPath;this._descriptionPath=p.descriptionPath;if(p.control){this.associateFilterField(p.control);}}}});O.prototype.destroy=function(){this._oFilterField=null;this._oInput=null;this._oTable=null;};O.prototype.getTable=function(){return this._oTable;};O.prototype.setTable=function(t,p){if(this._oTable){this._oTable.destroy();}this._oTable=t;this._oFilterField.getFieldHelp().setTable(t);if(p&&p.newValue){this._fSuggest(this,{newValue:p.newValue});}};O.prototype.setKeyPath=function(k){this._keyPath=k;};O.prototype.setDescriptionPath=function(d){this._descriptionPath=d;};O.prototype.keyFromItem=function(i){var b=i.getBindingContext();var d=b.getObject();return this._keyPath&&d&&d[this._keyPath]?d[this._keyPath]:null;};O.prototype.textFromItem=function(i){var b=i.getBindingContext();var d=b.getObject();return this._descriptionPath&&d[this._descriptionPath]?d[this._descriptionPath]:null;};O.prototype.handleTableItemSelect=function(e){var f=e.oSource;var i=e.getParameter("item");var b=i.getBindingContext();var d=b.getObject();var k=this._keyPath&&d[this._keyPath]?d[this._keyPath]:null;var D=this._descriptionPath&&d[this._descriptionPath]?d[this._descriptionPath]:null;f.setProperty("selectedKey",k,true);f.fireSelect({value:D,key:k});if(this._fSelect){if(this._fSelect(this,{suggestionObject:i})){return null;}}var s=this._oInput;var o=this._oFilterField.getBinding("conditions");var t=this._oFilterField._getDataType();var F=this._oFilterField.getFieldPath();var v="=="+k;q.sap.log.info("mdc:ODataSuggestProvider.handleTableItemSelect"," item: "+v);var a=this._oFilterField.getFilterOperatorConfig().getOperator("EEQ");if(a&&a.test(v,t)){var c=o.getModel().addCondition(o.getModel().createItemCondition(F,k,D));c.canonicalPath=b.getCanonicalPath?b.getCanonicalPath():b.getPath();s.setValue("");this._oFilterField.fireChange({value:c,type:"added",valid:true});}};O.prototype.handleTableNavigate=function(e){var f=e.oSource;var t=f.getTable();var s=e.getParameter("step");var S=e.getParameter("selectedItem");var i=t.getItems();var I=i.length;var a=0;if(S){a=t.indexOfItem(S);a=a+s;if(a<0){a=0;}else if(a>=I-1){a=I-1;}}else if(s>=0){a=s-1;}else{a=I+s;}var o=i[a];if(o){var b=o.getBindingContext();var d=b.getObject();var k=this._keyPath&&d[this._keyPath]?d[this._keyPath]:null;var D=this._descriptionPath&&d[this._descriptionPath]?d[this._descriptionPath]:null;o.setSelected(true);f.setProperty("selectedKey",k,true);f.fireNavigate({value:D,key:k});}};O.prototype.handleFilterItems=function(e){var f=e.oSource;var t=f.getTable();var F=e.getParameter("filterText");if(this._fInit&&!t){this._fInit(this,{newValue:F});return;}if(this._fSuggest){f.setSelectedKey();if(this.iChangeTimer){q.sap.clearDelayedCall(this.iChangeTimer);delete this.iChangeTimer;}this.iChangeTimer=q.sap.delayedCall(100,this,function(){this._fSuggest(this,{newValue:F});}.bind(this));}};O.prototype.associateFilterField=function(f){this._oFilterField=f;this._oInput=f.getAggregation("_input");if(!this._oInput){var t=this;setTimeout(function(){t.associateFilterField(f);},100);return;}if(!(this._oInput instanceof sap.m.MultiInput)){q.sap.log.error("mdc:ODataSuggestProvider","associateFilterField for "+(this._oInput?this._oInput.getId():"none")+" not possible!");return;}var F=new T();F.setGetKeyFromItem(this.keyFromItem.bind(this));F.setGetTextFromItem(this.textFromItem.bind(this));F.attachItemSelect(this.handleTableItemSelect.bind(this));F.attachNavigateToItem(this.handleTableNavigate.bind(this));F.attachFilterItems(this.handleFilterItems.bind(this));this._oFilterField.setFieldHelp(F);if(this._bFixedValues){this._oInput._getValueHelpIcon=function(){var _=sap.m.MultiInput.prototype._getValueHelpIcon.apply(this,arguments);if(_){_.setSrc(sap.ui.core.IconPool.getIconURI("slim-arrow-down"));}return _;};}if(this._bShowHint){this._oInput.setPlaceholder("press space to get help");}this._oInput.attachChange(function(e){var s=e.getParameter("newValue").trim(),S=this._oInput,b=this._oFilterField.getBinding("conditions"),o=this._oFilterField._getDataType(),c,a=this._oFilterField.getFieldPath();q.sap.log.info("mdc:ODataSuggestProvider","change text handled "+s);if(this._oFilterField.getFieldHelp()._getPopover().isOpen()&&this._oFilterField.getFieldHelp().getProperty("selectedKey")){this._oFilterField.getFieldHelp().close();S.setValue("");q.sap.delayedCall(100,this,function(){var k=this._oFilterField.getFieldHelp().getProperty("selectedKey");var v="=="+k;q.sap.log.info("mdc:ODataSuggestProvider","validator EEQ text handling "+v);var d=this._oFilterField.getFilterOperatorConfig().getOperator("EEQ");if(d&&d.test(v,o)){c=b.getModel().addCondition(b.getModel().createItemCondition(a,k,s));this._oFilterField.fireChange({value:c,type:"added",valid:true});}});}return null;}.bind(this));};return O;},true);

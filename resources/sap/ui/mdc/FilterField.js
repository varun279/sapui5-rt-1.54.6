/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2018 SAP SE. All rights reserved
 */
sap.ui.define(["./ResourceModel",'sap/ui/mdc/XMLComposite',"sap/ui/mdc/base/ODataSuggestProvider","sap/ui/mdc/base/OperatorSuggestProvider","sap/ui/model/json/JSONModel","sap/ui/mdc/ValueHelpDialog","sap/ui/mdc/internal/common/Helper"],function(R,X,O,a,J,V,C){"use strict";var F=X.extend("sap.ui.mdc.FilterField",{metadata:{designtime:false,specialSettings:{metadataContexts:{defaultValue:"{ model: 'entitySet', path:'',  name: 'entitySet'}, { model: 'property', path:'',  name: 'property'}"}},properties:{withLabel:{type:"boolean",defaultValue:true,invalidate:"template"},conditionModelName:{type:"string",defaultValue:"sap.fe.cm",invalidate:false}},events:{},aggregations:{},publicMethods:[]},fragment:"sap.ui.mdc.internal.filterfield.FilterField"});F.prototype.getInnerFilterField=function(){var i=this.get_content().getItems();return i[i.length-1];};F.prototype.init=function(){X.prototype.init.call(this);var i=this.getInnerFilterField();var s=i.data("suggest")==='true',f=i.data("fixedValues")==='true';if(s||f){new O({fixedValues:f,control:i,init:this.handleProviderInit.bind(this),suggest:this.handleProviderSuggest.bind(this)});}};F.prototype.handleProviderInit=function(p,e){var i=this.getInnerFilterField();var E=this._getEntitySet();var P=this._getPropertyPath();var m=this.getModel().getMetaModel();var f=i.data("fixedValues")==='true';var b={};if(!f&&e.newValue.trim()){b.$search=e.newValue.trim();}this.bSuggestionViewCreated=true;m.requestValueListInfo('/'+E+'/'+P).then(function(v){C._extendValueListMetadata(m,E,P,v);v=v[""];if(!v){return false;}v.$mdc.SuggestBindingParameters=JSON.stringify(b);var o=new J(v);var s=sap.ui.view({viewName:"sap.ui.mdc.internal.filterfield.SuggestionList",type:"XML",async:true,preprocessors:{xml:{bindingContexts:{valueList:o.createBindingContext("/")},models:{valueList:o}}}});return s.loaded().then(function(){if(v.$mdc){if(v.$mdc.keyPath){p.setKeyPath(v.$mdc.keyPath);}if(v.$mdc.descriptionPath){p.setDescriptionPath(v.$mdc.descriptionPath);}}var t=s.getContent()[0];t.setModel(v.$model);p.setTable(t,e);});},function(o){throw(o.message);});};F.prototype.handleProviderSuggest=function(p,e){var i=this.getInnerFilterField();var E=this._getEntitySet();var m=this.getModel().getMetaModel();var s;var f=i.data("fixedValues")==='true';var b={};if(!f){s=m.getObject("/"+E+"@Org.OData.Capabilities.V1.SearchRestrictions");if(!s||s.Searchable||s.Searchable===undefined){if(!f){b.$search=e.newValue.trim()?e.newValue.trim():undefined;}}else{return;}var S=p.getTable().getBinding("items");if(S){S.changeParameters(b);}}};F.prototype._getEntitySet=function(){return this.getInnerFilterField().data("entitySetName");};F.prototype._getPropertyPath=function(){return this.getInnerFilterField().getFieldPath().replace(/\*/g,'');};F.prototype.handleValueHelpRequest=function(){var l=this.get_content().getItems()[0].getText();if(l.indexOf(":")+1===l.length){l=l.substr(0,l.length-1);}this.oValueHelpDialog=new V({entitySet:this._getEntitySet(),fieldPath:this._getPropertyPath(),conditionModelName:"sap.ui.mdc.cm",title:l});this.oValueHelpDialog.setModel(this.getModel(this.getConditionModelName()),"sap.ui.mdc.cm");this.addDependent(this.oValueHelpDialog);this.oValueHelpDialog.open();};F._helper={getFieldPath:function(I,e,f){var m,s,p,t;m=I.getInterface(0).getModel();if(typeof f!=="string"){f=m.getObject(I.getInterface(1).getPath()+"@sapui.name");}if(f.indexOf('/')>-1){s=f.split('/');for(var i=0;i<(s.length-1);i++){p=m.getObject("/"+e+"/"+s.slice(0,(i+1)).join('/'));if(p&&p["$kind"]==="NavigationProperty"&&p["$isCollection"]){s[i]=s[i]+'*';t=true;}}if(t){f=s.join('/');}}return f;},getValueStatePath:function(i,e,f){var _=F._helper.getFieldPath(i,e,f);return"{sap.fe.cm>/fieldPath/"+_+"/valueState}";},getValueStateTextPath:function(i,e,f){var _=F._helper.getFieldPath(i,e,f);return"{sap.fe.cm>/fieldPath/"+_+"/valueStateText}";},isRequiredInFilter:function(p,d){var e,P,i=false,f,m=d.context.getModel(),s=d.context.getPath();e=C._getEntitySetPath(m,s);if(typeof p==="string"){P=p;}else{P=m.getObject(s+"@sapui.name");}f=m.getObject(e+"@Org.OData.Capabilities.V1.FilterRestrictions");if(f&&f.RequiredProperties){i=f.RequiredProperties.some(function(b){return b.$PropertyPath===P;});}return i;},typeFormatOptions:function(p,d){var f="{",s,m=d.context.getModel(),P=d.context.getPath(),t=m.getObject(P+"/$Type"),T,o;if(t==="Edm.Date"||t==="Edm.DateTimeOffset"||t==="Edm.TimeOfDay"){f+="style: 'medium'";}else if(t==="Edm.Decimal"){s=m.getObject(P+"/$Scale")||0;switch(s){case"floating":f+="decimals: "+(m.getObject(P+"/$Precision")||0);break;case"variable":break;default:f+="decimals: "+s;}}T=m.getObject(P+"@com.sap.vocabularies.Common.v1.Text");if(T){o=m.getObject(P+"@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement");if(f.length>1){f+=", ";}if(o&&o.$EnumMember){switch(o.$EnumMember){case"com.sap.vocabularies.UI.v1.TextArrangementType/TextLast":f+="displayFormat: 'ValueDescription'";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly":f+="displayFormat: 'Description'";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextSeparate":f+="displayFormat: 'Value'";break;default:f+="displayFormat: 'DescriptionValue'";}}else{f+="displayFormat: 'DescriptionValue'";}}return f+"}";},typeConstraints:function(p,d){var c="{",s,m,M=d.context.getModel(),P=d.context.getPath(),t=M.getObject(P+"/$Type");if(t==="Edm.Decimal"){s=M.getObject(P+"/$Scale")||0;switch(s){case"floating":c+="decimals: "+(M.getObject(P+"/$Precision")||0);break;case"variable":break;default:c+="decimals: "+s;}}else if(t==="Edm.String"){m=M.getObject(P+"/$MaxLength");if(m){c+="maxLength: "+m;}if(M.getObject(P+"@com.sap.vocabularies.Common.v1.IsUpperCase")){if(c.length>1){c+=", ";}c+="toUpperCase: true";}}return c+"}";},getValueListCollectionEntitySet:function(v){var m=v.getObject();return m.$model.getMetaModel().createBindingContext("/"+m.CollectionPath);},getValueListProperty:function(p){var v=p.getModel();var m=v.getObject("/");return m.$model.getMetaModel().createBindingContext('/'+m.CollectionPath+'/'+p.getObject());}};F._helper.getFieldPath.requiresIContext=true;F._helper.getValueStatePath.requiresIContext=true;F._helper.getValueStateTextPath.requiresIContext=true;F.createInstance=function(p){var e=p.entitySet,P=p.propertyPath,m=p.metaModel,o=p.parent,w=p.withLabel||false,E=m.createBindingContext("/"+e),b=m.createBindingContext("/"+e+"/"+P),n;var v=sap.ui.view({viewContent:"<core:View xmlns:core='sap.ui.core' xmlns:mdc='sap.ui.mdc'><mdc:FilterField metadataContexts=\"{ model: 'entitySet', path : '', name: 'entitySet'}, { model: 'property', path : '', name: 'property' }\" withLabel='"+w+"'/></core:View>",type:"XML",async:false,preprocessors:{xml:{bindingContexts:{entitySet:E,property:b},models:{entitySet:m,property:m}}}});n=v.getContent()[0];o.addDependent(n);return n;};return F;},true);

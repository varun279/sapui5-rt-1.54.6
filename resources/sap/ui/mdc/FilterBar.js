/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2018 SAP SE. All rights reserved
 */
sap.ui.define(["./ResourceModel",'sap/ui/mdc/XMLComposite','sap/ui/base/ManagedObject','sap/ui/Device',"sap/ui/mdc/internal/common/Helper","sap/ui/mdc/FilterField","sap/m/SearchField","sap/m/Dialog","sap/m/Button","sap/m/MessageToast","sap/ui/model/json/JSONModel",'sap/ui/mdc/base/ConditionModel','sap/ui/mdc/experimental/P13nFilterPanel','sap/ui/mdc/experimental/P13nFilterItem'],function(R,X,M,D,C,F,S,a,B,b,J,c,P,d){"use strict";var e=X.extend("sap.ui.mdc.FilterBar",{metadata:{designtime:"sap/ui/mdc/designtime/FilterBar.designtime",specialSettings:{metadataContexts:{defaultValue:"{ model: 'entitySet', path:'',  name: 'entitySet'},{model: 'sap.fe.deviceModel', path: '/', name: 'sap.fe.deviceModel'}"}},properties:{annotationForSelectionFields:{type:"string",defaultValue:"@com.sap.vocabularies.UI.v1.SelectionFields"},liveUpdate:{type:"boolean",defaultValue:!D.system.phone,invalidate:"template"},searchOnStart:{type:"boolean",defaultValue:true,invalidate:"template"},filterSummary:{type:"string",defaultValue:"",invalidate:false},enabled:{type:"boolean",defaultValue:true,invalidate:false},conditionModelName:{type:"string",defaultValue:"sap.fe.cm",invalidate:false},listBindingNames:{type:"string[]",invalidate:false},showBasicSearch:{type:"boolean",defaultValue:true,invalidate:"template"},enablePersonalization:{type:"boolean",defaultValue:true,invalidate:false}},events:{search:{},change:{}},aggregations:{},publicMethods:[]},fragment:"sap.ui.mdc.internal.filterbar.FilterBar"});var s=function(E){var o=this._getConditionModel(),m=this.getModel(),l,f,g;g=o.applyFilters();if(g&&m.getBindingForReference){var h=this._getSearchControl();if(h){f=h.getValue()||undefined;l=this.getListBindingNames();l.forEach(function(L){m.getBindingForReference(L).then(function(i){i.changeParameters({$search:f});});});}}};e.prototype.init=function(){X.prototype.init.call(this);var t=this;this._bIsReady=false;this.attachSearch(s);this._requestConditionModel().then(function(o){if(!t.bInitialized){t.bInitialized=true;var f=o.bindProperty("/",o.getContext("/"));f.attachChange(t.handleChange.bind(t));if(t.getSearchOnStart()&&t.getEnabled()){t._bIsReady=true;t.fireSearch();}if(!t.getEnabled()){t._getInnerFilterBar().setBusy(true);}}});};e.prototype.onBeforeRendering=function(){this._setFilterSummary();};e.prototype.setEnabled=function(E){this._getInnerFilterBar().setBusy(!E);this.setProperty("enabled",E);if(E){if(this.bInitialized&&this.getSearchOnStart()){this._bIsReady=true;this.fireSearch();}}};e.prototype.isReady=function(){return this._bIsReady;};e.prototype.getAppState=function(){var o=this._getConditionModel(),f=this._getDraftEditStateControl(),g=this._getSearchControl(),A={};if(o){A.conditionModel=o.serialize();}if(f){A.draftEditState=f.getSelectedKey();}if(g){A.search=g.getValue();}return A;};e.prototype.setAppState=function(A){var t=this;return this._requestConditionModel().then(function(o){var f=t._getDraftEditStateControl(),g=t._getSearchControl();if(A.conditionModel){if(o){o.parse(A.conditionModel);}else{throw("app state contains condition model state but condition model not yet set");}}if(A.draftEditState&&f){f.setSelectedKey(A.draftEditState);}if(A.search&&g){g.setValue(A.search);}if(!t.getLiveUpdate()){t.handleGo();}});};e.prototype.handleChange=function(){if(this.getLiveUpdate()&&this.getEnabled()){this.fireSearch();this._setFilterSummary();this.fireChange();}else{this._bIsReady=false;this.fireChange();}};e.prototype.handleSearch=function(E){this.fireSearch();this._setFilterSummary();this.fireChange();};e.prototype.handleSearchChange=function(E){var t=this,i;if(t._iSearchCounter){t._iSearchCounter++;}else{t._iSearchCounter=1;}i=t._iSearchCounter;if(this.getLiveUpdate()){setTimeout(function(){if(i===t._iSearchCounter){t.fireSearch();t._setFilterSummary();t.fireChange();delete t._iSearchCounter;}},400);}else{this._bIsReady=false;this.fireChange();}};e.prototype.handleGo=function(){this._bIsReady=true;this.fireSearch();this._setFilterSummary();this.fireChange();};e.prototype.handleAdapt=function(E){var t=this;var o=this.getModel(this.getConditionModelName());var f=o.clone();var g=[],h,A,j;if(this.oAdaptDialog){j=this.oAdaptDialog.getModel("p13n");this._updateAdaptFilterModel(j);}else{var p=new P();this.oAdaptDialog=A=new a({title:"Adapt Filters",contentWidth:"75%",contentHeight:"75%",content:p,verticalScrolling:true,resizable:true,draggable:true,endButton:new B({text:'{$i18n>filterbar.ADAPT_CANCEL}',press:function(){A.close();}}),beginButton:new B({text:'{$i18n>filterbar.ADAPT_OK}',type:'Emphasized',press:function(){var n=j.getObject("/filters");var k=[],r=[];for(var i=0;i<n.length;i++){if(n[i].selected&&g.indexOf(n[i])===-1){k.push(n[i]);}else if(!n[i].selected&&g.indexOf(n[i])>-1){r.push(n[i]);}}if(k.length>0||r.length>0){t._adaptFilterBar(k,r);}o.merge(undefined,this.getModel("sap.fe.cm"));o.applyFilters();A.close();}})});j=this._getAdaptFilterModel(A);A.setModel(j,"p13n");p.bindAggregation("items",{path:"/filters",model:"p13n",template:new d({columnKey:"{p13n>columnKey}",text:"{p13n>text}",position:"{p13n>position}",tooltip:"{p13n>tooltip}",selected:"{p13n>selected}",control:"{p13n>control}",required:"{p13n>required}"})});this.addDependent(A);}h=j.getObject("/filters");for(var i=0;i<h.length;i++){if(h[i].selected){g.push(h[i]);}}this.oAdaptDialog.setModel(f,"sap.fe.cm");this.oAdaptDialog.open();};e.prototype._getEntitySet=function(){return this.byId("template::Filterbar::Adapt").getCustomData()[0].getValue();};e.prototype._getInnerFilterBar=function(){return this.get_content();};e.prototype._setFilterSummary=function(){var o=this._getSearchControl(),f=this._getDraftEditStateControl(),g,h="",j=[],i;if(o){g=o.getValue();}if(g){h=R.getText("filterbar.SEARCHBY")+": "+g+((j.length>0)?" | ":"");}if(f&&f.getSelectedKey()!=='0'){j.push(R.getText("filterbar.EDITING_STATUS"));}var k=this._getFilterFieldControls();for(i=0;i<k.length;i++){if(k[i].getConditions().length>0){j.push(k[i].getCustomData()[0].getValue());}}if(j.length>0){h+=R.getText("filterbar.FILTERBY")+" ("+j.length+"): ";for(i=0;i<j.length;i++){h+=((i>0)?', ':'')+j[i];}}if(!h){h=R.getText("filterbar.FILTERBYNONE");}this.setFilterSummary(h);};e.prototype._requestConditionModel=function(){var o=this._getConditionModel(),t=this;if(o){return Promise.resolve(o);}else{return new Promise(function(r){var m=t.getModel();var f=function(){var m=t.getModel(),o,n;if(!m){return;}t.detachModelContextChange(f);o=t.getModel(t.getConditionModelName());if(o){return Promise.resolve(o);}else{n=t.getListBindingNames();if(n&&m.getBindingForReference){n.forEach(function(N){m.getBindingForReference(N).then(function(l){o=t.getModel(t.getConditionModelName());if(!o){o=c.getFor(l);this.setModel(o,this.getConditionModelName());}r(o);}.bind(this));}.bind(t));}}};if(m){f();}else{t.attachModelContextChange(f);}});}};e.prototype._getConditionModel=function(){return this.getModel(this.getConditionModelName());};e.prototype._getDraftEditStateControl=function(){var f=this._getInnerFilterBar().getContent();var o;for(var i=0;i<f.length;i++){if(!(f[i]instanceof F)&&f[i].getItems){o=f[i].getItems()[1];if(o.getBinding("items")&&o.getBinding("items").getPath()==="/editStates"&&o.getBinding("items").getModel()===o.getModel("$draft")){return o;}}}};e.prototype._getSearchControl=function(){if(this.getShowBasicSearch()){var f=this._getInnerFilterBar().getContent();var o;for(var i=0;i<f.length;i++){o=f[i].getItems()[1];if(o instanceof S){return o;}}}};e.prototype._getFilterFieldControls=function(){var f=this._getInnerFilterBar().getContent();var o,g=[];for(var i=0;i<f.length;i++){o=f[i];if(o instanceof F){g.push(o.get_content().getItems()[1]);}}return g;};e.prototype._getAdaptFilterModel=function(o){var t=this;var f=this._getFilterFieldControls();var E=this._getEntitySet();var g=[];var m=this.getModel().getMetaModel();var h=m.getObject("/"+E+"/");var A,j;function k(i){return F.createInstance({entitySet:E,propertyPath:i,metaModel:m,parent:o});}function l(i){return t._getFilterFieldControl(f,i)!==undefined;}function n(r){for(var i=0;i<f.length;i++){if(f[i].getFieldPath()===r){return i;}}}for(var p in h){if(h[p].$kind&&h[p].$kind==="Property"){A=m.getObject("/"+E+"/"+p+"@");j=m.getContext("/"+E+"/"+p);if(e._helper.isPropertyFilterable(j,p)){g.push({columnKey:p,text:A['@com.sap.vocabularies.Common.v1.Label']||p,position:n(p),tooltip:A['@com.sap.vocabularies.Common.v1.Label']||p,selected:l(p),control:k(p),required:F._helper.isRequiredInFilter(p,{context:j})});}}}var q=new J({"filters":g});return q;};e.prototype._updateAdaptFilterModel=function(A){var f=this._getFilterFieldControls();var g=A.getObject("/filters");for(var i=0;i<g.length;i++){g[i].selected=this._getFilterFieldControl(f,g[i].columnKey)!==undefined;}A.setProperty("/filters",g);};e.prototype._getFilterFieldControl=function(f,p){for(var i=0;i<f.length;i++){if(f[i].getFieldPath()===p){return f[i];}}};e.prototype._adaptFilterBar=function(A,r){var f="",g="";for(var i=0;i<A.length;i++){f+=A[i].text+", ";}for(var i=0;i<r.length;i++){g+=r[i].text+", ";}b.show("Adapting the Filter Bar is not yet implemented. \n The following filters shall be added:"+f+"The following filters shall be removed: "+g);};e._helper={getSelectionFields:function(o){var A=o.getObject("/this").getProperty("annotationForSelectionFields")||"";var E=o.getObject("entitySet");var f=E.getPath();return E.getModel().createBindingContext(f+"/"+A);},getFilterProperty:function(o){var p=o.getObject();if(p.$PropertyPath){return o.getModel().createBindingContext(o.getPath()+"/$PropertyPath");}else{return o;}},isPropertyFilterable:function(o,p){var E,f,i=false,m=o.getModel(),g=o.getPath();if(m.getObject(g+"@com.sap.vocabularies.UI.v1.Hidden")){return false;}if(m.getObject(g+"@com.sap.vocabularies.UI.v1.HiddenFilter")){return false;}E=C._getEntitySetPath(m,g);if(typeof(p)==="string"){f=p;}else{f=m.getObject(g+"@sapui.name");}if(f.indexOf("/")<0){i=e._helper._isInNonFilterableProperties(m,E,f);}else{i=e._helper._isContextPathFilterable(m,E,f);}return!i;},isNavPropertyFilterable:function(o,n){var E,f,i=false,p=o.getPath(),m=o.getModel();E=C._getEntitySetPath(m,p);f=p.slice(E.length+1);if(f.indexOf("/")<0){i=e._helper._isInNonFilterableProperties(m,E,f);}else{i=e._helper._isContextPathFilterable(m,E,f);}return!i;},_isInNonFilterableProperties:function(m,E,f){var i=false;var A=m.getObject(E+"@Org.OData.Capabilities.V1.FilterRestrictions");if(A&&A.NonFilterableProperties){i=A.NonFilterableProperties.some(function(p){return p.$NavigationPropertyPath===f||p.$PropertyPath===f;});}return i;},_isContextPathFilterable:function(m,E,f){var g=f.split("/"),i=false,h="";g.some(function(j,k,l){if(h.length>0){h+="/"+j;}else{h=j;}if(k===l.length-1){i=e._helper._isInNonFilterableProperties(m,E,h);}else if(m.getObject(E+"/$NavigationPropertyBinding/"+j)){i=e._helper._isInNonFilterableProperties(m,E,h);h="";E="/"+m.getObject(E+"/$NavigationPropertyBinding/"+j);}return i===true;});return i;},replaceSpecialCharsInId:function(p,i){var f;if(typeof(p)==="string"){f=p;}else{f=i.context.getModel().getObject(i.context.getPath()+"@sapui.name");}return C.replaceSpecialCharsInId(f);}};e._helper.isNavPropertyFilterable.requiresIContext=true;e._helper.isPropertyFilterable.requiresIContext=true;return e;},true);

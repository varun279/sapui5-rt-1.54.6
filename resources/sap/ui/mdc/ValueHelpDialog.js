/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2018 SAP SE. All rights reserved
 */
sap.ui.define(["./ResourceModel",'sap/ui/mdc/base/ConditionModel',"sap/ui/mdc/base/ValueHelpPanel","sap/ui/mdc/base/DefineConditionPanel","sap/ui/mdc/internal/common/Helper","sap/ui/model/json/JSONModel","sap/ui/mdc/experimental/NamedBindingModel","sap/m/Dialog","sap/m/Bar","sap/m/Label","sap/m/Button"],function(R,C,V,D,a,J,N,b,B,L,c){"use strict";var d=b.extend("sap.ui.mdc.ValueHelpDialog",{metadata:{properties:{entitySet:"string",fieldPath:"string",conditionModelName:"string",showConditionTab:{type:"boolean",defaultValue:true}},aggregations:{},events:{},publicMethods:[]},renderer:{}});d.prototype.init=function(){b.prototype.init.apply(this,arguments);var t=this;var T=new L();var o=new B({contentMiddle:T,contentRight:new c({text:'{$i18n>valuehelp.RESET}',press:this.onReset.bind(this)})});this.setCustomHeader(o);this.setDraggable(true);this.setResizable(true);this.setContentWidth('1024px');this.setContentHeight('600px');this.setVerticalScrolling(false);this.setHorizontalScrolling(false);this.setBeginButton(new c({text:'{$i18n>valuehelp.OK}',press:this.onOk.bind(this)}));this.setEndButton(new c({text:'{$i18n>valuehelp.CANCEL}',press:this.onCancel.bind(this)}));this.addStyleClass("sapUiNoContentPadding");this.oValueHelpPanel=new V({height:"100%"});this.oValueHelpPanel.attachOnBasicSearchChange(t.handleOnBasicSearch.bind(t));this.addContent(t.oValueHelpPanel);this.attachAfterClose(function(e){Object.keys(this.mSearchTemplates).forEach(function(s){var S=this.mSearchTemplates[s];if(S.$filterBar&&S.$listContainer){var g=S.$filterBar.getConditionModelName();var h=S.$filterBar.getModel(g);var l=S.$listContainer.getListBinding();C.destroyCM(h);l.getModel().unregisterNamedBinding(l);}}.bind(this));this.destroy();}.bind(this));var f=function(){var m=this.getModel();var e,F;if(m){t.detachModelContextChange(f);e=t.getEntitySet();F=t.getFieldPath();var g=t.getModel(t.getConditionModelName());t.oConditionModelClone=g.clone(F);var h=t.oConditionModelClone.bindProperty("/",t.oConditionModelClone.getContext("/"));h.attachChange(function(i){t.updateTableSelections();});t.oValueHelpPanel.initModel(t.oConditionModelClone);m.getMetaModel().requestValueListInfo('/'+e+'/'+F).then(function(v){a._extendValueListMetadata(m.getMetaModel(),e,F,v);t.mSearchTemplates=v;var i=[],s=Object.keys(t.mSearchTemplates);if(s.length>1){s.forEach(function(j){i.push({key:s.indexOf(j).toString(),title:j,visible:true});});t.oValueHelpPanel.setSearchTemplateModelData({currentVariant:"0",defaultVariant:"0",variantsEditable:false,variants:i});}var S=function(E){t.switchSearchTemplate(Object.keys(t.mSearchTemplates)[E.getParameter("key")]);};t.oValueHelpPanel.attachSearchTemplateChange(S);t.switchSearchTemplate(t.mSearchTemplates[""]?"":s[0]);},function(E){throw(E.message);});T.setText(t.getTitle());}};this.attachModelContextChange(f);};d.prototype.onOk=function(){var l=this.getFieldPath();var o=this.getModel(this.getConditionModelName());o.merge(l,this.oConditionModelClone);this.close();};d.prototype.onCancel=function(){this.close();};d.prototype.handleOnBasicSearch=function(e){var t=this.mSearchTemplates[this.sActiveSearchTemplate].$listContainer.getInnerTable();var s=e.getParameter("value")||e.getParameter("newValue");t.getBinding("items").changeParameters({$search:s||undefined});};d.prototype.switchSearchTemplate=function(s){if(this.mSearchTemplates[s].$listContainer&&this.mSearchTemplates[s].$filterBar){this.updateContent(this.mSearchTemplates[s].$filterBar,this.mSearchTemplates[s].$listContainer);this.sActiveSearchTemplate=s;this.updateTableSelections();return;}var t=this;var v=this.mSearchTemplates[s];var o=new J(v);var m=v.$model.getMetaModel();var e=sap.ui.view({viewName:"sap.ui.mdc.ValueHelpTemplate",type:"XML",async:true,preprocessors:{xml:{bindingContexts:{entitySet:m.createBindingContext("/"+v.CollectionPath),valueList:o.createBindingContext("/")},models:{valueList:o,entitySet:m}}}});e.loaded().then(function(e){var T=t.mSearchTemplates[s].$listContainer=e.byId("valueListTable");var F=t.mSearchTemplates[s].$filterBar=e.byId("valueListFilterBar");T.attachSelectionChange(t.handleSelectionChange.bind(t));T.onBeforeRendering=function(){var l=T.getListBinding();l.attachChange(t.updateTableSelections.bind(t));};(v.$model.registerNamedBinding?Promise.resolve():N.upgrade(v.$model)).then(function(){T.setModel(v.$model);F.setModel(v.$model);t.updateContent(F,T);e.destroy();});t.sActiveSearchTemplate=s;});if(t.getShowConditionTab()&&t.mSearchTemplates[s].sSelectionMode!=="SingleSelectLeft"){var f=new D({height:"100%"});t.oValueHelpPanel.setDefineConditions(f);}if(t.mSearchTemplates[s].sSelectionMode==="SingleSelectLeft"){t.oValueHelpPanel.setShowTokenizer(false);}};d.prototype.updateContent=function(f,t){this.oValueHelpPanel.setFilterbar(f);var s=new sap.m.ScrollContainer({height:"100%",horizontal:false,vertical:true});s.addContent(t);this.oValueHelpPanel.setTable(s);};d.prototype.handleSelectionChange=function(e){var t=this;var o=t.oConditionModelClone;var v=t.mSearchTemplates[t.sActiveSearchTemplate];var i,k,s,f;e.getParameter("listItems").forEach(function(l){f=l.getBindingContext();i=f.getObject();k=i[v.$mdc.keyPath];s=i[v.$mdc.descriptionPath];var O={};Object.keys(v.$mdc.oLocalDataToValueListMap).forEach(function(j){var m=v.$mdc.oLocalDataToValueListMap[j];O[j]=i[m];});var g;if(s===null||s===undefined||s===""){g=o.createCondition(t.getFieldPath(),"EEQ",[k]);}else{g=o.createCondition(t.getFieldPath(),"EEQ",[k,s]);}g.outParameters=O;var S=t.mSearchTemplates[t.sActiveSearchTemplate].$listContainer.getInnerTable()._sLastMode;var h=o.indexOf(g,t.getFieldPath());if(h===-1){if(S==="SingleSelectLeft"){o.removeAllConditions();o.addCondition(g);t.onOk();}else{o.addCondition(g);}}else{o.removeCondition(t.getFieldPath(),h);}});};d.prototype.updateTableSelections=function(e){var t=this;var T;if(!t.mSearchTemplates||!t.mSearchTemplates[t.sActiveSearchTemplate]){return;}T=t.mSearchTemplates[t.sActiveSearchTemplate].$listContainer.getInnerTable();T.removeSelections(true);var l=T.getItems();var f;var v=t.mSearchTemplates[t.sActiveSearchTemplate];f=t.oConditionModelClone.getConditions();f.forEach(function(o){if(o.operator==="EEQ"){l.forEach(function(g){var i=g.getBindingContext().getObject();var O=o.outParameters;if((Object.keys(O).filter(function(k){var s=v.$mdc.oLocalDataToValueListMap[k];return O[k]===i[s];}).length)===Object.keys(O).length){T.setSelectedItem(g,true);}});}});};d.prototype.onReset=function(){var f;for(var p in this.mSearchTemplates){f=this.mSearchTemplates[p].$filterBar;if(f){f.getModel(f.getConditionModelName()).removeAllConditions();}}this.oConditionModelClone.removeAllConditions();};return d;},true);

/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObject","./thirdparty/three","sap/ui/vk/threejs/thirdparty/matai","./PerspectiveCamera","./OrthographicCamera","sap/ui/vk/View"],function(q,M,t,m,P,O,V){"use strict";var C=M.extend("sap.ui.vk.threejs.ContentDeliveryService",{metadata:{publicMethods:["initUrl","load","update","loadView"],events:{cameraChanged:{parameters:{sceneId:{type:"string"},camera:{type:"any"}},enableEventBubbling:true},sceneUpdated:{parameters:{},enableEventBubbling:true},errorReported:{paramters:{error:{type:"any"}}}}}});var b=C.getMetadata().getParent().getClass().prototype;C.prototype.init=function(){if(b.init){b.init.call(this);}this._loader=null;this._transientSceneMap=new Map();};C.prototype.initUrl=function(u){var a=this;var d;var e;function n(){a.fireSceneUpdated({});}if(!a._loader){this._loader=new Matai.Loader();var s=this._loader.getState();s.onErrorCallbacks.attach(this._reportError.bind(a));s.onMaterialFinishedCallbacks.attach(n);s.onImageFinishedCallbacks.attach(n);s.onSetGeometryCallbacks.attach(n);}var p=[];if(q.sap.startsWith(u,"ws")){d=new Matai.Loader.WebSocketConnection();e=d.init(u).then(function(){a._loader.init(d);}).catch(function(f){a._loader=null;throw f;});p.push(e);}else if(q.sap.startsWith(u,"http")){d=new Matai.Loader.HttpConnection();e=d.init(u).then(function(){a._loader.init(d);});p.push(e);}else{a._loader=null;p.push(Promise.reject("Content Delivery Service only allows http and websocket connection"));}return Promise.all(p);};function c(a){if(!a){return null;}var d;if(a.isOrthographicCamera){d=new sap.ui.vk.threejs.OrthographicCamera();}else if(a.isPerspectiveCamera){d=new sap.ui.vk.threejs.PerspectiveCamera();}d.setCameraRef(a);d.setUsingDefaultClipPlanes(true);if(a.cameraInfo&&a.cameraInfo.zoom===-1){d.setZoomNeedRecalculate(true);}return d;}C.prototype._reportError=function(e){this.fireErrorReported(e);};C.prototype._createLoadParam=function(s,r,a,d,p,e){var f=this;var i;var g=false;var h=false;if(d.logger===true){h=true;}var j={root:p,onActiveCamera:function(n){var l=false;var o=f._loader.getState();if(o){var u=o.contextMap.get(d.veid);if(u&&u.phase<2){i=c(n);l=true;}}if(!l){f.fireCameraChanged({sceneId:d.veid,camera:c(n)});}},onInitialSceneFinished:function(){g=true;r({node:p,camera:i,contentResource:e,loader:f});},activateView:d.activateView,logger:h};var k=function(l){if(!g){var n=l.getParameter("context");if(n&&n.sceneId===s){f.detachErrorReported(k);var o;if(l.getParameter("error")){o=l.getParameter("error");}else if(l.getParameter("errorText")){o=l.getParameter("errorText");}else if(l.getParameter("reason")){o=l.getParameter("reason");}else{o="failed to load: unknown reason";}if(l.getParameter("events")){o=o+"\n"+JSON.stringify(l.getParameter("events"));}a(o);}}};f.attachErrorReported(k);return j;};C.prototype.load=function(p,a){var d=this;return new Promise(function(r,f){var s;var g=true;try{s=JSON.parse(a.getSource());}catch(e){f("ContentDeliveryService.load - invalid json: contentResource");return;}if(!s||!s.veid){f("url or veid not specified");return;}if(d._loader){var h=d._loader.getConnection();if(h){if(h.getUrl()===s.url){g=false;}else{h.close();}}}if(g){d.initUrl(s.url).then(function(){var i=d._createLoadParam(s.veid,r,f,s,p,a);d._loader.request(s.veid,i);}).catch(function(j){f(j);});}else{var i=d._createLoadParam(s.veid,r,f,s,p,a);d._loader.request(s.veid,i);}});};C.prototype.getState=function(){if(this._loader){return this._loader.getState();}return null;};C.prototype.decrementResouceCountersForDeletedTreeNode=function(s){var a=this.getState();if(a){a.contextMap.forEach(function(v,k){if(v.treeNodeMap.has(s)){Matai.decrementResouceCountersForDeletedTreeNode(a,v,s);}});}};C.prototype.loadTransientScene=function(s,p){var a=this;return new Promise(function(r,d){if(!s||!p){d("invalid arguments");return;}if(a._transientSceneMap.has(s)){var e=a._transientSceneMap.get(s).clone();p.add(e);r({nodeRef:e});return;}if(!a._loader){d("ContentDeliveryService is not initialised");return;}var f=new THREE.Object3D();f.name="transient";var o=function(){var h=a._loader.getState().getContext(s);h.onSceneCompletedCallbacks.detach(o);a._transientSceneMap.set(s,f);var e=f.clone();p.add(e);r({nodeRef:e});};var g={root:f,onSceneCompleted:o};a._loader.request(s,g);});};C.prototype.update=function(s,a,v){if(!this._loader){return Promise.reject("ContentDeliveryService is not initialised");}else{return Promise.resolve(this._loader.update(s,a,v));}};C.prototype.exit=function(){if(b.exit){b.exit.call(this);}if(this._loader){this._loader.dispose();this._loader=null;}this._transientSceneMap=null;};C.prototype.loadView=function(s,v,a){if(typeof a==="undefined"){a="static";}return this._loader.requestView(s,a,v).then(function(d){var e=new sap.ui.vk.View({name:d.name,nodeInfos:d.viewNodes});if(d.camera){var f=true;var r=false;if(d.camera.cameraInfo&&d.camera.cameraInfo.zoom===-1){r=true;}if(d.camera.type==="PerspectiveCamera"){e.setCameraInfo({type:d.camera.type,fov:d.camera.cameraInfo.fov*180/Math.PI,position:d.camera.position.toArray(),nearClipPlane:d.camera.near,farClipPlane:d.camera.far,upDirection:d.camera.up.toArray(),targetDirection:d.camera.getWorldDirection().toArray(),usingDefaultClipPlanes:f});}if(d.camera.type==="OrthographicCamera"){e.setCameraInfo({type:d.camera.type,zoomFactor:d.camera.zoom,position:d.camera.position.toArray(),nearClipPlane:d.camera.near,farClipPlane:d.camera.far,upDirection:d.camera.up.toArray(),targetDirection:d.camera.getWorldDirection().toArray(),usingDefaultClipPlanes:f,zoomNeedRecalculate:r});}}return e;}).catch(function(e){q.sap.log.error(e);return null;});};C.prototype.assignMaterialToNodes=function(s,a,n,d){var e=this;return this._loader.requestMaterial(a).then(function(f){function g(f,o){if(o===null||o===undefined){return;}o.userData.materialId=a;if(o.userData.originalMaterial!==undefined&&o.userData.originalMaterial!==f){o.userData.originalMaterial=f;f.userData.materialUsed++;}if(o.material!==undefined&&o.material!==f){o.material=f;if(o.userData.originalMaterial!==undefined){f.userData.materialUsed++;}}if(o.children===undefined||o.children===null){return;}o.children.forEach(function(p){g(f,p);});}function h(f,o){if(o.userData.markedForNotAssigningMaterial){delete o.userData.markedForNotAssigningMaterial;return;}o.userData.materialId=a;if(o.userData.originalMaterial!==undefined&&o.userData.originalMaterial!==f){o.userData.originalMaterial=f;f.userData.materialUsed++;}if(o.material!==undefined&&o.material!==f){o.material=f;if(o.userData.originalMaterial!==undefined){f.userData.materialUsed++;}}o.userData.materialId=a;if(o.userData.originalMaterial!==undefined&&o.userData.originalMaterial!==f){o.userData.originalMaterial=f;f.userData.materialUsed++;}if(o.children===undefined||o.children===null){return;}o.children.forEach(function(p){h(f,p);});}if(d===undefined||!d){for(var i=0;i<n.length;i++){g(f,n[i]);}}else{for(var j=0;j<n.length;j++){n[j].userData.markedForNotAssigningMaterial=true;}var k=e._loader.getState().contextMap.get(s);var l=k.root;h(f,l);}e.fireSceneUpdated({});return true;}).catch(function(f){q.sap.log.error(f);return false;});};C.prototype.printLogTokens=function(){if(this._loader){this._loader.printLogTokens();return true;}else{return false;}};return C;});

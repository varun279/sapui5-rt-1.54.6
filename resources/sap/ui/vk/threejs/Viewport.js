/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","../ViewportBase","sap/ui/core/ResizeHandler","../Loco","./thirdparty/three","../ContentConnector","../ViewStateManager","./ViewportGestureHandler","./OrthographicCamera","./NodesTransitionHelper"],function(q,l,V,R,L,t,C,a,b,O,N){"use strict";var c=V.extend("sap.ui.vk.threejs.Viewport",{metadata:{library:"sap.ui.vk",publicMethods:["setScene","getScene","getRenderer","hitTest","tap","render","getImage","setCamera"],properties:{renderMode:{type:"sap.ui.vk.RenderMode",defaultValue:"default"}}}});var d=c.getMetadata().getParent().getClass().prototype;c.prototype.init=function(){if(d.init){d.init.call(this);}this._resizeListenerId=null;this._renderLoopRequestId=0;this._renderLoopFunction=this._renderLoop.bind(this);this._shouldRenderFrame=true;this._clippingPlanes=[];this._renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});this._renderer.setPixelRatio(window.devicePixelRatio);this._renderer.setSize(1,1);this._renderer.shadowMap.enabled=true;this._camera=new sap.ui.vk.threejs.PerspectiveCamera();var e=["varying float vPos;","void main() {","	gl_Position = vec4(position, 1.0);","	vPos = position.y * -0.5 + 0.5;","}"].join("\n");var f=["uniform vec4 topColor;","uniform vec4 bottomColor;","varying float vPos;","void main() {","	gl_FragColor = mix(topColor, bottomColor, vPos);","}"].join("\n");var g=new THREE.Vector4();var h=new THREE.Vector4();this._updateColor(g,this.getBackgroundColorTop());this._updateColor(h,this.getBackgroundColorBottom());this._checkBackgroundColor();this._backgroundMaterial=new THREE.ShaderMaterial({uniforms:{topColor:{value:g},bottomColor:{value:h}},vertexShader:e,fragmentShader:f,side:THREE.DoubleSide,depthTest:false,depthWrite:false,blending:THREE.NoBlending});var i=new THREE.Geometry();i.vertices.push(new THREE.Vector3(-1,1,0),new THREE.Vector3(1,1,0),new THREE.Vector3(-1,-1,0),new THREE.Vector3(1,-1,0));i.faces.push(new THREE.Face3(0,2,1),new THREE.Face3(1,2,3));this._backgroundCamera=new THREE.Camera();this._backgroundScene=new THREE.Scene();this._backgroundScene.add(new THREE.Mesh(i,this._backgroundMaterial));var x=["#include <clipping_planes_pars_vertex>","varying vec3 vNormal;","void main() {","#include <begin_vertex>","#include <project_vertex>","#include <clipping_planes_vertex>","#include <beginnormal_vertex>","#include <defaultnormal_vertex>","	vNormal = normalize( transformedNormal );","}"].join("\n");var j=["#include <clipping_planes_pars_fragment>","uniform vec4 color1;","uniform vec4 color2;","varying vec3 vNormal;","void main() {","#include <clipping_planes_fragment>","	gl_FragColor = mix(color1, color2, abs(normalize(vNormal).z));","}"].join("\n");this._xrayColor1=new THREE.Vector4(0,0.75,1,0.45);this._xrayColor2=new THREE.Vector4(0,0,1,0);this._xrayMaterial=new THREE.ShaderMaterial({uniforms:{color1:{value:this._xrayColor1},color2:{value:this._xrayColor2}},vertexShader:x,fragmentShader:j,side:THREE.DoubleSide,depthWrite:false,depthFunc:THREE.LessDepth,blending:THREE.NormalBlending,clipping:true,transparent:true});this._viewportGestureHandler=new b(this);this._loco=new L();this._loco.addHandler(this._viewportGestureHandler);this._zoomedObject=null;this._nodesTransitionHelper=new N();this._nodesTransitionHelper.setViewport(this);this._cdsLoader=null;};c.prototype.exit=function(){this._loco.removeHandler(this._viewportGestureHandler);this._viewportGestureHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();this.setScene(null);this.setCamera(null);this._renderer=null;this._backgroundCamera=null;this._backgroundMaterial=null;this._backgroundScene=null;this._loco=null;this._viewportGestureHandler=null;if(this._cdsLoader){this._cdsLoader.detachSceneUpdated(this._handleCdsSceneUpdate,this);}if(d.exit){d.exit.call(this);}};c.prototype._startRenderLoop=function(){if(!this._renderLoopRequestId){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);}return this;};c.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=0;}return this;};c.prototype.setBackgroundColorTop=function(v){d.setBackgroundColorTop.call(this,v);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.topColor.value,v);this._checkBackgroundColor();}return this;};c.prototype.setBackgroundColorBottom=function(v){d.setBackgroundColorBottom.call(this,v);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.bottomColor.value,v);this._checkBackgroundColor();}return this;};c.prototype.setClippingPlanes=function(e){this._clippingPlanes=e;return this;};c.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();};c.prototype.onAfterRendering=function(){var e=this.getDomRef();e.appendChild(this._renderer.domElement);this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:e.clientWidth,height:e.clientHeight}});this._startRenderLoop();};c.prototype._handleResize=function(e){if(!this._camera||!this._renderer){return false;}var w=e.size.width;var h=e.size.height;if(this._camera){this._camera.update(w,h);}this._renderer.setSize(w,h);this.fireResize({size:{width:w,height:h}});this.setShouldRenderFrame();return true;};c.prototype.setScene=function(s){this._scene=s;this._homeCamera=null;var n=this._scene?this._scene.getSceneRef():undefined;if(n){var g;for(var i=0;i<n.children.length;i++){g=n.children[i];if(g.name==="DefaultLights"&&g.children.length){if(g.children[0]instanceof THREE.PointLight){this._eyePointLight=g.children[0];}}}}this.setShouldRenderFrame();return this;};c.prototype.getScene=function(){return this._scene;};c.prototype.setCamera=function(e){if(d.setCamera){d.setCamera.call(this,e);}var f=this.getCamera();if(f&&this._renderer){var s=this._renderer.getSize();f.update(s.width,s.height);if(!this._homeCamera&&f.getCameraRef()){this._homeCamera=f.getCameraRef().clone();}}this.setShouldRenderFrame();return this;};c.prototype.getRenderer=function(){return this._renderer;};c.prototype._getViewStateManagerThreeJS=function(){if(this._viewStateManager){if(this._viewStateManager.constructor===sap.ui.vk.threejs.ViewStateManager){return this._viewStateManager;}if(this._viewStateManager.constructor===sap.ui.vk.ViewStateManager&&this._viewStateManager._implementation.constructor===sap.ui.vk.threejs.ViewStateManager){return this._viewStateManager._implementation;}}return null;};c.prototype._updateBoundingBoxesTransformation=function(){var v=this._getViewStateManagerThreeJS();if(v){v._updateBoundingBoxesTransformation();}};c.prototype._updateBoundingBoxesIfNeeded=function(){var v=this._getViewStateManagerThreeJS();if(v){v._updateBoundingBoxesIfNeeded();}};c.prototype._updateColor=function(e,f){var g=sap.ui.vk.cssColorToColor(f);e.color=new THREE.Color(g.red/255,g.green/255,g.blue/255);e.alpha=g.alpha;e.x=e.color.r*e.alpha;e.y=e.color.g*e.alpha;e.z=e.color.b*e.alpha;e.w=e.alpha;};c.prototype._checkBackgroundColor=function(){var e=this.getBackgroundColorTop();if(e===this.getBackgroundColorBottom()){if(this._backgroundColor===null){this._backgroundColor=new THREE.Vector4();}this._updateColor(this._backgroundColor,e);}else{this._backgroundColor=null;}this.setShouldRenderFrame();};c.prototype._handleCdsSceneUpdate=function(){this.setShouldRenderFrame();};c.prototype.setShouldRenderFrame=function(){this._shouldRenderFrame=true;return this;};c.prototype.shouldRenderFrame=function(){return this._shouldRenderFrame;};c.prototype.hitTest=function(x,y){var n=this._scene?this._scene.getSceneRef():undefined;var e=this._camera?this._camera.getCameraRef():undefined;if(!e||!n){return null;}var f=this._renderer.domElement;var m=new THREE.Vector2((x-f.clientLeft)/f.clientWidth*2-1,(f.clientTop-y)/f.clientHeight*2+1);var g=new THREE.Raycaster();g.setFromCamera(m,e);var i=g.intersectObjects(n.children,true);if(i&&i.length){return i[0];}return null;};c.prototype.tap=function(x,y,i){if(!i){if(this._viewStateManager){var h=this.hitTest(x,y);var n=h&&h.object;var e={picked:n?[n]:[]};this.fireNodesPicked(e);if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Exclusive){this.exclusiveSelectionHandler(e.picked);}else if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Sticky){this.stickySelectionHandler(e.picked);}}}else{var f=this.hitTest(x,y);if(f&&(this._zoomedObject===null||this._zoomedObject!==f.object)){this._zoomedObject=f.object;this._viewportGestureHandler.zoomObject(this._zoomedObject,true);}else{this._viewportGestureHandler.zoomObject(this._zoomedObject,false);this._zoomedObject=null;}}return this;};var o={x:-2,y:-2};var r=2;var p=5;[{key:"left",dx:-r,dy:0},{key:"right",dx:+r,dy:0},{key:"up",dx:0,dy:-r},{key:"down",dx:0,dy:+r}].forEach(function(i){c.prototype["onsap"+i.key]=function(e){var f=this._viewportGestureHandler._cameraController;f.beginGesture(o.x,o.y);f.rotate(i.dx,i.dy,true);f.endGesture();this.setShouldRenderFrame();e.preventDefault();e.stopPropagation();};});[{key:"left",dx:-p,dy:0},{key:"right",dx:+p,dy:0},{key:"up",dx:0,dy:-p},{key:"down",dx:0,dy:+p}].forEach(function(i){c.prototype["onsap"+i.key+"modifiers"]=function(e){if(e.shiftKey&&!(e.ctrlKey||e.altKey||e.metaKey)){var f=this._viewportGestureHandler._cameraController;f.beginGesture(o.x,o.y);f.pan(i.dx,i.dy);f.endGesture();this.setShouldRenderFrame();e.preventDefault();e.stopPropagation();}};});[{key:"minus",d:0.98},{key:"plus",d:1.02}].forEach(function(i){c.prototype["onsap"+i.key]=function(e){var f=this._viewportGestureHandler._cameraController;f.beginGesture(this.$().width()/2,this.$().height()/2);f.zoom(i.d);f.endGesture();this.setShouldRenderFrame();e.preventDefault();e.stopPropagation();};});c.prototype._handleVisibilityChanged=c.prototype._handleSelectionChanged=c.prototype._handleOpacityChanged=c.prototype._handleTintColorChanged=c.prototype._handleHighlightColorChanged=function(e){this.setShouldRenderFrame();};c.prototype._handleSelectionChanged=function(e){var f=this.getTools();for(var i=0;i<f.length;i++){var g=sap.ui.getCore().byId(f[i]);var h=g.getGizmoForContainer(this);if(h&&h.handleSelectionChanged){h.handleSelectionChanged(e);}}this.setShouldRenderFrame();};c.prototype.setSelectionRect=function(e){this.setShouldRenderFrame();if(!e){this._selectionRect=null;return;}var s=this._renderer.getSize();var x=(e.x1/s.width)*2-1,y=(e.y1/s.height)*-2+1,f=(e.x2/s.width)*2-1,g=(e.y2/s.height)*-2+1;if(!this._selectionRect){var h=new THREE.Geometry();h.vertices.push(new THREE.Vector3(x,g,-1),new THREE.Vector3(f,g,-1),new THREE.Vector3(f,y,-1),new THREE.Vector3(x,y,-1),new THREE.Vector3(x,g,-1));this._selectionRect=new THREE.Line(h,new THREE.LineBasicMaterial({color:0xffff00}));}else{var v=this._selectionRect.geometry.vertices;v[0].set(x,g,-1);v[1].set(f,g,-1);v[2].set(f,y,-1);v[3].set(x,y,-1);v[4].set(x,g,-1);this._selectionRect.geometry.verticesNeedUpdate=true;}};c.prototype._renderLoop=function(){if(!this._renderer||!this.getDomRef()){this._renderLoopRequestId=0;return;}if(this._viewportGestureHandler){this._viewportGestureHandler.animateCameraUpdate();}if(this._nodesTransitionHelper){this._nodesTransitionHelper.displayNodesMoving();}var n=this.getCamera()?this.getCamera().getCameraRef():undefined;if(this._eyePointLight&&n){this._eyePointLight.position.copy(n.position);}if(this._shouldRenderFrame){this._shouldRenderFrame=false;this.render();}this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);};c.prototype.render=function(){var e=this._renderer;if(!e){return;}e.autoClear=this._backgroundColor!=null;if(e.autoClear){e.setClearColor(this._backgroundColor.color,this._backgroundColor.alpha);}else{e.render(this._backgroundScene,this._backgroundCamera);}var n=this._scene?this._scene.getSceneRef():null;var f=this._camera?this._camera.getCameraRef():null;if(!n||!f){return;}var g=this.getTools();var i,h,j;if(this._camera.getUsingDefaultClipPlanes()||(f.isOrthographicCamera&&this._camera.getZoomNeedRecalculate())){var k=this._scene._computeBoundingBox();if(!k.isEmpty()){if(this._camera.getUsingDefaultClipPlanes()){this._camera.adjustClipPlanes(k);for(i=0;i<g.length;i++){h=sap.ui.getCore().byId(g[i]);j=h.getGizmoForContainer(this);if(j&&j.adjustCameraClipPlanes){j.adjustCameraClipPlanes(this._camera,k);}}}if(f.isOrthographicCamera&&this._camera.getZoomNeedRecalculate()){this._camera.adjustZoom(k);}}}var v=this._getViewStateManagerThreeJS();e.clippingPlanes=this._clippingPlanes;if(this.getRenderMode()===sap.ui.vk.RenderMode.XRay){if(v){var m=n.children[n.children.length-1].clone();v._selectedNodes.forEach(function(u){if(u.visible){u.add(m);e.render(u,f);e.autoClear=false;u.remove(m);}});}this._xrayColor1.w=0.45;n.overrideMaterial=this._xrayMaterial;}e.render(n,f);e.autoClear=false;n.overrideMaterial=null;if(e.clippingPlanes.length>0){e.clippingPlanes.forEach(function(u){u.negate();});this._xrayColor1.w=0.1;n.overrideMaterial=this._xrayMaterial;e.render(n,f);n.overrideMaterial=null;e.clippingPlanes.forEach(function(u){u.negate();});}e.clippingPlanes=[];if(v){var s=v._boundingBoxesScene;if(s){e.render(s,f);}}for(i=0;i<g.length;i++){h=sap.ui.getCore().byId(g[i]);j=h.getGizmoForContainer(this);if(j&&j.render){j.render(this);}}if(this._selectionRect){e.render(this._selectionRect,this._backgroundCamera);}};c.prototype.getImage=function(e,f,g,i){if(this._scene===null){return null;}if(e<8){e=8;}if(f<8){f=8;}if(e>2048){e=2048;}if(f>2048){f=2048;}var j=new THREE.WebGLRenderer({preserveDrawingBuffer:true});j.setSize(e,f);var k=this.getBackgroundColorTop();var m=this.getBackgroundColorBottom();if(g&&!i){j.setClearColor(g,1);}else if(!g&&i){j.setClearColor(i,1);}else{if(g&&i){this.setBackgroundColorTop(g);this.setBackgroundColorBottom(i);}j.render(this._backgroundScene,this._backgroundCamera);j.autoClear=false;}document.body.appendChild(j.domElement);var n=this.getCamera().getCameraRef().clone();var s=e/f;if(n.isOrthographicCamera){var w=n.right-n.left;var h=n.top-n.bottom;if(w>h){n.top=w/s/2;n.bottom=-w/s/2;}else{n.left=-h*s/2;n.right=h*s/2;}}else{var u=2*Math.atan(n.aspect*Math.tan(n.fov*Math.PI/360));if(n.fov<u*180/Math.PI){n.fov=360*Math.atan(Math.tan(u*0.5)/s)/Math.PI;}n.aspect=s;}n.updateProjectionMatrix();var v=[];var x=this._getViewStateManagerThreeJS();if(x!==null){x.enumerateSelection(function(z){v.push(z);});x.setSelectionState(v,false,false);}j.render(this._scene.getSceneRef(),n);var y=j.getContext().canvas.toDataURL();if(x!==null&&v.length>0){x.setSelectionState(v,true,false);}j.forceContextLoss();document.body.removeChild(j.domElement);if(m&&g){this.setBackgroundColorBottom(m);}if(k&&i){this.setBackgroundColorTop(k);}return y;};c.prototype._setContent=function(e){var s;var f;if(e){s=e;if(!(s instanceof sap.ui.vk.threejs.Scene)){s=null;}f=e.camera;if(!(f instanceof sap.ui.vk.threejs.OrthographicCamera||f instanceof sap.ui.vk.threejs.PerspectiveCamera)){f=null;}if(e.loaders){for(var i=0;i<e.loaders.length;i++){if(e.loaders[i]instanceof sap.ui.vk.threejs.ContentDeliveryService){this._cdsLoader=e.loaders[i];this._cdsLoader.attachSceneUpdated(this._handleCdsSceneUpdate,this);break;}}}}this.setScene(s);if(f){this.setCamera(f);}};c.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};c.prototype._onBeforeClearContentConnector=function(){if(d._onBeforeClearContentConnector){d._onBeforeClearContentConnector.call(this);}this.setScene(null);};c.prototype._handleContentReplaced=function(e){var f=e.getParameter("newContent");this._setContent(f);};c.prototype._onAfterUpdateViewStateManager=function(){};c.prototype._onBeforeClearViewStateManager=function(){};C.injectMethodsIntoClass(c);a.injectMethodsIntoClass(c);c.prototype.activateView=function(v){var e=v.getCameraInfo();var n;if(e){if(e.type==="PerspectiveCamera"){n=new sap.ui.vk.threejs.PerspectiveCamera();n.setFov(e.fov);}if(e.type==="OrthographicCamera"){n=new sap.ui.vk.threejs.OrthographicCamera();n.setZoomFactor(e.zoomFactor);if(e.zoomNeedRecalculate){n.setZoomNeedRecalculate(true);}}n.setNearClipPlane(e.nearClipPlane);n.setFarClipPlane(e.farClipPlane);n.setUpDirection(e.upDirection);n.setPosition(e.position);n.setTargetDirection(e.targetDirection);n.setUsingDefaultClipPlanes(e.usingDefaultClipPlanes);this._viewportGestureHandler.prepareForCameraUpdateAnimation(e.type);this.setCamera(n);this._viewportGestureHandler.startAnimatingCameraUpdate(500);}function f(D){return new THREE.Matrix4().set(D[0],D[1],D[2],D[3],D[4],D[5],D[6],D[7],D[8],D[9],D[10],D[11],0,0,0,1);}var g=this._viewStateManager.getNodeHierarchy();var h=v.getNodeInfos();if(h){this._nodesTransitionHelper.clear();h.forEach(function(B){if(B.target===null){return;}function D(G,H,I){for(var J=0;J<G.elements.length;J++){if(Math.abs(G.elements[J]-H.elements[J])>I){return false;}}return true;}if(B.transform){var E=f(B.transform);if(!D(E,B.target.matrix,1e-6)){var F=g.createNodeProxy(B.target);this._nodesTransitionHelper.setNodeForDisplay(F);E.decompose(B.target.position,B.target.quaternion,B.target.scale);B.target.updateMatrix();}}}.bind(this));var i=[];var j=[];for(var k=0;k<h.length;k++){if(h[k].visible){i.push(h[k].target);}else{j.push(h[k].target);}}this._viewStateManager.setVisibilityState(i,true,false);this._viewStateManager.setVisibilityState(j,false,false);var m=new Set(i);var s=[];var u=g.getSceneRef();var w=this;u.traverse(function collectChildNodes(B){if(B.parent&&w._viewStateManager.getVisibilityState(B.parent)===false){return;}if(w._viewStateManager.getVisibilityState(B)){if(B.userData&&B.userData.treeNode){s.push(B);}}});var x=[];for(var y=0;y<s.length;y++){if(!m.has(s[y])){var z=true;var A=0;var B=s[y];while(B&&A<4){if(B.parent&&B.parent.userData&&B.parent.userData.treeNode){z=false;break;}else{B=B.parent;A++;}}if(!z){x.push(s[y]);}}}this._viewStateManager.setVisibilityState(x,false,false);this._nodesTransitionHelper.startDisplay(500);}return this;};c.prototype.queueCommand=function(e){if(this instanceof sap.ui.vk.threejs.Viewport){e();}return this;};c.prototype.getOutputSize=function(){var e=this.getDomRef().getBoundingClientRect();var v=e.width;var f=e.height;var g;g=Math.min(v,f);return{left:(v-g)/2,top:(f-g)/2,sideLength:g};};return c;});

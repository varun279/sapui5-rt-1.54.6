/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","../ViewportBase","sap/ui/core/ResizeHandler","../Loco","../ViewportHandler","../Smart2DHandler","../Messages","../ContentConnector","../ViewStateManager","./GraphicsCore"],function(q,l,V,R,L,a,S,M,C,b,G){"use strict";var d={encodedProjectionType:{},decodedProjectionType:{},encodedBindingType:{},decodedBindingType:{},decodedZoomTo:{}};d.decodedProjectionType[sap.ui.vk.CameraProjectionType.Perspective]=sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE;d.decodedProjectionType[sap.ui.vk.CameraProjectionType.Orthographic]=sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC;d.encodedProjectionType[sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE]=sap.ui.vk.CameraProjectionType.Perspective;d.encodedProjectionType[sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC]=sap.ui.vk.CameraProjectionType.Orthographic;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Minimum]=sap.ve.dvl.DVLCAMERAFOVBINDING.MIN;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Maximum]=sap.ve.dvl.DVLCAMERAFOVBINDING.Max;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Horizontal]=sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Vertical]=sap.ve.dvl.DVLCAMERAFOVBINDING.VERT;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.MIN]=sap.ui.vk.CameraFOVBindingType.Minimum;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.MAX]=sap.ui.vk.CameraFOVBindingType.Maximum;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ]=sap.ui.vk.CameraFOVBindingType.Horizontal;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.VERT]=sap.ui.vk.CameraFOVBindingType.Vertical;d.decodedZoomTo[sap.ui.vk.ZoomTo.All]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_ALL;d.decodedZoomTo[sap.ui.vk.ZoomTo.Visible]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_VISIBLE;d.decodedZoomTo[sap.ui.vk.ZoomTo.Selected]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_SELECTED;d.decodedZoomTo[sap.ui.vk.ZoomTo.Node]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_NODE;d.decodedZoomTo[sap.ui.vk.ZoomTo.NodeSetIsolation]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_NODE_SETISOLATION;d.decodedZoomTo[sap.ui.vk.ZoomTo.Restore]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_RESTORE;d.decodedZoomTo[sap.ui.vk.ZoomTo.RestoreRemoveIsolation]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_RESTORE_REMOVEISOLATION;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewLeft]=sap.ve.dvl.DVLZOOMTO.VIEW_LEFT;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewRight]=sap.ve.dvl.DVLZOOMTO.VIEW_RIGHT;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewTop]=sap.ve.dvl.DVLZOOMTO.VIEW_TOP;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewBottom]=sap.ve.dvl.DVLZOOMTO.VIEW_BOTTOM;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewBack]=sap.ve.dvl.DVLZOOMTO.VIEW_BACK;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewFront]=sap.ve.dvl.DVLZOOMTO.VIEW_FRONT;var c=V.extend("sap.ui.vk.dvl.Viewport",{metadata:{library:"sap.ui.vk",publicMethods:["beginGesture","endGesture","getGraphicsCore","getViewInfo","hitTest","pan","queueCommand","rotate","setGraphicsCore","setScene","setViewInfo","tap","zoom"],properties:{showAllHotspots:{type:"boolean",defaultValue:false},hotspotColorABGR:{type:"int",defaultValue:0xc00000ff},hotspotColor:{type:"sap.ui.core.CSSColor",defaultValue:"rgba(255, 0, 0, 0.7529411764705882)"},backgroundColorTopABGR:{type:"int",defaultValue:0xff000000},backgroundColorBottomABGR:{type:"int",defaultValue:0xffffffff}},events:{nodeClicked:{parameters:{nodeRef:"any",x:"int",y:"int"},enableEventBubbling:true},pan:{parameters:{dx:"int",dy:"int"}},zoom:{parameters:{zoomFactor:"float"}},rotate:{parameters:{dx:"int",dy:"int"}},viewActivated:{parameters:{type:{type:"string"}}},frameRenderingFinished:{}}}});var e=c.getMetadata().getParent().getClass().prototype;c.prototype.init=function(){if(e.init){e.init.call(this);}this._graphicsCore=null;this._dvl=null;this._dvlRendererId=null;this._viewStateManager=null;this._canvas=null;this._resizeListenerId=null;this._is2D=false;this._viewportHandler=new a(this);this._loco=new L();this._loco.addHandler(this._viewportHandler);this._smart2DHandler=null;this._lastPlayedStep=null;this._contentConnector=null;};c.prototype.exit=function(){this._loco.removeHandler(this._viewportHandler);this._viewportHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._clearContentConnector();this.setViewStateManager(null);this.setScene(null);this.setGraphicsCore(null);if(e.exit){e.exit.call(this);}};c.prototype.setGraphicsCore=function(f){if(f!=this._graphicsCore){if(this._graphicsCore){this._dvl.Client.detachFrameFinished(this._handleFrameFinished,this);this._dvl.Client.detachStepEvent(this._updateLastPlayedStep,this);this._dvl.Renderer.SetViewStateManager(null,this._dvlRendererId);this._graphicsCore._deregisterViewport(this);this._dvl=null;}this._graphicsCore=f;if(this._graphicsCore){this._dvl=this._graphicsCore._getDvl();this._graphicsCore._registerViewport(this);this.setShowDebugInfo(this.getShowDebugInfo());this._dvl.Client.attachStepEvent(this._updateLastPlayedStep,this);this._dvl.Client.attachFrameFinished(this._handleFrameFinished,this);this._dvl.Renderer.SetViewStateManager(this._viewStateManager,this._dvlRendererId);}}return this;};c.prototype.getGraphicsCore=function(){return this._graphicsCore;};c.prototype._setCanvas=function(f){var i=this.getDomRef()&&this._canvas!==f;this._canvas=f;if(i){this.invalidate();}return this;};c.prototype._setRenderer=function(f){this._dvlRendererId=f;return this;};c.prototype._updateLastPlayedStep=function(f){if(f.type===sap.ve.dvl.DVLSTEPEVENT.DVLSTEPEVENT_STARTED){this._lastPlayedStep=f.stepId;}};c.prototype.setScene=function(f){if(this._dvlRendererId){this._dvl.Renderer.AttachScene(f&&f.getSceneRef()||null,this._dvlRendererId);this._dvlSceneRef=f?f.getSceneRef():null;if(f){this._dvl.Client.attachUrlClicked(this._fireUrlClicked,this);var i=this._isSmart2DContent()||this._isSmart2DContentLegacy();if(i){this._dvl.Renderer.SetBackgroundColor(1,1,1,1,1,1,1,1,this._dvlRendererId);}else{var j=this._getDecomposedABGR(this.getBackgroundColorTopABGR());var m=this._getDecomposedABGR(this.getBackgroundColorBottomABGR());this._dvl.Renderer.SetBackgroundColor(j.red,j.green,j.blue,j.alpha,m.red,m.green,m.blue,m.alpha,this._dvlRendererId);}this.fireViewActivated({type:i?"2D":"3D"});}else{this._dvl.Client.detachUrlClicked(this._fireUrlClicked,this);if(this._smart2DHandler){var w=new L();w.removeHandler(this._smart2DHandler);}this.invalidate();}}return this;};c.prototype._isSmart2DContent=function(){var f=sap.ui.vk.dvl.getJSONObject(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_HOTSPOTS).ChildNodes);return f&&f.length>0;};c.prototype._isSmart2DContentLegacy=function(){var f=this._dvl.Scene.GetCurrentCamera(this._dvlSceneRef),i=this._dvl.Camera.GetRotation(f),j=this._dvl.Camera.GetProjection(f);return i[0]===90&&i[1]===-90&&i[2]===0&&j===sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC;};c.prototype._initializeSmart2DHandler=function(){if(this._viewStateManager){if(this._smart2DHandler){this._loco.removeHandler(this._smart2DHandler);}this._smart2DHandler=new S(this,this._viewStateManager);this._loco.addHandler(this._smart2DHandler);}if(this.getShowAllHotspots()){var f=this._viewStateManager.getNodeHierarchy(),i=f.getHotspotNodeIds();this.showHotspots(i,true);}};c.prototype._fireUrlClicked=function(f){this.fireUrlClicked({url:f.url,nodeRef:f.nodeId});};c.prototype.setHotspotColorABGR=function(f){this.setProperty("hotspotColorABGR",f,true);this.setProperty("hotspotColor",sap.ui.vk.colorToCSSColor(sap.ui.vk.abgrToColor(this.getProperty("hotspotColorABGR"))),true);return this;};c.prototype.setHotspotColor=function(f){this.setProperty("hotspotColor",f,true);this.setProperty("hotspotColorABGR",sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(this.getProperty("hotspotColor"))),true);return this;};c.prototype._getStepAndProcedureIndexes=function(f,m){var w=-1,x=-1,y=false;for(var i=0;i<f.length;i++){if(!y){for(var j=0;j<f[i].steps.length;j++){if(f[i].steps[j].id===m){x=j;w=i;y=true;break;}}}else{break;}}return{stepIndex:x,procedureIndex:w};};c.prototype._getStepVeIdById=function(f){if(f){var i=this._dvl.Scene.RetrieveVEIDs(this._dvlSceneRef,f);if(Array.isArray(i)){for(var j=0,m=i.length;j<m;++j){var w=i[j];if(w.source==="SAP"&&w.type==="VE_VIEWPORT"&&Array.isArray(w.fields)){for(var x=0,y=w.fields.length;x<y;++x){var z=w.fields[x];if(z.name==="ID"){return z.value;}}}}}}return null;};c.prototype._getStepIdByVeId=function(f,i){for(var j=0,m=f.length;j<m;++j){var w=f[j].steps;for(var x=0,y=w.length;x<y;++x){var z=w[x].id;if(this._getStepVeIdById(z)===i){return z;}}}return null;};var s=function(f){f.camera={};};var g=function(f){if(typeof f.camera==="object"&&f.camera!==null){f.camera.matrices=false;}};var h=function(f){if(typeof f.camera==="object"&&f.camera!==null){f.camera.useTransitionCamera=false;}};var k=function(f){f.animation=true;};var n=function(f){f.visibility=false;};var o=function(f){if(typeof f.visibility==="object"&&f.visibility!==null){f.visibility.mode=sap.ui.vk.VisibilityMode.Complete;}};c.prototype.getViewInfo=function(f){if(!this._dvlSceneRef){return null;}var i={};if(typeof f!=="object"||f===null){s(i);g(i);h(i);k(i);n(i);o(i);}else{if(typeof f.camera==="object"&&f.camera!==null){i.camera={};if(typeof f.camera.matrices==="boolean"){i.camera.matrices=f.camera.matrices;}else if("matrices"in f.camera){i.camera.matrices=false;}else{g(i);}if(typeof f.camera.useTransitionCamera==="boolean"){i.camera.useTransitionCamera=f.camera.useTransitionCamera;}else if("useTransitionCamera"in f.camera){i.camera.useTransitionCamera=false;}else{h(i);}}else if(typeof f.camera==="boolean"){if(f.camera===true){i.camera={};g(i);h(i);}else{i.camera=false;}}else if("camera"in f){i.camera=false;}else{s(i);g(i);h(i);}if(typeof f.animation==="boolean"){i.animation=f.animation;}else if("animation"in f){i.animation=false;}else{k(i);}if(typeof f.visibility==="object"&&f.visibility!==null){i.visibility={};if(f.visibility.mode===sap.ui.vk.VisibilityMode.Complete||f.visibility.mode===sap.ui.vk.VisibilityMode.Differences){i.visibility.mode=f.visibility.mode;}else{o(i);}}else if(typeof f.visibility==="boolean"){if(f.visibility===true){i.visibility={};o(i);}else{i.visibility=false;}}else if("visibility"in f){i.visibility=false;}else{n(i);o(i);}}var j={};if(i.camera){var m=null;if(i.camera.useTransitionCamera){m=this._dvl.Renderer.GetTransitionCamera(this._dvlRendererId);if(m===sap.ve.dvl.DVLID_INVALID){m=null;}}if(m===null){m=this._dvl.Renderer.GetCurrentCamera(this._dvlRendererId);}var w=this._dvl.Camera.GetRotation(m),x=this._dvl.Camera.GetOrigin(m);j.camera={rotation:{yaw:w[0],pitch:w[1],roll:w[2]},position:{x:x[0],y:x[1],z:x[2]},projectionType:d.encodedProjectionType[this._dvl.Camera.GetProjection(m)],bindingType:d.encodedBindingType[this._dvl.Camera.GetFOVBinding(m)]};if(this._matView){j.viewMatrix=this._matView.slice();}if(this._matProj){j.projectionMatrix=this._matProj.slice();}if(j.camera.projectionType===sap.ui.vk.CameraProjectionType.Perspective){j.camera.fieldOfView=this._dvl.Camera.GetFOV(m);}else if(j.camera.projectionType===sap.ui.vk.CameraProjectionType.Orthographic){j.camera.zoomFactor=this._dvl.Camera.GetOrthoZoomFactor(m);}if(i.camera.matrices){var y=this._dvl.Renderer.GetCameraMatrices(this._dvlRendererId);j.camera.matrices={view:y.view,projection:y.projection};}}if(i.animation){var z=this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_STEP_INFO),A=z.StepId!==sap.ve.dvl.DVLID_INVALID;var B=A?z.StepId:this._lastPlayedStep,D=A?z.StepTime:0,E=this._dvl.Scene.RetrieveProcedures(this._dvlSceneRef),F=this._getStepAndProcedureIndexes(E.procedures,B),H=this._getStepVeIdById(B);j.animation={animationTime:D,stepIndex:F.stepIndex,procedureIndex:F.procedureIndex};if(H){j.animation.stepVeId=H;}}if(i.visibility&&this._viewStateManager){j.visibility={mode:i.visibility.mode};if(i.visibility.mode===sap.ui.vk.VisibilityMode.Complete){var I=this._viewStateManager.getVisibilityComplete();j.visibility.visible=I.visible;j.visibility.hidden=I.hidden;}else if(this._viewStateManager.getShouldTrackVisibilityChanges()){j.visibility.changes=this._viewStateManager.getVisibilityChanges();}else{q.sap.log.warning(sap.ui.vk.getResourceBundle().getText(M.VIT32.summary),M.VIT32.code,"sap.ui.vk.dvl.Viewport");}}return j;};c.prototype.setViewInfo=function(f,i){var j=false;if(f.animation){var m=this._dvl.Scene.RetrieveProcedures(this._dvlSceneRef),w=f.animation.procedureIndex,x=f.animation.stepIndex,y=f.animation.stepVeId,z,A=f.animation.animationTime||0;if(y||x>=0&&w>=0){if(y){z=this._getStepIdByVeId(m.procedures,f.animation.stepVeId);}else if(w>=0&&w<m.procedures.length){if(x>=0&&x<m.procedures[w].steps.length){z=m.procedures[w].steps[x].id;}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT26.summary),M.VIT26.code,"sap.ui.vk.dvl.Viewport");}}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT27.summary),M.VIT27.code,"sap.ui.vk.dvl.Viewport");}if(z){this._dvl.Renderer.ActivateStep(this._dvlRendererId,z,false,false,A);this._dvl.Renderer.PauseCurrentStep(this._dvlRendererId);}}else{j=true;}}if(f.camera){var B;if(f.camera.projectionType===sap.ui.vk.CameraProjectionType.Perspective||f.camera.projectionType===sap.ui.vk.CameraProjectionType.Orthographic){B=d.decodedProjectionType[f.camera.projectionType];}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT19.summary),M.VIT19.code,"sap.ui.vk.dvl.Viewport");B=sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE;}var D=this._dvl.Scene.CreateCamera(this._dvlSceneRef,B,sap.ve.dvl.DVLID_INVALID);if(B===sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE){this._dvl.Camera.SetFOV(D,f.camera.fieldOfView);}else if(B===sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC){this._dvl.Camera.SetOrthoZoomFactor(D,f.camera.zoomFactor);}if(f.camera.position){this._dvl.Camera.SetOrigin(D,f.camera.position.x,f.camera.position.y,f.camera.position.z);}if(f.camera.rotation){this._dvl.Camera.SetRotation(D,f.camera.rotation.yaw,f.camera.rotation.pitch,f.camera.rotation.roll);}if(f.camera.bindingType){var E=d.decodedBindingType[f.camera.bindingType]||sap.ve.dvl.DVLCAMERAFOVBINDING.MIN;this._dvl.Camera.SetFOVBinding(D,E);}i=i||0;this._dvl.Renderer.ActivateCamera(this._dvlRendererId,D,i);this._dvl.Scene.DeleteNode(this._dvlSceneRef,D);}if(f.viewMatrix){this._matView=f.viewMatrix.slice();}if(f.projectionMatrix){this._matProj=f.projectionMatrix.slice();}if(f.visibility){var F=this._viewStateManager.getNodeHierarchy(),H=new Map(),I=F.findNodesByName();I.forEach(function(N){var O=F.createNodeProxy(N),P=q.grep(O.getVeIds(),function(P){return P.type==="VE_LOCATOR";});P=Array.isArray(P)&&P.length>0?P[0].fields[0].value:null;F.destroyNodeProxy(O);if(P){H.set(P,N);}});switch(f.visibility.mode){case sap.ui.vk.VisibilityMode.Complete:var J=f.visibility.visible,K=f.visibility.hidden;J.forEach(function(N){this._viewStateManager.setVisibilityState(H.get(N),true,false);},this);K.forEach(function(N){this._viewStateManager.setVisibilityState(H.get(N),false,false);},this);break;case sap.ui.vk.VisibilityMode.Differences:if(j){this.resetView({camera:false,visibility:true,transition:false});}f.visibility.changes.forEach(function(N){var O=H.get(N);if(O){this._viewStateManager.setVisibilityState(O,!this._viewStateManager.getVisibilityState(O),false);}},this);break;default:q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT28.summary),M.VIT28.code,"sap.ui.vk.dvl.Viewport");break;}}return this;};c.prototype.getOutputSize=function(){var f=this.getViewInfo().camera.bindingType,i=this.getDomRef().getBoundingClientRect(),j=i.width,m=i.height,w;switch(d.decodedBindingType[f]){case sap.ve.dvl.DVLCAMERAFOVBINDING.MIN:w=Math.min(j,m);break;case sap.ve.dvl.DVLCAMERAFOVBINDING.MAX:w=Math.max(j,m);break;case sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ:w=j;break;case sap.ve.dvl.DVLCAMERAFOVBINDING.VERT:w=m;break;default:break;}return{left:(j-w)/2,top:(m-w)/2,sideLength:w};};c.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}};c.prototype.onAfterRendering=function(){var f=this.getDomRef();if(this._canvas){f.appendChild(this._canvas);}this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:f.clientWidth,height:f.clientHeight}});};c.prototype._handleResize=function(f){if(this._dvlRendererId&&this._canvas){var i=f.size.width*window.devicePixelRatio;var j=f.size.height*window.devicePixelRatio;if(this._matProj){var m=this._matProj[0];var w=this._matProj[5];var x=Math.max(m,w);if(i>j){m=x*j/i;w=x;}else{m=x;w=x*i/j;}this._matProj[8]*=m/this._matProj[0];this._matProj[9]*=w/this._matProj[5];this._matProj[0]=m;this._matProj[5]=w;}this._dvl.Renderer.SetDimensions(i,j,this._dvlRendererId);this._dvl.Renderer.SetOptionF(sap.ve.dvl.DVLRENDEROPTIONF.DVLRENDEROPTIONF_DPI,96*window.devicePixelRatio,this._dvlRendererId);this._canvas.width=i;this._canvas.height=j;this._canvas.style.width=f.size.width+"px";this._canvas.style.height=f.size.height+"px";this.fireResize({size:{width:f.size.width,height:f.size.height}});return true;}};c.prototype._handleVisibilityChanged=c.prototype._handleSelectionChanged=c.prototype._handleOpacityChanged=c.prototype._handleTintColorChanged=function(f){if(this._dvlRendererId){this._dvl.Renderer.ForceRenderFrame(this._dvlRendererId);}};c.prototype.showHotspots=function(f,i,j){var m=sap.ui.vk.dvl.NodeProxy.prototype[typeof j==="string"?"setTintColor":"setTintColorABGR"];var w=function(y,j,D){var E=y.createNodeProxy(D);m.call(E,j);y.destroyNodeProxy(E);};if(!Array.isArray(f)){f=[f];}var x=j===undefined?this.getHotspotColorABGR():j;if(!i){x=0;}var y=this._viewStateManager.getNodeHierarchy();if(this._isSmart2DContent()){var z=[];f.forEach(function(D){var E=sap.ui.vk.dvl.getJSONObject(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,D,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN).ChildNodes);Array.prototype.push.apply(z,E);}.bind(this));Array.prototype.push.apply(z,f);z.forEach(w.bind(null,y,x));}else{var A=[];var B=function(D){var z=y.getChildren(D);Array.prototype.push.apply(A,z);z.forEach(B);};f.forEach(B);Array.prototype.push.apply(A,f);A.forEach(w.bind(null,y,x));}return this;};c.prototype._getDecomposedABGR=function(i){return{red:(i>>>0&0xff)/255,green:(i>>>8&0xff)/255,blue:(i>>>16&0xff)/255,alpha:(i>>>24&0xff)/255};};c.prototype._setBackgroundColor=function(){if(this._dvl){var f=this._getDecomposedABGR(this.getBackgroundColorTopABGR()),i=this._getDecomposedABGR(this.getBackgroundColorBottomABGR());this._dvl.Renderer.SetBackgroundColor(f.red,f.green,f.blue,f.alpha,i.red,i.green,i.blue,i.alpha,this._dvlRendererId);}};c.prototype.setBackgroundColorTopABGR=function(i){this.setProperty("backgroundColorTopABGR",i,true);this._setBackgroundColor();return this;};c.prototype.setBackgroundColorTop=function(f){this.setProperty("backgroundColorTop",f,true);return this.setBackgroundColorTopABGR(sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(f)));};c.prototype.setBackgroundColorBottomABGR=function(i){this.setProperty("backgroundColorBottomABGR",i,true);this._setBackgroundColor();return this;};c.prototype.setBackgroundColorBottom=function(f){this.setProperty("backgroundColorBottom",f,true);return this.setBackgroundColorBottomABGR(sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(f)));};c.prototype.setShouldRenderFrame=function(){if(this._dvlRendererId){this._dvl.Renderer.ForceRenderFrame(this._dvlRendererId);}return this;};c.prototype.shouldRenderFrame=function(){return this._dvlRendererId&&this._dvl.Renderer.ShouldRenderFrame(this._dvlRendererId);};c.prototype.renderFrame=function(){if(this._dvlRendererId){if(this._matView&&this._matProj){this.renderFrameEx(this._matView,this._matProj,this._dvlRendererId);}else{this._dvl.Renderer.RenderFrame(this._dvlRendererId);}}return this;};c.prototype.renderFrameEx=function(f,i){if(this._dvlRendererId){this._dvl.Renderer.RenderFrameEx.apply(this,[].concat(f,i),this._dvlRendererId);}return this;};c.prototype.resetView=function(f){if(f!==undefined&&!q.isPlainObject(f)){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT31.summary),M.VIT31.code,"sap.ui.vk.dvl.Viewport");}var i={camera:true,transition:true,visibility:false};q.extend(i,f);if(i.camera||i.visibility){var j=(i.camera?sap.ve.dvl.DVLRESETVIEWFLAG.CAMERA:0)|(i.transition?sap.ve.dvl.DVLRESETVIEWFLAG.SMOOTHTRANSITION:0)|(i.visibility?sap.ve.dvl.DVLRESETVIEWFLAG.VISIBILITY:0);if(this._dvlRendererId){this._dvl.Renderer.ResetView(j,this._dvlRendererId);this._lastPlayedStep=null;}}return this;};c.prototype.canIsolateNode=function(f){if(this._dvlRendererId){return this._dvl.Renderer.CanIsolateNode(f,this._dvlRendererId);}else{return false;}};c.prototype.setIsolatedNode=function(f){if(this._dvlRendererId){this._dvl.Renderer.SetIsolatedNode(f,this._dvlRendererId);}return this;};c.prototype.getIsolatedNode=function(){if(this._dvlRendererId){return this._dvl.Renderer.GetIsolatedNode(this._dvlRendererId);}else{return sap.ve.dvl.DVLID_INVALID;}};c.prototype.hitTest=function(x,y){if(this._dvlRendererId){var f=this._dvl.Renderer.HitTest(x*window.devicePixelRatio,y*window.devicePixelRatio,this._dvlRendererId).id;this.setShouldRenderFrame();return f;}else{return sap.ve.dvl.DVLID_INVALID;}};c.prototype.setShowDebugInfo=function(f){this.setProperty("showDebugInfo",f,true);if(this._dvlRendererId){this._dvl.Renderer.SetOption(sap.ve.dvl.DVLRENDEROPTION.DVLRENDEROPTION_SHOW_DEBUG_INFO,f,this._dvlRendererId);}return this;};c.prototype._handleFrameFinished=function(f){if(f.rendererId===this._dvlRendererId){this.fireFrameRenderingFinished();}};c.prototype.beginGesture=function(x,y){if(this._dvlRendererId){this._gesturePoint={x:x,y:y};this._dvl.Renderer.BeginGesture(x*window.devicePixelRatio,y*window.devicePixelRatio,this._dvlRendererId);}return this;};c.prototype.endGesture=function(){if(this._dvlRendererId){this._dvl.Renderer.EndGesture(this._dvlRendererId);}return this;};c.prototype._activateRedline=function(){var m=this._dvl.Renderer.GetCameraMatrices();this._matView=m.view;this._matProj=m.projection;};c.prototype._deactivateRedline=function(){this._matView=null;this._matProj=null;};c.prototype.pan=function(f,i){if(this._dvlRendererId){if(this._matProj){var j=this.getDomRef();this._matProj[8]-=f*2/j.clientWidth;this._matProj[9]+=i*2/j.clientHeight;this.setShouldRenderFrame();}else{this._dvl.Renderer.Pan(f*window.devicePixelRatio,i*window.devicePixelRatio,this._dvlRendererId);}this.firePan({dx:f,dy:i});}return this;};c.prototype.rotate=function(f,i){if(this._dvlRendererId){this._dvl.Renderer.Rotate(f*window.devicePixelRatio,i*window.devicePixelRatio,this._dvlRendererId);this.fireRotate({dx:f,dy:i});}return this;};function p(f){var m=f;var i=m[15]===1;var j=2/m[0];var w=2/m[5];var x,y;if(i){x=-m[12]*j;y=-m[13]*w;}else{x=m[8]*j;y=m[9]*w;}var z=(j+x)*0.5;var A=x-z;var B=(w+y)*0.5;var D=y-B;return{left:A,top:B,right:z,bottom:D};}function r(f,i){var m=f;var j=m[15]===1;m[0]=2/(i.right-i.left);m[5]=2/(i.top-i.bottom);if(j){m[12]=-(i.right+i.left)/(i.right-i.left);m[13]=-(i.top+i.bottom)/(i.top-i.bottom);}else{m[8]=(i.right+i.left)/(i.right-i.left);m[9]=(i.top+i.bottom)/(i.top-i.bottom);}}c.prototype.zoom=function(i){if(this._dvlRendererId){if(this._matProj){var j=this.getDomRef();var m=p(this._matProj);var w=m.left+(m.right-m.left)*this._gesturePoint.x/j.clientWidth;var x=m.top+(m.bottom-m.top)*this._gesturePoint.y/j.clientHeight;var f=1/i;m.left=w+(m.left-w)*f;m.right=w+(m.right-w)*f;m.top=x+(m.top-x)*f;m.bottom=x+(m.bottom-x)*f;r(this._matProj,m);this.setShouldRenderFrame();}else{this._dvl.Renderer.Zoom(i,this._dvlRendererId);}this.fireZoom({zoomFactor:i});}return this;};c.prototype.zoomTo=function(w,f,j,m){if(this._dvlRendererId){var x=0;if(Array.isArray(w)){for(var i in w){x|=d.decodedZoomTo[w[i]];}}else{x=d.decodedZoomTo[w];}this._dvl.Renderer.ZoomTo(x,f,j,m,this._dvlRendererId);}return this;};c.prototype.tap=function(x,y,i){if(this._dvlRendererId){var f=x*window.devicePixelRatio,j=y*window.devicePixelRatio;if(!i){var m=this.hitTest(x,y);var w={picked:m!==sap.ve.dvl.DVLID_INVALID?[m]:[]};this.fireNodesPicked(w);if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Exclusive){this.exclusiveSelectionHandler(w.picked);}else if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Sticky){this.stickySelectionHandler(w.picked);}if(m!==sap.ve.dvl.DVLID_INVALID){this.fireNodeClicked({nodeRef:m,nodeId:m,x:x,y:y},true,true);}this._dvl.Renderer.Tap(f,j,false,false,this._dvlRendererId);}else{this._dvl.Renderer.Tap(f,j,true,false,this._dvlRendererId);}}return this;};c.prototype.queueCommand=function(f){if(this._dvlRendererId){this._dvl.Renderer._queueCommand(f,this._dvlRendererId);}return this;};c.prototype._setContent=function(f){var i=null;if(f&&f instanceof sap.ui.vk.dvl.Scene){i=f;}this._setScene(i);};c.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};c.prototype._onBeforeClearContentConnector=function(){this._setScene(null);};c.prototype._handleContentReplaced=function(f){var i=f.getParameter("newContent");this._setContent(i);};c.prototype._setScene=function(f){var i=f&&f.getGraphicsCore();this.setGraphicsCore(i);this.setScene(f);if(f&&(this._isSmart2DContent()||this._isSmart2DContentLegacy())){this._initializeSmart2DHandler();}};c.prototype._handleContentChangesFinished=function(f){if(f.getSource().getContentResources().length>1){this.zoomTo(sap.ui.vk.ZoomTo.Visible,sap.ve.dvl.DVLID_INVALID,0,0);}this.setShouldRenderFrame();};c.prototype._onAfterUpdateViewStateManager=function(){if(this._dvl){this._dvl.Renderer.SetViewStateManager(this._viewStateManager,this._dvlRendererId);}};c.prototype._onBeforeClearViewStateManager=function(){if(this._dvl){this._dvl.Renderer.SetViewStateManager(null,this._dvlRendererId);}};var t={x:-2,y:-2};var u=2;var v=5;[{key:"left",dx:-u,dy:0},{key:"right",dx:+u,dy:0},{key:"up",dx:0,dy:-u},{key:"down",dx:0,dy:+u}].forEach(function(i){c.prototype["onsap"+i.key]=function(f){this.beginGesture(t.x,t.y);this.rotate(i.dx,i.dy);this.endGesture();this.setShouldRenderFrame();f.preventDefault();f.stopPropagation();};});[{key:"left",dx:-v,dy:0},{key:"right",dx:+v,dy:0},{key:"up",dx:0,dy:-v},{key:"down",dx:0,dy:+v}].forEach(function(i){c.prototype["onsap"+i.key+"modifiers"]=function(f){if(f.shiftKey&&!(f.ctrlKey||f.altKey||f.metaKey)){this.beginGesture(t.x,t.y);this.pan(i.dx,i.dy);this.endGesture();this.setShouldRenderFrame();f.preventDefault();f.stopPropagation();}};});[{key:"minus",d:0.98},{key:"plus",d:1.02}].forEach(function(i){c.prototype["onsap"+i.key]=function(f){this.beginGesture(this.$().width()/2,this.$().height()/2);this.zoom(i.d);this.endGesture();this.setShouldRenderFrame();f.preventDefault();f.stopPropagation();};});C.injectMethodsIntoClass(c);b.injectMethodsIntoClass(c);return c;});

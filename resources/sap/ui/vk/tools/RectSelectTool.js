/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","./Tool","./RectSelectToolHandler","sap/ui/vk/Loco"],function(q,a,T,R,L,b){"use strict";var c=T.extend("sap.ui.vk.tools.RectSelectTool",{metadata:{},constructor:function(i,s){if(c._instance){return c._instance;}T.apply(this,arguments);this._viewport=null;this._handler=null;this._loco=null;c._instance=this;}});c.prototype.init=function(){if(T.prototype.init){T.prototype.init.call(this);}this.setFootprint(["sap.ui.vk.threejs.Viewport"]);};c.prototype.setActive=function(v,e,g){if(T.prototype.setActive){T.prototype.setActive.call(this,v,e,g);}if(v){this._activateTool(e);}else{this._deactivateTool();}if(e){e.setShouldRenderFrame();}return this;};c.prototype._activateTool=function(e){this._viewport=e;this._handler=new R(this);this._prepare();};c.prototype._deactivateTool=function(){if(this._handler){this._viewport._loco.removeHandler(this._handler);}this._handler=null;};c.prototype._prepare=function(){if(this.isViewportType("sap.ui.vk.dvl.Viewport")){return false;}var o=false;if(this._viewport._loco){this._viewport._loco.addHandler(this._handler);o=true;}if(o){if(this.isViewportType("sap.ui.vk.threejs.Viewport")&&(this._viewport._scene&&this._viewport._scene.getSceneRef())){o=true;}}return o;};c.prototype.queueCommand=function(e){if(this._prepare()){if(this.isViewportType("sap.ui.vk.threejs.Viewport")){e();}}return this;};function d(e,f,v){var m=e.elements;var i=m[15]===1;var r=2/m[0];var t=2/m[5];var g,h;if(i){g=-m[12]*r;h=-m[13]*t;}else{g=m[8]*r;h=m[9]*t;}var j=(r+g)*0.5;var l=g-j;var k=(t+h)*0.5;var n=h-k;var o=THREE.Math.lerp(l,j,Math.min(f.x1,f.x2)/v.width);var p=THREE.Math.lerp(l,j,Math.max(f.x1,f.x2)/v.width);var s=THREE.Math.lerp(k,n,Math.min(f.y1,f.y2)/v.height);var u=THREE.Math.lerp(k,n,Math.max(f.y1,f.y2)/v.height);m[0]=2/(p-o);m[5]=2/(s-u);if(i){m[12]=-(p+o)/(p-o);m[13]=-(s+u)/(s-u);}else{m[8]=(p+o)/(p-o);m[9]=(s+u)/(s-u);}}c.prototype.select=function(x,y,e,f,s,g){var n=[];if(this._prepare()){var h=s?s.getSceneRef():undefined;var j=g?g.getCameraRef():undefined;var v=this._viewport._getViewStateManagerThreeJS();if(!j||!h||!v||x===e||y===f){return n;}var r={x1:x,y1:y,x2:e,y2:f};var m=j.projectionMatrix.clone();d(m,r,this._viewport._renderer.getSize());var k=new THREE.Matrix4().multiplyMatrices(m,j.matrixWorldInverse);var o=new THREE.Frustum().setFromMatrix(k);var p=new THREE.Vector3();h.traverse(function(u){var w=u.geometry;if(w!==undefined&&o.intersectsObject(u)){var i,l=0;if(w.isGeometry){var z=w.vertices;for(i=0,l=z.length;i<l;i++){p.copy(z[i]).applyMatrix4(u.matrixWorld);if(!o.containsPoint(p)){break;}}}else if(w.isBufferGeometry){var A=w.attributes.position;if(A!==undefined){for(i=0,l=A.count;i<l;i++){p.fromBufferAttribute(A,i).applyMatrix4(u.matrixWorld);if(!o.containsPoint(p)){break;}}}}if(l>0&&i===l){n.push(u);}}});if(n.length>0){var t={picked:n};this._viewport.fireNodesPicked(t);if(this._viewport.getSelectionMode()===sap.ui.vk.SelectionMode.Exclusive){this._viewport.exclusiveSelectionHandler(n);}else if(this._viewport.getSelectionMode()===sap.ui.vk.SelectionMode.Sticky){this._viewport.stickySelectionHandler(n);}}}return n;};c.prototype.destroy=function(){T.prototype.destroy.call(this);this._viewport=null;this._handler=null;};return c;});

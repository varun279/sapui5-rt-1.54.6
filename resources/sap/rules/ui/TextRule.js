/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","./library","sap/m/Label","sap/rules/ui/RuleBase","sap/m/Panel","sap/ui/core/Title","sap/ui/layout/form/Form","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/Text","sap/m/Button","sap/ui/layout/Grid","sap/ui/layout/form/FormContainer","sap/ui/layout/form/FormElement","sap/rules/ui/ExpressionAdvanced","sap/m/Link","sap/m/FlexBox","sap/m/Dialog","sap/rules/ui/TextRuleSettings","sap/rules/ui/ast/lib/AstYamlConverter"],function(q,l,L,R,P,T,F,a,b,c,B,G,d,f,E,g,h,D,k,A){"use strict";var m=R.extend("sap.rules.ui.TextRule",{metadata:{properties:{enableSettings:{type:"boolean",group:"Misc",defaultValue:false},enableElse:{type:"boolean",defaultValue:true},enableElseIf:{type:"boolean",defaultValue:true}},aggregations:{"_toolbar":{type:"sap.m.Toolbar",multiple:false,singularName:"_toolbar"},"_verticalLayout":{type:"sap.ui.core.Control",multiple:false,visibility:"visible",singularName:"_verticalLayout"}}},_addConditionBlock:function(e,t){var i=this;var o=this._getModel();var s=e.getSource();var p=s.getParent();if(t===this.typeElseIf&&!(p instanceof P)){p=s.getParent().getParent();}var v=p.getParent();var n=v.indexOfContent(p);var r=this._internalModel.getProperty("/ruleId");var j=this._internalModel.getProperty("/ruleVersion");var u=n+1;var w=false;var x;var K;var y={RuleId:r,RuleVersion:j};if(t===i.typeElse){K="/TextRuleDefaultBranches";w=true;}else{K="/TextRuleBranches";if(s.getParent()instanceof P){x=u;w=true;}else{x=u+1;}y.Sequence=x;}this._updateBusyState(true);var z={};z.properties=y;z.success=function(C){var H={};H.verticalLayout=v;H.nIndex=n;H.bfirst=w;i._addConditionSuccess(C,i,H);if(w){s.destroy();}};z.error=function(){q.sap.log.info("Error creating "+K+"entity");};o.createEntry(K,z);},_addConditionSuccess:function(n,t,e){var C=n.Id;var o=t._getModel();var H={RuleId:n.RuleId,Id:C,RuleVersion:n.RuleVersion};var p=o.createKey("/TextRuleConditions",H);var i=new sap.ui.model.Context(o,p);o.read(p,{urlParameters:{"$expand":"TextRuleResultExpressions"},success:function(r){var v=e.verticalLayout;t.getModel("displayModel").getProperty("/textRuleConditions").push(r);t._resetContent=true;if(r.Type===t.typeElse){t.getModel("displayModel").getProperty("/textRuleConditions/Else").push(r);var j=t._createElseFormLayout(i,t.oBundle.getText("titleElse"),true);v.removeContent(e.nIndex);v.insertContent(j,e.nIndex);}else if(r.Type===t.typeElseIf){t.getModel("displayModel").getProperty("/textRuleConditions/ElseIf").push(r);var s=t._createFormLayout(i,t.oBundle.getText("titleElseIf"),true);if(e.bfirst){v.removeContent(e.nIndex);v.insertContent(s,e.nIndex);}else{v.insertContent(s,e.nIndex+1);}}t._updateBusyState(false);},error:function(){q.sap.log.info("Error reading TextRuleResultExpressions");}});},_addToolBar:function(){var t=new a({design:"Transparent",enabled:"{TextRuleModel>/editable}"});var o=new sap.m.Title({text:this.oBundle.getText("textRule")});var s=new B({text:"",press:this._openTextRuleSettings.bind(this),visible:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement},enabled:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement}}).setTooltip(this.oBundle.getText("settings"));s.setIcon("sap-icon://action-settings");t.addContent(o);t.addContent(new b({}));t.addContent(s);t.addContent(new b({width:"1em"}));this.setAggregation("_toolbar",t,true);},_addTextRuleControl:function(){this.verticalLayout=new sap.ui.layout.VerticalLayout({width:"100%"});this.setAggregation("_verticalLayout",this.verticalLayout,true);},_bindRule:function(){var t=this;var M=this._getModel();var s=[this._getBindModelName(),this.getBindingContextPath()].join("");if(s&&M){M.setDeferredGroups(["read"]);M.read(s,{groupId:"read",urlParameters:{"$expand":"TextRule"}});var e=[s,"/TextRule/TextRuleResults"].join("");M.read(e,{groupId:"read"});e=[s,"/TextRule/TextRuleConditions"].join("");M.read(e,{groupId:"read",urlParameters:{"$expand":"TextRuleResultExpressions"}});M.submitChanges({groupId:"read",success:function(i){t._handleVerticalLayoutDataReceived(i);},error:function(){q.sap.log.info("Error reading TextRule data from backend");}});}},_bindVerticalLayout:function(){var I=this._getIfPanel();this.verticalLayout.addContent(I);if(this.getEnableElseIf()===true){var e=this._getElseIfPanel();for(var i=0;i<e.length;i++){this.verticalLayout.addContent(e[i]);}}if(this.getEnableElse()===true){var o=this._getElsePanel();this.verticalLayout.addContent(o[0]);}},_createFormLayout:function(C,t,e){var i=this;var p=new P({expandable:true,expanded:e,headerText:t,height:"100%",backgroundDesign:"Translucent",content:new F({editable:true,layout:new sap.ui.layout.form.ResponsiveGridLayout({labelSpanXL:2,labelSpanL:2,labelSpanM:2,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:4,emptySpanL:4,emptySpanM:4,emptySpanS:4,columnsL:1,columnsM:1}),formContainers:[i._createIfBlockFormContainer(C,t),i._createThenFormContainer(C,this.oBundle.getText("then"))]})}).addStyleClass("sapTextRulePanel");if(t===this.typeIf){p.setHeaderText(t);}else{var o=new a({design:"Transparent"});var j=new sap.m.Title({text:t});var n=new B({visible:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement},text:this.oBundle.getText("addButton"),tooltip:this.oBundle.getText("addNewElseIf"),press:function(s){i._addConditionBlock(s,i.typeElseIf);}}).setBindingContext(C);var r=new B({text:this.oBundle.getText("deleteButton"),tooltip:this.oBundle.getText("deleteElseIf"),visible:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement},press:function(s){i._deleteConditionBlock(s);}}).setBindingContext(C);o.addContent(j);o.addContent(new b({width:"900px"}));o.addContent(n);o.addContent(new b({width:"0.5px"}));o.addContent(r);p.setHeaderToolbar(o);}return p;},_createElseFormLayout:function(C,t,e){var i=this;var o=new a({design:"Transparent"});var j=new sap.m.Title({text:t});var n=new B({text:this.oBundle.getText("deleteButton"),tooltip:this.oBundle.getText("deleteElse"),visible:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement},press:function(r){i._deleteConditionBlock(r);}}).setBindingContext(C);o.addContent(j);o.addContent(new b({width:"965px"}));o.addContent(n);var p=new P({expandable:true,expanded:e,height:"100%",backgroundDesign:"Translucent",content:new F({editable:true,layout:new sap.ui.layout.form.ResponsiveGridLayout({labelSpanXL:2,labelSpanL:2,labelSpanM:2,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:4,emptySpanL:4,emptySpanM:4,emptySpanS:4,columnsL:1,columnsM:1}),formContainers:[this._createThenFormContainer(C,t)]})}).addStyleClass("sapTextRulePanel");p.setHeaderToolbar(o);return p;},_createIfBlockFormContainer:function(C,t){var e=C.getProperty("Expression");var i=new d({formElements:[new f({label:new L({text:""}),fields:[this._getExpressionAdvancedText(C,e)]})]});return i;},_createThenFormContainer:function(C,t){var e=new d({visible:false});if(C.getProperty("Type")!==this.typeElse){var o=new a({content:[new b({width:"2em"}),new L({text:t}).addStyleClass("sapTextRuleFontSize")]});e.setToolbar(o);}var s=C.getProperty("Id");var n=this.getModel("displayModel").getProperty("/textRuleConditions");for(var i=0;i<n.length;i++){if(s===n[i].Id){var r=n[i].TextRuleResultExpressions.results;if(r){for(var j=0;j<r.length;j++){var H={RuleId:r[j].RuleId,ConditionId:r[j].ConditionId,ResultId:r[j].ResultId,RuleVersion:r[j].RuleVersion};var p=this._getModel().createKey("/TextRuleResultExpressions",H);var u=new sap.ui.model.Context(this._getModel(),p);e.addFormElement(this._formElementsFactory(t+"result"+j,u));}}}}var v=e.getFormElements();for(var w in v){if(v[w].getVisible()){e.setVisible(true);break;}}return e;},_createTextRuleSettings:function(){var M=this._getModel();var C=this.getBindingContext();var t=new k({expressionLanguage:this.getExpressionLanguage(),newTextRule:this._internalModel.getProperty("/newTextRule")});var s=JSON.stringify(this._settingsModel.getData());var e=JSON.parse(s);var i=new sap.ui.model.json.JSONModel(e);t.setModel(i);t.setModel(this._internalModel,"TextRuleModel");t.setModel(M,"oDataModel");t.setBindingContext(C,"dummy");return t;},_decideSettingsEnablement:function(e,i){return e&&i;},_deleteConditionBlock:function(e){var t=this;var o=this._getModel();var s=e.getSource();var p=s.getParent().getParent();var v=p.getParent();var n=v.indexOfContent(p);var i=s.getBindingContext();var C=i.getProperty("Id");var j=i.getProperty("Type");var K;if(j===t.typeElse){K="/TextRuleDefaultBranches";}else if(j===t.typeElseIf){K="/TextRuleBranches";}var H={RuleId:i.getProperty("RuleId"),Id:C,RuleVersion:i.getProperty("RuleVersion")};var r=o.createKey(K,H);var _=function(){t._resetContent=true;var p;v.removeContent(n);if(j===t.typeElse){t.getModel("displayModel").setProperty("/textRuleConditions/Else",[]);p=t._getElsePanel();v.insertContent(p[0],n);}else{if(n===1&&v.getContent().length<=2){t.getModel("displayModel").setProperty("/textRuleConditions/ElseIf",[]);p=t._getElseIfPanel();v.insertContent(p[0],n);}else{var u=t.getModel("displayModel").getProperty("/textRuleConditions/ElseIf");for(var w in u){if(u[w].Id===C){u.splice(w,1);t.getModel("displayModel").setProperty("/textRuleConditions/ElseIf",u);break;}}}}t._updateBusyState(false);};this._updateBusyState(true);o.remove(r,{success:function(u){_();},error:function(){q.sap.log.info("Error deleting "+K+"entity");}});},_formRuleData:function(C,e){var i=this.getBindingContextPath();var r=i.split("/")[2];var o=C.getProperty("RuleId");var v=C.getProperty("Version");var j=q.extend({},this.getModel().oData);j=j[r];if(!j){j={};}if(!j.DecisionTable){j.DecisionTable={};}j.Type="DT";j.DecisionTable.metadata={};j.DecisionTable.RuleID=o;j.DecisionTable.version=v;j.DecisionTable.HitPolicy="FM";j.DecisionTable.DecisionTableColumns={};j.DecisionTable.DecisionTableColumns.results=[];j.DecisionTable.DecisionTableColumns.results.push({"metadata":{},"RuleId":o,"Id":1,"Version":v,"Sequence":1,"Type":"CONDITION","Condition":{"metadata":{},"RuleId":o,"Id":1,"Version":v,"Expression":e,"Description":null,"ValueOnly":false,"FixedOperator":null},"Result":null});j.DecisionTable.DecisionTableRows={};j.DecisionTable.DecisionTableRows.results=[];j.DecisionTable.DecisionTableColumnsCondition={};j.DecisionTable.DecisionTableColumnsCondition.results=[];j.DecisionTable.DecisionTableColumnsResult={};j.DecisionTable.DecisionTableColumnsResult.results=[];return j;},_formElementsFactory:function(i,C){var r=C.getProperty("ResultId"),e=C.getProperty("RuleId"),v=C.getProperty("RuleVersion"),V=true;var H={RuleId:e,Id:r,RuleVersion:v};var j=C.getProperty("Expression");var n=C.getModel().createKey("/TextRuleResults",H);this._internalModel.getProperty("/textRuleResults").push(C.getModel().getProperty(n));this._internalModel.getProperty("/textRuleResultExpressions").push(C.getModel().getProperty(C.getPath()));var o=C.getModel().getProperty(n+"/BusinessDataType");var s=C.getModel().getProperty(n+"/DataObjectAttributeName");var p=C.getModel().getProperty(n+"/AccessMode");if(p==="Editable"){V=true;}else if(p==="Hidden"){V=false;}var t=new f({visible:V,label:new L({text:s,tooltip:s}),fields:[this._getExpressionAdvancedText(C,j,o)]});return t;},_getBindModelName:function(){var p="";var e=this.getModelName();if(e){p=e+">";}return p;},_getBlankContent:function(){var o=new L({text:this.oBundle.getText("startTextRule")});var s=new c();s.setText("\u00a0");var e=new g({enabled:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement},text:" "+this.oBundle.getText("settings"),press:[this._openTextRuleSettings,this]}).addStyleClass("sapTextRuleLink");var i=new h({justifyContent:"Center",items:[o,s,e],visible:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement}}).addStyleClass("sapUiMediumMargin");return i;},_getConvertedExpression:function(e,i,C){var o=sap.ui.getCore().byId(this.getExpressionLanguage());var r=this._formRuleData(C,e);var j;if(i){j=o.convertRuleToCodeValues(r);}else{j=o.convertRuleToDisplayValues(r);}return j;},_getDataLoadedPromise:function(){if(!this._dataLoaded){this._setDataLoadedPromise();}return this._dataLoaded.promise();},_getElseButton:function(){var t=this;this.oElseButton=new sap.m.Button({id:"_elseButton",text:this.oBundle.getText("addElse"),tooltip:this.oBundle.getText("addElse"),enabled:"{TextRuleModel>/editable}",press:function(e){t._addConditionBlock(e,t.typeElse);}});return this.oElseButton;},_getElseIfButton:function(){var t=this;this.oElseIfButton=new sap.m.Button({id:"_elseIfButton",text:this.oBundle.getText("addElseIf"),tooltip:this.oBundle.getText("addElseIf"),enabled:"{TextRuleModel>/editable}",press:function(e){t._addConditionBlock(e,t.typeElseIf);}});return this.oElseIfButton;},_getElseIfPanel:function(){var t=this.oBundle.getText("titleElseIf");var C=[];var e=this._displayModel.getProperty("/textRuleConditions/ElseIf");if(e.length>0){for(var i=0;i<e.length;i++){var H={RuleId:e[i].RuleId,Id:e[i].Id,RuleVersion:e[i].RuleVersion};var p=this._getModel().createKey("/TextRuleConditions",H);var o=new sap.ui.model.Context(this._getModel(),p);C.push(this._createFormLayout(o,t),false);}}else{var j=new P({headerText:t,visible:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement},content:this._getElseIfButton()});C.push(j);}return C;},_getElsePanel:function(){var t=this.oBundle.getText("titleElse");var C=[];var e=this._displayModel.getProperty("/textRuleConditions/Else");if(e.length>0){var H={RuleId:e[0].RuleId,Id:e[0].Id,RuleVersion:e[0].RuleVersion};var p=this._getModel().createKey("/TextRuleConditions",H);var o=new sap.ui.model.Context(this._getModel(),p);C.push(this._createElseFormLayout(o,t),false);}else{var i=new P({headerText:t,visible:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement},content:this._getElseButton()});C.push(i);}return C;},_getExpressionAdvancedText:function(C,i,j){var t=this;var o=sap.ui.getCore().byId(this.getExpressionLanguage());var s=j?j:sap.rules.ui.ExpressionType.NonComparison;var r=t._getConvertedExpression(i,false,C);var n=t._getExpressionFromParseResults(i,r);return new E({expressionLanguage:o,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,type:s,value:n,editable:"{TextRuleModel>/editable}",change:function(p){var S=p.getSource();C=S.getBindingContext();var u=C.getPath();r=t._getConvertedExpression(S.getValue(),true,C);var v=t._getExpressionFromParseResults(S.getValue(),r);t._updateModelExpression(u,C,v);t._resetContent=true;var w=r.output.decisionTableData.DecisionTable.DecisionTableColumns.results["0"].Condition.parserResults;if(w.status!=="Error"){t._astUtils.Id=0;var x=w.converted.ASTOutput;try{var y=JSON.stringify(t._astUtils.parseConditionStatement(x));var z=C.oModel.oMetadata.mEntityTypes["/TextRuleConditions"].property;var H=0;if(z){for(var I=0;I<z.length;I++){if(z[I].name==="AST"){H=z[I].maxLength;}}if(y&&y.length<=H){t._updateModelExpressionModelAst(u,C,y);}}}catch(e){console.log("Exception while converting ast for expression"+S.getValue()+" :"+e.message);}}}.bind(this)}).setBindingContext(C);},_getExpressionFromParseResults:function(e,r){if(r&&r.output.decisionTableData.DecisionTable.DecisionTableColumns.results[0].Condition.parserResults.converted){return r.output.decisionTableData.DecisionTable.DecisionTableColumns.results[0].Condition.parserResults.converted.Expression;}else{return e;}},_getIfPanel:function(){var t=this.oBundle.getText("titleIf");var i=this._displayModel.getProperty("/textRuleConditions/If");var H={RuleId:i[0].RuleId,Id:i[0].Id,RuleVersion:i[0].RuleVersion};var p=this._getModel().createKey("/TextRuleConditions",H);var C=new sap.ui.model.Context(this._getModel(),p);return this._createFormLayout(C,t,true);},_getModel:function(){var e=this.getModelName();if(e){return this.getModel(e);}return this.getModel();},_handleVerticalLayoutDataReceived:function(r){var e=r.__batchResponses[2].data;var i;if(!e){return;}var v=this.getAggregation("_verticalLayout");if(e.results&&e.results.length===0){i=this._getBlankContent();v.addContent(i);this._internalModel.setProperty("/newTextRule",true);this._updateBusyState(false);}else{this._segregateTextRuleData(e.results);if(this._displayModel.getProperty("/textRuleConditions/If").length===0){i=this._getBlankContent();v.addContent(i);this._internalModel.setProperty("/newTextRule",true);this._updateBusyState(false);}else{this._bindVerticalLayout();this._internalModel.setProperty("/newTextRule",false);}}},_initDisplayModel:function(){var e={};e.textRuleConditions=[];e.textRuleConditions.If=[];e.textRuleConditions.ElseIf=[];e.textRuleConditions.Else=[];this._displayModel=new sap.ui.model.json.JSONModel(e);this.setModel(this._displayModel,"displayModel");},_initInternalModel:function(){var e={};e.editable=this.getEditable();e.newTextRule=true;e.enableSettings=true;e.projectId="";e.projectVersion="";e.ruleId="";e.ruleVersion="";e.ruleBindingPath="";e.textRuleResults=[];e.textRuleResultExpressions=[];this._internalModel=new sap.ui.model.json.JSONModel(e);this.setModel(this._internalModel,"TextRuleModel");},_initSettingsModel:function(){this._settingsModel=new sap.ui.model.json.JSONModel();this.setModel(this._settingsModel,"settingModel");},_openTextRuleSettings:function(){var t=this._createTextRuleSettings();var o=new D({contentWidth:"70%",title:this.oBundle.getText("textRuleSettings")});o.addContent(t);var e=t.getButtons(o);for(var i=0;i<e.length;i++){o.addButton(e[i]);}o.attachBeforeClose(function(j){var n=o.getState();if(n===sap.ui.core.ValueState.Success){if(this._internalModel.getProperty("/resultChanged")){var p=sap.ui.getCore().getEventBus();p.publish("sap.ui.rules","refreshTextRuleModel");}this._resetControl();}o.destroy();},this);o.open();},_resetControl:function(){this._unbindVerticalLayout();this._initInternalModel();this._initSettingsModel();this._initDisplayModel();this._updateBusyState(true);var M=this._getModel();var e=this.getBindingContextPath();if(!e||!M){return;}this._resetContent=false;var s=e.split("'");this._internalModel.setProperty("/projectId",s[1]);this._internalModel.setProperty("/projectVersion",s[3]);this._internalModel.setProperty("/ruleId",s[5]);this._internalModel.setProperty("/ruleVersion",s[7]);this._internalModel.setProperty("/ruleBindingPath",e);var C=new sap.ui.model.Context(M,e);this.setBindingContext(C);this._bindRule();},_segregateTextRuleData:function(e){var C=[];C.If=[];C.ElseIf=[];C.Else=[];for(var i=0;i<e.length;i++){C.push(e[i]);if(e[i].Type===this.typeIf){C.If.push(e[i]);}else if(e[i].Type===this.typeElseIf){C.ElseIf.push(e[i]);}else if(e[i].Type===this.typeElse){C.Else.push(e[i]);}}this.getModel("displayModel").setProperty("/textRuleConditions",C);},_updateBusyState:function(e){if(e){sap.ui.core.BusyIndicator.show(0);}else{setTimeout(function(){sap.ui.core.BusyIndicator.hide();},1500);}},_unbindVerticalLayout:function(){var v=this.getAggregation("_verticalLayout");v.destroyContent();},_updateModelExpression:function(p,C,e){C.getModel().setProperty(p+"/Expression",e,C,true);},_updateModelExpressionModelAst:function(p,C,e){if(C.getModel().getProperty(p+"/AST")){C.getModel().setProperty(p+"/AST",e,C,true);}},init:function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.typeIf="If";this.typeElseIf="ElseIf";this.typeElse="Else";this._resetContent=true;this._initInternalModel();this._initDisplayModel();this._initSettingsModel();this._addToolBar();this._addTextRuleControl();this._astUtils=A;},onAfterRendering:function(){var v=this.getAggregation("_verticalLayout");var t=this;v.addEventDelegate({"onAfterRendering":function(){t._updateBusyState(false);}},this);},onBeforeRendering:function(){if(this._resetContent){this._resetControl();}},setEnableSettings:function(v){this.setProperty("enableSettings",v,true);this._internalModel.setProperty("/enableSettings",v);return this;},setModelName:function(v){this.setProperty("modelName",v);this._resetContent=true;return this;},setExpressionLanguage:function(v){this.setAssociation("expressionLanguage",v,true);var e=(v instanceof Object)?v:sap.ui.getCore().byId(v);if(!e){return this;}var V=this.getAggregation("_verticalLayout");if(V){var i=V.getBinding("content");if(i){i.refresh();}}return this;},setEditable:function(v){this.setProperty("editable",v,true);this._internalModel.setProperty("/editable",v);return this;},setBindingContextPath:function(v){var o=this.getBindingContextPath();if(v&&(o!==v)){this._unbindVerticalLayout();this.setProperty("bindingContextPath",v);this._resetContent=true;}return this;}});return m;},true);

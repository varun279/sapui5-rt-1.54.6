/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/rules/ui/library","sap/ui/core/Control","sap/ui/layout/form/SimpleForm","sap/m/Label","sap/m/Switch","sap/m/Select","sap/m/MessageBox","sap/m/Table","sap/m/Column","sap/m/Text","sap/m/Input","sap/m/Button","sap/m/ComboBox","sap/rules/ui/ExpressionAdvanced","sap/ui/layout/VerticalLayout","sap/rules/ui/type/Expression","sap/rules/ui/ast/lib/AstYamlConverter"],function(q,l,C,S,L,a,b,M,T,c,d,I,B,f,E,V,g,A){"use strict";var t=C.extend("sap.rules.ui.TextRuleSettings",{metadata:{library:"sap.rules.ui",properties:{modelName:{type:"string",defaultValue:""},newTextRule:{type:"boolean",defaultValue:false}},aggregations:{mainLayout:{type:"sap.ui.layout.form.SimpleForm",multiple:false}},defaultAggregation:"mainLayout",associations:{expressionLanguage:{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,singularName:"expressionLanguage"}}}});sap.rules.ui.TextRuleSettings.prototype._bindPredefinedTable=function(p,k){var e=this;this.oPredefinedTable.destroyItems();var m=this.getModel("oDataModel");m.read(p,{success:function(h){var o=h.results;if(o&&o.length>0){e.oPredefinedTable.setBusy(true);for(var i=0;i<o.length;i++){var H;if(k=="/TextRuleResults"){H={RuleId:o[i].RuleId,Id:o[i].Id,RuleVersion:o[i].RuleVersion};}else{H={DataObjectId:o[i].DataObjectId,Id:o[i].Id,Version:o[i].Version};}var s=m.createKey(k,H);var j=new sap.ui.model.Context(m,s);e.oPredefinedTable.addItem(e._tableFactory("col-"+i,j));}e.oPredefinedTable.setBusy(false);e._internalModel.setProperty("/refreshButtonClicked",false);}},error:function(){q.sap.log.info("Error reading TextRule data from backend");}});};sap.rules.ui.TextRuleSettings.prototype._callRefreshResultsFunctionImport=function(){var h=this;var o=this.getModel("oDataModel");var m=this.getModel("TextRuleModel").getData();var i={groupId:"changes"};o.setDeferredGroups([i.groupId]);var s=function(){h._createPredefinedTable();h._internalModel.setProperty("/needToRefresh",false);};var j=function(e){sap.m.MessageToast.show(e);};var k=function(){var r=m.ruleId;o.callFunction("/RefreshRuleResultDataObject",{method:"POST",groupId:i.groupId,urlParameters:{RuleId:r}});o.submitChanges({groupId:i.groupId,success:s,error:j});};if(this._internalModel.getProperty("/needToRefresh")){k();}};sap.rules.ui.TextRuleSettings.prototype._createInfoMessageStrip=function(e,h){var m=new sap.m.MessageStrip({visible:true,id:h,text:e,type:sap.ui.core.MessageType.Information,showIcon:true,showCloseButton:true}).addStyleClass("sapTextRuleSettingsMessageStrip");return m;};sap.rules.ui.TextRuleSettings.prototype._createLayout=function(){if(!this.oForm){this._destroyElements();this.oForm=new S("_formLayout",{editable:true,layout:"ResponsiveGridLayout",maxContainerCols:1,columnsL:1,columnsM:1,labelSpanM:1,content:[new L({text:this.oBundle.getText("output")}).setTooltip(this.oBundle.getText("output")),new sap.ui.layout.HorizontalLayout({content:[new b("__resultSelect",{width:"220px",items:{path:"settingModel>/results/resultsEnumeration",template:new sap.ui.core.Item({key:"{settingModel>id}",text:"{settingModel>name}"})},selectedKey:"{/ResultDataObjectId}",change:function(e){var s=e.getSource();var m=this.getModel().getData();if(m.ResultDataObjectStatus!=="C"){m.ResultDataObjectId=s.getSelectedKey();m.ResultDataObjectName=s._getSelectedItemText();m.ResultDataObjectStatus="U";if(m.ResultDataObjectId!==s.getSelectedKey()){this._updateRefreshFlags(false,false);}}this._internalModel.setProperty("/resultDataObjectChanged",true);if(this._internalModel.getProperty("/results/resultsEnumeration/0").id==="0"){this._internalModel.getProperty("/results/resultsEnumeration").splice(0,1);}this._createPredefinedTable();}.bind(this)}),this._createRefreshButton()]}),new L(),this._createPredefinedResultsLayout()]}).addStyleClass("sapTextRuleSettingsForm");}this.oForm.setBusyIndicatorDelay(0);return this.oForm;};sap.rules.ui.TextRuleSettings.prototype._createPredefinedResultsLayout=function(){var r=false;var s=this.getModel("oDataModel").sServiceUrl;var n=s.search("/rules-service/rule_srv");if(n>=0){r=true;}if(r){var v=this._createVerticalLayout();return v;}else{return new L();}};sap.rules.ui.TextRuleSettings.prototype._createPredefinedTable=function(){if(!this.oPredefinedTable){this.oPredefinedTable=new T("idPredefinedTable",{backgroundDesign:sap.m.BackgroundDesign.Solid,showSeparators:sap.m.ListSeparators.All,swipeDirection:sap.m.SwipeDirection.Both,fixedLayout:true,layoutData:new sap.ui.layout.form.GridContainerData({halfGrid:false}),columns:[new c({width:"45%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedResultColumnHeaderText"),design:sap.m.LabelDesign.Bold})}),new c({width:"25%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedAccessColumnHeaderText"),design:sap.m.LabelDesign.Bold})}),new c({width:"45%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedValuesColumnHeaderText"),design:sap.m.LabelDesign.Bold})})]});}var r=this._internalModel.getProperty("/resultDataObjectChanged");var R=this._internalModel.getProperty("/refreshButtonClicked");var m=this.getModel("oDataModel");if(!r&&!R){this.oPredefinedTable.setModel(m);var e=[this.getModel("TextRuleModel").getProperty("/ruleBindingPath"),"/TextRule/TextRuleResults"].join("");this._bindPredefinedTable(e,"/TextRuleResults");this.oPredefinedTable.setBusyIndicatorDelay(0);return this.oPredefinedTable;}else{this._updatePredefinedTable(this.getModel().getData());}return null;};sap.rules.ui.TextRuleSettings.prototype._createRefreshButton=function(){var _=function(){this._internalModel.setProperty("/refreshButtonEnabled",true,null,true);return this.oBundle.getText("textRuleRefreshWarning");}.bind(this);var e=function(){this._updateRefreshFlags(true,false);}.bind(this);var h=_();var i=function(){var j=h;M.warning(j,{title:this.oBundle.getText("refeshResultWarningTitle"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(o){if(o===sap.m.MessageBox.Action.OK){e();}}});}.bind(this);var r=new B({layoutData:new sap.ui.layout.ResponsiveFlowLayoutData({weight:1}),icon:sap.ui.core.IconPool.getIconURI("synchronize"),width:"3rem",type:sap.m.ButtonType.Transparent,text:"",press:i,visible:true,enabled:"{settingModel>/refreshButtonEnabled}"}).setTooltip(this.oBundle.getText("refreshBtn"));this.refreshButton=r;return r;};sap.rules.ui.TextRuleSettings.prototype._createVerticalLayout=function(){var v=new sap.ui.layout.VerticalLayout("verticalLayout",{content:[this._createInfoMessageStrip(this.oBundle.getText("TRPredefinedMessageStripHiddenAccessInfoText"),"id_HiddenAccessMessageStrip"),this._createInfoMessageStrip(this.oBundle.getText("TRPredefinedMessageStripEditableAccessInfoText"),"id_EditableAccessMessageStrip"),this._createPredefinedTable()]});return v;};sap.rules.ui.TextRuleSettings.prototype._destroyElements=function(){if(sap.ui.getCore().byId("_formLayout")){sap.ui.getCore().byId("_formLayout").destroy();}if(sap.ui.getCore().byId("__elseCheckBox")){sap.ui.getCore().byId("__elseCheckBox").destroy();}if(sap.ui.getCore().byId("__resultSelect")){sap.ui.getCore().byId("__resultSelect").destroy();}if(sap.ui.getCore().byId("id_HiddenAccessMessageStrip")){sap.ui.getCore().byId("id_HiddenAccessMessageStrip").destroy();}if(sap.ui.getCore().byId("id_EditableAccessMessageStrip")){sap.ui.getCore().byId("id_EditableAccessMessageStrip").destroy();}if(sap.ui.getCore().byId("idPredefinedTable")){sap.ui.getCore().byId("idPredefinedTable").destroy();}};sap.rules.ui.TextRuleSettings.prototype._getAccessOptions=function(){var o={accessEnumration:[{key:"editableAccess",value:"Editable"},{key:"hiddenAccess",value:"Hidden"}]};return o;};sap.rules.ui.TextRuleSettings.prototype._getCurrentResult=function(){var m=this.getModel().getData();var e=this.getModel("TextRuleModel").getData();var h={Id:e.ruleId,Version:e.ruleVersion};var D=this.getModel("oDataModel");var p=D.createKey("/Rules",h);m.ResultDataObjectId=D.getProperty(p+"/ResultDataObjectId");m.ResultDataObjectName=D.getProperty(p+"/ResultDataObjectName");m.ResultDataObjectStatus="A";if(this._internalModel.getProperty("/results/resultsEnumeration/0").id==="0"){this._internalModel.getProperty("/results/resultsEnumeration").splice(0,1);}};sap.rules.ui.TextRuleSettings.prototype._getPredefinedExpressionAdvanced=function(o,h,i,j){var k=sap.ui.getCore().byId(this.getExpressionLanguage());var s=j?j:sap.rules.ui.ExpressionType.NonComparison;var m=this;return new E({expressionLanguage:k,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,id:h,type:s,value:i,editable:true,change:function(n){var p=n.getSource();o=p.getBindingContext();var r=m._getConvertedExpression(p.getValue(),true,o);var u="";if(r&&r!==""){var v=r.output.decisionTableData.DecisionTable.DecisionTableColumns.results["0"].Condition.parserResults;if(v&&v.status!=="Error"){m._astUtils.Id=0;var P=o.getPath();var w=v.converted.ASTOutput;try{u=JSON.stringify(m._astUtils.parseConditionStatement(w));var x=o.oModel.oMetadata.mEntityTypes["/TextRuleConditions"].property;var y=0;if(x){for(var z=0;z<x.length;z++){if(x[z].name==="AST"){y=x[z].maxLength;}}if(u&&u.length>y){m._updateModelExpressionModelAst(P,o,u);}}}catch(e){console.log("Exception while converting ast for expression"+p.getValue()+" :"+e.message);}}}this._internalModel.setProperty("/resultAttributeChanged",true);this._updateResultAttributeJSON(o,false,null,p.getValue(),u);}.bind(this)}).setBindingContext(o);};sap.rules.ui.TextRuleSettings.prototype._getConvertedExpression=function(e,i,o){var h=sap.ui.getCore().byId(this.getExpressionLanguage());var r=this._formRuleData(o,e);var R;if(i){R=h.convertRuleToCodeValues(r);}else{R=h.convertRuleToDisplayValues(r);}return R;};sap.rules.ui.TextRuleSettings.prototype._formRuleData=function(o,e){var r=o.getProperty("RuleId");var v=o.getProperty("Version");var R=q.extend({},this.getModel().oData);if(!R){R={};}if(!R.DecisionTable){R.DecisionTable={};}R.Type="DT";R.DecisionTable.metadata={};R.DecisionTable.RuleID=r;R.DecisionTable.version=v;R.DecisionTable.HitPolicy="FM";R.DecisionTable.DecisionTableColumns={};R.DecisionTable.DecisionTableColumns.results=[];R.DecisionTable.DecisionTableColumns.results.push({"metadata":{},"RuleId":r,"Id":1,"Version":v,"Sequence":1,"Type":"CONDITION","Condition":{"metadata":{},"RuleId":r,"Id":1,"Version":v,"Expression":e,"Description":null,"ValueOnly":false,"FixedOperator":null},"Result":null});R.DecisionTable.DecisionTableRows={};R.DecisionTable.DecisionTableRows.results=[];R.DecisionTable.DecisionTableColumnsCondition={};R.DecisionTable.DecisionTableColumnsCondition.results=[];R.DecisionTable.DecisionTableColumnsResult={};R.DecisionTable.DecisionTableColumnsResult.results=[];return R;};sap.rules.ui.TextRuleSettings.prototype._getSelectedVisibilityStatus=function(s){if(s==="Hidden"){return"hiddenAccess";}else{return"editableAccess";}};sap.rules.ui.TextRuleSettings.prototype._initSettingsModel=function(r){var i={};i.predefinedResults=[];i.results=r;i.accessOptions=this._getAccessOptions();this._internalModel=new sap.ui.model.json.JSONModel(i);this.setModel(this._internalModel,"settingModel");};sap.rules.ui.TextRuleSettings.prototype._getResultsData=function(e){var o=sap.ui.getCore().byId(this.getExpressionLanguage());var r={resultsEnumeration:o.getResults()};r.resultsEnumeration.unshift({id:"0",name:""});this._initSettingsModel(r);if(e){this._setDefaultResult();}else{this._getCurrentResult();}if(this.needCreateLayout){var h=this.getAggregation("mainLayout");if(h){h.destroy();}h=this._createLayout();this.setAggregation("mainLayout",h);this.needCreateLayout=false;}};sap.rules.ui.TextRuleSettings.prototype._setDefaultResult=function(){var m=this.getModel().getData();var r=this._internalModel.getProperty("/results/resultsEnumeration");if(r.length>0){m.ResultDataObjectId=r[0].Id;m.ResultDataObjectName=r[0].Name;m.ResultDataObjectStatus="A";}};sap.rules.ui.TextRuleSettings.prototype._setColumnAccessMode=function(o,e){var s=e.getSource();var h="exp"+e.getSource().sId.split("select")[1];var i=sap.ui.getCore().byId(h);var j=s.getSelectedKey();if(j==="hiddenAccess"){i.setValue("");i.setValueStateText(this.oBundle.getText("PredefinedResultsValueStateText"));this._updateResultAttributeJSON(o,false,"Hidden",null,null);}else{i.setValueStateText("");this._updateResultAttributeJSON(o,false,"Editable",null,null);}this._internalModel.setProperty("/resultAttributeChanged",true);};sap.rules.ui.TextRuleSettings.prototype._tableFactory=function(i,o){var e=i.split("-")[1];var h="exp"+e;var j=o.getProperty("DataObjectAttributeName")?o.getProperty("DataObjectAttributeName"):o.getProperty("Name");var k=o.getProperty("DataObjectAttributeId")?o.getProperty("DataObjectAttributeId"):o.getProperty("Id");var m;var n;var p=o.getProperty("BusinessDataType");var s;var r=this._internalModel.getProperty("/predefinedResults");if(this._internalModel.getProperty("/resultDataObjectChanged")){this._updateResultAttributeJSON(o,true,"Editable","","");s="Editable";m="";n="";}else if(this._internalModel.getProperty("/refreshButtonClicked")){var u=r[k];s=u?u.AccessMode:"Editable";m=u?u.Expression:"";n=u?u.AST:"";this._updateResultAttributeJSON(o,false,s,m,n);}else{m=o.getProperty("Expression");n=o.getProperty("AST");s=o.getProperty("AccessMode");this._updateResultAttributeJSON(o,false,s,m,n);}var v=this._getSelectedVisibilityStatus(s);return new sap.m.ColumnListItem({visible:true,cells:[new sap.m.Label({visible:true,design:sap.m.LabelDesign.Standard,text:j,textAlign:sap.ui.core.TextAlign.Begin,textDirection:sap.ui.core.TextDirection.Inherit}).setBindingContext(o),new sap.m.Select({width:"65%",id:"select"+e,items:{path:"settingModel>/accessOptions/accessEnumration",template:new sap.ui.core.Item({key:"{settingModel>key}",text:"{settingModel>value}"})},selectedKey:v,change:function(w){this._setColumnAccessMode(o,w);}.bind(this)}).setBindingContext(o),this._getPredefinedExpressionAdvanced(o,h,m,p)]});};sap.rules.ui.TextRuleSettings.prototype._updatePredefinedTable=function(r){if(this._internalModel.getProperty("/resultDataObjectChanged")){this._internalModel.setProperty("/predefinedResults",[]);}var D=this.getModel("oDataModel");var e=this.getModel("TextRuleModel").getData();var h={Id:e.projectId,Version:e.projectVersion};var p=D.createKey("/Projects",h);h={Id:r.ResultDataObjectId,Version:e.projectVersion};var s=[p,D.createKey("/DataObjects",h),"/DataObjectAttributes"].join("");this.oPredefinedTable.setModel(D);this._bindPredefinedTable(s,"/DataObjectAttributes");this.oPredefinedTable.setBusyIndicatorDelay(0);return this.oPredefinedTable;};sap.rules.ui.TextRuleSettings.prototype._updateRefreshFlags=function(n,i){this._internalModel.setProperty("/needToRefresh",n);this._internalModel.setProperty("/refreshButtonEnabled",i,null,true);this._internalModel.setProperty("/refreshButtonClicked",true);this._callRefreshResultsFunctionImport();};sap.rules.ui.TextRuleSettings.prototype._updateResultAttributeJSON=function(o,r,s,e,h){var i=this._internalModel.getProperty("/refreshButtonClicked");var j=o.getProperty("DataObjectAttributeId")?o.getProperty("DataObjectAttributeId"):o.getProperty("Id");if(this._internalModel.getProperty("/predefinedResults")){if(this._internalModel.getProperty("/predefinedResults/"+j)){if(r){this._internalModel.setProperty("/predefinedResults/"+j+"/AccessMode","Editable");this._internalModel.setProperty("/predefinedResults/"+j+"/Expression","");this._internalModel.setProperty("/predefinedResults/"+j+"/AST","");}if(i){this._internalModel.setProperty("/predefinedResults/"+j,o.getObject(o.sPath));this._internalModel.setProperty("/predefinedResults/"+j+"/isAttributeinBackend",true);this._internalModel.setProperty("/predefinedResults/"+j+"/AccessMode",s);this._internalModel.setProperty("/predefinedResults/"+j+"/Expression",e);this._internalModel.setProperty("/predefinedResults/"+j+"/AST",h);}if(s){this._internalModel.setProperty("/predefinedResults/"+j+"/AccessMode",s);}if(e||e===""){this._internalModel.setProperty("/predefinedResults/"+j+"/Expression",e);}if(h||h===""){this._internalModel.setProperty("/predefinedResults/"+j+"/AST",h);}}else{this._internalModel.setProperty("/predefinedResults/"+j,o.getObject(o.sPath));if(r){this._internalModel.setProperty("/predefinedResults/"+j+"/AccessMode","Editable");this._internalModel.setProperty("/predefinedResults/"+j+"/Expression","");this._internalModel.setProperty("/predefinedResults/"+j+"/AST","");}if(i){this._internalModel.setProperty("/predefinedResults/"+j+"/AccessMode",s);this._internalModel.setProperty("/predefinedResults/"+j+"/Expression",e);this._internalModel.setProperty("/predefinedResults/"+j+"/AST",h);this._internalModel.setProperty("/predefinedResults/"+j+"/isAttributeinBackend",true);}}}};sap.rules.ui.TextRuleSettings.prototype.getButtons=function(D){var e=[];var o=new B({text:this.oBundle.getText("cancelBtn")}).setTooltip(this.oBundle.getText("cancelBtn"));o.attachPress(function(){D.close();},this);var h=new B({text:this.oBundle.getText("applyChangesBtn")}).setTooltip(this.oBundle.getText("applyChangesBtn"));h.attachPress(function(){this._applySettingsModelChangesToOData(D);},this);e.push(h);e.push(o);return e;};sap.rules.ui.TextRuleSettings.prototype.init=function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.needCreateLayout=true;this.firstLoad=true;this.setBusyIndicatorDelay(0);this._astUtils=A;};sap.rules.ui.TextRuleSettings.prototype.onBeforeRendering=function(){if(this.firstLoad){var e=this.getProperty("newTextRule");this._getResultsData(e);this.firstLoad=false;}};sap.rules.ui.TextRuleSettings.prototype._applySettingsModelChangesToOData=function(D){var _=this.getModel();var o=this.getModel("oDataModel");var e=this.getModel("TextRuleModel");var s=this._internalModel;var r=e.getProperty("/ruleId");var R=e.getProperty("/ruleVersion");var h=_.getProperty("/ResultDataObjectId");var j=s.getProperty("/resultDataObjectChanged");var k=s.getProperty("/resultAttributeChanged");var m={groupId:"changes"};var n=false;var p=this.getProperty("newTextRule");var u=function(){e.setProperty("/resultChanged",j);D.setState(sap.ui.core.ValueState.Success);D.close();};o.setDeferredGroups([m.groupId]);var v=function(){var G=s.getProperty("/predefinedResults");for(var H in G){if(!G[H].isAttributeinBackend){var J={RuleId:G[H].RuleId,RuleVersion:G[H].RuleVersion,Id:G[H].Id};var K=o.createKey("/TextRuleResults",J);var N=new sap.ui.model.Context(o,K);o.deleteCreatedEntry(N);var O=e.getProperty("/textRuleResultExpressions");for(var i=0;i<O.length;i++){if(O[i].ResultId===G[H].Id){var Q={RuleId:G[H].RuleId,RuleVersion:G[H].RuleVersion,ResultId:G[H].Id,ConditionId:O[i].ConditionId};K=o.createKey("/TextRuleResultExpressions",Q);N=new sap.ui.model.Context(o,K);o.deleteCreatedEntry(N);}}}}};var w=function(){var P={};var i={RuleId:r,RuleVersion:R};var G=o.createKey("/TextRules",i);if(!o.getData(G)){P.properties=i;o.createEntry("/TextRules",P);}var H={RuleId:r,RuleVersion:R,Sequence:1};P.properties=H;o.createEntry("/TextRuleBranches",P);};var x=function(){var i=s.getProperty("/predefinedResults");if(i){var G;for(G in i){var H=i[G].AccessMode;var J=i[G].Expression?i[G].Expression:"";var K=i[G].AST?i[G].AST:"";var N="/PredefinedResults(RuleId='"+r+"',DataObjectAttributeId='"+G+"')";var O={AccessMode:H,Expression:J,AST:K};var P={groupId:m.groupId};o.update(N,O,P);}}};var y=function(){o.callFunction("/SetRuleResultDataObject",{method:"POST",groupId:m.groupId,urlParameters:{RuleId:r,ResultDataObjectId:h}});};var z=function(){o.callFunction("/RefreshRuleResultDataObject",{method:"POST",groupId:m.groupId,urlParameters:{RuleId:r}});};if(s.getProperty("/refreshButtonClicked")){v();}if(!j&&k){n=true;x();}else if(j){n=true;y();x();}var F=s.getProperty("/needToRefresh");if(F){n=true;z();}if(p){n=true;w();}var P={};P.success=u;P.groupId=m.groupId;if(n){o.submitChanges(P);return;}D.setState(sap.ui.core.ValueState.Success);D.close();};return t;},true);
